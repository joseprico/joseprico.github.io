<!DOCTYPE html>
<!--
  ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
  ‚ïë  CN Terrassa - Sistema d'Estad√≠stiques de Waterpolo         ‚ïë
  ‚ïë  Copyright ¬© 2025 Josep Rico. Tots els drets reservats.     ‚ïë
  ‚ïë                                                              ‚ïë
  ‚ïë  Desenvolupat per: Josep Rico Escofet                ‚ïë
  ‚ïë  Equips: CN Terrassa Cadet i Juvenil                        ‚ïë
  ‚ïë  Temporada: 2025-2026                                       ‚ïë
  ‚ïë                                                              ‚ïë
  ‚ïë  Aquest codi √©s propietat privada. No es permet la c√≤pia,   ‚ïë
  ‚ïë  modificaci√≥ o distribuci√≥ sense perm√≠s expl√≠cit.           ‚ïë
  ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
-->
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- PWA Manifest (primer de tot) -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Apple iOS PWA (ABANS de les icones normals) -->
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CNT WP">
    
    <!-- Theme colors -->
    <meta name="theme-color" content="#dc2626">
    
    <!-- Icones PWA -->
    <link rel="icon" type="image/png" sizes="192x192" href="cnt-ios-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="cnt-ios-512.png">
    
    <!-- Favicon navegador (al final) -->
    <link rel="icon" href="https://clubnatacioterrassa.cat/wp-content/uploads/CNT_Escut_Blau.png.webp" type="image/webp">
    
    <title>Visualitzador de Estad√≠stiques i en directe- CN Terrassa</title>
    <!-- ============================================
     üî• FIREBASE SDK - AFEGIR ARA!
     ============================================ -->
<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getDatabase, ref, onValue } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    // ‚ö†Ô∏è MATEIXA CONFIGURACI√ì QUE L'APP D'ENTRADA DE DADES!
    const firebaseConfig = {
  apiKey: "AIzaSyCmJwgJvh10LcpPjeWhLbN5EDYeHT3tAoU",
  authDomain: "cnt-wp-stats-bb7dc.firebaseapp.com",
  databaseURL: "https://cnt-wp-stats-bb7dc-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "cnt-wp-stats-bb7dc",
  storageBucket: "cnt-wp-stats-bb7dc.firebasestorage.app",
  messagingSenderId: "3430713575",
  appId: "1:3430713575:web:d580671a5d19049b187a42",
  measurementId: "G-VZVL8MZV4K"
};

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    
    window.firebaseDB = database;
    window.firebaseRef = ref;
    window.firebaseOnValue = onValue;
    window.firebaseReady = true;
    
    console.log('üî• Firebase inicialitzat per visualitzaci√≥!');
</script>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
body { 
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 50%, #0891b2 100%);
    color: white;
    min-height: 100vh;
    padding: 20px;
    transition: background 0.5s ease;
}
/* Bot√≥ d'instal¬∑laci√≥ PWA */
.install-button {
    display: block;
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: linear-gradient(135deg, #06b6d4, #0891b2);
    color: white;
    border: none;
    border-radius: 50px;
    padding: 15px 25px;
    font-weight: bold;
    font-size: 14px;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(6, 182, 212, 0.4);
    z-index: 9999;
    transition: all 0.3s;
    animation: pulse-install 2s infinite;
}
/* Fix espec√≠fic per singleMatchStatsTable - NOM√âS N¬∫ i Jugador fixes */
#singleMatchStatsTable thead tr:first-child th:nth-child(1),
#singleMatchStatsTable thead tr:first-child th:nth-child(2),
#singleMatchStatsTable tbody td:nth-child(1),
#singleMatchStatsTable tbody td:nth-child(2) {
    position: sticky;
    background: rgba(30, 58, 138, 0.95);
    z-index: 10;
}

#singleMatchStatsTable thead tr:first-child th:nth-child(1),
#singleMatchStatsTable tbody td:nth-child(1) {
    left: 0;
    min-width: 50px;
}

#singleMatchStatsTable thead tr:first-child th:nth-child(2),
#singleMatchStatsTable tbody td:nth-child(2) {
    left: 50px;
    min-width: 120px;
}

/* Headers de la primera fila amb z-index m√©s alt */
#singleMatchStatsTable thead tr:first-child th:nth-child(1),
#singleMatchStatsTable thead tr:first-child th:nth-child(2) {
    background: rgba(0, 0, 0, 0.5);
    z-index: 12;
}

/* Sombra nom√©s per tbody */
#singleMatchStatsTable tbody td:nth-child(2)::after {
    content: '';
    position: absolute;
    top: 0;
    right: -10px;
    bottom: 0;
    width: 10px;
    background: linear-gradient(to right, rgba(0,0,0,0.2), transparent);
    pointer-events: none;
}

/* Tema CADET per singleMatchStatsTable */
body.theme-cadet #singleMatchStatsTable thead tr:first-child th:nth-child(1),
body.theme-cadet #singleMatchStatsTable thead tr:first-child th:nth-child(2),
body.theme-cadet #singleMatchStatsTable tbody td:nth-child(1),
body.theme-cadet #singleMatchStatsTable tbody td:nth-child(2) {
    background: rgba(30, 41, 59, 0.95);
}

body.theme-cadet #singleMatchStatsTable thead tr:first-child th:nth-child(1),
body.theme-cadet #singleMatchStatsTable thead tr:first-child th:nth-child(2) {
    background: rgba(0, 0, 0, 0.5);
}

/* Tema JUVENIL per singleMatchStatsTable */
body.theme-juvenil #singleMatchStatsTable thead tr:first-child th:nth-child(1),
body.theme-juvenil #singleMatchStatsTable thead tr:first-child th:nth-child(2),
body.theme-juvenil #singleMatchStatsTable tbody td:nth-child(1),
body.theme-juvenil #singleMatchStatsTable tbody td:nth-child(2) {
    background: rgba(30, 58, 90, 0.95);
}

body.theme-juvenil #singleMatchStatsTable thead tr:first-child th:nth-child(1),
body.theme-juvenil #singleMatchStatsTable thead tr:first-child th:nth-child(2) {
    background: rgba(0, 0, 0, 0.5);
}
.install-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(6, 182, 212, 0.6);
}

@keyframes pulse-install {
    0%, 100% { box-shadow: 0 4px 15px rgba(6, 182, 212, 0.4); }
    50% { box-shadow: 0 4px 25px rgba(6, 182, 212, 0.8); }
}

@media (max-width: 768px) {
    .install-button {
        bottom: 10px;
        right: 10px;
        padding: 12px 20px;
        font-size: 13px;
    }
}

/* Missatge d'app ja instal¬∑lada */
.already-installed {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 9999;
}

.installed-card {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
    padding: 12px 20px;
    border-radius: 50px;
    box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
    font-weight: bold;
    font-size: 14px;
    animation: fadeInOut 3s ease-in-out;
}

@keyframes fadeInOut {
    0% { opacity: 0; transform: translateY(20px); }
    10%, 90% { opacity: 1; transform: translateY(0); }
    100% { opacity: 0; transform: translateY(-20px); }
}

@media (max-width: 768px) {
    .already-installed {
        bottom: 10px;
        right: 10px;
    }
    .installed-card {
        padding: 10px 16px;
        font-size: 13px;
    }
}
.goal-rect .ball {
  animation: pop-in 0.3s ease-out;
}
@keyframes pop-in {
  from { transform: scale(0.3); opacity: 0; }
  to   { transform: scale(1); opacity: 1; }
}
.tab.live {
  background: #666;
  color: #fff;
  border: 2px solid #999;
  font-weight: 600;
}
.goal-rect {
  --cell-w: 14px;     /* amplada cel¬∑la */
  --cell-h: 10px;     /* al√ßada cel¬∑la */
  --cols: 4;
  --rows: 3;

  display: grid;
  grid-template-columns: repeat(var(--cols), var(--cell-w));
  grid-template-rows: repeat(var(--rows), var(--cell-h));
  justify-items: center;
  align-items: center;
  gap: 1px;

  padding: 4px;
  border: 3px solid #d9e0ea;      /* marc */
  border-bottom-width: 4px;
  border-radius: 3px;
  background:
    repeating-linear-gradient(90deg, rgba(180,190,200,.5) 0 1px, transparent 1px calc(var(--cell-w))),
    repeating-linear-gradient(180deg, rgba(180,190,200,.5) 0 1px, transparent 1px calc(var(--cell-h)));
  background-clip: padding-box;
  width: calc(var(--cell-w)*var(--cols) + 8px);
  height: calc(var(--cell-h)*var(--rows) + 8px);
  position: relative;
  box-sizing: border-box;
}

.goal-rect .ball {
  grid-row: var(--r);
  grid-column: var(--c);
  font-size: 15px;
  transform: translateY(1px);
  filter: drop-shadow(0 0 1px rgba(0,0,0,.25));
}
/* contenidor meta */
.action-meta { display:flex; align-items:center; gap:.5rem; flex-wrap:wrap; }

.zone-wrap { display:flex; align-items:center; gap:.35rem; }
.zone-title {
  font-size:.8rem; color:#cbd5e1; /* to suau */
  padding:2px 6px; border-radius:6px; background:rgba(148,163,184,.15); border:1px solid rgba(148,163,184,.25);
}
/* contenidor amb porteria 3√ó3 */
.goal3x3{
  --size: 36px;         /* ample total (ajusta si cal) */
  --cell: 10px;         /* mida de cada "quadrat" de xarxa */
  --gap: 2px;

  display: grid;
  grid-template-columns: repeat(3, 1fr);
  grid-template-rows:    repeat(3, 1fr);
  width: calc(var(--size) + 8px);  /* + gruix marc */
  height: calc(var(--size) + 10px);
  padding: 4px;
  border: 3px solid #d9e0ea;       /* pals i travesser */
  border-bottom-width: 4px;         /* l√≠nia de gol m√©s gruixuda */
  border-radius: 4px;
  background:
    /* xarxa m√©s visible amb l√≠nies repetides */
    repeating-linear-gradient(90deg, rgba(180,190,200,.65) 0 1px, transparent 1px var(--cell)),
    repeating-linear-gradient(180deg, rgba(180,190,200,.65) 0 1px, transparent 1px var(--cell));
  background-clip: padding-box;
  position: relative;
  box-sizing: border-box;
}

/* pilota col¬∑locada a la cel¬∑la (grid-row/column via CSS vars) */
.goal3x3 .ball{
  grid-row: var(--r);
  grid-column: var(--c);
  display: inline-grid;
  place-items: center;
  font-size: 14px;
  line-height: 1;
  transform: translateY(1px); /* petit ajust √≤ptic */
  filter: drop-shadow(0 0 1px rgba(0,0,0,.25));
}
/* Piscineta per zones del camp */
.field-rect {
  --cell-w: 14px;     /* amplada cel¬∑la */
  --cell-h: 10px;     /* al√ßada cel¬∑la */
  --cols: 4;
  --rows: 3;

  display: flex;
  flex-direction: column;
  gap: 2px;
  
  padding: 4px;
  border: 3px solid #0284c7;
  border-radius: 3px;
  background: linear-gradient(135deg, #bae6fd 0%, #7dd3fc 50%, #0ea5e9 100%);
  box-shadow: inset 0 2px 4px rgba(14, 165, 233, 0.2);
  width: calc(var(--cell-w)*var(--cols) + 14px);
  position: relative;
  box-sizing: border-box;
}

/* Indicador de porteria rival */
.field-rect .goal-indicator {
  text-align: center;
  font-size: 10px;
  line-height: 1;
}

/* Grid de la piscina */
.field-rect .pool-grid {
  display: grid;
  grid-template-columns: repeat(var(--cols), var(--cell-w));
  grid-template-rows: repeat(var(--rows), var(--cell-h));
  justify-items: center;
  align-items: center;
  gap: 1px;
  /* Fons blau simulant aigua amb efecte d'ones */
  background:
    radial-gradient(circle at 20% 50%, rgba(255, 255, 255, 0.2) 0%, transparent 50%),
    radial-gradient(circle at 60% 70%, rgba(255, 255, 255, 0.15) 0%, transparent 50%),
    radial-gradient(circle at 80% 30%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
    linear-gradient(135deg, #bae6fd 0%, #7dd3fc 50%, #0ea5e9 100%);
  position: relative;
}

.field-rect .player-marker {
  grid-row: var(--r);
  grid-column: var(--c);
  font-size: 16px;
  transform: translateY(1px);
  filter: drop-shadow(0 0 2px rgba(0,0,0,.5));
  animation: pop-in 0.3s ease-out;
}
/* mini-porteria */
.mini-goal{
  --cell: 12px; --gap:2px;
  display:grid;
  grid-template-columns:repeat(3,var(--cell));
  grid-template-rows:repeat(3,var(--cell));
  gap:var(--gap);
  padding:4px;
  border:3px solid #e2e8f0;        /* pals i travesser */
  border-bottom-width:4px;          /* l√≠nia de gol m√©s gruixuda */
  border-radius:4px;
  background:
    /* xarxa */
    linear-gradient(90deg, rgba(226,232,240,.5) 1px, transparent 1px) 0 0/ calc(var(--cell)+var(--gap)) 100%,
    linear-gradient(180deg, rgba(226,232,240,.5) 1px, transparent 1px) 0 0/ 100% calc(var(--cell)+var(--gap));
}
.mini-goal .cell{
  width:var(--cell); height:var(--cell);
  background:#f8fafc; border:1px solid #e2e8f0; box-sizing:border-box;
}
.mini-goal .cell.active{
  background:#22c55e; border-color:#16a34a; box-shadow:0 0 0 2px rgba(34,197,94,.25) inset;
}

/* badge ‚ÄúNormal‚Äù neutre */
.action-badge.type-normal{ background:#eef2f7; border:1px solid #d7dee8; color:#344054; }

/* per si queda alguna label buida a HTML antic: amagar */
.action-meta .zone-label:empty, .action-meta .action-badge:empty{ display:none; }
/* Estat actiu, en directe */
.tab.live.active {
  background: linear-gradient(135deg, #dc2626, #ef4444);
  border: 2px solid #fca5a5;
}
/* badge gen√®rica ja la tens; afegim estil neutre per a ‚Äúnormal‚Äù */
.action-badge.type-normal {
  background: #eef2f7;
  border: 1px solid #d7dee8;
  color: #344054;
}

/* per si alguna vegada es pinta sense text (no hauria), amaguem xips buits */
.action-meta .zone-label:empty,
.action-meta .action-badge:empty {
  display: none;
}
/* No pintis en vermell el tab EN DIRECTE quan no est√† actiu */
.tab.live:not(.active):hover,
.tab.live:not(.active):focus,
.tab.live:not(.active):active {
  background: #666 !important;
  border-color: #999 !important;
  color: #fff !important;
}
.tab.live:disabled {
  opacity: 0.7;
  cursor: not-allowed;
}
/* Instruccions iOS */
.ios-instructions {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 9999;
    max-width: 90%;
    width: 350px;
}

.ios-card {
    background: linear-gradient(135deg, #06b6d4, #0891b2);
    color: white;
    padding: 20px;
    border-radius: 16px;
    box-shadow: 0 8px 24px rgba(6, 182, 212, 0.5);
    animation: slideUp 0.3s ease-out;
    position: relative;
}

.close-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 18px;
    line-height: 1;
    transition: background 0.2s;
}

.close-btn:hover {
    background: rgba(255, 255, 255, 0.3);
}

@keyframes slideUp {
    from {
        transform: translate(-50%, 100px);
        opacity: 0;
    }
    to {
        transform: translate(-50%, 0);
        opacity: 1;
    }
}

.ios-card ol {
    line-height: 1.6;
}

.ios-card li {
    margin: 8px 0;
}

@media (max-width: 768px) {
    .ios-instructions {
        bottom: 10px;
        width: 90%;
    }
}
/* Tema CADET (Gris suau) */
body.theme-cadet { 
    background: linear-gradient(135deg, #1e293b 0%, #334155 50%, #475569 100%);
}

/* Tema JUVENIL (Azul suau) */
body.theme-juvenil { 
    background: linear-gradient(135deg, #1e3a5a 0%, #1e4a7a 50%, #0891b2 100%);
}
        .container { max-width: 1400px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { font-size: 32px; margin-bottom: 10px; }
        /* Ajustes espec√≠ficos para gr√°ficos en m√≥vil */
@media (max-width: 768px) {
    /* Gr√°fico de Heatmap de Titularidades */
    #titularityHeatmapChart {
        min-height: 400px !important;
        max-height: 600px !important;
    }
   #totalTimeChart {
        min-height: 500px !important;
        max-height: 700px !important;
    } 
    /* Gr√°fico de Consistencia */
    #consistencyChart {
        min-height: 400px !important;
        max-height: 600px !important;
    }
    
    /* Contenedores de canvas para gr√°ficos horizontales */
    .card canvas[id$="Chart"] {
        min-height: 300px !important;
    }
}
        @media (max-width: 768px) {
            body { padding: 10px; }
            .header h1 { font-size: 24px; }
            .header p { font-size: 14px; }
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 12px;
            flex-wrap: wrap;
        }
        .tab {
            flex: 1;
            min-width: 120px;
            padding: 12px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        @media (max-width: 768px) {
            .tabs { gap: 8px; padding: 8px; }
            .tab { 
                padding: 10px 8px; 
                font-size: 13px;
                min-width: 100px;
            }
        }
        .tab.active { background: #06b6d4; }
        .tab:hover { background: rgba(255,255,255,0.2); }
        .card {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .scoreboard {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            padding: 20px;
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .team-score { text-align: center; }
        .team-name { font-size: 24px; font-weight: bold; color: #67e8f9; margin-bottom: 10px; }
        .score { font-size: 64px; font-weight: 900; color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .separator { font-size: 48px; font-weight: bold; color: #67e8f9; }
        
        @media (max-width: 768px) {
            .scoreboard { gap: 15px; padding: 15px; }
            .team-name { font-size: 18px; }
            .score { font-size: 48px; }
            .separator { font-size: 36px; }
        }
        .section-title { font-size: 22px; font-weight: bold; margin-bottom: 15px; color: #22d3ee; }
        .periods-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .period-card {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .period-label { font-size: 14px; color: #bae6fd; margin-bottom: 8px; }
        .period-score { font-size: 32px; font-weight: bold; color: #fde047; }
        .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 15px;
}
/* Banner per l'altre equip */
.other-team-banner {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 9999;
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
    padding: 12px 20px;
    text-align: center;
    box-shadow: 0 4px 16px rgba(245, 158, 11, 0.5);
    border-bottom: 3px solid #fbbf24;
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        transform: translateY(-100%);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.other-team-content {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 20px;
    flex-wrap: wrap;
}

.other-team-content span {
    font-size: 16px;
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.switch-team-btn {
    background: white;
    color: #d97706;
    border: none;
    padding: 8px 20px;
    border-radius: 20px;
    font-weight: bold;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

.switch-team-btn:hover {
    background: #fef3c7;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

/* Ajustar padding del body quan apareix el banner */
body.other-team-live {
    padding-top: 60px;
}

@media (max-width: 768px) {
    .other-team-content span {
        font-size: 14px;
    }
    
    .switch-team-btn {
        font-size: 12px;
        padding: 6px 16px;
    }
}
@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: 1fr;
        gap: 10px;
    }
    
    /* Player stat - m√©s espai i millor layout */
    .player-stat {
        padding: 15px;
        min-height: auto;
        gap: 12px;
    }
    
    /* Info del jugador - m√©s espai */
    .player-info {
        width: 100%;
        margin-bottom: 10px;
    }
    
    .player-name {
        font-size: 14px;
        font-weight: bold;
    }
    
    /* Stats del jugador - grid adaptat */
    .player-stats {
        display: grid !important;
        grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
        gap: 8px;
        width: 100%;
    }
    
    .stat-item {
        background: rgba(0, 0, 0, 0.2);
        padding: 8px;
        border-radius: 6px;
    }
    
    .stat-label {
        font-size: 9px;
        margin-bottom: 4px;
    }
    
    .stat-value {
        font-size: 16px;
        font-weight: bold;
    }
}
        .player-stat {
            background: rgba(0,0,0,0.2);
            padding: 12px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        @media (max-width: 768px) {
            .player-stat {
                padding: 10px;
                flex-direction: column;
                align-items: flex-start;
            }
            .player-info { margin-bottom: 8px; }
        }
.stats-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}
/* Pastilles responsive */
@media (max-width: 768px) {
    #pastilles-grid {
        grid-template-columns: 1fr !important;
    }
}
/* Limitar al√ßada dels gr√†fics circulars de porters */
#goalkeeperSavePercentageChart {
    max-height: 300px !important;
    width: 100% !important;
}

@media (max-width: 768px) {
    #goalkeeperSavePercentageChart {
        max-height: 250px !important;
    }
}
@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
}
.stats-table th,
.stats-table td {
    padding: 10px;
    text-align: left;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}
/* Visualitzaci√≥ Piscina */
.pool-container {
    background: linear-gradient(180deg, rgba(6, 182, 212, 0.3) 0%, rgba(8, 145, 178, 0.3) 100%);
    border: 3px solid #0891b2;
    border-radius: 20px;
    padding: 30px 20px;
    position: relative;
    max-width: 600px;
    margin: 0 auto;
}

.pool-goal {
    background: rgba(239, 68, 68, 0.3);
    border: 2px solid #ef4444;
    border-radius: 10px;
    padding: 10px;
    text-align: center;
    margin-bottom: 25px;
}

.pool-players {
    display: grid;
    gap: 15px;
}

.pool-goalkeeper {
    display: flex;
    justify-content: center;
    margin-bottom: 20px;
}

.pool-field-players {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    justify-items: center;
}

.pool-player {
    background: rgba(255, 255, 255, 0.1);
    border: 2px solid #22d3ee;
    border-radius: 12px;
    padding: 12px;
    text-align: center;
    min-width: 100px;
    transition: all 0.3s;
}

.pool-player:hover {
    transform: scale(1.05);
    background: rgba(255, 255, 255, 0.2);
}

.pool-player-num {
    background: #06b6d4;
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    font-weight: bold;
    margin: 0 auto 8px;
}

.pool-player-name {
    font-size: 12px;
    font-weight: bold;
    color: white;
    margin-bottom: 4px;
}

.pool-player-stat {
    font-size: 10px;
    color: #bae6fd;
}

.pool-midfield {
    border-top: 2px dashed rgba(255, 255, 255, 0.3);
    padding-top: 15px;
    margin-top: 15px;
    text-align: center;
    color: #bae6fd;
    font-size: 10px;
}
.stats-table th {
    background: rgba(6, 182, 212, 0.3);
    font-weight: bold;
    color: white;
}

.stats-table td {
    color: white;
}

.stats-table tbody tr:hover {
    background: rgba(255, 255, 255, 0.05);
}

        .player-info { display: flex; align-items: center; gap: 10px; }
        .player-num {
            background: #06b6d4;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .player-num.rival { background: #ef4444; }
        .player-name { font-weight: 600; }
        .player-stats { display: flex; gap: 15px; font-size: 18px; font-weight: bold; }
        .stat-item { display: flex; flex-direction: column; align-items: center; }
        .stat-label { font-size: 10px; color: #bae6fd; }
        .stat-value { color: #fde047; }
        .lineup-section { margin-bottom: 20px; }
        .lineup-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
        }
        .lineup-player {
            background: rgba(34, 197, 94, 0.3);
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            font-size: 12px;
            border: 2px solid #22c55e;
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .info-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 10px;
            }
        }
        .info-item {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 8px;
        }
        .info-label { font-size: 12px; color: #bae6fd; margin-bottom: 5px; }
        .info-value { font-size: 18px; font-weight: bold; }
        .observations {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 8px;
            white-space: pre-wrap;
            line-height: 1.6;
        }
        .btn {
            padding: 12px 24px;
            background: #06b6d4;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn:hover { background: #0891b2; }
        .no-data {
            text-align: center;
            padding: 60px 20px;
            font-size: 18px;
            color: #bae6fd;
        }
        .hidden { display: none; }
        .top-scorers {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .top-scorer-item {
            background: rgba(0,0,0,0.3);
            padding: 12px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .rank {
            background: #fbbf24;
            color: #000;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .rank.gold { background: #fbbf24; }
        .rank.silver { background: #d1d5db; }
        .rank.bronze { background: #d97706; }
        .matches-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }
        .match-item {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
            gap: 15px;
            flex-wrap: wrap;
        }
        .match-item:hover { background: rgba(0,0,0,0.3); }
        .match-info { flex: 1; min-width: 200px; }
        
        @media (max-width: 768px) {
            .match-item {
                padding: 12px;
                flex-direction: column;
                align-items: flex-start;
            }
            .match-info { width: 100%; }
            .match-score { margin: 10px 0 0 0 !important; }
        }
        .match-date { font-size: 12px; color: #bae6fd; margin-bottom: 5px; }
        .match-teams { font-size: 16px; font-weight: bold; }
        .match-score { font-size: 24px; font-weight: bold; color: #fde047; margin: 0 15px; }
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 14px;
        }
        .comparison-table th,
        .comparison-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .comparison-table th {
            background: rgba(0,0,0,0.3);
            color: #22d3ee;
            font-weight: bold;
        }
        .comparison-table tr:hover {
            background: rgba(255,255,255,0.05);
        }
        
        @media (max-width: 768px) {
            .comparison-table {
                font-size: 11px;
            }
            .comparison-table th,
            .comparison-table td {
                padding: 8px 4px;
            }
        }
        .win { color: #22c55e; font-weight: bold; }
        .loss { color: #ef4444; font-weight: bold; }
        .draw { color: #fbbf24; font-weight: bold; }
        .titular-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        @media (max-width: 768px) {
            .titular-stats {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            canvas {
                max-height: 250px !important;
            }
        }
        .titular-item {
            background: rgba(0,0,0,0.2);
            padding: 12px;
            border-radius: 8px;
        }
        .titular-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        .titular-quarters {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }
		.match-header {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 30px;
    padding: 20px;
    background: rgba(0,0,0,0.2);
    border-radius: 12px;
}

.team-section {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
}
.goal-zone-heatmap {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    grid-template-rows: repeat(3, 60px); /* Files m√©s altes per fer-ho rectangular */
    gap: 3px;
    max-width: 280px; /* Una mica m√©s estret */
    margin: 0 auto;
    background: rgba(20, 30, 40, 0.4);
    padding: 12px;
    border-radius: 8px;
    border: 3px solid #cbd5e1; /* Marc de porteria */
    border-bottom-width: 5px; /* L√≠nia de gol m√©s gruixuda */
    position: relative;
    /* Efecte de xarxa amb gradient */
    background-image: 
        repeating-linear-gradient(0deg, 
            transparent, 
            transparent 19px, 
            rgba(203, 213, 225, 0.3) 19px, 
            rgba(203, 213, 225, 0.3) 20px),
        repeating-linear-gradient(90deg, 
            transparent, 
            transparent 29px, 
            rgba(203, 213, 225, 0.3) 29px, 
            rgba(203, 213, 225, 0.3) 30px);
    background-color: rgba(20, 30, 40, 0.4);
    background-position: 12px 12px;
}
.player-row-clickable {
    cursor: pointer;
}

.player-row-clickable:hover {
    background: rgba(34, 211, 238, 0.2) !important;
}
.goal-zone-cell {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    font-size: 16px;
    font-weight: bold;
    transition: transform 0.2s, border-color 0.2s;
    min-height: 60px; /* Altura m√≠nima per mantenir proporcions */
    background-clip: padding-box;
}

.goal-zone-cell:hover {
    transform: scale(1.05);
    border-color: #22d3ee;
    z-index: 10;
}

.zone-label {
    font-size: 9px;
    color: rgba(255, 255, 255, 0.6);
    margin-bottom: 2px;
}

.zone-count {
    font-size: 18px;
    color: white;
}

.individual-zone-card {
    background: rgba(0, 0, 0, 0.2);
    padding: 12px;
    border-radius: 8px;
}

.individual-zone-card .player-name {
    font-size: 12px;
    font-weight: bold;
    color: #22d3ee;
    margin-bottom: 8px;
    text-align: center;
}
/* Estil especial per zones del camp (simulant piscina) */
.field-zone-heatmap {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    grid-template-rows: repeat(3, 60px);
    gap: 3px;
    max-width: 280px;
    margin: 0 auto;
    background: linear-gradient(135deg, #bae6fd 0%, #7dd3fc 50%, #0ea5e9 100%);
    padding: 12px;
    border-radius: 8px;
    border: 3px solid #0284c7;
    border-bottom-width: 5px;
    position: relative;
    /* Efecte d'ones d'aigua amb gradient */
    background-image: 
        radial-gradient(circle at 20% 50%, rgba(255, 255, 255, 0.2) 0%, transparent 50%),
        radial-gradient(circle at 60% 70%, rgba(255, 255, 255, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 80% 30%, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
    background-color: #7dd3fc;
    box-shadow: inset 0 2px 8px rgba(14, 165, 233, 0.3);
}

.individual-zone-card .goal-zone-heatmap {
    max-width: 180px;
}

.individual-zone-card .zone-count {
    font-size: 14px;
}


.team-section h2 {
    margin: 0;
    font-size: 20px;
    font-weight: bold;
}

.score {
    font-size: 48px;
    font-weight: bold;
    color: #fde047;
}

.vs {
    font-size: 24px;
    font-weight: bold;
    color: rgba(255,255,255,0.6);
}
        .quarter-badge {
            background: rgba(6, 182, 212, 0.3);
            border: 2px solid #06b6d4;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
        }
        .total-badge {
            background: #fbbf24;
            color: #000;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #22d3ee;
        }
        .filter-bar {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        @media (max-width: 768px) {
            .filter-bar {
                padding: 12px;
                gap: 10px;
            }
            .filter-item { width: 100%; }
            .filter-input { width: 100%; }
        }
        .filter-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .filter-label {
            font-size: 12px;
            color: #bae6fd;
        }
        .filter-input {
    padding: 8px 12px;
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.3);
    border-radius: 6px;
    color: white;
    font-size: 14px;
}
/* Estilos para pestanya Individual */
.player-header {
    text-align: center;
    padding: 20px;
    background: rgba(0,0,0,0.3);
    border-radius: 12px;
    margin-bottom: 20px;
}

.player-header h3 {
    font-size: 28px;
    color: #22d3ee;
    margin-bottom: 10px;
}

.player-header .player-number-big {
    display: inline-block;
    background: #06b6d4;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    line-height: 60px;
    font-size: 32px;
    font-weight: bold;
    margin-bottom: 10px;
}

#comparePlayersCheckboxes label {
    background: rgba(255,255,255,0.1);
    padding: 10px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 8px;
}

#comparePlayersCheckboxes label:hover {
    background: rgba(255,255,255,0.2);
}

#comparePlayersCheckboxes input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.zone-heatmap-container {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 5px;
    max-width: 400px;
    margin: 0 auto;
}

.zone-cell {
    aspect-ratio: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    font-weight: bold;
    color: white;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
}

.zone-cell .zone-label {
    font-size: 10px;
    margin-bottom: 5px;
    opacity: 0.8;
}

.zone-cell .zone-count {
    font-size: 24px;
}
.timeline {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.timeline-item {
    background: rgba(0,0,0,0.3);
    padding: 12px;
    border-radius: 8px;
    border-left: 4px solid;
    display: flex;
    align-items: center;
    gap: 12px;
}
.timeline-item.water-change {
    border-left-color: #06b6d4;
}

.timeline-item.goal {
    border-left-color: #22c55e;
}

.timeline-item.exclusion {
    border-left-color: #f97316;
}

.timeline-item.penalty-missed {
    border-left-color: #ef4444;
}

.timeline-icon {
    font-size: 24px;
    flex-shrink: 0;
}

.timeline-content {
    flex: 1;
}

.timeline-player {
    font-weight: bold;
    color: #22d3ee;
}

.timeline-detail {
    font-size: 12px;
    color: #bae6fd;
    margin-top: 2px;
}

.timeline-quarter {
    background: rgba(6, 182, 212, 0.3);
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 11px;
    color: #67e8f9;
    font-weight: bold;
    border: 1px solid #22d3ee;
    flex-shrink: 0;
}

.timeline-rival {
    color: #fca5a5;
}

.no-timeline {
    text-align: center;
    padding: 40px 20px;
    color: #bae6fd;
    font-size: 14px;
}
.filter-input:focus {
    outline: none;
    border-color: #22d3ee;
}
.player-number-big {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 36px;
    font-weight: bold;
    color: white;
    margin: 0 auto 15px;
    box-shadow: 0 4px 12px rgba(6, 182, 212, 0.4);
}
.filter-input option {
    background: #1e3a8a;
    color: white;
}
        .stats-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        @media (max-width: 768px) {
            .stats-breakdown {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 8px;
            }
        }
        .breakdown-item {
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }
        .breakdown-label {
            font-size: 11px;
            color: #bae6fd;
            margin-bottom: 5px;
        }
        .breakdown-value {
            font-size: 20px;
            font-weight: bold;
            color: #fde047;
        }
		@media print {
    /* Ocultar elements que no vols imprimir */
    .btn, .filter-bar, .tabs {
        display: none !important;
    }
    
    /* Ajustar mides per impressi√≥ */
    body {
        background: white;
    }
    
    .card {
        page-break-inside: avoid;
        box-shadow: none;
        border: 1px solid #ddd;
    }
}
/* Estils addicionals per la pestanya ACTAWP */
.stat-item {
    background: rgba(255,255,255,0.05);
    padding: 15px;
    border-radius: 8px;
    text-align: center;
}

.stat-label {
    font-size: 12px;
    color: #bae6fd;
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.stat-value {
    font-size: 32px;
    font-weight: bold;
    color: #22d3ee;
}

.comparison-table {
    width: 100%;
    border-collapse: collapse;
}

.comparison-table th {
    background: rgba(0,0,0,0.3);
    padding: 12px;
    text-align: left;
    font-weight: bold;
    color: #22d3ee;
    border-bottom: 2px solid rgba(34, 211, 238, 0.3);
}

.comparison-table td {
    padding: 10px 12px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

.comparison-table tr:hover {
    background: rgba(255,255,255,0.05);
}
.hidden {
    display: none !important;
}

.tab-content {
    display: none;
}

.tab-content:not(.hidden) {
    display: block;
}
/* Estils per la classificaci√≥ */
.ranking-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}

.ranking-table thead {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.ranking-table th {
    padding: 12px 8px;
    text-align: center;
    color: white;
    font-weight: 600;
    font-size: 12px;
    text-transform: uppercase;
}

.ranking-table tbody tr {
    border-bottom: 1px solid rgba(255,255,255,0.1);
    transition: all 0.2s ease;
}

.ranking-table tbody tr:hover {
    background-color: rgba(34, 211, 238, 0.1);
}

.ranking-table tbody tr.highlight-team {
    background-color: rgba(251, 191, 36, 0.2);
    font-weight: bold;
    border-left: 3px solid #fbbf24;
}

.ranking-table td {
    padding: 12px 8px;
    text-align: center;
    color: #bae6fd;
}

.team-cell {
    text-align: left !important;
    display: flex;
    align-items: center;
    gap: 10px;
    padding-left: 15px !important;
}

.team-logo {
    width: 30px;
    height: 30px;
    object-fit: contain;
    background: white;
    border-radius: 4px;
    padding: 2px;
}

.position-badge {
    display: inline-block;
    width: 26px;
    height: 26px;
    line-height: 26px;
    border-radius: 50%;
    font-weight: bold;
    color: white;
}

.position-badge.gold { background: linear-gradient(135deg, #FFD700, #FFA500); }
.position-badge.silver { background: linear-gradient(135deg, #C0C0C0, #A8A8A8); }
.position-badge.bronze { background: linear-gradient(135deg, #CD7F32, #B8733A); }

.stat-wins { color: #4ade80; font-weight: 600; }
.stat-draws { color: #fbbf24; font-weight: 600; }
.stat-losses { color: #ef4444; font-weight: 600; }
.stat-points { color: #fbbf24; font-weight: bold; font-size: 16px; }
/* Estils per els logos dels equips */
.match-team-logo {
    width: 28px;
    height: 28px;
    object-fit: contain;
    background: white;
    border-radius: 4px;
    padding: 2px;
    margin-right: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}

.match-team-container {
    display: flex;
    align-items: center;
    gap: 8px;
}

.match-team-name {
    flex: 1;
}
/* Estil per les instruccions iOS */
.ios-instructions {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 9999;
    max-width: 90%;
    width: 350px;
}

.ios-card {
    background: linear-gradient(135deg, #06b6d4, #0891b2);
    color: white;
    padding: 20px;
    border-radius: 16px;
    box-shadow: 0 8px 24px rgba(6, 182, 212, 0.5);
    animation: slideUp 0.3s ease-out;
}

@keyframes slideUp {
    from {
        transform: translateY(100px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.ios-card ol {
    line-height: 1.6;
}

.ios-card li {
    margin: 8px 0;
}
/* ========================================
   COLUMNES FIXES PER TAULES DE JUGADORS
   NOM√âS PER .comparison-table
   ======================================== */

/* Primera columna (N¬∫) sticky */
.comparison-table thead tr:first-child th:nth-child(1),
.comparison-table tbody tr td:nth-child(1),
.comparison-table tfoot tr td:nth-child(1) {
    position: sticky !important;
    left: 0 !important;
    z-index: 100 !important;
    background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%) !important;
    min-width: 50px !important;
    max-width: 50px !important;
}

/* Segona columna (Jugador/Nom) sticky - M√âS CURTA */
.comparison-table thead tr:first-child th:nth-child(2),
.comparison-table tbody tr td:nth-child(2),
.comparison-table tfoot tr td:nth-child(2) {
    position: sticky !important;
    left: 50px !important;
    z-index: 100 !important;
    background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%) !important;
    min-width: 120px !important;
    max-width: 140px !important;
    white-space: nowrap !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
}

/* Tercera columna (Partidos) sticky */
.comparison-table thead tr:first-child th:nth-child(3),
.comparison-table tbody tr td:nth-child(3),
.comparison-table tfoot tr td:nth-child(3) {
    position: sticky !important;
    left: 170px !important;
    z-index: 100 !important;
    background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%) !important;
    min-width: 30px !important;
    max-width: 30px !important;
}

/* Headers de les 3 primeres columnes amb fons m√©s fosc */
.comparison-table thead tr:first-child th:nth-child(1),
.comparison-table thead tr:first-child th:nth-child(2),
.comparison-table thead tr:first-child th:nth-child(3) {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    z-index: 101 !important;
}

/* Segona fila de headers - z-index BAIX */
.comparison-table thead tr:nth-child(2) th {
    position: relative !important;
    z-index: 5 !important;
}

/* Footer tamb√© sticky per les 3 columnes */
.comparison-table tfoot tr td:nth-child(1),
.comparison-table tfoot tr td:nth-child(2),
.comparison-table tfoot tr td:nth-child(3) {
    background: rgba(34, 211, 238, 0.3) !important;
    z-index: 100 !important;
}

/* Ombra a la dreta de la TERCERA columna */
.comparison-table thead tr th:nth-child(3)::after,
.comparison-table tbody tr td:nth-child(3)::after,
.comparison-table tfoot tr td:nth-child(3)::after {
    content: '';
    position: absolute;
    top: 0;
    right: -4px;
    bottom: 0;
    width: 4px;
    background: linear-gradient(to right, rgba(0,0,0,0.3), transparent);
    z-index: 100;
}

@media (max-width: 768px) {
    .comparison-table thead tr:first-child th:nth-child(1),
    .comparison-table tbody tr td:nth-child(1),
    .comparison-table tfoot tr td:nth-child(1) {
        min-width: 45px !important;
        max-width: 45px !important;
    }
    
    .comparison-table thead tr:first-child th:nth-child(2),
    .comparison-table tbody tr td:nth-child(2),
    .comparison-table tfoot tr td:nth-child(2) {
        left: 45px !important;
        min-width: 100px !important;
        max-width: 110px !important;
    }
    
    .comparison-table thead tr:first-child th:nth-child(3),
    .comparison-table tbody tr td:nth-child(3),
    .comparison-table tfoot tr td:nth-child(3) {
        left: 145px !important;
        min-width: 60px !important;
        max-width: 65px !important;
    }
}

@media (max-width: 768px) {
    /* Reduir font de la taula al m√≤bil */
    #singleMatchStatsTable {
        font-size: 10px;
    }
    
    #singleMatchStatsTable th,
    #singleMatchStatsTable td {
        padding: 6px 4px;
    }
}
.notification-toggle {
  background: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%);
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 20px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  transition: all 0.3s;
  box-shadow: 0 2px 8px rgba(6, 182, 212, 0.3);
}

.notification-toggle:hover {
  box-shadow: 0 4px 12px rgba(6, 182, 212, 0.5);
}

.notification-toggle.subscribed {
  background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
}

.notification-toggle.subscribed #notificationIcon::after {
  content: '‚úì';
  position: absolute;
  font-size: 10px;
  background: white;
  color: #22c55e;
  border-radius: 50%;
  width: 14px;
  height: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-left: 12px;
  margin-top: -8px;
}
/* ============================================
   üî• BANNER DE TEMPS REAL - S√öPER VISIBLE!
   ============================================ */
.live-banner {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 10000;
    background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
    color: white;
    padding: 20px;
    text-align: center;
    box-shadow: 0 8px 32px rgba(220, 38, 38, 0.6);
    border-bottom: 4px solid #fca5a5;
    animation: live-pulse 2s infinite;
    display: none; /* Ocultat per defecte */
}

.live-banner.active {
    display: block;
}

@keyframes live-pulse {
    0%, 100% {
        box-shadow: 0 8px 32px rgba(220, 38, 38, 0.6);
        background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
    }
    50% {
        box-shadow: 0 8px 48px rgba(220, 38, 38, 0.9);
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }
}

.live-banner-content {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
    flex-wrap: wrap;
}

.live-dot {
    width: 16px;
    height: 16px;
    background: white;
    border-radius: 50%;
    animation: live-blink 1s infinite;
}

@keyframes live-blink {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.3; transform: scale(1.3); }
}

.live-text {
    font-size: 24px;
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: 2px;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
}

.live-match-info {
    font-size: 16px;
    font-weight: 600;
    color: #fecaca;
}

/* Ajustar el contingut per no quedar tapat pel banner */
body.live-mode {
    padding-top: 100px !important;
}

/* Indicador petit de temps real (sempre visible) */
.live-indicator-small {
    position: fixed;
    bottom: 20px;
    left: 20px;
    background: rgba(220, 38, 38, 0.95);
    color: white;
    padding: 10px 15px;
    border-radius: 25px;
    font-size: 12px;
    font-weight: bold;
    display: none;
    align-items: center;
    gap: 8px;
    z-index: 9999;
    box-shadow: 0 4px 16px rgba(220, 38, 38, 0.5);
}

.live-indicator-small.active {
    display: flex;
}

.live-indicator-small .dot {
    width: 8px;
    height: 8px;
    background: white;
    border-radius: 50%;
    animation: live-blink 1s infinite;
}

@media (max-width: 768px) {
    .live-text {
        font-size: 18px;
    }
    
    .live-match-info {
        font-size: 14px;
    }
    
    .live-banner {
        padding: 15px 10px;
    }
}
/* ============================================
   üî¥ PESTANYA EN DIRECTE
   ============================================ */
#liveTab {
    display: none; /* Oculta per defecte */
}

#liveTab.active {
    display: inline-block;
    animation: tab-appear 0.3s ease-out;
}

@keyframes tab-appear {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

#liveView {
    display: none;
}

#liveView:not(.hidden) {
    display: block;
}

/* Marcador principal EN DIRECTE */
.live-scoreboard {
    background: linear-gradient(135deg, #1e3a8a 0%, #0891b2 100%);
    border-radius: 16px;
    padding: 30px 20px;
    margin-bottom: 20px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    border: 3px solid #22d3ee;
}

.live-title {
    text-align: center;
    font-size: 18px;
    font-weight: 900;
    color: #fca5a5;
    text-transform: uppercase;
    letter-spacing: 2px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.live-pulse-dot {
    width: 12px;
    height: 12px;
    background: #ef4444;
    border-radius: 50%;
    animation: live-pulse-dot 1.5s infinite;
}

@keyframes live-pulse-dot {
    0%, 100% { 
        opacity: 1; 
        transform: scale(1); 
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
    }
    50% { 
        opacity: 0.7; 
        transform: scale(1.2); 
        box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
    }
}

.live-main-score {
    display: flex;
    justify-content: space-around;
    align-items: center;
    margin-bottom: 30px;
}

.live-team {
    flex: 1;
    text-align: center;
}

.live-team-name {
    font-size: 16px;
    font-weight: 700;
    color: #bae6fd;
    margin-bottom: 10px;
    text-transform: uppercase;
}

.live-team-score {
    font-size: 72px;
    font-weight: 900;
    color: white;
    line-height: 1;
    text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.4);
    font-family: 'Courier New', monospace;
}

.live-score-separator {
    font-size: 48px;
    color: #64748b;
    font-weight: bold;
}

/* Marcadors per quarter */
.live-quarters {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
    margin-bottom: 20px;
}

.live-quarter {
    background: rgba(255, 255, 255, 0.1);
    padding: 12px;
    border-radius: 8px;
    text-align: center;
    border: 2px solid rgba(255, 255, 255, 0.2);
}

.live-quarter-label {
    font-size: 12px;
    color: #67e8f9;
    font-weight: 700;
    margin-bottom: 5px;
}

.live-quarter-score {
    font-size: 24px;
    font-weight: 900;
    color: white;
    font-family: 'Courier New', monospace;
}

/* Timestamp */
.live-timestamp {
    text-align: center;
    font-size: 12px;
    color: #94a3b8;
    margin-top: 15px;
    font-style: italic;
}

/* Card de golejadors */
.live-scorers-card {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.live-scorers-title {
    font-size: 18px;
    font-weight: 700;
    color: #22d3ee;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.live-scorers-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.live-scorer-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: rgba(255, 255, 255, 0.05);
    padding: 10px 15px;
    border-radius: 8px;
    border-left: 4px solid #22c55e;
}

.live-scorer-item.rival {
    border-left-color: #ef4444;
}

.live-scorer-info {
    display: flex;
    align-items: center;
    gap: 10px;
    flex: 1;
}

.live-scorer-number {
    width: 32px;
    height: 32px;
    background: #3b82f6;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 900;
    font-size: 14px;
}

.live-scorer-item.rival .live-scorer-number {
    background: #ef4444;
}

.live-scorer-name {
    font-size: 14px;
    font-weight: 600;
    color: white;
}

.live-scorer-goals {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 18px;
    font-weight: 900;
    color: #fde047;
}

.live-scorer-badge {
    background: #ef4444;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 700;
    margin-left: 8px;
}

/* Secci√≥ d'exclusions */
.live-exclusions {
    display: flex;
    gap: 15px;
    margin-top: 15px;
    flex-wrap: wrap;
}

.live-exclusion-group {
    flex: 1;
    min-width: 200px;
}

.live-exclusion-title {
    font-size: 14px;
    font-weight: 700;
    color: #fbbf24;
    margin-bottom: 8px;
}

.live-exclusion-list {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.live-exclusion-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: #fca5a5;
}

/* Empty state */
.live-empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #94a3b8;
}

.live-empty-icon {
    font-size: 64px;
    margin-bottom: 20px;
    opacity: 0.5;
}

.live-empty-text {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 10px;
}

.live-empty-subtext {
    font-size: 14px;
    opacity: 0.7;
}

/* Responsive */
@media (max-width: 768px) {
    .live-team-score {
        font-size: 48px;
    }
    
    .live-score-separator {
        font-size: 32px;
    }
    
    .live-quarters {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .live-main-score {
        margin-bottom: 20px;
    }
    
    .live-scoreboard {
        padding: 20px 15px;
    }
    
    .live-exclusions {
        flex-direction: column;
    }
}
/* ============================================
   ‚ö° SUB-TABS DINS EN DIRECTE
   ============================================ */
.live-sub-tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
    border-bottom: 2px solid rgba(255, 255, 255, 0.1);
    padding-bottom: 0;
}

.live-sub-tab {
    flex: 1;
    padding: 12px 16px;
    background: transparent;
    border: none;
    color: rgba(255, 255, 255, 0.6);
    font-size: 14px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    border-bottom: 3px solid transparent;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.live-sub-tab:hover {
    color: rgba(255, 255, 255, 0.9);
    background: rgba(255, 255, 255, 0.05);
}

.live-sub-tab.active {
    color: #22d3ee;
    border-bottom-color: #22d3ee;
    background: rgba(34, 211, 238, 0.1);
}

/* Sub-vistes */
.live-sub-view {
    display: none;
}

.live-sub-view.active {
    display: block;
    animation: fade-in 0.3s ease-out;
}

@keyframes fade-in {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* ============================================
   ‚ö° TIMELINE D'ACCIONS
   ============================================ */
.actions-timeline {
    display: flex;
    flex-direction: column;
    gap: 12px;
    max-height: 600px;
    overflow-y: auto;
    padding-right: 8px;
}

/* Scrollbar personalitzada */
.actions-timeline::-webkit-scrollbar {
    width: 8px;
}

.actions-timeline::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 4px;
}

.actions-timeline::-webkit-scrollbar-thumb {
    background: rgba(34, 211, 238, 0.5);
    border-radius: 4px;
}

.actions-timeline::-webkit-scrollbar-thumb:hover {
    background: rgba(34, 211, 238, 0.7);
}

/* Item d'acci√≥ */
.action-item {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    padding: 15px;
    border-left: 4px solid #3b82f6;
    position: relative;
    transition: all 0.2s;
}

.action-item:hover {
    background: rgba(255, 255, 255, 0.08);
    transform: translateX(4px);
}

/* Tipus d'accions - Colors */
.action-item.goal {
    border-left-color: #22c55e;
    background: linear-gradient(90deg, rgba(34, 197, 94, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
}

.action-item.goal-rival {
    border-left-color: #ef4444;
    background: linear-gradient(90deg, rgba(239, 68, 68, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
}

.action-item.exclusion {
    border-left-color: #f97316;
    background: linear-gradient(90deg, rgba(249, 115, 22, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
}

.action-item.save {
    border-left-color: #8b5cf6;
    background: linear-gradient(90deg, rgba(139, 92, 246, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
}

.action-item.assist {
    border-left-color: #06b6d4;
    background: linear-gradient(90deg, rgba(6, 182, 212, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
}

.action-item.action {
    border-left-color: #64748b;
    background: linear-gradient(90deg, rgba(100, 116, 139, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
}

/* Header de l'acci√≥ */
.action-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.action-time {
    font-size: 12px;
    color: #94a3b8;
    font-weight: 600;
}

.action-quarter {
    background: rgba(34, 211, 238, 0.2);
    color: #22d3ee;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 700;
}

/* Contingut de l'acci√≥ */
.action-content {
    display: flex;
    align-items: center;
    gap: 12px;
}

.action-icon {
    font-size: 32px;
    line-height: 1;
    flex-shrink: 0;
}

.action-details {
    flex: 1;
}

.action-title {
    font-size: 16px;
    font-weight: 700;
    color: white;
    margin-bottom: 4px;
}

.action-player {
    font-size: 14px;
    color: #bae6fd;
    font-weight: 600;
}

.action-player-number {
    display: inline-block;
    background: #3b82f6;
    color: white;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    text-align: center;
    line-height: 24px;
    font-size: 12px;
    font-weight: 900;
    margin-right: 6px;
    vertical-align: middle;
}

.action-player-number.rival {
    background: #ef4444;
}

.action-meta {
    font-size: 12px;
    color: #94a3b8;
    margin-top: 4px;
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

.action-meta-item {
    display: flex;
    align-items: center;
    gap: 4px;
}

/* Badges */
.action-badge {
    background: rgba(251, 191, 36, 0.2);
    color: #fbbf24;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
}

.action-badge.type-h-plus {
    background: rgba(34, 197, 94, 0.2);
    color: #22c55e;
}

.action-badge.type-penalty {
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
}

/* Empty state */
.actions-empty {
    text-align: center;
    padding: 60px 20px;
    color: #94a3b8;
}

.actions-empty-icon {
    font-size: 64px;
    margin-bottom: 20px;
    opacity: 0.3;
}

.actions-empty-text {
    font-size: 16px;
    font-weight: 600;
}

/* Animaci√≥ d'entrada per noves accions */
@keyframes action-appear {
    from {
        opacity: 0;
        transform: translateX(-20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.action-item.new {
    animation: action-appear 0.4s ease-out;
}

/* Responsive */
@media (max-width: 768px) {
    .live-sub-tab {
        padding: 10px 12px;
        font-size: 12px;
    }
    
    .action-icon {
        font-size: 24px;
    }
    
    .action-title {
        font-size: 14px;
    }
    
    .action-player {
        font-size: 13px;
    }
}
/* ============================================
   üìà TAULA D'ESTAD√çSTIQUES COMPLETES
   ============================================ */
.stats-table-container {
    overflow-x: auto;
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.05);
    padding: 15px;
}

.live-stats-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
    background: transparent;
}

.live-stats-table thead {
    background: rgba(34, 211, 238, 0.2);
    position: sticky;
    top: 0;
    z-index: 10;
}

.live-stats-table th {
    padding: 12px 8px;
    text-align: center;
    font-weight: 700;
    color: #22d3ee;
    white-space: nowrap;
    cursor: pointer;
    user-select: none;
    transition: all 0.2s;
    border-bottom: 2px solid rgba(34, 211, 238, 0.3);
}

.live-stats-table th:hover {
    background: rgba(34, 211, 238, 0.3);
    color: #67e8f9;
}

.live-stats-table th.sortable::after {
    content: ' ‚ÜïÔ∏è';
    font-size: 10px;
    opacity: 0.5;
}

.live-stats-table th.sorted-asc::after {
    content: ' ‚¨ÜÔ∏è';
    opacity: 1;
}

.live-stats-table th.sorted-desc::after {
    content: ' ‚¨áÔ∏è';
    opacity: 1;
}

.live-stats-table th:first-child,
.live-stats-table td:first-child {
    text-align: left;
    position: sticky;
    left: 0;
    background: rgba(15, 23, 42, 0.95);
    z-index: 5;
}

.live-stats-table th:nth-child(2),
.live-stats-table td:nth-child(2) {
    text-align: left;
    position: sticky;
    left: 50px;
    background: rgba(15, 23, 42, 0.95);
    z-index: 5;
    min-width: 140px;
}

.live-stats-table tbody tr {
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.2s;
}

.live-stats-table tbody tr:hover {
    background: rgba(34, 211, 238, 0.1);
}

.live-stats-table tbody tr.best-player {
    background: linear-gradient(90deg, rgba(251, 191, 36, 0.2) 0%, transparent 100%);
    border-left: 4px solid #fbbf24;
}

.live-stats-table tbody tr.best-player td:first-child {
    background: rgba(251, 191, 36, 0.3);
}

.live-stats-table tbody tr.best-player td:nth-child(2) {
    background: rgba(251, 191, 36, 0.3);
}

.live-stats-table td {
    padding: 10px 8px;
    text-align: center;
    color: white;
    white-space: nowrap;
}

.live-stats-table td.player-number {
    font-weight: 900;
    color: #22d3ee;
    width: 50px;
}

.live-stats-table td.player-name {
    font-weight: 600;
    color: #bae6fd;
}

.live-stats-table td.stat-highlight {
    font-weight: 700;
    color: #fde047;
}

.live-stats-table td.stat-positive {
    color: #22c55e;
    font-weight: 600;
}

.live-stats-table td.stat-negative {
    color: #ef4444;
    font-weight: 600;
}

.live-stats-table td.mvp-score {
    font-weight: 900;
    font-size: 14px;
    color: #fbbf24;
}
/* 1) permet sticky fiable en <td> i habilita ample > viewport */
.live-stats-table {
  border-collapse: separate;  /* abans: collapse */
  border-spacing: 0;
  min-width: max-content;
}

/* 2) fila ‚Äúnom d‚Äôequip‚Äù enganxada a l‚Äôesquerra tot i l‚Äôscroll horitzontal */
.live-stats-table tr.team-header > td,
.live-stats-table tr.team-header.rival > td {
  position: sticky;
  left: 0;
  z-index: 7; /* > 5 de les primeres columnes */
  background: rgba(15, 23, 42, 0.98); /* mateix to que les sticky cols */
  color: #fff;
  font-weight: 700;
  backdrop-filter: saturate(120%);
  /* l√≠nia visual a la dreta perqu√® es noti el ‚Äútall‚Äù */
  box-shadow: inset -10px 0 8px -8px rgba(0, 0, 0, 0.45);
}

/* (opcional) separador entre equips que no es mogui verticalment amb la hover-row */
.live-stats-table tr.team-separator > td {
  height: 6px;
  background: transparent;
  border: 0;
}
/* Badge MVP */
.mvp-badge {
    display: inline-block;
    background: linear-gradient(135deg, #fbbf24, #f59e0b);
    color: #000;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 900;
    margin-left: 6px;
    text-transform: uppercase;
    box-shadow: 0 2px 8px rgba(251, 191, 36, 0.4);
}

/* Separador entre equips */
.team-separator {
    height: 20px;
    background: rgba(34, 211, 238, 0.1);
}

/* T√≠tol d'equip */
.team-header {
    background: rgba(34, 211, 238, 0.15);
    font-weight: 900;
    color: #22d3ee;
    text-transform: uppercase;
    letter-spacing: 1px;
    padding: 12px !important;
    text-align: left !important;
}

.team-header.rival {
    background: rgba(239, 68, 68, 0.15);
    color: #fca5a5;
}

/* Stats porters */
.goalkeeper-stats {
    font-size: 11px;
    color: #a78bfa;
    margin-top: 4px;
}

/* Tooltip */
.stat-tooltip {
    position: relative;
    cursor: help;
}

.stat-tooltip:hover::after {
    content: attr(data-tooltip);
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.9);
    color: white;
    padding: 6px 10px;
    border-radius: 6px;
    font-size: 11px;
    white-space: nowrap;
    z-index: 1000;
    pointer-events: none;
}

/* Temps jugat */
.playing-time {
    font-size: 11px;
    color: #94a3b8;
}
.action-item.change { border-left:3px solid rgba(148,163,184,.35); }
.action-item.change-in  { border-left-color:#22c55e; }
.action-item.change-out { border-left-color:#f59e0b; }
.change-badge{display:inline-block;padding:2px 8px;border-radius:9999px;font-size:.75rem;border:1px solid transparent}
.change-badge.in{background:#dcfce7;color:#166534;border-color:#86efac}
.change-badge.out{background:#fff7ed;color:#9a3412;border-color:#fed7aa}
/* Responsive */
@media (max-width: 768px) {
    .live-stats-table {
        font-size: 11px;
    }
    
    .live-stats-table th,
    .live-stats-table td {
        padding: 8px 4px;
    }
    
    .live-stats-table th:nth-child(2),
    .live-stats-table td:nth-child(2) {
        min-width: 100px;
    }
}

/* Empty state */
.stats-empty {
    text-align: center;
    padding: 60px 20px;
    color: #94a3b8;
}

.stats-empty-icon {
    font-size: 64px;
    margin-bottom: 20px;
    opacity: 0.3;
}

.stats-empty-text {
    font-size: 16px;
    font-weight: 600;
}
/* ============================================
   üíß INDICADOR JUGADORS A L'AIGUA
   ============================================ */
.player-in-water {
    position: relative;
}

.player-in-water::before {
    content: 'üíß';
    position: absolute;
    left: -20px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 16px;
    animation: water-pulse 2s infinite;
}

@keyframes water-pulse {
    0%, 100% { 
        opacity: 1; 
        transform: translateY(-50%) scale(1);
    }
    50% { 
        opacity: 0.6; 
        transform: translateY(-50%) scale(1.2);
    }
}

.in-water-badge {
    display: inline-block;
    background: linear-gradient(135deg, #06b6d4, #0891b2);
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 900;
    margin-left: 6px;
    text-transform: uppercase;
    animation: badge-glow 2s infinite;
}

@keyframes badge-glow {
    0%, 100% { 
        box-shadow: 0 0 8px rgba(6, 182, 212, 0.4);
    }
    50% { 
        box-shadow: 0 0 16px rgba(6, 182, 212, 0.8);
    }
}

/* Destaca la fila sencera */
.live-stats-table tbody tr.player-in-water-row {
    background: linear-gradient(90deg, rgba(6, 182, 212, 0.15) 0%, transparent 100%);
    border-left: 4px solid #06b6d4;
}

.live-stats-table tbody tr.player-in-water-row:hover {
    background: linear-gradient(90deg, rgba(6, 182, 212, 0.25) 0%, transparent 100%);
}
/* ============================================
   üì± TOTES LES COLUMNES - ULTRA OPTIMITZAT
   ============================================ */

@media (max-width: 768px) {
    /* Container amb scroll suau */
    .stats-table-container {
        overflow-x: auto;
        overflow-y: visible;
        -webkit-overflow-scrolling: touch;
        width: 100%;
        position: relative;
        padding-bottom: 50px;
    }
    
    /* Indicadors de scroll (esquerra i dreta) */
    .stats-table-container::before {
        content: '‚Üí';
        position: fixed;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(34, 211, 238, 0.95);
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        font-weight: 900;
        pointer-events: none;
        z-index: 200;
        animation: pulse-arrow 1.5s infinite;
        box-shadow: 0 4px 12px rgba(34, 211, 238, 0.4);
    }
    
    @keyframes pulse-arrow {
        0%, 100% { 
            transform: translateY(-50%) scale(1);
            opacity: 1;
        }
        50% { 
            transform: translateY(-50%) scale(1.1);
            opacity: 0.8;
        }
    }
    
    /* Amagar fletxa quan ha fet scroll */
    .stats-table-container.scrolled::before {
        display: none;
    }
    
    /* Taula ultra compacta */
    .live-stats-table {
        min-width: 650px;
        font-size: 8px;
        width: auto;
        border-collapse: separate;
        border-spacing: 0;
    }
    
    /* Totes les cel¬∑les ultra petites */
    .live-stats-table th,
    .live-stats-table td {
        padding: 4px 2px;
        white-space: nowrap;
        font-size: 8px;
    }
    
    /* ============================================
       COLUMNES FIXES (# i Cognom)
       ============================================ */
    
    /* Columna # */
    .live-stats-table th:first-child,
    .live-stats-table td:first-child {
        position: sticky;
        left: 0;
        z-index: 20;
        background: #0f172a;
        box-shadow: 2px 0 5px rgba(0, 0, 0, 0.4);
        min-width: 24px;
        max-width: 24px;
        padding: 4px 1px;
    }
    
    /* Columna Jugador (nom√©s cognom) */
    .live-stats-table th:nth-child(2),
    .live-stats-table td:nth-child(2) {
        position: sticky;
        left: 24px;
        z-index: 20;
        background: #0f172a;
        box-shadow: 2px 0 5px rgba(0, 0, 0, 0.4);
        min-width: 50px;
        max-width: 50px;
        padding: 4px 3px;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    /* Columnes de stats */
    .live-stats-table th:nth-child(n+3),
    .live-stats-table td:nth-child(n+3) {
        min-width: 24px;
        max-width: 24px;
        padding: 4px 2px;
    }
    
    /* Columna MVP una mica m√©s gran */
    .live-stats-table th:nth-child(14),
    .live-stats-table td:nth-child(14) {
        min-width: 28px;
        max-width: 28px;
    }
    
    /* ============================================
       AJUSTOS VISUALS
       ============================================ */
    
    /* Headers amb emojis */
    .live-stats-table th {
        font-size: 12px;
        line-height: 1;
        padding: 6px 2px;
        font-weight: 700;
    }
    
    /* N√∫mero jugador */
    .live-stats-table td.player-number {
        font-size: 10px;
        font-weight: 900;
        color: #22d3ee;
    }
    
    /* Nom jugador (nom√©s cognom) */
    .live-stats-table td.player-name {
        font-size: 8px;
        font-weight: 700;
        line-height: 1.1;
    }
    
    /* Badges MOLT petits */
    .mvp-badge {
        display: block;
        padding: 1px 2px;
        font-size: 5px;
        margin-top: 1px;
        width: fit-content;
        line-height: 1;
    }
    
    .in-water-badge {
        display: block;
        padding: 1px 2px;
        font-size: 5px;
        margin-top: 1px;
        width: fit-content;
        line-height: 1;
    }
    
    /* Stats */
    .live-stats-table tbody td {
        font-size: 9px;
        font-weight: 600;
    }
    
    /* MVP destacat */
    .live-stats-table td.mvp-score {
        font-size: 10px;
        font-weight: 900;
        color: #fbbf24;
    }
    
    /* Colors */
    .stat-positive {
        color: #22c55e;
        font-weight: 700;
    }
    
    .stat-negative {
        color: #ef4444;
        font-weight: 700;
    }
    
    /* Headers equip */
    .team-header {
        font-size: 9px;
        padding: 5px 3px !important;
        font-weight: 900;
    }
    
    .team-header td {
        position: sticky;
        left: 0;
        z-index: 15;
        background: rgba(34, 211, 238, 0.15);
    }
    
    .team-header.rival td {
        background: rgba(239, 68, 68, 0.15);
    }
    
    /* Porters - detalls molt petits */
    .goalkeeper-stats {
        font-size: 6px;
        margin-top: 1px;
    }
    
    /* Temps jugat */
    .playing-time {
        font-size: 7px;
    }
    
    /* Scrollbar visible */
    .stats-table-container::-webkit-scrollbar {
        height: 8px;
    }
    
    .stats-table-container::-webkit-scrollbar-track {
        background: rgba(34, 211, 238, 0.1);
        border-radius: 4px;
    }
    
    .stats-table-container::-webkit-scrollbar-thumb {
        background: linear-gradient(90deg, #06b6d4, #22d3ee);
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(34, 211, 238, 0.4);
    }
    
    /* Sub-tabs */
    .live-sub-tab {
        padding: 8px 10px;
        font-size: 11px;
    }
    
    /* T√≠tol */
    .live-scorers-title {
        font-size: 13px;
        margin-bottom: 10px;
    }
    
    /* Card */
    .live-scorers-card {
        padding: 12px;
    }
}

/* Tablets */
@media (min-width: 769px) and (max-width: 1024px) {
    .live-stats-table {
        font-size: 11px;
    }
    
    .live-stats-table th,
    .live-stats-table td {
        padding: 8px 6px;
    }
}
    </style>
 <script async src="https://www.googletagmanager.com/gtag/js?id=G-H8JDTNNK0Z"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-H8JDTNNK0Z');
</script>
<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>

<script>
  window.OneSignalDeferred = window.OneSignalDeferred || [];
  OneSignalDeferred.push(async function(OneSignal) {
    await OneSignal.init({
      appId: "96af4d1a-fcab-412e-aadb-ed44fadd1b4b",
      safari_web_id: "web.onesignal.auto.468a09a1-a4c0-43e5-8472-22975b523798",
      webPush: {
        notificationIcon: "https://joseprico.github.io/cnt-stats-192.png"
      },
      notifyButton: {
        enable: true,
        size: 'medium',
        theme: 'default',
        position: 'bottom-right',
        text: {
          'tip.state.unsubscribed': 'Activar notificacions',
          'tip.state.subscribed': 'Notificacions activades',
          'tip.state.blocked': 'Notificacions bloquejades',
          'message.prenotify': 'Fes clic per activar notificacions',
          'message.action.subscribed': "T'has subscrit a les notificacions! üéâ",
          'message.action.resubscribed': "Subscripci√≥ reactivada!",
          'message.action.unsubscribed': "Has desactivat les notificacions.",
          'dialog.main.title': 'Gestiona les notificacions',
          'dialog.main.button.subscribe': 'Activar',
          'dialog.main.button.unsubscribe': 'Desactivar',
          'dialog.blocked.title': 'Notificacions bloquejades',
          'dialog.blocked.message': 'Habilita les notificacions des de la configuraci√≥ del navegador.'
        }
      }
    });
  });
</script>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="text/javascript">
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "ucp9eaucjs");
</script>
</head>
<body>
<!-- ============================================
     üî• BANNER DE TEMPS REAL - AFEGIR ARA!
     ============================================ -->
<div id="liveBanner" class="live-banner">
    <div class="live-banner-content">
        <div class="live-dot"></div>
        <div class="live-text">‚ö° EN DIRECTE ‚ö°</div>
        <div class="live-dot"></div>
    </div>
    <div class="live-match-info" id="liveMatchInfo">
        Carregant partit en directe...
    </div>
</div>
<!-- Banner per l'altre equip en directe -->
<div id="otherTeamLiveBanner" class="other-team-banner" style="display: none;">
    <div class="other-team-content">
        <span id="otherTeamText">üü¶ JUVENIL EN DIRECTE</span>
        <button onclick="switchToLiveTeam()" class="switch-team-btn">
            üëÅÔ∏è Veure partit
        </button>
    </div>
</div>
<!-- Indicador petit (sempre visible quan hi ha temps real) -->
<div id="liveIndicatorSmall" class="live-indicator-small">
    <div class="dot"></div>
    <span>EN DIRECTE</span>
</div>
<!-- HTML del bot√≥ -->
<button id="installButton" class="install-button" style="display: none;">
    üì± Instal¬∑lar App
</button>

<!-- Missatge d'app ja instal¬∑lada -->
<div id="alreadyInstalled" class="already-installed" style="display: none;">
    <div class="installed-card">
        ‚úÖ App ja instal¬∑lada
    </div>
</div>

<!-- Instruccions per iOS (amagat per defecte) -->
<div id="iosInstructions" class="ios-instructions" style="display: none;">
    <div class="ios-card">
        <button class="close-btn" onclick="document.getElementById('iosInstructions').style.display='none'">‚úï</button>
        <p style="margin: 0 0 10px 0; font-size: 16px;">
            <strong>üì± Per instal¬∑lar en iPhone:</strong>
        </p>
        <ol style="text-align: left; margin: 0; padding-left: 20px; font-size: 14px;">
            <li>Clica la icona de <strong>Compartir</strong> ‚ÜóÔ∏è</li>
            <li>Selecciona <strong>"Afegir a pantalla d'inici"</strong></li>
            <li>Clica <strong>"Afegir"</strong></li>
        </ol>
    </div>
</div>
<div id="teamSelectionModal" style="
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.95);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
">
    <div style="
        background: linear-gradient(135deg, #1e3a8a 0%, #0891b2 100%);
        border-radius: 16px;
        padding: 40px;
        max-width: 500px;
        width: 90%;
        text-align: center;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    ">
        <h1 style="
            font-size: 32px;
            font-weight: bold;
            color: white;
            margin-bottom: 10px;
        ">üèä CN Terrassa</h1>
        <p style="
            font-size: 16px;
            color: #bae6fd;
            margin-bottom: 30px;
        ">Selecciona l'equip que vols veure:</p>
        
        <div style="
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        ">
         <button onclick="selectTeam('cadet')" style="
    padding: 30px 20px;
    background: linear-gradient(135deg, #64748b, #475569);
    border: 3px solid #fb923c;
    border-radius: 12px;
    color: white;
    font-size: 20px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 4px 20px rgba(251, 146, 60, 0.3);
" onmouseover="this.style.background='linear-gradient(135deg, #475569, #334155)'; this.style.transform='translateY(-3px) scale(1.05)'; this.style.boxShadow='0 8px 30px rgba(251, 146, 60, 0.5)'" 
   onmouseout="this.style.background='linear-gradient(135deg, #64748b, #475569)'; this.style.transform='none'; this.style.boxShadow='0 4px 20px rgba(251, 146, 60, 0.3)'">
    <div style="font-size: 48px; margin-bottom: 10px;">üèä‚Äç‚ôÇÔ∏è</div>
    CADET
    <div style="font-size: 12px; color: #fed7aa; margin-top: 8px; font-weight: 600;">Temporada 25-26</div>
</button>
            
            <button onclick="selectTeam('juvenil')" style="
    padding: 30px 20px;
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    border: 3px solid #60a5fa;
    border-radius: 12px;
    color: white;
    font-size: 20px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 4px 20px rgba(59, 130, 246, 0.5);
" onmouseover="this.style.background='linear-gradient(135deg, #2563eb, #1d4ed8)'; this.style.transform='translateY(-3px) scale(1.05)'; this.style.boxShadow='0 8px 30px rgba(59, 130, 246, 0.7)'" 
   onmouseout="this.style.background='linear-gradient(135deg, #3b82f6, #2563eb)'; this.style.transform='none'; this.style.boxShadow='0 4px 20px rgba(59, 130, 246, 0.5)'">
    <div style="font-size: 48px; margin-bottom: 10px;">üèä‚Äç‚ôÇÔ∏è</div>
    JUVENIL
    <div style="font-size: 12px; color: #dbeafe; margin-top: 8px; font-weight: 600;">Temporada 25-26</div>
</button>
        </div>
        
        <p style="font-size: 11px; color: #94a3b8; margin-top: 20px;">
            Pots canviar d'equip m√©s tard des del men√∫
        </p>
    </div>
</div>
    <div class="container">
    <div class="header" style="position: relative;">
    <div style="position: absolute; top: 0; right: 0; font-size: 12px; color: rgba(255,255,255,0.6); font-style: italic;">
        by Josep Rico<br><a href="mailto:josep.rico@gmail.com" style="color: rgba(255,255,255,0.6); font-size: 10px;">info: josep.rico@gmail.com</a>
    </div>
    <div style="display: flex; align-items: center; justify-content: center; gap: 15px; flex-wrap: wrap; margin-bottom: 10px;">
        <img src="https://clubnatacioterrassa.cat/wp-content/uploads/CNT_Escut_Blau.png.webp" 
             alt="CN Terrassa" 
             style="width: 60px; height: 60px; object-fit: contain;">
        <div style="text-align: center;">
            <h1 id="mainTitle" style="margin: 0;">üìä Estad√≠stiques CN Terrassa</h1>
            <p id="mainSubtitle" style="margin: 5px 0 0 0;">Selecciona un equip...</p>
        </div>
    </div>
    <p id="coachName" style="font-size: 16px; color: #fde047; margin-top: 8px; font-weight: 600;"></p>
    <button onclick="changeTeam()" class="btn" style="background: #8b5cf6; padding: 8px 16px; font-size: 14px; margin-top: 10px;">
        üîÑ Canviar Equip
    </button>
</div>
	
        <!-- TABS SEMPRE VISIBLES -->
<div class="tabs">
  <!-- üî¥ Bot√≥ EN DIRECTE (ara sempre visible) -->
  <button id="liveTab" class="tab live" onclick="showTab('live')">
    ‚è∏Ô∏è Cap partit en temps real
  </button>
  <button class="tab active" onclick="showTab('list')">üè† Inici</button>
  <button class="tab" onclick="showTab('temporadaTab')">üìÖ Temporada</button>
  <button class="tab" onclick="showTab('comparison')">üìä Estad√≠stiques</button>
  <button class="tab" onclick="showTab('titular')">üë• Titularitat</button>
  <button class="tab" onclick="showTab('tiempo')">‚è±Ô∏è Temps de Joc</button>
  <button class="tab" onclick="showTab('individual')">üë§ Individual</button>
    <button class="tab" onclick="showTab('rivalsTab')">üìä An√†lisi dels Rivals</button>
  <button class="tab" onclick="showTab('actawpTab')">üåê FCN ACTAWP</button> 
</div>
        </div>

        <!-- TAB: LISTA DE PARTIDOS -->
        <div id="listTab">
            <div id="loadingMatches" class="loading">
                Cargando partidos...
            </div>

            <div id="matchesView" class="hidden">
			          <!-- üìÖ √öLTIMA ACTUALITZACI√ì ACTAWP -->
    <div style="margin-bottom: 15px; padding: 12px 16px; background: rgba(34, 211, 238, 0.08); border-radius: 8px; border-left: 3px solid #22d3ee; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
        <div style="display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 18px;">üì°</span>
            <div>
                <div style="color: #bae6fd; font-size: 11px; font-weight: 600; opacity: 0.8;">DADES FCN ACTAWP</div>
                <div style="color: #93c5fd; font-size: 13px; margin-top: 2px;">
                    √öltima actualitzaci√≥: <span id="lastUpdateTimeHome" style="font-weight: bold; color: #22d3ee;">Carregant...</span>
                </div>
            </div>
        </div>
        <span id="recentUpdateBadgeHome" style="display: none; background: #10b981; color: white; padding: 5px 12px; border-radius: 12px; font-size: 11px; font-weight: bold;">
            üü¢ Actualitzat
        </span>
    </div>
 <!-- ‚≠ê PASTILLES: Pr√≤xim Partit + An√†lisi Rival -->
<div id="pastilles-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
    
    <!-- Pastilla 1: Pr√≤xim Partit -->
    <div class="card" style="background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); color: white; padding: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin: 0; font-size: 14px; opacity: 0.9; font-weight: 600;">‚ö° PR√íXIM PARTIT</h3>
            <button class="btn" onclick="showTab('actawpTab')" style="background: rgba(255,255,255,0.2); padding: 4px 10px; font-size: 11px; color: white;">
                Veure tot ‚Üí
            </button>
        </div>
		
        <div id="next-match-pill" style="text-align: center;">
            <div style="color: #bfdbfe; font-size: 12px;">Carregant...</div>
        </div>
    </div>
    
    <!-- Pastilla 2: An√†lisi del Rival -->
    <div id="rivals-map-pill" class="card" style="background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); color: white; padding: 0; overflow: hidden;">
        <div style="padding: 15px 15px 0 15px;">
            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px; font-weight: 600;">üìä AN√ÄLISI DEL RIVAL</div>
        </div>
	
        <div id="rivals-map" style="width: 100%;"></div>
    </div>
    
</div>

<!-- üèÜ CLASSIFICACI√ì (fila completa) -->
<div class="card" style="padding: 15px; margin-bottom: 20px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <h3 style="margin: 0; font-size: 14px; font-weight: 600;">üèÜ Classificaci√≥</h3>
        <button class="btn" onclick="showTab('actawpTab')" style="background: #3b82f6; padding: 4px 10px; font-size: 11px;">
            Veure tot ‚Üí
        </button>
    </div>
    <div id="ranking-pill" style="font-size: 12px;">
        <div style="color: #64748b; text-align: center; padding: 10px;">Carregant...</div>
    </div>
</div>

<div style="margin-bottom: 20px;">
        <button class="btn" onclick="window.print()" style="background: #8b5cf6; padding: 12px 20px;">
            üñ®Ô∏è Imprimir / Exportar PDF
        </button>
    </div>
                <div class="card">
                    <h2 class="section-title">Estad√≠stiques de partits ja jugats</h2>
                    <div class="matches-list" id="availableMatches"></div>
                </div>
            </div>
	</div>

<!-- üìÖ PESTANYA TEMPORADA -->
<div id="temporadaTab" class="hidden">
    <div class="card" style="margin-bottom: 20px;">
        <h2 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
            üìÖ Temporada 25/26
            <span id="temporada-stats-badge" style="font-size: 12px; background: #3b82f6; padding: 4px 12px; border-radius: 20px; font-weight: normal;"></span>
        </h2>
        
        <!-- Filtres -->
        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <button onclick="filterTemporada('tots')" id="filter-tots" class="btn" style="background: #3b82f6; padding: 8px 16px; font-size: 12px;">üìã Tots</button>
            <button onclick="filterTemporada('jugats')" id="filter-jugats" class="btn" style="background: #334155; padding: 8px 16px; font-size: 12px;">‚úÖ Jugats</button>
            <button onclick="filterTemporada('proxims')" id="filter-proxims" class="btn" style="background: #334155; padding: 8px 16px; font-size: 12px;">üìÖ Pr√≤xims</button>
        </div>
    </div>
    <!-- Timeline + Calendari Visual -->
    <div class="card" style="margin-bottom: 20px; padding: 15px;">
        <h3 style="margin-bottom: 15px; font-size: 16px;">üìÖ Calendari de la Temporada</h3>
        
        <!-- Timeline horitzontal -->
        <div id="timeline-container" style="margin-bottom: 20px; overflow-x: auto; padding: 10px 0;">
            <div id="timeline-matches" style="display: flex; align-items: center; gap: 5px; min-width: max-content; padding: 10px;"></div>
        </div>
        
        <!-- Navegaci√≥ del mes -->
        <div style="display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 15px;">
            <button onclick="changeCalendarMonth(-1)" class="btn" style="padding: 8px 15px; background: #334155;">‚óÄ</button>
            <span id="calendar-month-title" style="font-size: 18px; font-weight: 700; color: #22d3ee; min-width: 150px; text-align: center;"></span>
            <button onclick="changeCalendarMonth(1)" class="btn" style="padding: 8px 15px; background: #334155;">‚ñ∂</button>
        </div>
        
        <!-- Calendari mensual -->
        <div id="calendar-grid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center;"></div>
        
        <!-- Llegenda -->
        <div style="display: flex; justify-content: center; gap: 15px; margin-top: 15px; font-size: 12px; color: #94a3b8;">
            <span>üü¢ Vict√≤ria</span>
            <span>üî¥ Derrota</span>
            <span>‚ö™ Pendent</span>
        </div>
    </div>
    <!-- Resum temporada -->
    <div id="temporada-resum" class="card" style="margin-bottom: 20px; padding: 15px;"></div>
    
    <!-- Llista de partits -->
    <div id="temporada-partits" class="card" style="padding: 15px;"></div>
</div>
<!-- TAB: TIEMPO DE JUEGO -->
<div id="tiempoTab" class="hidden">
 <!--
 <div style="margin-bottom: 20px;">
        <button class="btn" onclick="generateTimePDF()" style="background: #8b5cf6; padding: 12px 20px;">
            üìÑ Generar PDF Temps de Joc
        </button>
    </div>
	-->
	
    <!-- Filtro por jugador -->
    <div class="card">
        <div class="filter-bar">
            <div class="filter-item">
                <label class="filter-label">Filtrar por jugador</label>
                <select class="filter-input" id="filterPlayerTime" onchange="filterByPlayerTime()">
                    <option value="">Todos los jugadores</option>
                </select>
            </div>
            <button class="btn" onclick="clearPlayerTimeFilter()" style="margin-top: 20px;">Limpiar filtro</button>
        </div>
    </div>


<div class="card">
    <div class="filter-bar">
                        <div class="filter-item">
                            <label class="filter-label">Buscar rival</label>
                            <input type="text" class="filter-input" id="filterRival" placeholder="Nombre del rival..." onkeyup="filterMatches()">
                        </div>
                        <div class="filter-item">
                            <label class="filter-label">Resultado</label>
                            <select class="filter-input" id="filterResult" onchange="filterMatches()">
                                <option value="">Todos</option>
                                <option value="win">Victorias</option>
                                <option value="loss">Derrotas</option>
                                <option value="draw">Empates</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label class="filter-label">Ordenar por</label>
                            <select class="filter-input" id="sortBy" onchange="filterMatches()">
                                <option value="date-desc">Fecha (m√°s reciente)</option>
                                <option value="date-asc">Fecha (m√°s antiguo)</option>
                                <option value="score-desc">M√°s goles</option>
                            </select>
                        </div>
                    </div>
                </div>
    <!-- Estad√≠sticas individuales del jugador seleccionado -->
    <div id="playerTimeStatsCard" class="card hidden">
        <h2 class="section-title">‚è±Ô∏è Estad√≠sticas de Tiempo - <span id="selectedPlayerTimeName"></span></h2>
        <div class="info-grid" id="playerTimeSummaryGrid"></div>
        
        <h3 class="section-title" style="margin-top: 20px;">üìà Evoluci√≥n del Tiempo por Partido</h3>
        <canvas id="playerTimeEvolutionChart" style="max-height: 300px;"></canvas>
        
        <h3 class="section-title" style="margin-top: 20px;">üî• Tiempo por Cuarto (Todos los Partidos)</h3>
        <canvas id="playerTimeByQuarterChart" style="max-height: 250px;"></canvas>
        
        <h3 class="section-title" style="margin-top: 20px;">‚ö° Eficiencia por Minuto</h3>
        <div class="stats-breakdown" id="playerEfficiencyBreakdown"></div>
        
        <h3 class="section-title" style="margin-top: 20px;">üìä Rendimiento: Titular vs Suplente</h3>
        <div class="info-grid" id="playerTitularVsSuplenteGrid"></div>
    </div>

    <!-- Separador -->
    <div style="margin: 40px 0 30px 0; text-align: center;">
        <div style="height: 3px; background: linear-gradient(to right, transparent, #22d3ee, transparent); margin-bottom: 15px;"></div>
        <h2 style="font-size: 28px; font-weight: bold; color: #22d3ee; text-transform: uppercase; letter-spacing: 2px;">
            üìä Estad√≠sticas del Equipo
        </h2>
        <div style="height: 3px; background: linear-gradient(to right, transparent, #22d3ee, transparent); margin-top: 15px;"></div>
    </div>
<!-- PISCINA: 7 Jugadors m√©s utilitzats -->
    <div class="card">
        <h2 class="section-title">üèä‚Äç‚ôÇÔ∏è Els 7 Jugadors M√©s Utilitzats</h2>
        <p style="font-size: 12px; color: #bae6fd; margin-bottom: 15px;">
            Alineaci√≥ basada en el temps total jugat en tots els partits
        </p>
        <div id="globalTimePoolContainer"></div>
    </div>
	  <!-- 1. Heatmap de Tiempo por Cuarto -->
    <div class="card">
        <h2 class="section-title">üî• Heatmap: Tiempo por Cuarto</h2>
        <div style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
            <table class="comparison-table" id="timeHeatmapTable"></table>
        </div>
    </div>
    <!-- 2. Tiempo Total por Jugador -->
    <div class="card">
        <h2 class="section-title">üìä Tiempo Total Jugado por Jugador</h2>
        <p id="timeChartSubtitle" style="font-size: 12px; color: #bae6fd; margin-bottom: 15px;">
            Cargando...
        </p>
        <canvas id="totalTimeChart" style="max-height: 400px;"></canvas>
    </div>

  

  
    <!-- 4. Distribuci√≥n de Minutos (Pastel) -->
    <div class="card">
        <h2 class="section-title">ü•ß Distribuci√≥n de Minutos del Equipo</h2>
        <canvas id="minutesDistributionChart" style="max-height: 350px;"></canvas>
    </div>

    <!-- 5. Plus/Minus por Jugador -->
    <div class="card">
        <h2 class="section-title">üìà Plus/Minus cuando est√° en el Agua</h2>
        <p style="font-size: 12px; color: #bae6fd; margin-bottom: 15px;">
            Diferencia de goles (a favor - en contra) cuando el jugador est√° jugando
        </p>
        <canvas id="plusMinusChart" style="max-height: 400px;"></canvas>
    </div>

    <!-- 6. Balance de Carga -->
    <div class="card">
        <h2 class="section-title">‚öñÔ∏è Balance de Carga del Equipo</h2>
        <div class="info-grid" id="loadBalanceGrid"></div>
        <canvas id="loadBalanceChart" style="max-height: 250px; margin-top: 20px;"></canvas>
    </div>

    <!-- 7. An√°lisis por Cuarto -->
    <div class="card">
        <h2 class="section-title">üìä An√°lisis de Rotaci√≥n por Cuarto</h2>
        <div style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
            <table class="comparison-table" id="quarterAnalysisTable"></table>
        </div>
    </div>

    <!-- 8. Rendimiento vs Tiempo (Dispersi√≥n) -->
    <div class="card">
        <h2 class="section-title">üéØ Rendimiento del Equipo vs Tiempo Jugado</h2>
        <p style="font-size: 12px; color: #bae6fd; margin-bottom: 15px;">
            ¬øEl equipo rinde mejor cuando ciertos jugadores juegan m√°s?
        </p>
        <canvas id="performanceVsTimeChart" style="max-height: 400px;"></canvas>
    </div>

   <!-- 9. An√°lisis de Fatiga -->
    <!-- <div class="card">
        <h2 class="section-title">üòì An√°lisis de Fatiga</h2>
        <p style="font-size: 12px; color: #bae6fd; margin-bottom: 15px;">
            Comparaci√≥n de rendimiento: Primer cuarto vs √öltimo cuarto
        </p>
        <div style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
            <table class="comparison-table" id="fatigueAnalysisTable"></table>
        </div>
    </div> -->

    <!-- 10. Promedio de Rotaci√≥n -->
    <div class="card">
        <h2 class="section-title">üîÑ Estad√≠sticas de Rotaci√≥n</h2>
        <div class="info-grid" id="rotationStatsGrid"></div>
    </div>
</div>
<!-- TAB: INDIVIDUAL -->
<div style="margin-bottom: 20px;">
        <button class="btn" onclick="window.print()" style="background: #8b5cf6; padding: 12px 20px;">
            üñ®Ô∏è Imprimir / Exportar PDF
        </button>
    </div>
<div id="individualTab" class="hidden">
    <!-- Selector de jugador -->
    <div class="card">
        <h2 class="section-title">üë§ Selecciona un Jugador</h2>
        <select class="filter-input" id="playerSelector" onchange="showPlayerStats()" style="font-size: 16px; padding: 12px;">
            <option value="">-- Selecciona un jugador --</option>
        </select>
    </div>

    <!-- Contingut de les estad√≠stiques (es mostra quan se selecciona un jugador) -->
    <div id="playerStatsContent" class="hidden">
        
        <!-- 1. Resum Global -->
        <div class="card">
            <h2 class="section-title">üìä Resum Global</h2>
            <div class="player-header" id="playerHeader"></div>
            <div class="stats-grid" id="playerSummaryGrid"></div>
        </div>

        <!-- 2. Gr√†fic d'Evoluci√≥ Temporal -->
        <div class="card">
            <h2 class="section-title">üìà Evoluci√≥ al Llarg de la Temporada</h2>
            <canvas id="playerEvolutionChart"></canvas>
        </div>

        <!-- 3. Mapa de Zones de Gol -->
        <div class="card">
            <h2 class="section-title">üéØ Mapa de Calor - Zones de Gol</h2>
            <div id="playerGoalZonesHeatmap"></div>
        </div>
	<!-- 3b. Mapa de Zones de la Piscina (des d'on tira) -->
<div class="card">
    <h2 class="section-title">üèä Mapa de Calor - Zones de Tir</h2>
    <p style="font-size: 12px; color: #bae6fd; margin-bottom: 15px;">Des d'on marca els gols a la piscina</p>
    <div id="playerFieldZonesHeatmap"></div>
</div>
        <!-- 4. Comparativa amb la Mitjana de l'Equip -->
        <div class="card">
            <h2 class="section-title">‚öñÔ∏è Comparativa: Jugador vs Mitjana Equip</h2>
            <canvas id="playerVsTeamChart"></canvas>
        </div>

        <!-- 5. Comparativa Multi-Jugador -->
        <div class="card">
            <h2 class="section-title">üë• Comparar amb Altres Jugadors</h2>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px; font-weight: bold;">Selecciona jugadors per comparar (fins a 4):</label>
                <div id="comparePlayersCheckboxes" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;"></div>
            </div>
            <button class="btn" onclick="compareSelectedPlayers()" style="background: #8b5cf6; margin-bottom: 20px;">
                üîÑ Comparar Jugadors
            </button>
            <div id="multiPlayerComparisonContent" class="hidden">
                <canvas id="multiPlayerComparisonChart"></canvas>
            </div>
        </div>

        <!-- 6. Estad√≠stiques per Tipus de Partit -->
        <div class="card">
            <h2 class="section-title">üè† Rendiment: Casa vs Fora</h2>
            <canvas id="homeAwayChart"></canvas>
        </div>

        <!-- 7. Efici√®ncia per Quarter -->
        <div class="card">
            <h2 class="section-title">‚è±Ô∏è Rendiment per Quarter</h2>
            <canvas id="quarterPerformanceChart"></canvas>
        </div>

        <!-- 8. Hist√≤ric Detallat de Partits -->
        <div class="card">
            <h2 class="section-title">üìã Hist√≤ric de Tots els Partits</h2>
            <div style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
    <table class="comparison-table" id="playerMatchHistoryTable" style="min-width: 800px;"></table>
</div>
        </div>

    </div>
	<!-- Secci√≥ especial per PORTERS -->
<div id="goalkeeperStatsContent" class="hidden">
    
    <!-- 1. Resum Espec√≠fic de Porter -->
    <div class="card">
        <h2 class="section-title">üß§ Estad√≠stiques de Porter</h2>
        <div class="stats-grid" id="goalkeeperSummaryGrid"></div>
    </div>

    !-- 2. Gr√†fic de % Parades -->
<div class="card">
    <h2 class="section-title">üìä Percentatge de Parades</h2>
    <div style="max-width: 400px; max-height: 400px; margin: 0 auto;">
        <canvas id="goalkeeperSavePercentageChart"></canvas>
    </div>
</div>

    <!-- 3. Parades per Tipus -->
    <div class="card">
        <h2 class="section-title">ü§æ Parades per Tipus</h2>
        <canvas id="goalkeeperSaveTypeChart"></canvas>
    </div>

    <!-- 4. Mapa de Calor - Zones de Parades -->
    <div class="card">
        <h2 class="section-title">üéØ Mapa de Zones - On Para M√©s</h2>
        <div id="goalkeeperZonesHeatmap"></div>
        <p style="font-size: 12px; color: #bae6fd; margin-top: 15px; text-align: center;">
            * Zones des de la perspectiva del porter (esquerra del porter = dreta de l'atacant)
        </p>
    </div>

    <!-- 5. Parades per Rival -->
    <div class="card">
        <h2 class="section-title">üèÜ Rendiment per Rival</h2>
        <div style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
            <table class="comparison-table" id="goalkeeperByRivalTable"></table>
        </div>
    </div>

    <!-- 6. Evoluci√≥ Temporal del % Parades -->
    <div class="card">
        <h2 class="section-title">üìà Evoluci√≥ del Percentatge de Parades</h2>
        <canvas id="goalkeeperEvolutionChart"></canvas>
    </div>

    <!-- 7. Comparativa amb altres Porters -->
    <div class="card">
        <h2 class="section-title">‚öñÔ∏è Comparativa amb Altres Porters</h2>
        <canvas id="goalkeeperComparisonChart"></canvas>
    </div>

    <!-- 8. Penalties -->
    <div class="card">
        <h2 class="section-title">üéØ Estad√≠stiques de Penalties</h2>
        <div class="stats-grid" id="goalkeeperPenaltiesGrid"></div>
    </div>

</div>
	
</div>
<!-- üìä PESTANYA ESTUDI RIVALS -->
<div id="rivalsTab" class="hidden">
    <div class="card" style="margin-bottom: 20px;">
        <h2 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
            üìä Estudi de Rivals
            <span style="font-size: 12px; background: #3b82f6; padding: 4px 12px; border-radius: 20px; font-weight: normal;">
                Temporada 25/26
            </span>
        </h2>
        <p style="color: #64748b; font-size: 14px;">An√†lisi complet dels rivals de la lliga</p>
    </div>

    <!-- Secci√≥ 1: Visi√≥ General -->
    <div class="card" style="margin-bottom: 20px;">
        <h3 style="margin-bottom: 15px; font-size: 16px;">üèÜ Visi√≥ General de la Lliga</h3>
        <div id="rivals-overview" style="overflow-x: auto;">
            <div style="text-align: center; color: #64748b; padding: 20px;">Carregant dades...</div>
        </div>
    </div>

 
    <!-- Secci√≥ 3: Comparativa -->
    <div class="card" style="margin-bottom: 20px;">
        <h3 style="margin-bottom: 15px; font-size: 16px;">üìà Comparativa d'Equips</h3>
        <div id="teams-comparison">
            <div style="text-align: center; color: #64748b; padding: 20px;">Carregant dades...</div>
        </div>
    </div>

    <!-- Secci√≥ 4: An√†lisi Detallat per Rival -->
    <div class="card" style="margin-bottom: 20px;">
        <h3 style="margin-bottom: 15px; font-size: 16px;">üîç An√†lisi Detallat per Rival - Click per detall</h3>
        <div id="rivals-detailed">
            <div style="text-align: center; color: #64748b; padding: 20px;">Carregant dades...</div>
        </div>
    </div>
	
	   <!-- Secci√≥ 5: Top Golejadors -->
    <div class="card" style="margin-bottom: 20px;">
        <h3 style="margin-bottom: 15px; font-size: 16px;">‚≠ê Top Golejadors de la Lliga (Dades de la federaci√≥) Nota: Poden no coincidir amb les dades de l'aplicaci√≥</h3>
        <div id="league-top-scorers">
            <div style="text-align: center; color: #64748b; padding: 20px;">Carregant dades...</div>
        </div>
    </div>
	
</div>
<!-- TAB: WEB FEDERACI√ì -->
<div id="federacionTab" class="hidden">
    <div class="card">
        <h2 class="section-title">üìÖ Calendari i Resultats de la Federaci√≥</h2>
        <p style="color: #bae6fd; margin-bottom: 30px;">
            Clica als botons per veure el calendari i resultats oficials de cada equip a la web de la Federaci√≥ Catalana de Nataci√≥.
        </p>
        
        <!-- Cadet -->
        <div style="margin-bottom: 30px; padding: 20px; background: rgba(34, 211, 238, 0.1); border-radius: 12px; border: 2px solid rgba(34, 211, 238, 0.3);">
            <h3 style="color: #22d3ee; font-size: 22px; margin-bottom: 15px;">
                üèä Cadet - Didac Cobacho
            </h3>
            <p style="color: #bae6fd; margin-bottom: 15px; font-size: 14px;">
                Consulta el calendari, resultats, classificaci√≥ i estad√≠stiques de l'equip Cadet.
            </p>
            <a href="https://actawp.natacio.cat/ca/team/15621224" target="_blank" rel="noopener noreferrer">
                <button class="btn" style="background: #06b6d4; padding: 15px 30px; font-size: 16px; width: 100%; max-width: 400px;">
                    üåê Obrir Web Cadet
                </button>
            </a>
        </div>

        <!-- Juvenil -->
        <div style="padding: 20px; background: rgba(34, 211, 238, 0.1); border-radius: 12px; border: 2px solid rgba(34, 211, 238, 0.3);">
            <h3 style="color: #22d3ee; font-size: 22px; margin-bottom: 15px;">
                üèä Juvenil - Jordi Busquets
            </h3>
            <p style="color: #bae6fd; margin-bottom: 15px; font-size: 14px;">
                Consulta el calendari, resultats, classificaci√≥ i estad√≠stiques de l'equip Juvenil.
            </p>
            <a href="https://actawp.natacio.cat/es/team/15621223" target="_blank" rel="noopener noreferrer">
                <button class="btn" style="background: #06b6d4; padding: 15px 30px; font-size: 16px; width: 100%; max-width: 400px;">
                    üåê Obrir Web Juvenil
                </button>
            </a>
        </div>
    </div>
</div>
  
<!-- 2. AFEGIR AQUEST DIV DESPR√âS DE LES ALTRES TABS -->
<div id="actawpTab" class="hidden">
    <div class="card">
        <h2 class="section-title">üìä Dades Oficials ACTAWP</h2>
        <p style="color: #bae6fd; margin-bottom: 10px;">
    Estad√≠stiques i calendari oficial de la Federaci√≥ Catalana de Nataci√≥
</p>
<p style="color: #93c5fd; font-size: 14px; margin-bottom: 20px; font-style: italic;">
    üîÑ Dades extretes directament de la Federaci√≥ Catalana de Nataci√≥ ‚Ä¢ Actualitzades autom√†ticament
</p>
       <div style="display: flex; align-items: center; gap: 15px; margin-top: 10px; flex-wrap: wrap;">
    <p style="color: #93c5fd; font-size: 13px; margin: 0;">
        üìÖ √öltima actualitzaci√≥: <span id="lastUpdateTime" style="font-weight: bold; color: #22d3ee;">Carregant...</span>
    </p>
    <span id="recentUpdateBadge" style="display: none; background: #ef4444; color: white; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: bold; animation: pulse 2s infinite;">
        üî¥ Actualitzat recentment
    </span>
</div> 
        <div id="actawpLoading" style="text-align: center; padding: 40px;">
            <div style="font-size: 48px;">‚è≥</div>
            <p>Carregant dades d'ACTAWP...</p>
        </div>
        
        <div id="actawpContent" style="display: none;">
            
            
            <!-- PR√íXIMS PARTITS -->
            <div class="card" style="background: rgba(0,0,0,0.3); margin-top: 20px;">
			   <h3 class="section-title">üìÖ Pr√≤xims Partits</h3>
                <div id="actawp-upcoming-matches">
                    <p style="color: #bae6fd;">No hi ha pr√≤xims partits programats</p>
                </div>
            </div>
            
            <!-- √öLTIMS RESULTATS -->
            <div class="card" style="background: rgba(0,0,0,0.3); margin-top: 20px;">
                <h3 class="section-title">üèÜ √öltims Resultats</h3>
                <div id="actawp-last-results">
                    <p style="color: #bae6fd;">No hi ha resultats recents</p>
                </div>
            </div>
           <!-- AFEGIR DESPR√âS DELS "√öLTIMS RESULTATS" -->

<!-- CLASSIFICACI√ì FASE 2 -->
<div class="card" style="background: rgba(0,0,0,0.3); margin-top: 20px;">
    <h3 class="section-title">üèÜ Classificaci√≥ Fase 3</h3>
    <p style="color: #bae6fd; margin-bottom: 15px; font-size: 14px;">
        Classificaci√≥ oficial de la tercera fase de la lliga
    </p>
    <div id="actawp-ranking-container">
        <p style="text-align: center; color: #bae6fd;">Carregant classificaci√≥...</p>
    </div>
</div>
<!-- ESTAD√çSTIQUES DE L'EQUIP -->
            <div class="card" style="background: rgba(0,0,0,0.3);">
                <h3 class="section-title">üìà Estad√≠stiques de la Federaci√≥</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-label">Punts</div>
                        <div class="stat-value" id="actawp-points">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Partits Jugats</div>
                        <div class="stat-value" id="actawp-matches-played">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Victories</div>
                        <div class="stat-value" style="color: #4ade80;" id="actawp-wins">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Empats</div>
                        <div class="stat-value" style="color: #fbbf24;" id="actawp-draws">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Derrotes</div>
                        <div class="stat-value" style="color: #ef4444;" id="actawp-losses">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Gols a Favor</div>
                        <div class="stat-value" style="color: #22d3ee;" id="actawp-goals-for">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Gols en Contra</div>
                        <div class="stat-value" style="color: #fb923c;" id="actawp-goals-against">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Difer√®ncia</div>
                        <div class="stat-value" id="actawp-goal-diff">-</div>
                    </div>
                </div>
            </div>
            <!-- COMPARATIVA AMB LES NOSTRES DADES -->
            <div class="card" style="background: rgba(0,0,0,0.3); margin-top: 20px;">
                <h3 class="section-title">üîç Comparativa de Jugadors</h3>
                <p style="color: #bae6fd; margin-bottom: 15px; font-size: 14px;">
                    Comparaci√≥ entre les estad√≠stiques locals i les oficials d'ACTAWP
                </p>
                <div id="actawp-comparison-table"></div>
            </div>
        </div>
    </div>
<div class="card" style="background: rgba(0,0,0,0.3); margin-top: 30px;">
    <h3 class="section-title">üåê Enlla√ßos Directes ACTAWP</h3>
    
    <!-- Cadet -->
    <div style="margin-bottom: 30px; padding: 20px; background: rgba(34, 211, 238, 0.1); border-radius: 12px; border: 2px solid rgba(34, 211, 238, 0.3);">
        <h3 style="color: #22d3ee; font-size: 22px; margin-bottom: 15px;">
            üèä Cadet - Didac Cobacho
        </h3>
        <p style="color: #bae6fd; margin-bottom: 15px; font-size: 14px;">
            Consulta el calendari, resultats, classificaci√≥ i estad√≠stiques de l'equip Cadet.
        </p>
        <a href="https://actawp.natacio.cat/ca/team/15621224" target="_blank" rel="noopener noreferrer">
            <button class="btn" style="background: #06b6d4; padding: 15px 30px; font-size: 16px; width: 100%; max-width: 400px;">
                üåê Obrir Web Cadet
            </button>
        </a>
    </div>
    
    <!-- Juvenil -->
    <div style="padding: 20px; background: rgba(34, 211, 238, 0.1); border-radius: 12px; border: 2px solid rgba(34, 211, 238, 0.3);">
        <h3 style="color: #22d3ee; font-size: 22px; margin-bottom: 15px;">
            üèä Juvenil - Jordi Busquets
        </h3>
        <p style="color: #bae6fd; margin-bottom: 15px; font-size: 14px;">
            Consulta el calendari, resultats, classificaci√≥ i estad√≠stiques de l'equip Juvenil.
        </p>
        <a href="https://actawp.natacio.cat/es/team/15621223" target="_blank" rel="noopener noreferrer">
            <button class="btn" style="background: #06b6d4; padding: 15px 30px; font-size: 16px; width: 100%; max-width: 400px;">
                üåê Obrir Web Juvenil
            </button>
        </a>
    </div>
</div>
</div>     
<!-- ============================================
     üî¥ VISTA EN DIRECTE - AFEGIR ARA!
     ============================================ -->
<div id="liveView" class="hidden">
    <div class="card">
        <!-- üî¥ SUB-TABS -->
        <div class="live-sub-tabs">
    <button class="live-sub-tab active" onclick="showLiveSubTab('marcador')">
        üìä Marcador
    </button>
    <button class="live-sub-tab" onclick="showLiveSubTab('accions')">
        ‚ö° Accions
    </button>
    <button class="live-sub-tab" onclick="showLiveSubTab('stats')">
        üìà Stats
    </button>
</div>
        
        <!-- ============================================
             üìä SUB-VISTA: MARCADOR (la que ja tens)
             ============================================ -->
        <div id="liveMarcadorView" class="live-sub-view active">
            <!-- Marcador principal -->
            <div class="live-scoreboard">
    <div class="live-title" id="liveTitleText">
        <div class="live-pulse-dot" id="livePulseDot1"></div>
        PARTIT EN DIRECTE
        <div class="live-pulse-dot" id="livePulseDot2"></div>
    </div>
                
                <div class="live-main-score">
                    <div class="live-team">
                        <div class="live-team-name" id="liveCNTName">CN TERRASSA</div>
                        <div class="live-team-score" id="liveScoreCNT">0</div>
                    </div>
                    
                    <div class="live-score-separator">-</div>
                    
                    <div class="live-team">
                        <div class="live-team-name" id="liveRivalName">RIVAL</div>
                        <div class="live-team-score" id="liveScoreRival">0</div>
                    </div>
                </div>
                
                <!-- Marcadors per quarter -->
                <div class="live-quarters">
                    <div class="live-quarter">
                        <div class="live-quarter-label">Q1</div>
                        <div class="live-quarter-score" id="liveQ1">0-0</div>
                    </div>
                    <div class="live-quarter">
                        <div class="live-quarter-label">Q2</div>
                        <div class="live-quarter-score" id="liveQ2">0-0</div>
                    </div>
                    <div class="live-quarter">
                        <div class="live-quarter-label">Q3</div>
                        <div class="live-quarter-score" id="liveQ3">0-0</div>
                    </div>
                    <div class="live-quarter">
                        <div class="live-quarter-label">Q4</div>
                        <div class="live-quarter-score" id="liveQ4">0-0</div>
                    </div>
                </div>
                
                <div class="live-timestamp" id="liveTimestamp">
                    Carregant...
                </div>
            </div>
            
            <!-- Golejadors CN Terrassa -->
            <div class="live-scorers-card">
                <div class="live-scorers-title">
                    ‚öΩ Golejadors CN Terrassa
                </div>
                <div class="live-scorers-list" id="liveScorersCNT">
                    <div class="live-empty-state" style="padding: 20px;">
                        Encara no hi ha gols
                    </div>
                </div>
                
                <!-- Exclusions CNT -->
                <div id="liveExclusionsCNT" style="display: none; margin-top: 15px;">
                    <div class="live-exclusion-title">üü• Exclusions</div>
                    <div class="live-exclusion-list" id="liveExclusionsCNTList"></div>
                </div>
            </div>
            
            <!-- Golejadors Rival -->
            <div class="live-scorers-card">
                <div class="live-scorers-title">
                    ‚öΩ Golejadors Rival
                </div>
                <div class="live-scorers-list" id="liveScorersRival">
                    <div class="live-empty-state" style="padding: 20px;">
                        Encara no hi ha gols
                    </div>
                </div>
                
                <!-- Exclusions Rival -->
                <div id="liveExclusionsRival" style="display: none; margin-top: 15px;">
                    <div class="live-exclusion-title">üü• Exclusions</div>
                    <div class="live-exclusion-list" id="liveExclusionsRivalList"></div>
                </div>
            </div>
        </div>
        
        <!-- ============================================
             ‚ö° SUB-VISTA: ACCIONS (NOVA!)
             ============================================ -->
        <div id="liveAccionsView" class="live-sub-view">
            <div class="live-scorers-card">
                <div class="live-scorers-title">
                    ‚ö° Timeline d'accions
                </div>
                
                <div id="actionsTimeline" class="actions-timeline">
                    <!-- Les accions es carregaran aqu√≠ din√†micament -->
                    <div class="actions-empty">
                        <div class="actions-empty-icon">‚öΩ</div>
                        <div class="actions-empty-text">Esperant accions del partit...</div>
                    </div>
                </div>
            </div>
        </div>
		<!-- ============================================
     üìà SUB-VISTA: STATS (NOVA!)
     ============================================ -->
<div id="liveStatsView" class="live-sub-view">
    <div class="live-scorers-card">
        <div class="live-scorers-title">
            üìà Estad√≠stiques Completes - ‚≠ê MVP - üíß Jugant ara
        </div>
        
        <div id="statsTableContainer" class="stats-table-container">
            <!-- La taula es carregar√† aqu√≠ din√†micament -->
            <div class="stats-empty">
                <div class="stats-empty-icon">üìä</div>
                <div class="stats-empty-text">Carregant estad√≠stiques...</div>
            </div>
        </div>
    </div>
</div>
    </div>
</div>

		   <!-- Vista de partido individual -->
            <div id="singleMatchView" class="hidden">
                <div class="card">
                    <button class="btn" onclick="backToList()" style="margin-bottom: 20px;">‚Üê Volver a la lista</button>
  <!--  <button class="btn" onclick="generateMatchPDF(currentMatch)" style="background: #8b5cf6; padding: 12px 20px; margin-bottom: 15px;">
            üìÑ Generar PDF d'aquest Partit
        </button>-->
		
		<div id="listTab" class="hidden">
    <div id="matchesView" class="hidden">
        <!-- contingut -->
    </div>
</div>
    <div class="card">
        <div class="match-header">
            <div class="team-section">
                <h2>CN Terrassa</h2>
                <div class="score" id="scoreCNT">0</div>
            </div>
            <div class="vs">VS</div>
            <div class="team-section">
                <h2 id="teamRival">RIVAL</h2>
                <div class="score" id="scoreRival">0</div>
            </div>
        </div>
    </div>

    <div class="card">
        <h2 class="section-title">‚ÑπÔ∏è Informaci√≥n del Partido</h2>
        <div id="matchInfo"></div>
    </div>

    <div class="card">
        <h2 class="section-title">‚öΩ Desglose de Goles CN Terrassa</h2>
        <div class="stats-breakdown" id="goalsScoredBreakdown"></div>
    </div>

    <div class="card">
        <h2 class="section-title">ü•Ö Desglose de Goles Recibidos</h2>
        <div class="stats-breakdown" id="goalsReceivedBreakdown"></div>
    </div>

    <div class="card">
        <h2 class="section-title">üü• Desglose de Exclusiones</h2>
        <div class="stats-breakdown" id="exclusionsBreakdown"></div>
    </div>
	
                    
 <div style="margin: 0 -20px 20px -20px;">
    <h2 class="section-title" style="padding: 0 20px; margin-bottom: 10px;">üìä Estad√≠sticas Completas del Partido</h2>
    <div style="overflow-x: auto; -webkit-overflow-scrolling: touch; padding: 0 20px;">
        <table class="comparison-table" id="singleMatchStatsTable"></table>
    </div>
    <div style="margin: 20px 20px 0 20px; padding: 15px; background: rgba(34, 211, 238, 0.1); border-radius: 8px; border-left: 4px solid #22d3ee;">
        <h3 style="color: #22d3ee; margin-bottom: 10px; font-size: 14px;">‚≠ê Criteris de Valoraci√≥ MVP</h3>
        <div style="font-size: 12px; color: #bae6fd; line-height: 1.8;">
            <strong style="color: #22c55e;">Accions Positives:</strong><br>
            ‚Ä¢ Gol normal/contraatac/H+/boya: +2 | Gol penalty: +1<br>
            ‚Ä¢ Assist√®ncia: +1 | Robatori: +1 | Blocatge: +1 | Parada: +1 | Parada penal: +2 | Falta rebuda: +1<br><br>
            <strong style="color: #ef4444;">Accions Negatives:</strong><br>
            ‚Ä¢ Exclusi√≥ (normal o penalty): -1 | Penalty fallat: -2 | P√®rdua: -0.5 | Tir fallat: -0.5 | Infraccions 2m: -0.5 | Contrafalta: -0.75 | Gol rebut (porters): -0.5
        </div>
    </div>
</div>

                
                <div class="card">
                    <h2 class="section-title">üìà Evoluci√≥n del Marcador por Cuartos</h2>
                    <canvas id="scoreEvolutionChart" style="max-height: 300px;"></canvas>
                </div>
    <div class="card">
                    <h2 class="section-title">Alineaciones por Cuarto</h2>
                    <div id="lineupsContainer"></div>
                </div>
               
                <div class="card">
                    <h2 class="section-title">‚öñÔ∏è Balance Ofensivo vs Defensivo</h2>
                    <canvas id="offenseDefenseChart" style="max-height: 300px;"></canvas>
                </div>

                <div class="card">
                    <h2 class="section-title">üë• Eficiencia por Jugador (Goles vs Exclusiones)</h2>
                    <canvas id="playerEfficiencyChart" style="max-height: 350px;"></canvas>
                </div>

                 <div class="card">
                    <h2 class="section-title">Estad√≠stiques CN Terrassa</h2>
                    <div class="stats-grid" id="statsCNT"></div>
                </div>

                <div class="card">
                    <h2 class="section-title">Estad√≠stiques Rival</h2>
                    <div class="stats-grid" id="statsRival"></div>
                </div>
<div class="card">
    <h2 class="section-title">‚è±Ô∏è Temps de Joc per Jugador</h2>
    <div id="playingTimesContainer"></div>
</div>
<div class="card">
    <h2 class="section-title">üß§ Parades dels Porters</h2>
    <canvas id="goalkeeperSavesChart" style="max-height: 300px;"></canvas>
</div>
            

                <div class="card">
                    <h2 class="section-title">Observaciones</h2>
                    <div class="observations" id="observations">No hay observaciones</div>
                </div>
				<div class="card">
    <h2 class="section-title">üéØ Zones de Porteria CN Terrassa</h2>
    <div id="matchGoalZonesContainer"></div>
</div>  
<div class="card">
    <h2 class="section-title">üìç Zones del Camp CN Terrassa</h2>
    <div id="matchFieldZonesContainer"></div>
</div>
<div class="card" id="swimRacesCard" style="display: none;">
    <h2 class="section-title">üèä Curses Inicials</h2>
    <div id="matchSwimRacesContainer"></div>
</div>
<div class="card">
    <h2 class="section-title">üìã Cronolog√≠a del Partido</h2>
    <div id="matchTimeline"></div>
</div>
            </div>
        </div>

      <!-- TAB: COMPARACI√ìN -->
<div id="comparisonTab" class="hidden">
    <div id="comparisonView">
	<!--<div style="margin-bottom: 20px;">
            <button class="btn" onclick="generateGeneralPDF()" style="background: #8b5cf6; padding: 12px 20px;">
                üìÑ Generar PDF General
            </button>
        </div>-->
       <!-- <div style="margin-bottom: 20px;">
            <button class="btn" onclick="window.print()" style="background: #8b5cf6; padding: 12px 20px;">
                üñ®Ô∏è Imprimir / Exportar PDF
            </button>
        </div>-->
        
		 <div class="card">
            <h2 class="section-title">Resumen de Resultados</h2>
            <div class="info-grid" id="summaryGrid"></div>
        </div>
		<!-- NUEVO: Evoluci√≥n de Resultados -->
        <div class="card">
            <h2 class="section-title">üìà Evoluci√≥n de Resultados</h2>
            <canvas id="resultsEvolutionChart" style="max-height: 300px;"></canvas>
        </div>

        <!-- NUEVO: Diferencia de Goles por Cuarto -->
        <div class="card">
            <h2 class="section-title">‚ö° Diferencia de Goles por Cuarto</h2>
            <p style="font-size: 12px; color: #bae6fd; margin-bottom: 15px;">
                Promedio de diferencia (Goles a favor - Goles en contra) en cada cuarto
            </p>
            <canvas id="quarterDifferenceChart" style="max-height: 250px;"></canvas>
        </div>

        <!-- NUEVO: Mejores y Peores Partidos -->
        <div class="card">
            <h2 class="section-title">üèÜ Mejores y Peores Partidos</h2>
            <div class="info-grid" id="bestWorstGrid"></div>
        </div>

        <!-- NUEVO: Historial contra Rivales -->
        <div class="card">
            <h2 class="section-title">üéØ Historial contra Rivales</h2>
            <div style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
                <table class="comparison-table" id="rivalsHistoryTable"></table>
            </div>
        </div>
        <div class="card">
            <h2 class="section-title">Desglose de Goles (Total)</h2>
            <div class="stats-breakdown" id="totalGoalsBreakdown"></div>
        </div>

        <div class="card">
            <h2 class="section-title">Desglose de Goles Recibidos (Total)</h2>
            <div class="stats-breakdown" id="totalGoalsReceivedBreakdown"></div>
        </div>

        <div class="card">
            <h2 class="section-title">Desglose de Exclusiones (Total)</h2>
            <div class="stats-breakdown" id="totalExclusionsBreakdown"></div>
        </div>

        <div class="card">
            <h2 class="section-title">ü•ß Distribuci√≥n de Goles por Jugador</h2>
            <canvas id="goalsDistributionChart" style="max-height: 300px;"></canvas>
        </div>

        <div class="card">
    <h2 class="section-title">üìä Comparaci√≥n de Estad√≠sticas</h2>
	<h3 style="color: #22d3ee; margin-bottom: 10px; font-size: 14px;">Fes click a qualsevol variable per ordenar la taula per aquesta</h3>
    <div style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
        <table class="comparison-table" id="comparisonTable"></table>
    </div>
    <div style="margin-top: 20px; padding: 15px; background: rgba(34, 211, 238, 0.1); border-radius: 8px; border-left: 4px solid #22d3ee;">
    <h3 style="color: #22d3ee; margin-bottom: 10px; font-size: 14px;">‚≠ê Criteris de Valoraci√≥ MVP</h3>
    <div style="font-size: 12px; color: #bae6fd; line-height: 1.8;">
        <strong style="color: #22c55e;">Accions Positives:</strong><br>
        ‚Ä¢ Gol normal/contraatac/H+/boya: +2 | Gol penalty: +1<br>
        ‚Ä¢ Assist√®ncia: +1 | Robatori: +1 | Blocatge: +1 | Parada: +1 | Parada penal: +2 | Falta rebuda: +1<br><br>
        <strong style="color: #ef4444;">Accions Negatives:</strong><br>
        ‚Ä¢ Exclusi√≥ (normal o penalty): -1 | Penalty fallat: -2 | P√®rdua: -0.5 | Tir fallat: -0.5 |Infraccions 2m(-0.5)| Contrafalta: -0.75 | Gol rebut (porters): -0.5
    </div>
</div>
</div>

        <div class="card">
            <h2 class="section-title">Top Goleadores (Todos los Partidos)</h2>
            <div class="top-scorers" id="allTimeScorers"></div>
        </div>
		<div id="swimRacesStatsContainer"></div>
    </div>
    </div>
	
</div>

        <!-- TAB: TITULARIDAD -->
<!-- TAB: TITULARIDAD -->
<div id="titularTab" class="hidden">
<!--<div style="margin-bottom: 20px;">
        <button class="btn" onclick="generateTitularityPDF()" style="background: #8b5cf6; padding: 12px 20px;">
            üìÑ Generar PDF Titularitats
        </button>
    </div>-->
<!--	<div style="margin-bottom: 20px;">
        <button class="btn" onclick="window.print()" style="background: #8b5cf6; padding: 12px 20px;">
            üñ®Ô∏è Imprimir / Exportar PDF
        </button>
    </div>-->
	
    <div class="card">
        <h2 class="section-title">‚è∞ Equipo tipo titular</h2>
        <p style="font-size: 12px; color: #bae6fd; margin-bottom: 15px;">
            ¬øQue jugadores han sido m√°s veces titulares?
        </p>
        <div id="quarterPatternsGrid" class="stats-grid"></div>
    </div>
    <div class="card">
        <h2 class="section-title">üî• Heatmap de Titularidades</h2>
        <canvas id="titularityHeatmapChart" style="max-height: 400px;"></canvas>
    </div>
    
    <!-- Consistencia de Titularidad -->
    <div class="card">
        <h2 class="section-title">üìä Consistencia de Titularidad</h2>
        <p style="font-size: 12px; color: #bae6fd; margin-bottom: 15px;">
            Porcentaje de cuartos en los que cada jugador fue titular
        </p>
        <canvas id="consistencyChart" style="max-height: 350px;"></canvas>
    </div>
    
    <!-- Rendimiento seg√∫n Titularidad -->
    <div class="card">
        <h2 class="section-title">‚ö° Rendimiento: Titular vs Suplente</h2>
        <p style="font-size: 12px; color: #bae6fd; margin-bottom: 15px;">
            Media de goles y exclusiones cuando son titulares vs suplentes
        </p>
        <div style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
            <table class="comparison-table" id="performanceTable"></table>
        </div>
    </div>
    
    <div class="card">
        <div id="titularView"></div>
    </div>
    
   
</div>

    <script>
// ============================================
// üî• VARIABLES GLOBALS FIREBASE
// ============================================
let liveMatchActive = false;
let liveMatchData = null;
let firebaseListeners = [];
let autoRefreshInterval = null;

// ‚òÅÔ∏è API del temps
const WEATHER_API_KEY = '48d972eea2f04ac9a9674326250811'; 	
        let allMatches = [];
        let filteredMatches = [];
        let currentMatch = null;
		let matchesWithTime = []; 
        window.addEventListener('DOMContentLoaded', async () => {
        await loadAllMatches(localStorage.getItem('selectedTeam') || 'juvenil');
        });

  async function loadAllMatches(team = 'juvenil') {
    try {
        console.log('üéØ Iniciando carga de partidos para:', team);
        
        // ‚úÖ URL base segons l'equip
        const baseUrls = {
            cadet: 'https://joseprico.github.io/cnt_cadet_25-26/',
            juvenil: 'https://joseprico.github.io/CNT_juvenil_25_26/'
        };
        
        const baseUrl = baseUrls[team];
        console.log('üåê Base URL:', baseUrl);
        
        // ‚≠ê CARREGAR DES D'INDEX.JSON (sense token, sense rate limit)
        console.log('üì• Cargando lista de archivos desde index.json...');
        const indexResponse = await fetch(`${baseUrl}index.json?t=${Date.now()}`); // Cache buster
        
        if (!indexResponse.ok) {
            throw new Error(`Error cargando index.json: ${indexResponse.status}`);
        }
        
        const indexData = await indexResponse.json();
        const jsonFiles = indexData.files || [];
        
        console.log('‚úÖ Archivos encontrados en index.json:', jsonFiles.length);
        console.log('üìÑ Lista de archivos:', jsonFiles);
        console.log('üìÖ √öltima actualizaci√≥n:', indexData.last_updated);

        if (jsonFiles.length === 0) {
            throw new Error('No se encontraron archivos en index.json. Verifica que el GitHub Action se haya ejecutado correctamente.');
        }

        // Carregar cada fitxer JSON
        const promises = jsonFiles.map(async fileName => {
            console.log('üì• Cargando archivo:', fileName);
            const fileUrl = `${baseUrl}${fileName}`;
            
            try {
                const res = await fetch(fileUrl);
                
                if (!res.ok) {
                    console.warn(`‚ö†Ô∏è Error cargando ${fileName}: ${res.status}`);
                    return null;
                }
                
                const matchData = await res.json();
                normalizeAllPlayers(matchData);

                // Normalitzar estad√≠stiques
                (matchData.jugadors || []).forEach(p => {
                    p.estadistiques = p.estadistiques || {};
                    p.estadistiques.paradeTypes = {
                        corner: 0, rebuig: 0, atrapa: 0, penal: 0,
                        ...(p.estadistiques.paradeTypes || {})
                    };
                });
                
                if (!matchData.data || !matchData.rivalTeam) {
                    console.warn('‚ö†Ô∏è Archivo con estructura incorrecta:', fileName);
                }
                
                return matchData;
            } catch (error) {
                console.error(`‚ùå Error procesando ${fileName}:`, error);
                return null;
            }
        });

        const results = await Promise.all(promises);
        allMatches = results.filter(m => m !== null); // Filtrar nulls

        // Filtrar partits v√†lids
        allMatches = allMatches.filter(m => {
            if (!m || !m.data || m.scoreCNT === undefined || m.scoreRival === undefined) {
                console.warn('‚ö†Ô∏è Partido sin estructura b√°sica');
                return false;
            }
            
            if (!m.rivalTeam || m.rivalTeam.toLowerCase() === 'rival' || m.rivalTeam.trim() === '') {
                console.warn('‚ö†Ô∏è Partido sin nombre de rival v√°lido:', m.rivalTeam);
                return false;
            }
            
            if (!m.jugadors || m.jugadors.length === 0) {
                console.warn('‚ö†Ô∏è Partido sin jugadores');
                return false;
            }
            
            if (!m.periodScores) {
                console.warn('‚ö†Ô∏è Partido sin marcadores por periodo');
                return false;
            }
            
            return true;
        });

        console.log('‚úÖ Partidos v√°lidos cargados:', allMatches.length);
        
        // Ordenar per data (m√©s recent primer)
        allMatches.sort((a, b) => {
            const dateA = new Date(a.data).getTime();
            const dateB = new Date(b.data).getTime();
            return dateB - dateA;
        });
        
        filteredMatches = [...allMatches];

        document.getElementById('loadingMatches').classList.add('hidden');
        document.getElementById('matchesView').classList.remove('hidden');
        
        displayMatchesList();
        displayComparison();
        displayTitularStats();
        initializePlayerSelector();
        document.getElementById('mainSubtitle').innerHTML = `Temporada 25/26 ‚Ä¢ ${allMatches.length} partits`;
        
        // Carregar dades ACTAWP
        await loadActawpData(team);
        
        setTimeout(() => {
            showTab('list');
        }, 200);
        
		// üî• AFEGIR AIX√í AL FINAL DE LA FUNCI√ì!
        // Iniciar listener de Firebase per temps real
        if (window.firebaseReady) {
            listenForLiveMatch(team);
        }
    } catch (error) {
        console.error('‚ùå Error detallado:', error);
        document.getElementById('loadingMatches').innerHTML = `
            <div class="no-data">
                <p style="color: #ef4444; font-weight: bold;">‚ùå Error al cargar los partidos</p>
                <p style="font-size: 14px; margin-top: 10px; color: #fbbf24;">${error.message}</p>
                <p style="font-size: 12px; margin-top: 10px; color: #bae6fd;">
                    Posibles causas:<br>
                    ‚Ä¢ El archivo index.json no existe en el repositorio<br>
                    ‚Ä¢ El GitHub Action no se ha ejecutado todav√≠a<br>
                    ‚Ä¢ GitHub Pages tarda unos segundos en actualizar
                </p>
                <button class="btn" onclick="loadAllMatches('${team}')" style="margin-top: 15px;">
                    üîÑ Reintentar
                </button>
            </div>
        `;
    }
}
// üìä √öLTIMS 3 RESULTATS (mini per l'inici)
function loadUltimsResultatsMini() {
    console.log('üîÑ loadUltimsResultatsMini() - INICI');
    
    const container = document.getElementById('ultims-resultats-mini');
    console.log('üîÑ Container:', container);
    console.log('üîÑ actawpData:', actawpData);
    console.log('üîÑ last_results:', actawpData?.last_results);
    
    if (!container) {
        console.log('‚ùå Container no trobat!');
        return;
    }
    
    if (!actawpData || !actawpData.last_results) {
        container.innerHTML = '<div style="color: #64748b; text-align: center;">No hi ha dades</div>';
        return;
    }
    
    const results = actawpData.last_results.slice(0, 3);
    console.log('üîÑ Results:', results);
    
    if (results.length === 0) {
        container.innerHTML = '<div style="color: #64748b; text-align: center;">No hi ha resultats</div>';
        return;
    }
    
    container.innerHTML = `
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            ${results.map(r => {
                const t1 = r.team1 || '';
                const t2 = r.team2 || '';
                const score = r.score || '0-0';
                const parts = score.split('-');
                const g1 = parseInt(parts[0]) || 0;
                const g2 = parseInt(parts[1]) || 0;
                
                const cntIsTeam1 = t1.toUpperCase().includes('TERRASSA');
                const gCNT = cntIsTeam1 ? g1 : g2;
                const gRival = cntIsTeam1 ? g2 : g1;
                const rival = cntIsTeam1 ? t2 : t1;
                const isHome = cntIsTeam1;
                
                let bgColor = '#fbbf24';
                let icon = '‚ûñ';
                
                if (gCNT > gRival) {
                    bgColor = '#22c55e';
                    icon = '‚úÖ';
                } else if (gCNT < gRival) {
                    bgColor = '#ef4444';
                    icon = '‚ùå';
                }
                
                // Escur√ßar nom rival
                const shortRival = rival.replace(/C\.N\.|C\.E\.|U\.E\./g, '').trim().substring(0, 12);
                
                return `
                    <div style="flex: 1; min-width: 120px; background: ${bgColor}20; border-left: 3px solid ${bgColor}; border-radius: 8px; padding: 10px;">
                        <div style="display: flex; align-items: center; gap: 5px; margin-bottom: 5px;">
                            <span style="font-size: 14px;">${icon}</span>
                            <span style="font-size: 11px; color: #94a3b8;">J${r.jornada || '?'}</span>
                            <span style="font-size: 11px; color: #94a3b8;">${isHome ? 'üè†' : '‚úàÔ∏è'}</span>
                        </div>
                        <div style="font-size: 18px; font-weight: 700; color: ${bgColor};">${gCNT} - ${gRival}</div>
                        <div style="font-size: 11px; color: #94a3b8; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${shortRival}</div>
                    </div>
                `;
            }).join('')}
        </div>
    `;
    
    console.log('‚úÖ loadUltimsResultatsMini() - COMPLETAT');
}
// üìÖ PESTANYA TEMPORADA
let currentTemporadaFilter = 'tots';

function loadTemporadaTab() {
    loadTemporadaResum();
    loadTemporadaPartits();
	loadCalendarData();
}

function loadTemporadaResum() {
    const container = document.getElementById('temporada-resum');
    const badge = document.getElementById('temporada-stats-badge');
    if (!container || !actawpData) return;
    
    const jugats = actawpData.last_results?.length || 0;
    const proxims = actawpData.upcoming_matches?.length || 0;
    const total = jugats + proxims;
    
    // Calcular stats
    let wins = 0, draws = 0, losses = 0, gf = 0, gc = 0;
    
    if (actawpData.last_results) {
        actawpData.last_results.forEach(r => {
            const parts = (r.score || '0-0').split('-');
            const g1 = parseInt(parts[0]) || 0;
            const g2 = parseInt(parts[1]) || 0;
            const cntIsTeam1 = (r.team1 || '').toUpperCase().includes('TERRASSA');
            const gCNT = cntIsTeam1 ? g1 : g2;
            const gRival = cntIsTeam1 ? g2 : g1;
            
            gf += gCNT;
            gc += gRival;
            
            if (gCNT > gRival) wins++;
            else if (gCNT < gRival) losses++;
            else draws++;
        });
    }
    
    badge.textContent = `${jugats} jugats ¬∑ ${proxims} pendents`;
    
    container.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 15px; text-align: center;">
            <div style="background: #22c55e20; padding: 15px; border-radius: 12px;">
                <div style="font-size: 28px; font-weight: 700; color: #22c55e;">${wins}</div>
                <div style="font-size: 11px; color: #94a3b8;">Vict√≤ries</div>
            </div>
            <div style="background: #fbbf2420; padding: 15px; border-radius: 12px;">
                <div style="font-size: 28px; font-weight: 700; color: #fbbf24;">${draws}</div>
                <div style="font-size: 11px; color: #94a3b8;">Empats</div>
            </div>
            <div style="background: #ef444420; padding: 15px; border-radius: 12px;">
                <div style="font-size: 28px; font-weight: 700; color: #ef4444;">${losses}</div>
                <div style="font-size: 11px; color: #94a3b8;">Derrotes</div>
            </div>
            <div style="background: #3b82f620; padding: 15px; border-radius: 12px;">
                <div style="font-size: 28px; font-weight: 700; color: #3b82f6;">${gf}</div>
                <div style="font-size: 11px; color: #94a3b8;">Gols favor</div>
            </div>
            <div style="background: #8b5cf620; padding: 15px; border-radius: 12px;">
                <div style="font-size: 28px; font-weight: 700; color: #8b5cf6;">${gc}</div>
                <div style="font-size: 11px; color: #94a3b8;">Gols contra</div>
            </div>
            <div style="background: #06b6d420; padding: 15px; border-radius: 12px;">
                <div style="font-size: 28px; font-weight: 700; color: #06b6d4;">${gf - gc}</div>
                <div style="font-size: 11px; color: #94a3b8;">Difer√®ncia</div>
            </div>
        </div>
    `;
}
// ============================================
// üìÖ CALENDARI VISUAL DE TEMPORADA
// ============================================

let calendarCurrentMonth = new Date().getMonth();
let calendarCurrentYear = new Date().getFullYear();
let allSeasonMatches = [];

function loadCalendarData() {
    allSeasonMatches = [];
    
    // Afegir partits jugats
    if (allMatches && allMatches.length > 0) {
        allMatches.forEach((match, idx) => {
            const dateStr = match.data || '';
            let matchDate = null;
            if (dateStr) {
                if (dateStr.includes('T')) {
                    matchDate = new Date(dateStr);
                } else if (dateStr.includes('/')) {
                    const parts = dateStr.split('/');
                    if (parts.length === 3) {
                        matchDate = new Date(parts[2], parts[1] - 1, parts[0]);
                    }
                }
            }
            
            let result = 'pending';
            if (match.scoreCNT !== undefined && match.scoreRival !== undefined) {
                if (match.scoreCNT > match.scoreRival) result = 'win';
                else if (match.scoreCNT < match.scoreRival) result = 'loss';
                else result = 'draw';
            }
            
         allSeasonMatches.push({
    date: matchDate,
    dateStr: dateStr,
    rival: match.rivalTeam || 'Rival',
    scoreCNT: match.scoreCNT,
    scoreRival: match.scoreRival,
    isHome: match.matchLocation === 'home',
    result: result,
    jornada: match.jornada || (idx + 1),
    matchIdx: idx,
    type: 'played'
});
        });
    }
    
    // Afegir pr√≤xims partits
    if (actawpData && actawpData.upcoming_matches) {
        actawpData.upcoming_matches.forEach((match, idx) => {
            const dateStr = match.date || '';
            let matchDate = null;
            if (dateStr) {
                const parts = dateStr.split('/');
                if (parts.length === 3) {
                    matchDate = new Date(parts[2], parts[1] - 1, parts[0]);
                }
            }
            
            const t1 = match.team1 || '';
            const isHome = t1.toUpperCase().includes('TERRASSA');
            const rival = isHome ? (match.team2 || 'Rival') : (match.team1 || 'Rival');
            
            allSeasonMatches.push({
                date: matchDate,
                dateStr: dateStr,
                rival: rival,
                time: match.time || '',
                isHome: isHome,
                result: 'pending',
                jornada: match.jornada || (allMatches.length + idx + 1),
                type: 'upcoming'
            });
        });
    }
    
    // Ordenar per data
    allSeasonMatches.sort((a, b) => {
        if (!a.date) return 1;
        if (!b.date) return -1;
        return a.date - b.date;
    });
    
    renderTimeline();
    renderCalendar();
}

function renderTimeline() {
    const container = document.getElementById('timeline-matches');
    if (!container) return;
    
    const monthNames = ['GEN', 'FEB', 'MAR', 'ABR', 'MAI', 'JUN', 'JUL', 'AGO', 'SET', 'OCT', 'NOV', 'DES'];
    
    let nextMatchIdx = -1;
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    // Trobar pr√≤xim partit
    for (let i = 0; i < allSeasonMatches.length; i++) {
        if (allSeasonMatches[i].type === 'upcoming' && allSeasonMatches[i].date && allSeasonMatches[i].date >= today) {
            nextMatchIdx = i;
            break;
        }
    }
    
    let html = '';
    let currentMonth = -1;
    
    allSeasonMatches.forEach((match, idx) => {
        // Separador de mes
        if (match.date) {
            const matchMonth = match.date.getMonth();
            if (matchMonth !== currentMonth) {
                currentMonth = matchMonth;
                if (idx > 0) {
                    html += '<div style="width: 2px; height: 60px; background: #475569; margin: 0 5px;"></div>';
                }
                html += '<div style="display: flex; flex-direction: column; justify-content: center; align-items: center; min-width: 40px; padding: 5px; background: #1e3a5c; border-radius: 6px; margin-right: 5px;">';
                html += '<div style="font-size: 11px; font-weight: 700; color: #22d3ee;">' + monthNames[matchMonth] + '</div>';
                html += '</div>';
            }
        }
        
        let color, bgColor, icon;
        switch (match.result) {
            case 'win':
                color = '#22c55e';
                bgColor = 'rgba(34, 197, 94, 0.2)';
                icon = 'üü¢';
                break;
            case 'loss':
                color = '#ef4444';
                bgColor = 'rgba(239, 68, 68, 0.2)';
                icon = 'üî¥';
                break;
            case 'draw':
                color = '#fbbf24';
                bgColor = 'rgba(251, 191, 36, 0.2)';
                icon = 'üü°';
                break;
            default:
                color = '#94a3b8';
                bgColor = 'rgba(148, 163, 184, 0.2)';
                icon = '‚ö™';
        }
        
        const isNext = idx === nextMatchIdx;
        const borderStyle = isNext ? 'border: 3px solid #22d3ee; box-shadow: 0 0 10px rgba(34, 211, 238, 0.5);' : '';
        const rivalShort = match.rival.replace(/C\.N\.|C\.E\.|U\.E\./g, '').trim();
        const rivalDisplay = rivalShort.length > 10 ? rivalShort.substring(0, 9) + '.' : rivalShort;
        const homeAway = match.isHome ? 'üè†' : '‚úàÔ∏è';
        
        html += '<div onclick="showMatchDetails(' + idx + ')" style="cursor: pointer; text-align: center; min-width: 70px; padding: 8px 6px; background: ' + bgColor + '; border-radius: 8px; ' + borderStyle + '">';
        html += '<div style="font-size: 12px; margin-bottom: 2px;">' + homeAway + '</div>';
        html += '<div style="font-size: 20px; margin-bottom: 2px;">' + icon + '</div>';
        html += '<div style="font-size: 10px; color: white; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 65px;">' + rivalDisplay + '</div>';
        if (match.type === 'played') {
            html += '<div style="font-size: 11px; color: ' + color + '; font-weight: bold;">' + match.scoreCNT + '-' + match.scoreRival + '</div>';
        } else {
            html += '<div style="font-size: 9px; color: #64748b;">Pendent</div>';
        }
        html += '</div>';
    });
    
    container.innerHTML = html;
    
    // Scroll al pr√≤xim partit
    if (nextMatchIdx > 0) {
        setTimeout(() => {
            const containerEl = document.getElementById('timeline-container');
            if (containerEl) {
                containerEl.scrollLeft = Math.max(0, (nextMatchIdx * 80) - 150);
            }
        }, 100);
    }
}
function renderCalendar() {
    const grid = document.getElementById('calendar-grid');
    const title = document.getElementById('calendar-month-title');
    if (!grid || !title) return;
    
    const monthNames = ['Gener', 'Febrer', 'Mar√ß', 'Abril', 'Maig', 'Juny', 'Juliol', 'Agost', 'Setembre', 'Octubre', 'Novembre', 'Desembre'];
    const dayNames = ['Dl', 'Dt', 'Dc', 'Dj', 'Dv', 'Ds', 'Dg'];
    
    title.textContent = monthNames[calendarCurrentMonth] + ' ' + calendarCurrentYear;
    
    // Primer dia del mes
    const firstDay = new Date(calendarCurrentYear, calendarCurrentMonth, 1);
    let startDay = firstDay.getDay() - 1;
    if (startDay < 0) startDay = 6;
    
    // Dies del mes
    const daysInMonth = new Date(calendarCurrentYear, calendarCurrentMonth + 1, 0).getDate();
    
    // Partits d'aquest mes
    const monthMatches = {};
    allSeasonMatches.forEach((match, idx) => {
        if (match.date && match.date.getMonth() === calendarCurrentMonth && match.date.getFullYear() === calendarCurrentYear) {
            const day = match.date.getDate();
            monthMatches[day] = { ...match, idx: idx };
        }
    });
    
    let html = '';
    
    // Headers dels dies
    dayNames.forEach(day => {
        html += '<div style="padding: 8px; font-weight: 600; color: #64748b; font-size: 12px;">' + day + '</div>';
    });
    
    // Espais buits abans del primer dia
    for (let i = 0; i < startDay; i++) {
        html += '<div></div>';
    }
    
    // Dies del mes
    const today = new Date();
    for (let day = 1; day <= daysInMonth; day++) {
        const match = monthMatches[day];
        const isToday = day === today.getDate() && calendarCurrentMonth === today.getMonth() && calendarCurrentYear === today.getFullYear();
        
        let bgColor = 'transparent';
        let icon = '';
        let extraInfo = '';
        let cursor = 'default';
        let onclick = '';
        
        if (match) {
            cursor = 'pointer';
            onclick = 'onclick="showMatchDetails(' + match.idx + ')"';
            
            switch (match.result) {
                case 'win':
                    bgColor = 'rgba(34, 197, 94, 0.3)';
                    icon = 'üü¢';
                    break;
                case 'loss':
                    bgColor = 'rgba(239, 68, 68, 0.3)';
                    icon = 'üî¥';
                    break;
                case 'draw':
                    bgColor = 'rgba(251, 191, 36, 0.3)';
                    icon = 'üü°';
                    break;
                default:
                    bgColor = 'rgba(34, 211, 238, 0.3)';
                    icon = '‚ö™';
            }
            
            const rivalShort = match.rival.replace(/C\.N\.|C\.E\.|U\.E\./g, '').trim().substring(0, 8);
const homeAwayIcon = match.isHome ? 'üè†' : '‚úàÔ∏è';
extraInfo = '<div style="font-size: 8px; color: #94a3b8; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">' + homeAwayIcon + ' ' + rivalShort + '</div>';
            if (match.type === 'played') {
                extraInfo += '<div style="font-size: 9px; font-weight: bold; color: white;">' + match.scoreCNT + '-' + match.scoreRival + '</div>';
            } else if (match.time) {
                extraInfo += '<div style="font-size: 9px; color: #22d3ee;">' + match.time + '</div>';
            }
        }
        
        const todayBorder = isToday ? 'border: 2px solid #22d3ee;' : '';
        
        html += '<div ' + onclick + ' style="padding: 5px; min-height: 60px; background: ' + bgColor + '; border-radius: 8px; cursor: ' + cursor + '; ' + todayBorder + '">';
        html += '<div style="font-size: 12px; color: white;">' + day + ' ' + icon + '</div>';
        html += extraInfo;
        html += '</div>';
    }
    
    grid.innerHTML = html;
}

function changeCalendarMonth(delta) {
    calendarCurrentMonth += delta;
    if (calendarCurrentMonth > 11) {
        calendarCurrentMonth = 0;
        calendarCurrentYear++;
    } else if (calendarCurrentMonth < 0) {
        calendarCurrentMonth = 11;
        calendarCurrentYear--;
    }
    renderCalendar();
}

function showMatchDetails(idx) {
    const match = allSeasonMatches[idx];
    if (!match) return;
    
    // Si √©s un partit jugat, obrir el detall
    if (match.type === 'played') {
        viewMatchFromTemporada(match.matchIdx);
        return;
    }
    
    // Si √©s un partit pendent, mostrar info
    let message = 'üìÖ Pr√≤xim partit\n\n';
    message += (match.isHome ? 'üè† Casa' : '‚úàÔ∏è Fora') + ' vs ' + match.rival + '\n';
    message += 'üìÜ ' + match.dateStr + (match.time ? '\n‚è∞ ' + match.time : '');
    
    alert(message);
}
function loadTemporadaPartits() {
    const container = document.getElementById('temporada-partits');
    if (!container) return;
    
    let partits = [];
    
    // Afegir partits jugats des de allMatches (els nostres)
    if (allMatches && allMatches.length > 0) {
        allMatches.forEach((match, idx) => {
            partits.push({
                tipus: 'jugat',
                idx: idx,
                rival: match.rivalTeam || 'Rival',
                scoreCNT: match.scoreCNT,
                scoreRival: match.scoreRival,
                date: match.data,
                isHome: match.matchLocation === 'home' || !match.matchLocation,
                jornada: match.jornada || null
            });
        });
    }
    
    // Afegir pr√≤xims partits des de actawpData
    if (actawpData && actawpData.upcoming_matches) {
        actawpData.upcoming_matches.forEach(r => {
            const t1 = r.team1 || '';
            const t2 = r.team2 || '';
            const cntIsTeam1 = t1.toUpperCase().includes('TERRASSA');
            partits.push({
                tipus: 'proxim',
                rival: cntIsTeam1 ? t2 : t1,
                date: r.date || '',
                time: r.time || '',
                isHome: cntIsTeam1,
                jornada: r.jornada || null,
                logo1: r.team1_logo,
                logo2: r.team2_logo,
				url: r.url || ''
            });
        });
    }
    
    // Funci√≥ per parsejar dates
    const parseDate = (dateStr) => {
        if (!dateStr) return new Date(0);
        if (dateStr.includes('T')) {
            return new Date(dateStr);
        }
        if (dateStr.includes('/')) {
            const parts = dateStr.split('/');
            if (parts.length === 3) {
                return new Date(parts[2], parts[1] - 1, parts[0]);
            }
        }
        return new Date(dateStr);
    };
    
    // Funci√≥ per determinar la fase
    const getPhase = (dateStr) => {
        const date = parseDate(dateStr);
        const phase1End = new Date(2025, 10, 1);
        const phase2End = new Date(2025, 11, 31);
        
        if (date < phase1End) return 1;
        else if (date <= phase2End) return 2;
        else return 3;
    };
    
    // Ordenar per data
    partits.sort((a, b) => parseDate(a.date) - parseDate(b.date));
    
    // Filtrar
    if (currentTemporadaFilter === 'jugats') {
        partits = partits.filter(p => p.tipus === 'jugat');
    } else if (currentTemporadaFilter === 'proxims') {
        partits = partits.filter(p => p.tipus === 'proxim');
    }
    
    if (partits.length === 0) {
        container.innerHTML = '<div style="color: #64748b; text-align: center; padding: 20px;">No hi ha partits</div>';
        return;
    }
    
    // Generar HTML amb separadors de fases
    let html = '<div style="display: grid; gap: 15px;">';
    let currentPhase = 0;
    
    const phaseInfo = {
        1: { name: 'üèÜ Primera Fase', color: '#3b82f6', dates: 'Fins 1 Nov 2025' },
        2: { name: 'ü•à Segona Fase', color: '#f97316', dates: '1 Nov - 31 Des 2025' },
        3: { name: 'ü•á Tercera Fase', color: '#22c55e', dates: 'Des de 2026' }
    };
    
    partits.forEach(p => {
        const phase = getPhase(p.date);
        
        // Afegir separador si canviem de fase
        if (phase !== currentPhase) {
            currentPhase = phase;
            const info = phaseInfo[phase];
            html += `
                <div style="background: linear-gradient(135deg, ${info.color}40, ${info.color}20); border: 2px solid ${info.color}; border-radius: 12px; padding: 15px; margin: 10px 0; text-align: center;">
                    <div style="font-size: 18px; font-weight: 700; color: ${info.color};">${info.name}</div>
                    <div style="font-size: 12px; color: #94a3b8; margin-top: 5px;">${info.dates}</div>
                </div>
            `;
        }
        
        if (p.tipus === 'jugat') {
            const date = new Date(p.date);
            const dateStr = date.toLocaleDateString('ca-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
            
            // Determinar resultat
            let resultClass, resultIcon, bgColor, borderColor;
            if (p.scoreCNT > p.scoreRival) {
                resultClass = 'win';
                resultIcon = '‚úÖ';
                bgColor = 'rgba(74, 222, 128, 0.1)';
                borderColor = '#4ade80';
            } else if (p.scoreCNT < p.scoreRival) {
                resultClass = 'loss';
                resultIcon = '‚ùå';
                bgColor = 'rgba(239, 68, 68, 0.1)';
                borderColor = '#ef4444';
            } else {
                resultClass = 'draw';
                resultIcon = '‚ûñ';
                bgColor = 'rgba(148, 163, 184, 0.1)';
                borderColor = '#94a3b8';
            }
            
            html += `
                <div onclick="viewMatchFromTemporada(${p.idx})" style="cursor: pointer;">
                    <div style="background: ${bgColor}; border-left: 4px solid ${borderColor}; border-radius: 8px; padding: 12px; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.01)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.3)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <!-- Data -->
                            <div style="font-size: 11px; color: #94a3b8;">
                                ${dateStr}
                            </div>
                            
                            <!-- Equips -->
                            <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
                                <div style="flex: 1; min-width: 0;">
                                    ${p.isHome ? `
                                        <div style="font-size: 14px; font-weight: bold; color: #bae6fd; display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
                                            <span>CN Terrassa</span>
                                        </div>
                                        <div style="font-size: 13px; color: #94a3b8; display: flex; align-items: center; gap: 6px;">
                                            <span>vs ${p.rival.replace(/C\.N\.|C\.E\.|U\.E\./g, '').trim()}</span>
                                        </div>
                                    ` : `
                                        <div style="font-size: 14px; font-weight: bold; color: #bae6fd; display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
                                            <span>${p.rival.replace(/C\.N\.|C\.E\.|U\.E\./g, '').trim()}</span>
                                        </div>
                                        <div style="font-size: 13px; color: #94a3b8; display: flex; align-items: center; gap: 6px;">
                                            <span>vs CN Terrassa</span>
                                        </div>
                                    `}
                                    <div style="font-size: 11px; color: #64748b; margin-top: 4px;">
                                        ${p.isHome ? 'üè† Local' : '‚úàÔ∏è Visitant'}
                                    </div>
                                </div>
                                
                                <!-- Marcador -->
                                <div style="text-align: center; flex-shrink: 0;">
                                    <div style="font-size: 24px; font-weight: bold; color: #bae6fd;">
                                        ${p.isHome ? `${p.scoreCNT} - ${p.scoreRival}` : `${p.scoreRival} - ${p.scoreCNT}`}
                                    </div>
                                    <div style="font-size: 16px; margin-top: 2px;">
                                        ${resultIcon}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Bot√≥ veure -->
                            <div style="text-align: center;">
                                <span style="display: inline-block; padding: 8px 20px; background: rgba(34, 211, 238, 0.2); color: #22d3ee; border-radius: 6px; font-size: 12px;">
                                    üìä Veure detalls
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        } else {
            // Pr√≤xims partits - AMB BOTONS DETALLS I COM ARRIBAR
            const rivalName = p.rival.replace(/C\.N\.|C\.E\.|U\.E\./g, '').trim();
            const mapsUrl = `https://www.google.com/maps/dir/Terrassa,+Barcelona,+Spain/${encodeURIComponent(p.isHome ? 'CN Terrassa, Terrassa' : p.rival)}`;
            
            html += `
                <div style="background: rgba(34, 211, 238, 0.1); border-left: 4px solid #22d3ee; border-radius: 8px; padding: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <!-- Info partit -->
                        <div style="flex: 1; min-width: 200px;">
                            <div style="font-size: 12px; color: #94a3b8; margin-bottom: 5px;">
                                üìÖ ${p.date} ${p.time ? `‚Ä¢ ‚è∞ ${p.time}` : ''} ${p.jornada ? `‚Ä¢ J${p.jornada}` : ''}
                            </div>
                            
                            ${p.isHome ? `
                                <div style="font-size: 16px; font-weight: bold; color: #bae6fd; display: flex; align-items: center;">
                                    ${p.logo1 ? `<img src="${p.logo1}" style="width: 24px; height: 24px; object-fit: contain; background: white; border-radius: 4px; padding: 2px; margin-right: 8px;" onerror="this.style.display='none';">` : ''}
                                    <span>CN Terrassa</span>
                                </div>
                                <div style="font-size: 14px; color: #94a3b8; margin-top: 2px; display: flex; align-items: center;">
                                    <span style="margin-right: 8px;">vs</span>
                                    ${p.logo2 ? `<img src="${p.logo2}" style="width: 24px; height: 24px; object-fit: contain; background: white; border-radius: 4px; padding: 2px; margin-right: 8px;" onerror="this.style.display='none';">` : ''}
                                    <span>${rivalName}</span>
                                </div>
                            ` : `
                                <div style="font-size: 16px; font-weight: bold; color: #bae6fd; display: flex; align-items: center;">
                                    ${p.logo1 ? `<img src="${p.logo1}" style="width: 24px; height: 24px; object-fit: contain; background: white; border-radius: 4px; padding: 2px; margin-right: 8px;" onerror="this.style.display='none';">` : ''}
                                    <span>${rivalName}</span>
                                </div>
                                <div style="font-size: 14px; color: #94a3b8; margin-top: 2px; display: flex; align-items: center;">
                                    <span style="margin-right: 8px;">vs</span>
                                    ${p.logo2 ? `<img src="${p.logo2}" style="width: 24px; height: 24px; object-fit: contain; background: white; border-radius: 4px; padding: 2px; margin-right: 8px;" onerror="this.style.display='none';">` : ''}
                                    <span>CN Terrassa</span>
                                </div>
                            `}
                        </div>
                        
                        <!-- Icona Local/Visitant -->
                        <div style="text-align: center; min-width: 80px;">
                            <div style="font-size: 32px; color: #22d3ee;">
                                ${p.isHome ? 'üè†' : '‚úàÔ∏è'}
                            </div>
                            <div style="font-size: 12px; color: #94a3b8; margin-top: 5px;">
                                ${p.isHome ? 'Local' : 'Visitant'}
                            </div>
                        </div>
                        
                        <!-- Botons -->
                        <div style="min-width: 100px; text-align: right; display: flex; flex-direction: column; gap: 8px;">
                            ${p.url ? `
                                <a href="${p.url}" target="_blank" rel="noopener noreferrer" style="display: inline-block; padding: 8px 16px; background: rgba(34, 211, 238, 0.2); color: #22d3ee; border-radius: 6px; text-decoration: none; font-size: 13px; text-align: center;">
                                    ‚ÑπÔ∏è Detalls
                                </a>
                            ` : ''}
                            <a href="${mapsUrl}" target="_blank" rel="noopener noreferrer" style="display: inline-block; padding: 8px 16px; background: rgba(34, 211, 238, 0.2); color: #22d3ee; border-radius: 6px; text-decoration: none; font-size: 13px; text-align: center;">
                                üöó Com arribar
                            </a>
                        </div>
                    </div>
                </div>
            `;
        }
    });
    
    html += '</div>';
    container.innerHTML = html;
}

function viewMatchFromTemporada(idx) {
    console.log('üéØ viewMatchFromTemporada - idx:', idx);
    
    if (!allMatches || idx < 0 || idx >= allMatches.length) {
        console.error('‚ùå Index inv√†lid:', idx);
        return;
    }
    
    // Seleccionar el partit directament
    currentMatch = allMatches[idx];
    
    // IMPORTANT: Primer canviar a la pestanya "list" perqu√® singleMatchView sigui visible
    showTab('list');
    
    // Despr√©s mostrar vista del partit
    document.getElementById('matchesView')?.classList.add('hidden');
    document.getElementById('singleMatchView')?.classList.remove('hidden');
    
    // Mostrar dades
    displayMatchData();
    
    // Scroll a dalt
    window.scrollTo(0, 0);
}

function filterTemporada(filter) {
    currentTemporadaFilter = filter;
    
    // Actualitzar botons
    document.getElementById('filter-tots').style.background = filter === 'tots' ? '#3b82f6' : '#334155';
    document.getElementById('filter-jugats').style.background = filter === 'jugats' ? '#3b82f6' : '#334155';
    document.getElementById('filter-proxims').style.background = filter === 'proxims' ? '#3b82f6' : '#334155';
    
    loadTemporadaPartits();
	loadCalendarData();
}
// ============================================
// üî• ESCOLTAR FIREBASE PER PARTITS EN DIRECTE
// ============================================
function listenForLiveMatch(team = 'juvenil') {
  if (!window.firebaseReady) {
    console.warn('‚ö†Ô∏è Firebase no disponible');
    showNoLiveBanner();
    return;
  }

  try {
    showNoLiveBanner();

    const matchesRef = window.firebaseRef(window.firebaseDB, 'matches');
    const listener = window.firebaseOnValue(matchesRef, (snapshot) => {
      if (!snapshot.exists()) {
        console.log('üìä No hi ha dades a Firebase');
        showNoLiveBanner();
        hideOtherTeamBanner();
        return;
      }

      const all = snapshot.val();
      
      let currentTeamMatch = null;
      let otherTeamMatch = null;
      let currentTeamLatestTs = -1;
      let otherTeamLatestTs = -1;
      
      const otherTeam = team === 'cadet' ? 'juvenil' : 'cadet';

      for (const id of Object.keys(all)) {
        // Saltar les carpetes de migraci√≥
        if (id === 'cadet_25_26' || id === 'juvenil_25_26') continue;
        
        const m = all[id];
        if (!m || typeof m !== 'object' || !m.lastUpdate) continue;
        
        const lu = m.lastUpdate;
        
        // Partit de l'equip actual
        if (id.includes(`cnt_${team}_`)) {
          if (lu > currentTeamLatestTs) {
            currentTeamLatestTs = lu;
            currentTeamMatch = { ...m, id };
          }
        }
        
        // Partit de l'altre equip
        if (id.includes(`cnt_${otherTeam}_`)) {
          if (lu > otherTeamLatestTs) {
            otherTeamLatestTs = lu;
            otherTeamMatch = { ...m, id };
          }
        }
      }

      const now = Date.now();

      // Gestionar partit de l'equip actual
      if (currentTeamMatch) {
        const minutesSinceUpdate = currentTeamLatestTs > 0 ? (now - currentTeamLatestTs)/60000 : Infinity;
        const isWithin60 = minutesSinceUpdate < 60;

        console.log('üèä Partit trobat:', currentTeamMatch.id, '| Fa', Math.round(minutesSinceUpdate), 'minuts');

        if (isWithin60) {
          showLiveBanner(currentTeamMatch, minutesSinceUpdate);
          liveMatchActive = true;
          liveMatchData = currentTeamMatch;

          try { ensurePeriodEndActions && ensurePeriodEndActions(liveMatchData); } catch(e){}
          try { updateWithLiveData(currentTeamMatch); } catch(e){ console.error(e); }
        } else {
          showNoLiveBanner();
          liveMatchActive = false;
          liveMatchData = null;
        }
      } else {
        showNoLiveBanner();
        liveMatchActive = false;
        liveMatchData = null;
      }

      // Gestionar partit de l'altre equip
      if (otherTeamMatch) {
        const minutesSinceUpdate = otherTeamLatestTs > 0 ? (now - otherTeamLatestTs)/60000 : Infinity;
        const isWithin60 = minutesSinceUpdate < 60;

        if (isWithin60) {
          const period = getPeriodStatus(otherTeamMatch);
          showOtherTeamBanner(otherTeam, period.finished);
        } else {
          hideOtherTeamBanner();
        }
      } else {
        hideOtherTeamBanner();
      }

    }, (err) => {
      console.error('‚ùå Error escoltant Firebase:', err);
      showNoLiveBanner();
      hideOtherTeamBanner();
    });

    (window.firebaseListeners ||= []).push(listener);
  } catch (e) {
    console.error('‚ùå Error iniciant listener Firebase:', e);
    showNoLiveBanner();
    hideOtherTeamBanner();
  }
}
// ‚úÖ Mostrar banner de l'altre equip
function showOtherTeamBanner(otherTeam, isFinished) {
    const banner = document.getElementById('otherTeamLiveBanner');
    const text = document.getElementById('otherTeamText');
    
    if (!banner || !text) return;
    
    const teamEmoji = otherTeam === 'cadet' ? '‚¨õ' : 'üü¶';
    const teamName = otherTeam === 'cadet' ? 'CADET' : 'JUVENIL';
    const status = isFinished ? 'FINALITZAT' : 'EN DIRECTE';
    
    text.textContent = `${teamEmoji} ${teamName} ${status}`;
    banner.style.display = 'block';
    document.body.classList.add('other-team-live');
    
    console.log(`üì¢ Mostrant banner: ${teamName} ${status}`);
}

// ‚úÖ Amagar banner de l'altre equip
function hideOtherTeamBanner() {
    const banner = document.getElementById('otherTeamLiveBanner');
    if (banner) {
        banner.style.display = 'none';
        document.body.classList.remove('other-team-live');
    }
}

// ‚úÖ Canviar a l'equip que est√† jugant
function switchToLiveTeam() {
    const currentTeam = localStorage.getItem('selectedTeam') || 'juvenil';
    const otherTeam = currentTeam === 'cadet' ? 'juvenil' : 'cadet';
    
    // Canviar d'equip
    selectTeam(otherTeam);
    
    // Recarregar per actualitzar
    setTimeout(() => {
        showTab('live');
    }, 500);
}
function getPeriodStatus(match){
  const Q = ['q1','q2','q3','q4'];
  const qs = match.quarterStartTimes || {};
  const qe = match.quarterRealEndTimes || {};
  const now = Date.now();

  const start = Object.fromEntries(Q.map(q=>[q, toMs(qs[q])]));
  const end   = Object.fromEntries(Q.map(q=>[q, toMs(qe[q])]));

  if (end.q4) return { label:'Finalitzat', code:'FINAL', finished:true };

  for (const q of Q) if (start[q] && !end[q] && now >= start[q]) return { label:q.toUpperCase()+' en joc', code:q.toUpperCase(), finished:false };

  if (start.q1 && end.q1 && !start.q2) return { label:'Descans Q1‚ÄìQ2', code:'BREAK12', finished:false };
  if (start.q2 && end.q2 && !start.q3) return { label:'Descans Q2‚ÄìQ3', code:'BREAK23', finished:false };
  if (start.q3 && end.q3 && !start.q4) return { label:'Descans Q3‚ÄìQ4', code:'BREAK34', finished:false };

  if (!start.q1) return { label:'Pre-partit', code:'PRE', finished:false };
  return { label:'En joc', code:'LIVE', finished:false };
}

function updateLiveTab(isActive) {
  const liveTab = document.getElementById('liveTab');
  if (!liveTab) return;

  if (isActive) {
    liveTab.textContent = 'üî¥ EN DIRECTE';
    liveTab.classList.add('active');
    liveTab.title = 'Hi ha un partit en temps real';
    // Si vols que vagi a la pestanya "live":
    liveTab.onclick = () => showTab('live');
    liveTab.style.cursor = 'pointer';
  } else {
    liveTab.textContent = '‚è∏Ô∏è Cap partit en temps real';
    liveTab.classList.remove('active');
    liveTab.title = 'Ara mateix no hi ha cap partit en temps real';
    // Mant√© el clic si vols que obri igualment la pestanya live, o desactiva‚Äôl:
    liveTab.onclick = () => showTab('list'); // o null si prefereixes que no faci res
    liveTab.style.cursor = 'default';
  }

  // Sempre visible
  liveTab.style.display = 'inline-flex';
}
function getLiveTab(){
  const el = document.getElementById('liveTab');
  if (!el) {
    console.warn('‚ö†Ô∏è No s‚Äôha trobat #liveTab. Revisa l‚ÄôHTML de les tabs.');
    return null;
  }
  // assegura que no queda ocult per classes
  el.classList.remove('hidden');
  el.style.display = 'inline-block';
  return el;
}

// ============================================
// üî• MOSTRAR BANNER DE TEMPS REAL
// ============================================
function showLiveBanner(match){
  const btn = document.getElementById('liveTab');
  if (!btn) return;

  // Detectar quin equip est√† jugant
  const currentTeam = localStorage.getItem('selectedTeam') || 'juvenil';
  const teamEmoji = currentTeam === 'cadet' ? '‚¨õ' : 'üü¶';
  const teamName = currentTeam === 'cadet' ? 'CADET' : 'JUVENIL';

  // calcula estat
  const st = getPeriodStatus(match);
  const lastMs = getLastUpdateMs(match);
  const ago = lastMs ? formatAgoFromMs(Date.now() - lastMs) : '';

  if (st.finished){
    btn.textContent = `üèÅ ${teamName} FINALITZAT` + (ago ? ` ¬∑ actual. ${ago}` : '');
    btn.style.background = 'linear-gradient(135deg,#6b7280,#9ca3af)';
    btn.style.border = '2px solid #d1d5db';
  } else {
    btn.textContent = `üî¥ ${teamEmoji} ${teamName} EN DIRECTE ‚Äî ${st.label}` + (ago ? ` ¬∑ actual. ${ago}` : '');
    btn.style.background = 'linear-gradient(135deg,#dc2626,#ef4444)';
    btn.style.border = '2px solid #fca5a5';
  }
  
  // ‚úÖ Reactivar el bot√≥ (molt important!)
  btn.style.cursor = 'pointer';
  btn.style.opacity = '1';
  btn.style.color = 'white';
  btn.onclick = () => showTab('live');
  btn.title = st.finished ? 'Veure resultat del partit' : 'Veure partit en directe';

  // refresc cada 15s perqu√® passi de "30s" a "1‚Ä≤", etc.
  clearInterval(liveBannerTicker);
  liveBannerTicker = setInterval(() => {
    const lms = getLastUpdateMs(match);
    const ago2 = lms ? formatAgoFromMs(Date.now() - lms) : '';
    if (st.finished){
      btn.textContent = `üèÅ ${teamName} FINALITZAT` + (ago2 ? ` ¬∑ actual. ${ago2}` : '');
    } else {
      btn.textContent = `üî¥ ${teamEmoji} ${teamName} EN DIRECTE ‚Äî ${st.label}` + (ago2 ? ` ¬∑ actual. ${ago2}` : '');
    }
  }, 15000);
}
function showNoLiveBanner(){
  const btn = getLiveTab();
  if (!btn) return;
  
  btn.textContent = '‚ö™ No hi ha cap partit en temps real';
  
  // ‚úÖ Color m√©s fosc i menys blanc
  btn.style.background = 'linear-gradient(135deg, #4b5563, #6b7280)';
  btn.style.border = '2px solid #9ca3af';
  btn.style.color = '#d1d5db'; // Text m√©s apagat
  
  // ‚úÖ Desactivar click
  btn.style.cursor = 'not-allowed';
  btn.style.opacity = '0.6';
  btn.onclick = (e) => {
    e.preventDefault();
    e.stopPropagation();
  };
  
  // ‚úÖ Opcional: Afegir tooltip
  btn.title = 'Ara mateix no hi ha cap partit en directe';
}
function ensurePeriodEndActions(match){
  const listKey = Array.isArray(match.chronologicalActions) ? 'chronologicalActions'
               : Array.isArray(match.actions) ? 'actions' : null;
  if (!listKey) return;

  const arr = match[listKey];
  const hasType = (t, q) => arr.some(a => a.type === t && (!q || a.quarter === q));

  const qs = match.quarterStartTimes || {};
  const qe = match.quarterRealEndTimes || {};
  const toMs = (x)=> x ? (x>1e12?x:x*1000) : null;

  // Finals de Q1..Q3..Q4
  (['q1','q2','q3','q4']).forEach(q=>{
    const endMs = toMs(qe[q]);
    if (endMs && !hasType('period-end', q)) {
      arr.push({
        type: 'period-end',
        quarter: q,
        timestamp: endMs,
        label: q.toUpperCase() + ' final'
      });
    }
  });

  // Final del partit si Q4 t√© final
  if (qe.q4 && !hasType('match-end')) {
    arr.push({
      type: 'match-end',
      timestamp: toMs(qe.q4),
      label: 'Final del partit'
    });
  }

  // Mant√©n ordenades
  arr.sort((a,b)=>{
    const ta = Number(a.timestamp || a.ts || 0);
    const tb = Number(b.timestamp || b.ts || 0);
    return ta - tb;
  });
}
// ============================================
// üî• AMAGAR BANNER
// ============================================
function hideLiveBanner() {
    const banner = document.getElementById('liveBanner');
    const indicator = document.getElementById('liveIndicatorSmall');
    
    liveMatchActive = false;
    liveMatchData = null;
    
    if (banner) {
        banner.classList.remove('active');
        document.body.classList.remove('live-mode');
    }
    
    if (indicator) {
        indicator.classList.remove('active');
    }
	// üî¥ AFEGIR AIX√í AL FINAL
    // Amagar pestanya EN DIRECTE
    const liveTab = document.getElementById('liveTab');
    if (liveTab) {
        liveTab.classList.remove('active');
        liveTab.style.display = 'none';
    }
    
    // Si est√†vem a la vista EN DIRECTE, tornar a la llista
    const liveView = document.getElementById('liveView');
    if (liveView && !liveView.classList.contains('hidden')) {
        showTab('list');
    }
}

// ============================================
// üî• ACTUALITZAR AMB DADES EN DIRECTE
// ============================================
function updateWithLiveData(matchData) {
  try {
    console.log('üîÑ Actualitzant amb dades en directe...');

    window.latestMatch = matchData;

    const livePlayedMap = computeLivePlayingTimes(matchData);
    window.currentLivePlayingTimes = livePlayedMap;
	
	// 2) gols rebuts incremental
const concededMap = processNewConceded(matchData);
window.currentLiveGoalsConceded = concededMap;

    // 3) calcula MVP per a cada jugador
if (Array.isArray(matchData.jugadors)) {
  matchData.jugadors = matchData.jugadors.map(p => {
    const secs = livePlayedMap?.[p.numero] || 0;
    const conceded = (p.numero === 1 || p.numero === 13) ? (concededMap[p.numero] || 0) : 0;
    p.__liveSeconds = secs;
    p.mvp = calculateMVP(p, secs, conceded);
    // depuraci√≥ opcional:
    console.log(`Porter ${p.nom} (#${p.numero}) ‚Üí gols rebuts: ${conceded}, mvp: ${p.mvp}`);
    return p;
  });
}

    if (Array.isArray(allMatches)) {
      allMatches = allMatches.filter(m => {
        const sameId =
          (m.id && matchData.id && m.id === matchData.id) ||
          (m.rivalTeam === matchData.rivalTeam &&
           new Date(m.data).toDateString() === new Date(matchData.data).toDateString());
        return !sameId;
      });
      allMatches.unshift(matchData);

      if (typeof displayMatchesList === 'function')  displayMatchesList();
      if (typeof displayComparison === 'function')   displayComparison();
      if (typeof displayTitularStats === 'function') displayTitularStats();

      console.log('‚úÖ Dades actualitzades amb temps real!');
    }

    // üëá IMPORTANT: noms locals √∫nics (no globals)
    const liveViewEl   = document.getElementById('liveView');
    if (liveViewEl && !liveViewEl.classList.contains('hidden') && typeof updateLiveView === 'function') {
      updateLiveView();
    }

    const accionsViewEl = document.getElementById('liveAccionsView');
    if (accionsViewEl && accionsViewEl.classList.contains('active') && typeof updateLiveActions === 'function') {
      updateLiveActions();
    }

    const statsViewEl = document.getElementById('liveStatsView');
    if (statsViewEl && statsViewEl.classList.contains('active') && typeof updateLiveStats === 'function') {
      updateLiveStats();
    }

  } catch (err) {
    console.error('‚ùå Error a updateWithLiveData:', err);
  }
  ensurePeriodEndActions(matchData);
}
function renderPeriodEndAction(action, quarterLabel, timeStr){
  const label = action.label || (quarterLabel + ' final');
  return `
    <div class="action-item period-end">
      <div class="action-header">
        <span class="action-time">‚è±Ô∏è ${timeStr}</span>
        <span class="action-quarter">${quarterLabel}</span>
      </div>
      <div class="action-content">
        <div class="action-icon">üîî</div>
        <div class="action-details">
          <div class="action-title">${label}</div>
        </div>
      </div>
    </div>
  `;
}

function renderMatchEndAction(action, timeStr){
  const label = action.label || 'Final del partit';
  return `
    <div class="action-item match-end">
      <div class="action-header">
        <span class="action-time">‚è±Ô∏è ${timeStr}</span>
        <span class="action-quarter">Q4</span>
      </div>
      <div class="action-content">
        <div class="action-icon">üèÅ</div>
        <div class="action-details">
          <div class="action-title">${label}</div>
        </div>
      </div>
    </div>
  `;
}
// ============================================
// üî• AUTO-REFRESH MENTRE HI HA TEMPS REAL
// ============================================
function startAutoRefresh() {
    // Netejar interval anterior si existeix
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
    
    // Nom√©s auto-refresh si hi ha partit actiu
    autoRefreshInterval = setInterval(() => {
        if (liveMatchActive && liveMatchData) {
            console.log('üîÑ Auto-refresh: actualitzant displays...');
            updateWithLiveData(liveMatchData);
        }
    }, 5000); // Cada 5 segons
}

// Iniciar auto-refresh quan es detecti un partit
// (afegir-ho a la funci√≥ showLiveBanner)
// ============================================
// ‚ö° GESTI√ì DE SUB-TABS EN DIRECTE
// ============================================
function showLiveSubTab(subTabName) {
    // Actualitzar tabs
    document.querySelectorAll('.live-sub-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    event.target.classList.add('active');
    
    // Actualitzar vistes
    document.querySelectorAll('.live-sub-view').forEach(view => {
        view.classList.remove('active');
    });
    
    if (subTabName === 'marcador') {
        document.getElementById('liveMarcadorView')?.classList.add('active');
    } else if (subTabName === 'accions') {
        document.getElementById('liveAccionsView')?.classList.add('active');
        updateLiveActions();
    } else if (subTabName === 'stats') {
        // üî¥ AFEGIR AIX√í
        document.getElementById('liveStatsView')?.classList.add('active');
        updateLiveStats();
    }
}
// ============================================
// ‚ö° RENDERITZAR TIMELINE D'ACCIONS
// ============================================
function updateLiveActions() {
    if (!liveMatchData) {
        console.warn('‚ö†Ô∏è No hi ha dades de partit per mostrar accions');
        return;
    }
    
    const timeline = document.getElementById('actionsTimeline');
    if (!timeline) return;
    
    const actions = liveMatchData.chronologicalActions || [];
    
    if (actions.length === 0) {
        timeline.innerHTML = `
            <div class="actions-empty">
                <div class="actions-empty-icon">‚öΩ</div>
                <div class="actions-empty-text">Encara no hi ha accions registrades</div>
            </div>
        `;
        return;
    }
    
    // Ordenar per timestamp (m√©s recent primer)
    // ‚úÖ AMB CRITERI SECUNDARI: si mateix timestamp, 'out' abans que 'in'
    const sortedActions = [...actions].sort((a, b) => {
        const timeDiff = b.timestamp - a.timestamp;
        
        // Si tenen el mateix timestamp
        if (timeDiff === 0) {
            // Si tots dos s√≥n water-change
            if (a.type === 'water-change' && b.type === 'water-change') {
                // 'out' va primer (retorna -1 si a √©s 'out' i b √©s 'in')
                if (a.action === 'out' && b.action === 'in') return -1;
                if (a.action === 'in' && b.action === 'out') return 1;
            }
        }
        
        return timeDiff;
    });
    
    // Renderitzar accions
    const html = sortedActions.map(action => {
        return renderActionItem(action);
    }).join('');
    
    timeline.innerHTML = html;
    
    console.log('‚úÖ Timeline d\'accions actualitzat:', actions.length, 'accions');
}

// ============================================
// ‚ö° RENDERITZAR UN ITEM D'ACCI√ì
// ============================================
function renderActionItem(action) {
  const isRival = action.team === 'rival' || action.team === 'away' || action.equip === 'rival';
  const quarterLabel = action.quarter?.toUpperCase() || 'Q?';

  // timestamp robust
  const toMs = (x)=> x ? (x>1e12?x:x*1000) : null;
  const ts = toMs(action.timestamp ?? action.ts ?? action.time);
  const timeStr = ts ? new Date(ts).toLocaleTimeString('ca-ES',{hour:'2-digit',minute:'2-digit',second:'2-digit'}) : 'N/A';

  // nous tipus
  if (action.type === 'period-end') return renderPeriodEndAction(action, quarterLabel, timeStr);
  if (action.type === 'match-end')  return renderMatchEndAction(action, timeStr);

// ‚úÖ AFEGIR AQUESTA L√çNIA:
  if (action.type === 'water-change') {
    const inOut = action.action; // 'in' o 'out'
    return renderChangeAction(action, inOut, quarterLabel, timeStr);
  }
  
  // existents
  switch (action.type) {
    case 'goal':       return renderGoalAction(action, isRival, quarterLabel, timeStr);
    case 'exclusion':  return renderExclusionAction(action, isRival, quarterLabel, timeStr);
    case 'save':       return renderSaveAction(action, quarterLabel, timeStr);
    case 'action':     return renderGeneralAction(action, isRival, quarterLabel, timeStr);
    case 'swim-race':  return renderSwimRaceAction(action, quarterLabel, timeStr);
	case 'penalty-missed': return renderPenaltyMissedAction(action, isRival, quarterLabel, timeStr);
    default:           return '';
  }
}
// ============================================
// √¢≈°¬° RENDERITZAR PENAL FALLAT
// ============================================
function renderPenaltyMissedAction(action, isRival, quarterLabel, timeStr) {
    const playerNum = action.playerNum || '?';
    const playerName = action.playerName || 'Desconegut';
    
    return `
        <div class="action-item exclusion">
            <div class="action-header">
                <span class="action-time">‚è±Ô∏è ${timeStr}</span>
                <span class="action-quarter">${quarterLabel}</span>
            </div>
            <div class="action-content">
                <div class="action-icon">ü•Ö‚ùå</div>
                <div class="action-details">
                    <div class="action-title">PENAL FALLAT ${isRival ? 'RIVAL' : 'CN TERRASSA'}</div>
                    <div class="action-player">
                        <span class="action-player-number ${isRival ? 'rival' : ''}">${playerNum}</span>
                        ${playerName}
                    </div>
                </div>
            </div>
        </div>
    `;
}
// ============================================
// ‚ö° RENDERITZAR GOL
// ============================================
function renderGoalAction(action, isRival, quarterLabel, timeStr) {
  const playerNum  = action.playerNum || '?';
  const playerName = action.playerName || 'Desconegut';
  const rawType    = (action.goalType || 'normal').toLowerCase();
  const zone       = (action.goalZone || action.zone || '').trim();
  const fieldZone  = (action.fieldZone || '').trim(); // ‚úÖ AFEGIR ZONA DEL CAMP

  const goalTypes = { normal:'Normal', 'h+':'Superioritat', penalty:'Penal', contra:'Contraatac', boya:'Boia' };
  const goalTypeText = goalTypes[rawType] || (rawType.charAt(0).toUpperCase()+rawType.slice(1));

  // ‚úÖ Mapeig de zones del camp
  const fieldZoneNames = {
    '2m-left': '2m Esq.', '2m-center': '2m Centre', '2m-right': '2m Dre.',
    '5m-left': '-6m Esq.', '5m-center': '-6m Centre', '5m-right': '5m Dre.',
    '+6m-left': '+6m Esq.', '+6m-center': '+6m Centre', '+6m-right': '+6m Dre.'
  };

  return `
    <div class="action-item ${isRival ? 'goal-rival' : 'goal'}">
      <div class="action-header">
        <span class="action-time">‚è±Ô∏è ${timeStr}</span>
        <span class="action-quarter">${quarterLabel}</span>
      </div>
      <div class="action-content">
        <div class="action-icon">‚öΩ</div>
        <div class="action-details">
          <div class="action-title">GOL ${isRival ? 'RIVAL' : 'CN TERRASSA'}!</div>
          <div class="action-player">
            <span class="action-player-number ${isRival ? 'rival' : ''}">${playerNum}</span>
            ${playerName}
          </div>

          <div class="action-meta">
  <span class="action-badge ${'type-' + rawType}">${goalTypeText}</span>
  ${fieldZone && fieldZoneNames[fieldZone] ? `
    <div class="zone-wrap">
      <span class="zone-title">üìç Camp</span>
      ${fieldZoneMiniRect(fieldZone)}
    </div>
  ` : ''}
  ${zone ? `
    <div class="zone-wrap">
      <span class="zone-title">üéØ Porteria</span>
      ${goalZoneMiniRect(zone)}
    </div>
  ` : ''}
</div>
        </div>
      </div>
    </div>`;
}

// ============================================
// ‚ö° RENDERITZAR EXCLUSI√ì
// ============================================
function renderExclusionAction(action, isRival, quarterLabel, timeStr) {
  const playerNum = action.playerNum || '?';
  const playerName = action.playerName || 'Desconegut';
  const exclusionType = action.exclusionType || 'ordinaria';

  const exclusionTypes = {
    'ordinaria': 'Ordin√†ria',
    'brutalitat': 'Brutalitat',
    'antiesportiva': 'Antiesportiva'
  };
// despr√©s de latestMatch = ...
liveMatchData = latestMatch;

// normalitza llistat i crea mapa num->nom
const list = liveMatchData.players
  ? liveMatchData.players.map(p => ({ num: Number(p.num), name: p.name }))
  : (liveMatchData.jugadors || []).map(j => ({ num: Number(j.numero), name: j.nom }));

window.liveNameByNum = Object.fromEntries(
  list.map(p => [Number(p.num), p.name])
);
  const exclusionText = exclusionTypes[exclusionType] || exclusionType;

  // üü¶ si √©s exclusi√≥ rival i hi ha jugador CNT afectat
let faltaRebudaHTML = '';
if (isRival && action.faltaSobreJugador != null && action.faltaSobreJugador !== '') {
  const n = Number(action.faltaSobreJugador);
  const frName = (window.liveNameByNum && window.liveNameByNum[n]) || `Jugador ${n}`;
  faltaRebudaHTML = `
    <div class="action-falta-rebuda" style="margin-top:4px;font-size:12px;color:#38bdf8;">
      üü¶ Falta rebuda per <b>${frName}</b> <span style="opacity:0.7;">(#${n})</span>
    </div>`;
}

  return `
    <div class="action-item exclusion">
      <div class="action-header">
        <span class="action-time">‚è±Ô∏è ${timeStr}</span>
        <span class="action-quarter">${quarterLabel}</span>
      </div>
      <div class="action-content">
        <div class="action-icon">üü•</div>
        <div class="action-details">
          <div class="action-title">EXCLUSI√ì ${isRival ? 'RIVAL' : 'CN TERRASSA'}</div>
          <div class="action-player">
            <span class="action-player-number ${isRival ? 'rival' : ''}">${playerNum}</span>
            ${playerName}
          </div>
          <div class="action-meta">
            <span class="action-badge">${exclusionText}</span>
          </div>
          ${faltaRebudaHTML}   <!-- ‚úÖ afegim la falta rebuda si existeix -->
        </div>
      </div>
    </div>
  `;
}

// ============================================
// ‚ö° RENDERITZAR PARADA
// ============================================
function renderSaveAction(action, quarterLabel, timeStr) {
    const playerNum = action.playerNum || '?';
    const playerName = action.playerName || 'Porter';
    const saveType = action.saveType || 'normal';
    
    const saveTypes = {
        'corner': 'Corner',
        'rebuig': 'Rebuig',
        'atrapa': 'Atrapa',
        'penal': 'Penal'
    };
    
    const saveText = saveTypes[saveType] || saveType;
    
    return `
        <div class="action-item save">
            <div class="action-header">
                <span class="action-time">‚è±Ô∏è ${timeStr}</span>
                <span class="action-quarter">${quarterLabel}</span>
            </div>
            <div class="action-content">
                <div class="action-icon">üß§</div>
                <div class="action-details">
                    <div class="action-title">PARADA!</div>
                    <div class="action-player">
                        <span class="action-player-number">${playerNum}</span>
                        ${playerName}
                    </div>
                    <div class="action-meta">
                        <span class="action-badge">${saveText}</span>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// ============================================
// ‚ö° RENDERITZAR ACCI√ì GENERAL
// ============================================
function renderGeneralAction(action, isRival, quarterLabel, timeStr) {
    const playerNum = action.playerNum || '?';
    const playerName = action.playerName || 'Desconegut';
    const actionType = action.actionType || 'unknown';
    
    const actionIcons = {
        'assistencia': 'üéØ',
        'robatori': 'üí™',
        'perdua': '‚ùå',
        'xut': 'üéØ',
        'block': 'üõ°Ô∏è',
        'contrafalta': '‚ö†Ô∏è',
        '2metres': 'üî¥'
    };
    
    const actionNames = {
        'assistencia': 'Assist√®ncia',
        'robatori': 'Robatori',
        'perdua': 'P√®rdua',
        'xut': 'Xut Fallat',
        'block': 'Block',
        'contrafalta': 'Contrafalta',
        '2metres': 'Infracci√≥ 2m'
    };
    
    const icon = actionIcons[actionType] || 'üîµ';
    const name = actionNames[actionType] || actionType;
    
    return `
        <div class="action-item action">
            <div class="action-header">
                <span class="action-time">‚è±Ô∏è ${timeStr}</span>
                <span class="action-quarter">${quarterLabel}</span>
            </div>
            <div class="action-content">
                <div class="action-icon">${icon}</div>
                <div class="action-details">
                    <div class="action-title">${name}</div>
                    <div class="action-player">
                        <span class="action-player-number ${isRival ? 'rival' : ''}">${playerNum}</span>
                        ${playerName}
                    </div>
                </div>
            </div>
        </div>
    `;
}

// ============================================
// ‚ö° RENDERITZAR CURSA INICIAL
// ============================================
function renderSwimRaceAction(action, quarterLabel, timeStr) {
    const playerName = action.playerName || 'Desconegut';
    const result = action.result === 'win' ? 'Guanyada' : 'Perduda';
    const icon = action.result === 'win' ? '‚úÖ' : '‚ùå';
    
    return `
        <div class="action-item action">
            <div class="action-header">
                <span class="action-time">‚è±Ô∏è ${timeStr}</span>
                <span class="action-quarter">${quarterLabel}</span>
            </div>
            <div class="action-content">
                <div class="action-icon">üèä</div>
                <div class="action-details">
                    <div class="action-title">Cursa Inicial ${icon}</div>
                    <div class="action-player">${playerName}</div>
                    <div class="action-meta">
                        <span class="action-badge">${result}</span>
                    </div>
                </div>
            </div>
        </div>
    `;
}
// ============================================
// ‚è±Ô∏è CALCULAR TEMPS JUGAT EN TEMPS REAL (CORREGIT)
// ============================================
function calculateLivePlayingTime(match, playerNum) {
    if (!match || !match.playerWaterChanges || !match.quarterStartTimes) {
        return { total: 0, byQuarter: { q1: 0, q2: 0, q3: 0, q4: 0 } };
    }
    
    const quarterDuration = 480; // 8 minuts en segons
    const changes = match.playerWaterChanges.filter(c => c.playerNum === playerNum);
    const times = { total: 0, byQuarter: { q1: 0, q2: 0, q3: 0, q4: 0 } };
    
    ['q1', 'q2', 'q3', 'q4'].forEach(quarter => {
        const qChanges = changes.filter(c => c.quarter === quarter);
        if (qChanges.length === 0) {
            times.byQuarter[quarter] = 0;
            return;
        }
        
        qChanges.sort((a, b) => a.timestamp - b.timestamp);
        
        let timeInWater = 0;
        let lastInTime = null;
        const quarterStartTime = match.quarterStartTimes[quarter];
        
        if (!quarterStartTime) {
            times.byQuarter[quarter] = 0;
            return;
        }
        
        qChanges.forEach(change => {
            if (change.action === 'in') {
                lastInTime = change.timestamp;
            } else if (change.action === 'out' && lastInTime !== null) {
                timeInWater += (change.timestamp - lastInTime) / 1000;
                lastInTime = null;
            }
        });
        
        // üî¥ CORRECCI√ì: Si encara est√† dins l'aigua
        if (lastInTime !== null) {
            // Usar quarterRealEndTimes si existeix, sin√≥ usar TEMPS ACTUAL
            let quarterEndTime;
            
            if (match.quarterRealEndTimes?.[quarter]) {
                // El quarter ja ha acabat
                quarterEndTime = match.quarterRealEndTimes[quarter];
            } else {
                // El quarter encara est√† en curs - usar TEMPS ACTUAL
                quarterEndTime = Date.now();
            }
            
            timeInWater += (quarterEndTime - lastInTime) / 1000;
        }
        
        times.byQuarter[quarter] = Math.round(timeInWater);
        times.total += Math.round(timeInWater);
    });
    
    return times;
}
// ‚úÖ Nou c√†lcul MVP: sense multiplicador de temps.
// 'conceded' s√≥n els gols rebuts mentre AQUEST jugador-porter era dins l‚Äôaigua.
function calculateMVP(player, playingSeconds, conceded = 0) {
  const s = player.estadistiques || {};
  const isGoalkeeper = (player.numero === 1 || player.numero === 13) ||
                       (player.posicio && String(player.posicio).toLowerCase() === 'porter');

  const w = {
    gols: 2,
    assistencies: 1,
    parades: 1,
    robatoris: 1,
    blocks: 1,
    exclusions: -1,
    perdues: -0.5,
    xutsFallats: -0.5,
    contrafaltes: -0.75,
    infraccions2m: -0.5,
	faltesRebudes: 1
  };

  let score = 0;
  score += (s.gols || 0) * w.gols;
  score += (s.assistencies || 0) * w.assistencies;
  score += (s.parades || 0) * w.parades;
  score += (s.robatoris || 0) * w.robatoris;
  score += (s.blocks || 0) * w.blocks;
  score += (s.exclusions || 0) * w.exclusions;       // ja negatiu
  score += (s.perdues || 0) * w.perdues;             // negatiu
  score += (s.xutsFallats || 0) * w.xutsFallats;     // negatiu
  score += (s.contrafaltes || 0) * w.contrafaltes;   // negatiu
  score += (s.infraccions2m || 0) * w.infraccions2m; // negatiu
  score += (s.faltesRebudes || 0) * w.faltesRebudes;

  // üëá nom√©s penalitza el porter que juga (ha tingut playingSeconds > 0)
  if (isGoalkeeper && playingSeconds > 0) {
    score -= (conceded || 0) * 1; // -1 per cada gol rival atribu√Øt a ell
  }

  return Number(score.toFixed(1));
}
// ============================================
// üìà RENDERITZAR TAULA D'ESTAD√çSTIQUES
// ============================================
let statsCurrentSort = { column: 'numero', order: 'asc' };

function updateLiveStats() {
  if (!liveMatchData) {
    console.warn('‚ö†Ô∏è No hi ha dades de partit per mostrar stats');
    return;
  }

  const container = document.getElementById('statsTableContainer');
  if (!container) return;

  const match = liveMatchData;

  // Fonts ‚Äúlive‚Äù si ja les tens preparades a updateWithLiveData
  const liveMap = window.currentLivePlayingTimes || null;
  const concededMapFromState = window.currentLiveGoalsConceded || null;

  // helpers
  const z = (v) => (typeof v === 'number' ? v : (parseFloat(v) || 0));
  const fmt = (secs) => {
    const s = Math.max(0, Math.round(secs || 0));
    const m = Math.floor(s / 60), r = s % 60;
    return `${String(m).padStart(2, '0')}:${String(r).padStart(2, '0')}`;
  };
  const getSecsPlayed = (playerNum, fallbackObj) => {
    if (liveMap && typeof liveMap[playerNum] === 'number') return liveMap[playerNum];
    return (fallbackObj?.total) ? fallbackObj.total : 0;
  };

  // Si no tenim concededMap en estat (per qualsevol motiu), el calculem ara mateix:
  const concededMap = concededMapFromState || processNewConceded(match);

  // ------ CN TERRASSA (jugadors locals) ------
const cntPlayers = (match.jugadors || []).map(player => {
  const playingTime = typeof calculateLivePlayingTime === 'function'
    ? calculateLivePlayingTime(match, player.numero) : { total: 0, byQuarter: {} };

  const secs = getSecsPlayed(player.numero, playingTime);
  const isGoalkeeper = player.numero === 1 || player.numero === 13 ||
                       (player.posicio && String(player.posicio).toLowerCase() === 'porter');
  const conceded = isGoalkeeper ? (concededMap[player.numero] || 0) : 0;

  // üü¶ NOVETAT: FR del jugador
  const fr = z(player?.estadistiques?.faltesRebudes);

  // MVP: si ve precomputat, el respectem per√≤ el **restem per FR**; sin√≥, calculem (ja resta FR dins calculateMVP)
  const baseMvp = (typeof player.mvp === 'number')
  ? player.mvp
  : calculateMVP(player, secs, conceded);

// ‚úÖ ja no restem res, el c√†lcul ja ho fa
const mvpValue = baseMvp;

  const isInWater = !!(match.playersInWater?.includes(player.numero));

  return {
    team: 'cnt',
    numero: player.numero,
    nom: player.nom,
    // üü¶ Incloem FR dins stats perqu√® la taula el pugui pintar
    stats: { ...(player.estadistiques || {}), faltesRebudes: fr },
    temps: secs,
    mvp: mvpValue,
    isGoalkeeper,
    isInWater,
    conceded
  };
});

  // ------ RIVAL (temps 0; MVP simple) ------
  const rivalPlayers = (match.rivalStats || []).map(p => ({
    team: 'rival',
    numero: p.num,
    nom: p.name || `Rival ${p.num}`,
    stats: {
      gols: z(p.gols),
      exclusions: z(p.exclusions),
      assistencies: z(p.assistencies),
      parades: z(p.parades),
      robatoris: z(p.robatoris),
      perdues: z(p.perdues),
      blocks: z(p.blocks),
      xutsFallats: z(p.xutsFallats),
      contrafaltes: z(p.contrafaltes),
      infraccions2m: z(p.infraccions2m)
    },
    temps: 0,
    mvp: (z(p.gols) * 2) - (z(p.exclusions) * 1),
    isGoalkeeper: false,
    isInWater: false,
    conceded: 0
  }));

  // Ordenaci√≥ (admet 'temps' i 'mvp')
  sortPlayersByColumn(cntPlayers, statsCurrentSort.column, statsCurrentSort.order);
  sortPlayersByColumn(rivalPlayers, statsCurrentSort.column, statsCurrentSort.order);

  // Millor MVP CNT (opcional destacar)
  const bestCNTPlayer = cntPlayers.length
    ? cntPlayers.reduce((b, c) => (c.mvp > b.mvp ? c : b), cntPlayers[0])
    : null;

  const cell = (v) => `<td>${v ?? 0}</td>`;
  const renderRow = (p, hi = false) => {
    const s = p.stats || {};
    const rowClass = [
      p.team === 'rival' ? 'rival' : '',
      hi ? 'best-mvp' : '',
      p.isInWater ? 'in-water' : ''
    ].filter(Boolean).join(' ');

    return `
      <tr class="${rowClass}" data-num="${p.numero}">
        <td>${p.numero}</td>
        <td>
${hi ? ' <span class="mvpstar" title="Millor jugador">‚≠ê</span>' : ''}
  ${p.isInWater ? ' <span class="inwater" title="Jugant ara">üíß</span>' : ''} 
 ${p.nom || ''}
  
</td>

        <!-- ordre: Gols, Exclusions, Assist√®ncies -->
        ${cell(s.gols)}
        ${cell(s.exclusions)}
        ${cell(s.assistencies)}

        ${cell(s.parades)}
        ${cell(s.robatoris)}
        ${cell(s.perdues)}
        ${cell(s.blocks)}
        ${cell(s.xutsFallats)}
        ${cell(s.contrafaltes)}
        ${cell(s.infraccions2m)}
		${cell(s.faltesRebudes)}

        <!-- Temps -->
        <td class="col-time" data-seconds="${p.temps}">${fmt(p.temps)}</td>

        
      </tr>
    `;
  };

  const html = `
    <table class="live-stats-table">
      <thead>
        <tr>
          <th class="sortable" onclick="sortStatsTable('numero')">#</th>
          <th class="sortable" onclick="sortStatsTable('nom')">Jugador</th>

          <th class="sortable" onclick="sortStatsTable('gols')" data-tooltip="Gols">Gols‚öΩ</th>
          <th class="sortable" onclick="sortStatsTable('exclusions')" data-tooltip="Exclusions">Excl.</th>
          <th class="sortable" onclick="sortStatsTable('assistencies')" data-tooltip="Assist√®ncies">Ass</th>

          <th class="sortable" onclick="sortStatsTable('parades')" data-tooltip="Parades">Par.</th>
          <th class="sortable" onclick="sortStatsTable('robatoris')" data-tooltip="Robatoris">Rob.</th>
          <th class="sortable" onclick="sortStatsTable('perdues')" data-tooltip="P√®rdues">Perd.</th>
          <th class="sortable" onclick="sortStatsTable('blocks')" data-tooltip="Blocks">Bloc.</th>
          <th class="sortable" onclick="sortStatsTable('xutsFallats')" data-tooltip="Xuts Fallats">X.F.</th>
          <th class="sortable" onclick="sortStatsTable('contrafaltes')" data-tooltip="Contrafaltes">C.F</th>
          <th class="sortable" onclick="sortStatsTable('infraccions2m')" data-tooltip="Infraccions 2m">2m</th>
		  <th class="sortable" onclick="sortStatsTable('faltesRebudes')" data-tooltip="Faltes rebudes">FR</th>
          <th class="sortable" onclick="sortStatsTable('temps')" data-tooltip="Temps jugat">‚è±Ô∏è</th>
          </tr>
      </thead>
      <tbody>
        <tr class="team-header">
  <td class="team-title-sticky" colspan="2">üîµ CN TERRASSA</td>
  <td class="team-title-fill" colspan="13"></td>
</tr>
        ${cntPlayers.map(p => renderRow(p, bestCNTPlayer && p.numero === bestCNTPlayer.numero)).join('')}

        <tr class="team-separator"><td colspan="14"></td></tr>
        <tr class="team-header rival">
  <td class="team-title-sticky" colspan="2">üî¥ ${match.rivalTeam || 'RIVAL'}</td>
  <td class="team-title-fill" colspan="13"></td>
</tr>
        ${rivalPlayers.map(p => renderRow(p, false)).join('')}
      </tbody>
    </table>
  `;

  container.innerHTML = html;

  if (typeof updateSortIndicators === 'function') updateSortIndicators();
  console.log('‚úÖ Taula d‚Äôestad√≠stiques actualitzada (ordenada per:', statsCurrentSort.column, statsCurrentSort.order + ')');
}
// ============================================
// üìä RENDERITZAR FILA DE JUGADOR
// ============================================
function renderPlayerStatsRow(player, bestPlayer) {
    const isBest = bestPlayer && player.team === 'cnt' && player.numero === bestPlayer.numero;
    const stats = player.stats;
    const time = player.playingTime;
    const isInWater = player.isInWater || false;  // üî¥ AFEGIR
    
    // üî¥ AFEGIR classes segons estat
    const rowClasses = [];
    if (isBest) rowClasses.push('best-player');
    if (isInWater) rowClasses.push('player-in-water-row');
    
    return `
        <tr class="${rowClasses.join(' ')}">
            <td class="player-number">${player.numero}</td>
            <td class="player-name ${isInWater ? 'player-in-water' : ''}">
    ${player.nom}
    ${isBest ? '<span class="mvp-badge">‚≠ê</span>' : ''}
    ${isInWater ? '<span class="in-water-badge">üíß</span>' : ''}
</td>
            <td class="${stats.gols > 0 ? 'stat-positive' : ''}">${stats.gols || 0}</td>
            <td class="${stats.assistencies > 0 ? 'stat-positive' : ''}">${stats.assistencies || 0}</td>
            <td class="${stats.exclusions > 0 ? 'stat-negative' : ''}">${stats.exclusions || 0}</td>
            <td class="${stats.parades > 0 ? 'stat-positive' : ''}">
                ${stats.parades || 0}
                ${player.isGoalkeeper && stats.paradeTypes ? renderGoalkeeperDetails(stats.paradeTypes) : ''}
            </td>
            <td class="${stats.robatoris > 0 ? 'stat-positive' : ''}">${stats.robatoris || 0}</td>
            <td class="${stats.perdues > 0 ? 'stat-negative' : ''}">${stats.perdues || 0}</td>
            <td class="${stats.blocks > 0 ? 'stat-positive' : ''}">${stats.blocks || 0}</td>
            <td class="${stats.xutsFallats > 0 ? 'stat-negative' : ''}">${stats.xutsFallats || 0}</td>
            <td class="${stats.contrafaltes > 0 ? 'stat-negative' : ''}">${stats.contrafaltes || 0}</td>
            <td class="${stats.infraccions2m > 0 ? 'stat-negative' : ''}">${stats.infraccions2m || 0}</td>
			<td class="${(stats.faltesRebudes||0) > 0 ? 'stat-positive' : ''}">${stats.faltesRebudes || 0}</td>
            <td class="mvp-score">${player.mvp.toFixed(1)}</td>
        </tr>
    `;
}

// ============================================
// üß§ DETALLS PARADES PORTER
// ============================================
function renderGoalkeeperDetails(paradeTypes) {
    const details = [];
    if (paradeTypes.corner) details.push(`C:${paradeTypes.corner}`);
    if (paradeTypes.rebuig) details.push(`R:${paradeTypes.rebuig}`);
    if (paradeTypes.atrapa) details.push(`A:${paradeTypes.atrapa}`);
    if (paradeTypes.penal) details.push(`P:${paradeTypes.penal}`);
    
    return details.length > 0 ? 
        `<div class="goalkeeper-stats">${details.join(' | ')}</div>` : '';
}

// ============================================
// üîÑ CANVIAR ORDENACI√ì (ONCLICK COLUMNA)
// ============================================
function sortStatsTable(column) {
    console.log('üîÑ Ordenar per:', column);
    
    // Toggle ordre si √©s la mateixa columna
    if (statsCurrentSort.column === column) {
        statsCurrentSort.order = statsCurrentSort.order === 'desc' ? 'asc' : 'desc';
    } else {
        statsCurrentSort.column = column;
        statsCurrentSort.order = 'desc';
    }
    
    // Re-renderitzar amb nou ordre
    updateLiveStats();
}

// ============================================
// üîÑ ORDENAR JUGADORS PER COLUMNA (AMB AIGUA PRIMER)
// ============================================
function sortPlayersByColumn(players, column, order) {
    players.sort((a, b) => {
        // üî¥ PRIORITAT 1: Jugadors a l'aigua primer
        const aInWater = a.isInWater || false;
        const bInWater = b.isInWater || false;
        
        if (aInWater && !bInWater) return -1; // A va primer (est√† a l'aigua)
        if (!aInWater && bInWater) return 1;  // B va primer (est√† a l'aigua)
        
        // üî¥ PRIORITAT 2: Si tots dos estan (o no estan) a l'aigua, ordenar per columna
        let valA, valB;
        
        switch(column) {
            case 'numero':
                valA = a.numero;
                valB = b.numero;
                break;
            case 'nom':
                valA = a.nom.toLowerCase();
                valB = b.nom.toLowerCase();
                return order === 'asc' ? 
                    valA.localeCompare(valB) : valB.localeCompare(valA);
            case 'playingTime':
                valA = a.playingTime.total || 0;
                valB = b.playingTime.total || 0;
                break;
            case 'mvp':
                valA = a.mvp || 0;
                valB = b.mvp || 0;
                break;
            default:
                // Per qualsevol altra estad√≠stica
                valA = a.stats[column] || 0;
                valB = b.stats[column] || 0;
        }
        
        // Ordenaci√≥ num√®rica
        if (order === 'desc') {
            return valB - valA;
        } else {
            return valA - valB;
        }
    });
}

// ============================================
// üìä ACTUALITZAR INDICADORS DE COLUMNA ORDENADA
// ============================================
function updateSortIndicators() {
    // Eliminar indicadors anteriors
    document.querySelectorAll('.live-stats-table th').forEach(th => {
        th.classList.remove('sorted-asc', 'sorted-desc');
    });
    
    // Mapa de columnes (√≠ndex a la taula)
    const columnMap = {
        'numero': 0, 
        'nom': 1, 
        'gols': 2, 
        'assistencies': 3, 
        'exclusions': 4, 
        'parades': 5, 
        'robatoris': 6, 
        'perdues': 7,
        'blocks': 8, 
        'xutsFallats': 9, 
        'contrafaltes': 10, 
        'infraccions2m': 11, 
        'playingTime': 12, 
      
    };
    
    const columnIndex = columnMap[statsCurrentSort.column];
    
    if (columnIndex !== undefined) {
        const headers = document.querySelectorAll('.live-stats-table th');
        if (headers[columnIndex]) {
            headers[columnIndex].classList.add(
                statsCurrentSort.order === 'asc' ? 'sorted-asc' : 'sorted-desc'
            );
        }
    }
}
// Formatear temps (segons -> MM:SS)
function formatPlayingTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}
  function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }
	// ‚úÖ Funci√≥ per mostrar nom + primer cognom (per evitar confusions amb jugadors amb mateix nom)
function getShortPlayerName(fullName) {
    if (!fullName) return '';
    const parts = fullName.trim().split(' ');
    if (parts.length >= 2) {
        return `${parts[0]} ${parts[1]}`; // Nom + Primer cognom
    }
    return parts[0]; // Si nom√©s t√© un nom
}
function getQuarterRealStartTime(match, quarter) {
    // Prioritzar quarterRealStartTimes si existeix (nou sistema amb bot√≥)
    if (match.quarterRealStartTimes && match.quarterRealStartTimes[quarter]) {
        return match.quarterRealStartTimes[quarter];
    }
    
    // Fallback: usar quarterStartTimes (sistema antic)
    return match.quarterStartTimes && match.quarterStartTimes[quarter] 
        ? match.quarterStartTimes[quarter] 
        : null;
}
function getQuarterRealStartTime(match, quarter) {
    // Buscar la primera acci√≥n REAL del cuarto (gol, exclusi√≥n, cambio de agua)
    const actions = match.chronologicalActions || [];
    const quarterActions = actions.filter(a => a.quarter === quarter);
    
    if (quarterActions.length > 0) {
        // Ordenar por timestamp y devolver el primero
        quarterActions.sort((a, b) => a.timestamp - b.timestamp);
        return quarterActions[0].timestamp;
    }
    
    // Si no hay acciones, usar quarterStartTimes como fallback
    return match.quarterStartTimes[quarter];
}
function getQuarterEndTime(match, quarter, quarterStartTime, quarterDuration) {
    if (match.quarterRealEndTimes && match.quarterRealEndTimes[quarter]) {
        return match.quarterRealEndTimes[quarter];
    }
    
    const quarterOrder = ['q1', 'q2', 'q3', 'q4'];
    const currentIndex = quarterOrder.indexOf(quarter);
    
    if (currentIndex < 3) {
        const nextQuarter = quarterOrder[currentIndex + 1];
        if (match.quarterStartTimes[nextQuarter]) {
            return match.quarterStartTimes[nextQuarter];
        }
    }
    
    return quarterStartTime + (quarterDuration * 1000);
}
  function displayMatchesList() {
    const container = document.getElementById('availableMatches');
    
    if (filteredMatches.length === 0) {
        container.innerHTML = '<div class="no-data">No hay partidos que coincidan con los filtros</div>';
        return;
    }

    container.innerHTML = filteredMatches.map((match, idx) => {  // ‚úÖ Usar idx del map
        const date = new Date(match.data);
        const result = match.scoreCNT > match.scoreRival ? 'win' : 
                      match.scoreCNT < match.scoreRival ? 'loss' : 'draw';
        const resultText = result === 'win' ? '‚úÖ Victoria' : 
                          result === 'loss' ? '‚ùå Derrota' : 'ü§ù Empate';
        const locationIcon = (match.matchLocation === 'home' || !match.matchLocation) ? 'üè†' : '‚úàÔ∏è';
        const locationText = (match.matchLocation === 'home' || !match.matchLocation) ? 'Casa' : 'Fuera';
        
        return `
            <div class="match-item" onclick="viewMatch(${idx})">  
                <div class="match-info">
                    <div class="match-date">${date.toLocaleDateString('es-ES', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'})}</div>
                    <div class="match-teams">CN Terrassa vs ${match.rivalTeam || 'Rival'} ${locationIcon}</div>
                    <div class="${result}">${resultText} ‚Ä¢ ${locationText}</div>
                </div>
                <div class="match-score">${match.scoreCNT} - ${match.scoreRival}</div>
            </div>
        `;
    }).join('');
}

        function filterMatches() {
            const rivalFilter = document.getElementById('filterRival').value.toLowerCase();
            const resultFilter = document.getElementById('filterResult').value;
            const sortBy = document.getElementById('sortBy').value;

            filteredMatches = allMatches.filter(match => {
                const rivalMatch = !rivalFilter || (match.rivalTeam || '').toLowerCase().includes(rivalFilter);
                
                let resultMatch = true;
                if (resultFilter) {
                    const result = match.scoreCNT > match.scoreRival ? 'win' : 
                                  match.scoreCNT < match.scoreRival ? 'loss' : 'draw';
                    resultMatch = result === resultFilter;
                }

                return rivalMatch && resultMatch;
            });

            if (sortBy === 'date-desc') {
                filteredMatches.sort((a, b) => new Date(b.data) - new Date(a.data));
            } else if (sortBy === 'date-asc') {
                filteredMatches.sort((a, b) => new Date(a.data) - new Date(b.data));
            } else if (sortBy === 'score-desc') {
                filteredMatches.sort((a, b) => b.scoreCNT - a.scoreCNT);
            }

            displayMatchesList();
        }

      function viewMatch(idx) {
    currentMatch = filteredMatches[idx];  // ‚úÖ USAR filteredMatches en lugar de allMatches
    document.getElementById('matchesView').classList.add('hidden');
    document.getElementById('singleMatchView').classList.remove('hidden');
    displayMatchData();
}

  function backToList() {
    document.getElementById('singleMatchView').classList.add('hidden');
    document.getElementById('matchesView').classList.remove('hidden');
    const pdfButton = document.getElementById('pdfMatchButton');
    if (pdfButton) {
        pdfButton.style.display = 'none';
    }
}

function showTab(tabName) {
    if (tabName !== 'list') {
        stopCountdownTimer();
    }
    
    // Eliminar active de tots els tabs
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    
    // Afegir active al tab seleccionat
    if (tabName === 'live') {
        document.getElementById('liveTab')?.classList.add('active');
    } else if (event && event.target) {
        event.target.classList.add('active');
    }
    
    // Ocultar TOTS els tabs/vistes
    document.getElementById('listTab')?.classList.add('hidden');
	document.getElementById('temporadaTab')?.classList.add('hidden');
    document.getElementById('comparisonTab')?.classList.add('hidden');
    document.getElementById('titularTab')?.classList.add('hidden');
    document.getElementById('tiempoTab')?.classList.add('hidden');
    document.getElementById('individualTab')?.classList.add('hidden');
    document.getElementById('federacionTab')?.classList.add('hidden');
	document.getElementById('rivalsTab')?.classList.add('hidden');
    document.getElementById('actawpTab')?.classList.add('hidden');
    document.getElementById('liveView')?.classList.add('hidden'); // üî¥ Vista EN DIRECTE
    
    // Ocultar tamb√© les vistes internes del listTab
    document.getElementById('matchesView')?.classList.add('hidden');
    document.getElementById('singleMatchView')?.classList.add('hidden');
    
    // Mostrar el tab seleccionat amb la seva l√≤gica espec√≠fica
    if (tabName === 'live') {
        // üî¥ PESTANYA EN DIRECTE
        document.getElementById('liveView')?.classList.remove('hidden');
        updateLiveView(); // Actualitzar dades en obrir
        
    } else if (tabName === 'list') {
        document.getElementById('listTab')?.classList.remove('hidden');
        document.getElementById('matchesView')?.classList.remove('hidden');
        
        // Carregar les pastilles
        setTimeout(() => {
            loadFrontPagePills();
        }, 100);
    
   
    } else if (tabName === 'comparison') {
        document.getElementById('comparisonTab')?.classList.remove('hidden');
        
    } else if (tabName === 'titular') {
        document.getElementById('titularTab')?.classList.remove('hidden');
        setTimeout(() => {
            renderTitularityHeatmapChart();
        }, 100);
     } else if (tabName === 'temporadaTab') {
    document.getElementById('temporadaTab')?.classList.remove('hidden');
	setTimeout(() => {
    loadTemporadaTab();
	}    , 100);
    } else if (tabName === 'tiempo') {
        document.getElementById('tiempoTab')?.classList.remove('hidden');
        setTimeout(() => {
            displayTimeStats();
        }, 100);
        
    } else if (tabName === 'individual') {
        document.getElementById('individualTab')?.classList.remove('hidden');
        setTimeout(() => {
            initializePlayerSelector();
        }, 100);
        
    } else if (tabName === 'rivalsTab') {
        document.getElementById('rivalsTab')?.classList.remove('hidden');
        loadRivalsStudy();
        
    } else if (tabName === 'actawpTab') {
        document.getElementById('actawpTab')?.classList.remove('hidden');
        setTimeout(() => {
            if (actawpData) {
                displayActawpData();
				loadUltimsResultatsMini();
            }
        }, 100);
    }
}
 function displayMatchData() {
    document.getElementById('scoreCNT').textContent = currentMatch.scoreCNT || 0;
    document.getElementById('scoreRival').textContent = currentMatch.scoreRival || 0;
    document.getElementById('teamRival').textContent = currentMatch.rivalTeam || 'RIVAL';
// Actualitzar tamb√© el scoreboard de dalt si existeix
if (document.getElementById('scoreboardCNT')) {
    document.getElementById('scoreboardCNT').textContent = currentMatch.scoreCNT || 0;
    document.getElementById('scoreboardRival').textContent = currentMatch.scoreRival || 0;
    document.getElementById('scoreboardRivalName').textContent = currentMatch.rivalTeam || 'RIVAL';
}
    const date = new Date(currentMatch.data);
    const locationIcon = (currentMatch.matchLocation === 'home' || !currentMatch.matchLocation) ? 'üè†' : '‚úàÔ∏è';
    const locationText = (currentMatch.matchLocation === 'home' || !currentMatch.matchLocation) ? 'Casa' : 'Fuera';
    const totalExcCNT = currentMatch.jugadors.reduce((sum, j) => sum + j.estadistiques.exclusions, 0);
    const totalExcRival = currentMatch.rivalStats.reduce((sum, j) => sum + j.exclusions, 0);

    // Parades dels porters
    const totalParadesCNT = currentMatch.jugadors.reduce((sum, j) => {
        return sum + (j.estadistiques.parades || 0);
    }, 0);
    
    // Calcular totalGoals abans d'utilitzar-lo
    const totalGoals = currentMatch.jugadors.reduce((sum, j) => sum + j.estadistiques.gols, 0);
    
    // Noves accions
    const totalAssistenciesCNT = currentMatch.jugadors.reduce((sum, j) => {
        return sum + (j.estadistiques.assistencies || 0);
    }, 0);

    const totalRobatorisCNT = currentMatch.jugadors.reduce((sum, j) => {
        return sum + (j.estadistiques.robatoris || 0);
    }, 0);

    const totalPerduesCNT = currentMatch.jugadors.reduce((sum, j) => {
        return sum + (j.estadistiques.perdues || 0);
    }, 0);

    const totalXutsFallatsCNT = currentMatch.jugadors.reduce((sum, j) => {
        return sum + (j.estadistiques.xutsFallats || 0);
    }, 0);
    
    const totalBlocksCNT = currentMatch.jugadors.reduce((sum, j) => {
        return sum + (j.estadistiques.blocks || 0);
    }, 0);

    const totalFaltesRebudesCNT = currentMatch.jugadors.reduce((sum, j) => {
        return sum + (j.estadistiques.faltesRebudes || 0);
    }, 0);
    const totalInfraccions2mCNT = currentMatch.jugadors.reduce((sum, j) => {
    return sum + (j.estadistiques.infraccions2m || 0);
}, 0);
const totalContrafaltesCNT = currentMatch.jugadors.reduce((sum, j) => {
        return sum + (j.estadistiques.contrafaltes || 0);
    }, 0);

    // Efici√®ncia de tir
    const totalXutsCNT = totalGoals + totalXutsFallatsCNT;
    const eficienciaTirCNT = totalXutsCNT > 0 ? ((totalGoals / totalXutsCNT) * 100).toFixed(1) : '0.0';
    
    // Conversi√≥n H+ del CNT (goles H+ CNT / exclusiones normales rival)
    let totalHPlusCNT = 0;
    let totalExclusionsNoPenaltyRival = 0;

    currentMatch.jugadors.forEach(j => {
        if (j.estadistiques.goalTypes && j.estadistiques.goalTypes['h+']) {
            totalHPlusCNT += j.estadistiques.goalTypes['h+'];
        }
    });

    currentMatch.rivalStats.forEach(j => {
        if (j.exclusionTypes) {
            totalExclusionsNoPenaltyRival += (j.exclusionTypes.normal || 0);
        }
    });

    const conversionRateCNT = totalExclusionsNoPenaltyRival > 0 ? 
        ((totalHPlusCNT / totalExclusionsNoPenaltyRival) * 100).toFixed(1) : '0.0';

    // Conversi√≥n H+ del Rival (goles H+ rival / exclusiones normales CNT)
    let totalHPlusRival = 0;
    let totalExclusionsNoPenaltyCNT = 0;

    currentMatch.rivalStats.forEach(j => {
        if (j.goalTypes && j.goalTypes['h+']) {
            totalHPlusRival += j.goalTypes['h+'];
        }
    });

    currentMatch.jugadors.forEach(j => {
        if (j.estadistiques.exclusionTypes) {
            totalExclusionsNoPenaltyCNT += (j.estadistiques.exclusionTypes.normal || 0);
        }
    });

    const conversionRateRival = totalExclusionsNoPenaltyCNT > 0 ? 
        ((totalHPlusRival / totalExclusionsNoPenaltyCNT) * 100).toFixed(1) : '0.0';

    document.getElementById('matchInfo').innerHTML = `
        <div class="info-grid">
            <div class="info-item">
                <div class="info-label">üìÖ Fecha</div>
                <div class="info-value">${date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' })}</div>
            </div>
            <div class="info-item">
                <div class="info-label">${locationIcon} Ubicaci√≥n</div>
                <div class="info-value">${locationText}</div>
            </div>
            <div class="info-item">
                <div class="info-label">üü• Exclusiones CNT</div>
                <div class="info-value">${totalExcCNT}</div>
            </div>
            <div class="info-item">
                <div class="info-label">üü• Exclusiones Rival</div>
                <div class="info-value">${totalExcRival}</div>
            </div>
            ${totalParadesCNT > 0 ? `
            <div class="info-item">
                <div class="info-label">üß§ Parades CNT</div>
                <div class="info-value" style="color: #c084fc;">${totalParadesCNT}</div>
            </div>
            ` : ''}
            <div class="info-item">
                <div class="info-label">üéØ Efici√®ncia Tir CNT</div>
                <div class="info-value" style="color: ${eficienciaTirCNT >= 50 ? '#22c55e' : eficienciaTirCNT >= 30 ? '#fbbf24' : '#ef4444'};">${eficienciaTirCNT}%</div>
            </div>
            <div class="info-item">
                <div class="info-label">üìä Conversi√≥ H+ CNT</div>
                <div class="info-value">${conversionRateCNT}%</div>
            </div>
            <div class="info-item">
                <div class="info-label">üìä Conversi√≥ H+ Rival</div>
                <div class="info-value">${conversionRateRival}%</div>
            </div>
            ${totalAssistenciesCNT > 0 ? `
            <div class="info-item">
                <div class="info-label">üéØ Assist√®ncies CNT</div>
                <div class="info-value" style="color: #86efac;">${totalAssistenciesCNT}</div>
            </div>
            ` : ''}
            ${totalRobatorisCNT > 0 ? `
            <div class="info-item">
                <div class="info-label">üõ°Ô∏è Robatoris CNT</div>
                <div class="info-value" style="color: #7dd3fc;">${totalRobatorisCNT}</div>
            </div>
            ` : ''}
            ${totalPerduesCNT > 0 ? `
            <div class="info-item">
                <div class="info-label">‚ùå P√®rdues CNT</div>
                <div class="info-value" style="color: #fca5a5;">${totalPerduesCNT}</div>
            </div>
            ` : ''}
            ${totalXutsFallatsCNT > 0 ? `
            <div class="info-item">
                <div class="info-label">üéØ‚ùå Xuts Fallats CNT</div>
                <div class="info-value" style="color: #fb923c;">${totalXutsFallatsCNT}</div>
            </div>
            ` : ''}
            ${totalBlocksCNT > 0 ? `
            <div class="info-item">
                <div class="info-label">‚úã Blocks CNT</div>
                <div class="info-value" style="color: #a78bfa;">${totalBlocksCNT}</div>
            </div>
            ` : ''}
            ${totalFaltesRebudesCNT > 0 ? `
            <div class="info-item">
                <div class="info-label">‚ö†Ô∏è Faltes Rebudes</div>
                <div class="info-value" style="color: #fbbf24;">${totalFaltesRebudesCNT}</div>
            </div>
            ` : ''}
			${totalInfraccions2mCNT > 0 ? `
<div class="info-item">
    <div class="info-label">üìè Infraccions 2m CNT</div>
    <div class="info-value" style="color: #fb923c;">${totalInfraccions2mCNT}</div>
</div>
` : ''}
            ${totalContrafaltesCNT > 0 ? `
<div class="info-item">
    <div class="info-label">‚ö†Ô∏è Contrafaltes CNT</div>
    <div class="info-value" style="color: #fbbf24;">${totalContrafaltesCNT}</div>
</div>
` : ''}
        </div>
    `;

    // Stats CNT
    document.getElementById('statsCNT').innerHTML = currentMatch.jugadors
    .filter(j => j.estadistiques.gols > 0 || j.estadistiques.exclusions > 0 || 
             (j.estadistiques.parades || 0) > 0 || (j.estadistiques.assistencies || 0) > 0 || 
             (j.estadistiques.infraccions2m || 0) > 0 ||  // ‚úÖ AFEGEIX AQUESTA L√çNIA
			 (j.estadistiques.contrafaltes || 0) > 0 ||
             (j.estadistiques.robatoris || 0) > 0 || (j.estadistiques.perdues || 0) > 0 || 
             (j.estadistiques.xutsFallats || 0) > 0 || (j.estadistiques.blocks || 0) > 0 ||
             (j.estadistiques.faltesRebudes || 0) > 0)
        .map(j => {
            const goalTypes = j.estadistiques.goalTypes || {};
            const exclusionTypes = j.estadistiques.exclusionTypes || {};
            const penaltyMissed = j.estadistiques.penaltyMissed || 0;
            const parades = j.estadistiques.parades || 0;
            const paradeTypes = j.estadistiques.paradeTypes || {};
            const assistencies = j.estadistiques.assistencies || 0;
			const infraccions2m = j.estadistiques.infraccions2m || 0;
            const robatoris = j.estadistiques.robatoris || 0;
            const perdues = j.estadistiques.perdues || 0;
            const xutsFallats = j.estadistiques.xutsFallats || 0;
            const blocks = j.estadistiques.blocks || 0;
			const contrafaltes = j.estadistiques.contrafaltes || 0;
            const faltesRebudes = j.estadistiques.faltesRebudes || 0;
            
            const isGoalkeeper = j.numero === 1 || j.numero === 13;
            
            let goalTypesText = '';
            if (goalTypes['h+']) goalTypesText += `H+:${goalTypes['h+']} `;
            if (goalTypes.penalty) goalTypesText += `P:${goalTypes.penalty} `;
            if (goalTypes.contra) goalTypesText += `C:${goalTypes.contra} `;
            if (goalTypes.boya) goalTypesText += `B:${goalTypes.boya} `;
            if (goalTypes.normal) goalTypesText += `N:${goalTypes.normal}`;
            
            let exclusionTypesText = '';
            if (exclusionTypes.normal) exclusionTypesText += `EX:${exclusionTypes.normal} `;
            if (exclusionTypes.penalty) exclusionTypesText += `P:${exclusionTypes.penalty}`;
            
            let paradeTypesText = '';
            if (paradeTypes.corner) paradeTypesText += `Corner:${paradeTypes.corner} `;
            if (paradeTypes.rebuig) paradeTypesText += `Rebuig:${paradeTypes.rebuig} `;
            if (paradeTypes.atrapa) paradeTypesText += `Atrapa:${paradeTypes.atrapa}`;
			if (paradeTypes.penal) paradeTypesText += `Penal:${paradeTypes.penal} `;
            
            return `
            <div class="player-stat">
                <div class="player-info">
                    <div class="player-num">${j.numero}</div>
                    <div class="player-name">${j.nom}</div>
                </div>
                <div class="player-stats">
                    ${j.estadistiques.gols > 0 ? `
                    <div class="stat-item">
                        <div class="stat-label">Gols</div>
                        <div class="stat-value">${j.estadistiques.gols}</div>
                    </div>
                    ` : ''}
                    ${goalTypesText ? `
                    <div class="stat-item" style="grid-column: span 2;">
                        <div class="stat-label">Tipus</div>
                        <div class="stat-value" style="font-size: 11px;">${goalTypesText}</div>
                    </div>
                    ` : ''}
                    ${j.estadistiques.exclusions > 0 ? `
                    <div class="stat-item">
                        <div class="stat-label">Exc</div>
                        <div class="stat-value">${j.estadistiques.exclusions}</div>
                    </div>
                    ` : ''}
                    ${exclusionTypesText ? `
                    <div class="stat-item">
                        <div class="stat-label">Tipus</div>
                        <div class="stat-value" style="font-size: 11px;">${exclusionTypesText}</div>
                    </div>
                    ` : ''}
                    ${parades > 0 ? `
                    <div class="stat-item">
                        <div class="stat-label">üß§ Parades</div>
                        <div class="stat-value" style="color: #c084fc;">${parades}</div>
                    </div>
                    ` : ''}
                    ${paradeTypesText ? `
                    <div class="stat-item" style="grid-column: span 2;">
                        <div class="stat-label">Tipus</div>
                        <div class="stat-value" style="font-size: 11px;">${paradeTypesText}</div>
                    </div>
                    ` : ''}
                    ${assistencies > 0 ? `
                    <div class="stat-item">
                        <div class="stat-label">üéØ Asist</div>
                        <div class="stat-value" style="color: #86efac;">${assistencies}</div>
                    </div>
                    ` : ''}
					${infraccions2m > 0 ? `
<div class="stat-item">
    <div class="stat-label">üìè 2m</div>
    <div class="stat-value" style="color: #fb923c;">${infraccions2m}</div>
</div>
` : ''}
                    ${contrafaltes > 0 ? `
<div class="stat-item">
    <div class="stat-label">‚ö†Ô∏è C.F</div>
    <div class="stat-value" style="color: #fbbf24;">${contrafaltes}</div>
</div>
` : ''}
					${robatoris > 0 ? `
                    <div class="stat-item">
                        <div class="stat-label">üõ°Ô∏è Rob</div>
                        <div class="stat-value" style="color: #7dd3fc;">${robatoris}</div>
                    </div>
                    ` : ''}
                    ${perdues > 0 ? `
                    <div class="stat-item">
                        <div class="stat-label">‚ùå P√®rd</div>
                        <div class="stat-value" style="color: #fca5a5;">${perdues}</div>
                    </div>
                    ` : ''}
                    ${xutsFallats > 0 ? `
                    <div class="stat-item">
                        <div class="stat-label">üéØ‚ùå X.F</div>
                        <div class="stat-value" style="color: #fb923c;">${xutsFallats}</div>
                    </div>
                    ` : ''}
                    ${blocks > 0 ? `
                    <div class="stat-item">
                        <div class="stat-label">‚úã Block</div>
                        <div class="stat-value" style="color: #a78bfa;">${blocks}</div>
                    </div>
                    ` : ''}
                    ${faltesRebudes > 0 ? `
                    <div class="stat-item">
                        <div class="stat-label">‚ö†Ô∏è F.Reb</div>
                        <div class="stat-value" style="color: #fbbf24;">${faltesRebudes}</div>
                    </div>
                    ` : ''}
                    ${(j.estadistiques.gols > 0 || xutsFallats > 0) ? `
                    <div class="stat-item">
                        <div class="stat-label">Efic%</div>
                        <div class="stat-value" style="color: ${(() => {
                            const totalXuts = j.estadistiques.gols + xutsFallats;
                            const efic = totalXuts > 0 ? (j.estadistiques.gols / totalXuts * 100) : 0;
                            return efic >= 50 ? '#22c55e' : efic >= 30 ? '#fbbf24' : '#ef4444';
                        })()};">
                            ${(() => {
                                const totalXuts = j.estadistiques.gols + xutsFallats;
                                const efic = totalXuts > 0 ? (j.estadistiques.gols / totalXuts * 100).toFixed(0) : 0;
                                return efic + '%';
                            })()}
                        </div>
                    </div>
                    ` : ''}
                    ${penaltyMissed > 0 ? `
                    <div class="stat-item">
                        <div class="stat-label">Pen.F</div>
                        <div class="stat-value" style="color: #ef4444;">${penaltyMissed}</div>
                    </div>
                    ` : ''}
                </div>
            </div>
        `;
    }).join('');

    // Stats Rival
    const rivalPlayers = currentMatch.rivalStats.filter(p => p.name || p.gols > 0 || p.exclusions > 0);
    document.getElementById('statsRival').innerHTML = rivalPlayers.length === 0 ? '<p>No hay estad√≠sticas del rival</p>' :
        rivalPlayers.map(j => {
            const penaltyMissed = j.penaltyMissed || 0;
            return `
            <div class="player-stat">
                <div class="player-info">
                    <div class="player-num rival">${j.num}</div>
                    <div class="player-name">${j.name || 'Jugador ' + j.num}</div>
                </div>
                <div class="player-stats">
                    <div class="stat-item">
                        <div class="stat-label">Gols</div>
                        <div class="stat-value">${j.gols}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Exc</div>
                        <div class="stat-value">${j.exclusions}</div>
                    </div>
                    ${penaltyMissed > 0 ? `
                    <div class="stat-item">
                        <div class="stat-label">Pen.F</div>
                        <div class="stat-value" style="color: #ef4444;">${penaltyMissed}</div>
                    </div>
                    ` : ''}
                </div>
            </div>
        `}).join('');

    // Alineaciones
    const quarters = ['q1', 'q2', 'q3', 'q4'];
    const labels = ['1¬∫ Cuarto', '2¬∫ Cuarto', '3¬∫ Cuarto', '4¬∫ Cuarto'];
    document.getElementById('lineupsContainer').innerHTML = quarters.map((q, i) => {
        const lineup = currentMatch.lineups[q] || [];
        if (lineup.length === 0) return '';

        const players = lineup.map(num => {
            const player = currentMatch.jugadors.find(j => j.numero === num);
            return player ? `${player.numero}. ${player.nom.split(' ').slice(0, 2).join(' ')}` : num;
        }).join(', ');

        const score = currentMatch.periodScores[q];
        return `
            <div class="period-row">
                <div class="period-label">${labels[i]}</div>
                <div style="font-size: 12px; color: rgba(255,255,255,0.8);">${players}</div>
                <div class="period-score">${score.cnt} - ${score.rival}</div>
            </div>
        `;
    }).join('');

    // Desglose de tipos de goles
    const goalLabels = {
        'h+': 'Superioridad (H+)',
        'penalty': 'Penalty',
        'contra': 'Contraataque',
        'boya': 'Boya',
        'normal': 'Normal'
    };

    const cntGoalStats = {
        'h+': 0,
        'penalty': 0,
        'contra': 0,
        'boya': 0,
        'normal': 0
    };

    currentMatch.jugadors.forEach(j => {
        if (j.estadistiques.goalTypes) {
            Object.keys(cntGoalStats).forEach(type => {
                cntGoalStats[type] += j.estadistiques.goalTypes[type] || 0;
            });
        }
    });

    document.getElementById('goalsScoredBreakdown').innerHTML = Object.keys(cntGoalStats)
        .filter(type => cntGoalStats[type] > 0)
        .map(type => `
            <div class="breakdown-item">
                <div class="breakdown-label">${goalLabels[type]}</div>
                <div class="breakdown-value">${cntGoalStats[type]}</div>
            </div>
        `).join('') || '<p class="no-data" style="padding: 20px;">No hay datos de tipos de goles</p>';

    const rivalGoalStats = {
        'h+': 0,
        'penalty': 0,
        'contra': 0,
        'boya': 0,
        'normal': 0
    };

    currentMatch.rivalStats.forEach(j => {
        if (j.goalTypes) {
            Object.keys(rivalGoalStats).forEach(type => {
                rivalGoalStats[type] += j.goalTypes[type] || 0;
            });
        }
    });

    document.getElementById('goalsReceivedBreakdown').innerHTML = Object.keys(rivalGoalStats)
        .filter(type => rivalGoalStats[type] > 0)
        .map(type => `
            <div class="breakdown-item">
                <div class="breakdown-label">${goalLabels[type]}</div>
                <div class="breakdown-value">${rivalGoalStats[type]}</div>
            </div>
        `).join('') || '<p class="no-data" style="padding: 20px;">No hay datos de tipos de goles</p>';

    // Desglose de exclusiones
    const excStats = {
        cnt: { normal: 0, penalty: 0 },
        rival: { normal: 0, penalty: 0 }
    };

    currentMatch.jugadors.forEach(j => {
        if (j.estadistiques.exclusionTypes) {
            excStats.cnt.normal += j.estadistiques.exclusionTypes.normal || 0;
            excStats.cnt.penalty += j.estadistiques.exclusionTypes.penalty || 0;
        }
    });

    currentMatch.rivalStats.forEach(j => {
        if (j.exclusionTypes) {
            excStats.rival.normal += j.exclusionTypes.normal || 0;
            excStats.rival.penalty += j.exclusionTypes.penalty || 0;
        }
    });

    document.getElementById('exclusionsBreakdown').innerHTML = `
        <div class="breakdown-item">
            <div class="breakdown-label">CNT - Normales</div>
            <div class="breakdown-value">${excStats.cnt.normal}</div>
        </div>
        <div class="breakdown-item">
            <div class="breakdown-label">CNT - Penalty</div>
            <div class="breakdown-value">${excStats.cnt.penalty}</div>
        </div>
        <div class="breakdown-item">
            <div class="breakdown-label">Rival - Normales</div>
            <div class="breakdown-value">${excStats.rival.normal}</div>
        </div>
        <div class="breakdown-item">
            <div class="breakdown-label">Rival - Penalty</div>
            <div class="breakdown-value">${excStats.rival.penalty}</div>
        </div>
    `;
	


    document.getElementById('observations').textContent = currentMatch.observacions || 'No hay observaciones';

    
// ============ MVP DEL PARTIT ============
const playersWithValue = currentMatch.jugadors.map(j => {
    // Calcular gols rebuts pel porter
    const isGoalkeeper = j.numero === 1 || j.numero === 13 || (j.posicio && String(j.posicio).toLowerCase() === 'porter');
    const golsRebuts = isGoalkeeper ? (currentMatch.scoreRival || 0) : 0;
    
    const valor = calculatePlayerValue({
        gols: j.estadistiques.gols,
        goalTypes: j.estadistiques.goalTypes,
        assistencies: j.estadistiques.assistencies,
        infraccions2m: j.estadistiques.infraccions2m || 0,
        contrafaltes: j.estadistiques.contrafaltes || 0,
        robatoris: j.estadistiques.robatoris,
        blocatges: j.estadistiques.blocks || 0,
        parades: j.estadistiques.parades,
        paradeTypes: j.estadistiques.paradeTypes || {},
        faltesRebudes: j.estadistiques.faltesRebudes || 0,
        exclusions: j.estadistiques.exclusions,
        exclusionTypes: j.estadistiques.exclusionTypes || { normal: 0, penalty: 0 },
        penaltyMissed: j.estadistiques.penaltyMissed,
        perdues: j.estadistiques.perdues,
        xutsFallats: j.estadistiques.xutsFallats,
        golsRebuts: golsRebuts
    });
    return { ...j, valor };
}).sort((a, b) => b.valor - a.valor);

const mvp = playersWithValue[0];
const top3 = playersWithValue.slice(0, 3);

document.getElementById('matchInfo').insertAdjacentHTML('afterend', `
    <div class="card" style="margin-top: 20px;">
        <h2 class="section-title">üèÜ MVP del Partit</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
            ${top3.map((player, index) => {
                const medals = ['ü•á', 'ü•à', 'ü•â'];
                const colors = ['#fbbf24', '#d1d5db', '#d97706'];
                const borderColors = ['#f59e0b', '#9ca3af', '#ea580c'];
                const bgColors = [
                    'linear-gradient(135deg, rgba(251, 191, 36, 0.3), rgba(245, 158, 11, 0.1))',
                    'linear-gradient(135deg, rgba(209, 213, 219, 0.3), rgba(156, 163, 175, 0.1))',
                    'linear-gradient(135deg, rgba(217, 119, 6, 0.3), rgba(234, 88, 12, 0.1))'
                ];
                
                return `
                    <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; border: 3px solid ${borderColors[index]}; position: relative;">
                        <div style="position: absolute; top: 10px; right: 10px; font-size: 36px;">
                            ${medals[index]}
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                            <div class="player-num" style="width: 40px; height: 40px; font-size: 18px;">${player.numero}</div>
                            <div>
                                <div style="font-weight: bold; font-size: 16px; color: ${colors[index]};">${player.nom}</div>
                                <div style="font-size: 12px; color: #bae6fd;">Valoraci√≥: ${player.valor.toFixed(1)}</div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 8px;">
                            ${player.estadistiques.gols > 0 ? `
                                <div style="background: rgba(253, 224, 71, 0.2); padding: 6px; border-radius: 4px; text-align: center;">
                                    <div style="color: #bae6fd;">Gols</div>
                                    <div style="color: #fde047; font-weight: bold;">${player.estadistiques.gols}</div>
                                </div>
                            ` : ''}
                            ${(player.estadistiques.assistencies || 0) > 0 ? `
                                <div style="background: rgba(6, 182, 212, 0.2); padding: 6px; border-radius: 4px; text-align: center;">
                                    <div style="color: #bae6fd;">Assists</div>
                                    <div style="color: #06b6d4; font-weight: bold;">${player.estadistiques.assistencies}</div>
                                </div>
                            ` : ''}
                            ${(player.estadistiques.robatoris || 0) > 0 ? `
                                <div style="background: rgba(59, 130, 246, 0.2); padding: 6px; border-radius: 4px; text-align: center;">
                                    <div style="color: #bae6fd;">Robatoris</div>
                                    <div style="color: #3b82f6; font-weight: bold;">${player.estadistiques.robatoris}</div>
                                </div>
                            ` : ''}
                            ${(player.estadistiques.parades || 0) > 0 ? `
                                <div style="background: rgba(139, 92, 246, 0.2); padding: 6px; border-radius: 4px; text-align: center;">
                                    <div style="color: #bae6fd;">Parades</div>
                                    <div style="color: #8b5cf6; font-weight: bold;">${player.estadistiques.parades}</div>
                                </div>
                            ` : ''}
                            ${(player.estadistiques.faltesRebudes || 0) > 0 ? `
                                <div style="background: rgba(251, 191, 36, 0.2); padding: 6px; border-radius: 4px; text-align: center;">
                                    <div style="color: #bae6fd;">Faltes R.</div>
                                    <div style="color: #fbbf24; font-weight: bold;">${player.estadistiques.faltesRebudes}</div>
                                </div>
                            ` : ''}
							${(player.estadistiques.infraccions2m || 0) > 0 ? `
    <div style="background: rgba(251, 146, 60, 0.2); padding: 6px; border-radius: 4px; text-align: center;">
        <div style="color: #bae6fd;">2m</div>
        <div style="color: #fb923c; font-weight: bold;">${player.estadistiques.infraccions2m}</div>
    </div>
` : ''}
                            ${(player.estadistiques.contrafaltes || 0) > 0 ? `
    <div style="background: rgba(251, 191, 36, 0.2); padding: 6px; border-radius: 4px; text-align: center;">
        <div style="color: #bae6fd;">C.F</div>
        <div style="color: #fbbf24; font-weight: bold;">${player.estadistiques.contrafaltes}</div>
    </div>
` : ''}
							${player.estadistiques.exclusions > 0 ? `
                                <div style="background: rgba(239, 68, 68, 0.2); padding: 6px; border-radius: 4px; text-align: center;">
                                    <div style="color: #bae6fd;">Exc</div>
                                    <div style="color: #ef4444; font-weight: bold;">${player.estadistiques.exclusions}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('')}
        </div>
    </div>
`);


	// Generar gr√°ficas
    renderScoreEvolutionChart();
    renderOffenseDefenseChart();
    renderPlayerEfficiencyChart();
    renderMatchTimeline();
    renderSingleMatchStatsTable();
    renderPlayingTimes();
    renderMatchGoalZones();
    renderMatchFieldZones();
    // ‚úÖ AFEGIR AQU√ç les zones de gols rebuts pels porters
    
    // Zones de Porteria dels Porters (nom√©s per aquest partit)
// ‚úÖ Obtenir noms reals dels porters del partit actual
const gk1 = currentMatch.jugadors.find(j => j.numero === 1);
const gk13 = currentMatch.jugadors.find(j => j.numero === 13);

const matchGoalkeeperZones = {
    1: { num: 1, name: gk1 ? gk1.nom : 'Porter 1', totalGolsRebuts: 0, zones: {} },
    13: { num: 13, name: gk13 ? gk13.nom : 'Porter 13', totalGolsRebuts: 0, zones: {} }
};
    
    // Inicialitzar zones
    [1, 13].forEach(gkNum => {
        matchGoalkeeperZones[gkNum].zones = {
            'top-left': 0, 'top-center': 0, 'top-right': 0,
            'mid-left': 0, 'mid-center': 0, 'mid-right': 0,
            'bottom-left': 0, 'bottom-center': 0, 'bottom-right': 0,
            'unknown': 0
        };
    });
    
    // Calcular zones dels gols rebuts en aquest partit
    currentMatch.jugadors.forEach(j => {
        if ((j.numero === 1 || j.numero === 13) && j.estadistiques.golsRebutsZones) {
            Object.keys(j.estadistiques.golsRebutsZones).forEach(zone => {
                const count = j.estadistiques.golsRebutsZones[zone] || 0;
                matchGoalkeeperZones[j.numero].zones[zone] += count;
                matchGoalkeeperZones[j.numero].totalGolsRebuts += count;
            });
        }
    });
    
    // Nom√©s mostrar si hi ha dades
    const hasGoalkeeperData = matchGoalkeeperZones[1].totalGolsRebuts > 0 || 
                              matchGoalkeeperZones[13].totalGolsRebuts > 0;
    
    if (hasGoalkeeperData) {
        const matchGkZonesHTML = `
            <div class="card" id="goalkeeperZonesCard">
                <h2 class="section-title">üß§ Zones de Gols Rebuts pels Porters</h2>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    ${[1, 13].map(gkNum => {
                        const gk = matchGoalkeeperZones[gkNum];
                        if (gk.totalGolsRebuts === 0) return '';
                        
                        const zoneOrder = [
                            'top-left', 'top-center', 'top-right',
                            'mid-left', 'mid-center', 'mid-right',
                            'bottom-left', 'bottom-center', 'bottom-right'
                        ];
                        
                        const zoneLabels = {
                            'top-left': '‚¨ÜÔ∏èE',
                            'top-center': '‚¨ÜÔ∏èC',
                            'top-right': '‚¨ÜÔ∏èD',
                            'mid-left': '‚û°Ô∏èE',
                            'mid-center': 'üéØ',
                            'mid-right': '‚¨ÖÔ∏èD',
                            'bottom-left': '‚¨áÔ∏èE',
                            'bottom-center': '‚¨áÔ∏èB',
                            'bottom-right': '‚¨áÔ∏èD'
                        };
                        
                        const maxCount = Math.max(...zoneOrder.map(z => gk.zones[z] || 0));
                        
                        // Trobar zona m√©s feble
                        const weakestZone = zoneOrder.reduce((max, zone) => 
                            (gk.zones[zone] || 0) > (gk.zones[max] || 0) ? zone : max
                        , zoneOrder[0]);
                        
                        const weakestZoneLabel = {
                            'top-left': 'Dalt Esquerra',
                            'top-center': 'Dalt Centre',
                            'top-right': 'Dalt Dreta',
                            'mid-left': 'Centre Esquerra',
                            'mid-center': 'Centre',
                            'mid-right': 'Centre Dreta',
                            'bottom-left': 'Baix Esquerra',
                            'bottom-center': 'Baix Centre',
                            'bottom-right': 'Baix Dreta'
                        }[weakestZone];
                        
                        return `
                            <div style="background: rgba(0, 0, 0, 0.2); padding: 12px; border-radius: 8px;">
                                <div style="text-align: center; margin-bottom: 10px;">
                                    <div style="font-size: 12px; font-weight: bold; color: #22d3ee;">
                                        ${gk.num}. ${gk.name.split(' ').slice(0, 2).join(' ')}
                                    </div>
                                    <div style="font-size: 10px; color: #bae6fd; margin-top: 2px;">
                                        ${gk.totalGolsRebuts} gols rebuts
                                    </div>
                                </div>
                                
                                <div class="goal-zone-heatmap" style="max-width: 200px; margin: 0 auto;">
                                    ${zoneOrder.map(zone => {
                                        const count = gk.zones[zone] || 0;
                                        const percentage = gk.totalGolsRebuts > 0 ? 
                                            ((count / gk.totalGolsRebuts) * 100).toFixed(1) : 0;
                                        const intensity = maxCount > 0 ? count / maxCount : 0;
                                        const bgColor = getHeatmapColor(intensity);
                                        
                                        return `
                                            <div class="goal-zone-cell" style="background: ${bgColor};">
                                                <div class="zone-label">${zoneLabels[zone]}</div>
                                                <div class="zone-count">${count}</div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                                
                                ${gk.zones[weakestZone] > 0 ? `
                                    <div style="text-align: center; margin-top: 10px; font-size: 10px; color: #fca5a5;">
                                        ‚ö†Ô∏è Zona m√©s vulnerable: ${weakestZoneLabel} (${gk.zones[weakestZone]})
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
        
        // ‚úÖ Inserir DESPR√âS del segon card de zones (el que t√© id matchGoalZonesContainer)
        // Buscar tots els cards amb zones
        const allCards = document.querySelectorAll('.card');
        let matchZonesCard = null;
        
        allCards.forEach(card => {
            if (card.querySelector('#matchGoalZonesContainer')) {
                matchZonesCard = card;
            }
        });
        
        if (matchZonesCard) {
            // Esborrar si ja existeix
            const existingGKCard = document.getElementById('goalkeeperZonesCard');
            if (existingGKCard) {
                existingGKCard.remove();
            }
            
            matchZonesCard.insertAdjacentHTML('afterend', matchGkZonesHTML);
        }
    }
    
    const pdfButton = document.getElementById('pdfMatchButton');
    if (pdfButton) {
        pdfButton.style.display = 'inline-block';
    }
	 renderGoalkeeperSavesChart(currentMatch);
}  // ‚Üê Tancament de displayMatchData()
       
function sortSingleMatchTable(column) {
    if (singleMatchSortColumn === column) {
        singleMatchSortOrder = singleMatchSortOrder === 'desc' ? 'asc' : 'desc';
    } else {
        singleMatchSortColumn = column;
        singleMatchSortOrder = 'desc';
    }
    renderSingleMatchStatsTable();
}
 function renderSingleMatchStatsTable() {
    const table = document.getElementById('singleMatchStatsTable');
    if (!table || !currentMatch) return;

    const players = currentMatch.jugadors.map(j => {
        const stats = j.estadistiques;
        const goles = stats.gols;
        const xutsTotal = goles + (stats.xutsFallats || 0);
        const eficiencia = xutsTotal > 0 ? ((goles / xutsTotal) * 100).toFixed(1) : '0.0';
        
        // ‚úÖ SUMAR blocks i blocatges
        const totalBlocks = (stats.blocks || 0) + (stats.blocatges || 0);
        
        const valor = calculatePlayerValue({
    gols: stats.gols,
    goalTypes: stats.goalTypes,
    assistencies: stats.assistencies,
    infraccions2m: stats.infraccions2m || 0,  // ‚úÖ AFEGEIX
	contrafaltes: stats.contrafaltes || 0,
    robatoris: stats.robatoris,
    blocatges: totalBlocks,
    parades: stats.parades,
	paradeTypes: stats.paradeTypes || {},
    faltesRebudes: stats.faltesRebudes || 0,
    exclusions: stats.exclusions,
    exclusionTypes: stats.exclusionTypes || { normal: 0, penalty: 0 },
    penaltyMissed: stats.penaltyMissed,
    perdues: stats.perdues,
    xutsFallats: stats.xutsFallats
});

        return {
            num: j.numero,
            nom: j.nom,
            gols: goles,
            hPlus: stats.goalTypes?.['h+'] || 0,
            penalty: stats.goalTypes?.penalty || 0,
            contra: stats.goalTypes?.contra || 0,
            boya: stats.goalTypes?.boya || 0,
            normal: stats.goalTypes?.normal || 0,
            exclusions: stats.exclusions,
            parades: stats.parades || 0,
            assistencies: stats.assistencies || 0,
			infraccions2m: stats.infraccions2m || 0,
            robatoris: stats.robatoris || 0,
            blocks: totalBlocks,  // ‚úÖ AFEGIR AQUESTA L√çNIA
            infraccions2m: stats.infraccions2m || 0,
			perdues: stats.perdues || 0,
			contrafaltes: stats.contrafaltes || 0,
            faltesRebudes: stats.faltesRebudes || 0,
            xutsFallats: stats.xutsFallats || 0,
            penaltyMissed: stats.penaltyMissed || 0,
            eficiencia: eficiencia,
           
        };
    });

   // Aplicar ordenaci√≥ segons la columna seleccionada
   players.sort((a, b) => {
       let valA, valB;
       
       switch(singleMatchSortColumn) {
           case 'num':
               valA = a.num;
               valB = b.num;
               break;
           case 'nom':
               return singleMatchSortOrder === 'desc' 
                   ? b.nom.localeCompare(a.nom)
                   : a.nom.localeCompare(b.nom);
           case 'gols':
               valA = a.gols;
               valB = b.gols;
               break;
           case 'hPlus':
               valA = a.hPlus;
               valB = b.hPlus;
               break;
           case 'penalty':
               valA = a.penalty;
               valB = b.penalty;
               break;
           case 'contra':
               valA = a.contra;
               valB = b.contra;
               break;
           case 'boya':
               valA = a.boya;
               valB = b.boya;
               break;
           case 'normal':
               valA = a.normal;
               valB = b.normal;
               break;
           case 'exclusions':
               valA = a.exclusions;
               valB = b.exclusions;
               break;
           case 'parades':
               valA = a.parades;
               valB = b.parades;
               break;
           case 'assistencies':
               valA = a.assistencies;
               valB = b.assistencies;
               break;
           case 'robatoris':
               valA = a.robatoris;
               valB = b.robatoris;
               break;
           case 'blocks':
               valA = a.blocks;
               valB = b.blocks;
               break;
           case 'infraccions2m':
               valA = a.infraccions2m;
               valB = b.infraccions2m;
               break;
			case 'contrafaltes':
    valA = a.contrafaltes;
    valB = b.contrafaltes;
    break;   
           case 'perdues':
               valA = a.perdues;
               valB = b.perdues;
               break;
           case 'faltesRebudes':
               valA = a.faltesRebudes;
               valB = b.faltesRebudes;
               break;
           case 'xutsFallats':
               valA = a.xutsFallats;
               valB = b.xutsFallats;
               break;
           case 'penaltyMissed':
               valA = a.penaltyMissed;
               valB = b.penaltyMissed;
               break;
           case 'eficiencia':
               valA = parseFloat(a.eficiencia);
               valB = parseFloat(b.eficiencia);
               break;
           
           default:
               return 0;
       }
       
       return singleMatchSortOrder === 'desc' ? valB - valA : valA - valB;
   });
   const getSortIndicator = (column) => {
       if (singleMatchSortColumn !== column) return '';
       return singleMatchSortOrder === 'desc' ? ' ‚ñº' : ' ‚ñ≤';
   };
    table.innerHTML = `
     <thead>
<tr>
    <th rowspan="2" onclick="sortSingleMatchTable('num')" style="cursor: pointer; vertical-align: middle;">N¬∫${getSortIndicator('num')}</th>
    <th rowspan="2" onclick="sortSingleMatchTable('nom')" style="cursor: pointer; vertical-align: middle;">Jugador${getSortIndicator('nom')}</th>
    <th rowspan="2" onclick="sortSingleMatchTable('gols')" style="cursor: pointer; vertical-align: middle;">Gols${getSortIndicator('gols')}</th>
    
        <th colspan="5" style="background: rgba(34, 211, 238, 0.2); text-align: center;" title="Tipus de Gols">üéØ TIPUS GOLS</th>
        <th colspan="6" style="background: rgba(34, 197, 94, 0.2); text-align: center;" title="Accions Positives">‚úÖ POSITIVES</th>
        <th colspan="5" style="background: rgba(239, 68, 68, 0.2); text-align: center;" title="Accions Negatives">‚ùå NEGATIVES</th>
		<th rowspan="2" onclick="sortSingleMatchTable('eficiencia')" style="cursor: pointer; vertical-align: middle;">Efic%${getSortIndicator('eficiencia')}</th>
        
    </tr>
    <tr style="font-size: 11px;">
        <!-- Tipus de Gols (5 columnes) -->
        <th onclick="sortSingleMatchTable('hPlus')" style="cursor: pointer;">H+${getSortIndicator('hPlus')}</th>
        <th onclick="sortSingleMatchTable('penalty')" style="cursor: pointer;">Pen${getSortIndicator('penalty')}</th>
        <th onclick="sortSingleMatchTable('contra')" style="cursor: pointer;">Con${getSortIndicator('contra')}</th>
        <th onclick="sortSingleMatchTable('boya')" style="cursor: pointer;">Boy${getSortIndicator('boya')}</th>
        <th onclick="sortSingleMatchTable('normal')" style="cursor: pointer;">Nor${getSortIndicator('normal')}</th>
        
        <!-- Positives (6 columnes) -->
        <th onclick="sortSingleMatchTable('parades')" style="cursor: pointer;">üß§ Par${getSortIndicator('parades')}</th>
        <th onclick="sortSingleMatchTable('assistencies')" style="cursor: pointer;">üéØ Ast${getSortIndicator('assistencies')}</th>
        <th onclick="sortSingleMatchTable('robatoris')" style="cursor: pointer;">üõ°Ô∏è Rob${getSortIndicator('robatoris')}</th>
        <th onclick="sortSingleMatchTable('blocks')" style="cursor: pointer;">üö´ Blk${getSortIndicator('blocks')}</th>
        <th onclick="sortSingleMatchTable('faltesRebudes')" style="cursor: pointer;">‚ö†Ô∏è FR${getSortIndicator('faltesRebudes')}</th>
        <th onclick="sortSingleMatchTable('exclusions')" style="cursor: pointer;">Exc${getSortIndicator('exclusions')}</th>
        
        <!-- Negatives (6 columnes) -->
        <th onclick="sortSingleMatchTable('infraccions2m')" style="cursor: pointer;">üìè 2m${getSortIndicator('infraccions2m')}</th>
        <th onclick="sortSingleMatchTable('contrafaltes')" style="cursor: pointer;">‚ö†Ô∏è CF${getSortIndicator('contrafaltes')}</th>
        <th onclick="sortSingleMatchTable('perdues')" style="cursor: pointer;">‚ùå P√®r${getSortIndicator('perdues')}</th>
        <th onclick="sortSingleMatchTable('xutsFallats')" style="cursor: pointer;">üö´ Xut${getSortIndicator('xutsFallats')}</th>
        <th onclick="sortSingleMatchTable('penaltyMissed')" style="cursor: pointer;">PenF${getSortIndicator('penaltyMissed')}</th>
    </tr>
</thead>
        <tbody>
            ${players.map((p, index) => {
                // Colors per al podi
                const rankColor = index === 0 ? 'background: rgba(255, 215, 0, 0.2);' :
                                 index === 1 ? 'background: rgba(192, 192, 192, 0.2);' :
                                 index === 2 ? 'background: rgba(205, 127, 50, 0.2);' : '';
                
                 return `
                    <tr style="${rankColor}">
                        <td>${p.num}</td>
                        <td><strong>${getShortPlayerName(p.nom)}</strong></td>
                        <td>${p.gols}</td>
                        <!-- Tipus Gols (5) -->
                        <td>${p.hPlus}</td>
                        <td>${p.penalty}</td>
                        <td>${p.contra}</td>
                        <td>${p.boya}</td>
                        <td>${p.normal}</td>
                        <!-- Positives (6) -->
                        <td>${p.parades}</td>
                        <td>${p.assistencies}</td>
                        <td>${p.robatoris}</td>
                        <td>${p.blocks}</td>
                        <td>${p.faltesRebudes}</td>
                        <td>${p.exclusions}</td>
                        <!-- Negatives (6) -->
                        <td>${p.infraccions2m}</td>
                        <td>${p.contrafaltes}</td>
                        <td>${p.perdues}</td>
                        <td>${p.xutsFallats}</td>
                        <td>${p.penaltyMissed}</td>
                        <!-- Efic i Valor -->
                        <td>${p.eficiencia}%</td>
                      
                    </tr>
                `;
            }).join('')}
        </tbody>
    `;
}
 function renderScoreEvolutionChart() {
            const ctx = document.getElementById('scoreEvolutionChart');
            if (!ctx) return;
            
            if (window.scoreEvolutionChartInstance) {
                window.scoreEvolutionChartInstance.destroy();
            }
            
            const periods = ['Inicio', '1Q', '2Q', '3Q', '4Q'];
            const cntScores = [0];
            const rivalScores = [0];
            
            ['q1', 'q2', 'q3', 'q4'].forEach(q => {
                const lastCnt = cntScores[cntScores.length - 1];
                const lastRival = rivalScores[rivalScores.length - 1];
                cntScores.push(lastCnt + currentMatch.periodScores[q].cnt);
                rivalScores.push(lastRival + currentMatch.periodScores[q].rival);
            });
            
            window.scoreEvolutionChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: periods,
                    datasets: [
                        {
                            label: 'CN Terrassa',
                            data: cntScores,
                            borderColor: '#22d3ee',
                            backgroundColor: 'rgba(34, 211, 238, 0.1)',
                            tension: 0.3,
                            fill: true,
                            pointRadius: 5,
                            pointHoverRadius: 7
                        },
                        {
                            label: currentMatch.rivalTeam || 'Rival',
                            data: rivalScores,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.3,
                            fill: true,
                            pointRadius: 5,
                            pointHoverRadius: 7
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { 
                            display: true,
                            labels: { color: 'white', font: { size: 14 } }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            ticks: { color: 'white', stepSize: 1 },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        x: { 
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
        }

        function renderOffenseDefenseChart() {
            const ctx = document.getElementById('offenseDefenseChart');
            if (!ctx) return;
            
            if (window.offenseDefenseChartInstance) {
                window.offenseDefenseChartInstance.destroy();
            }
            
            const cntGoalStats = { 'h+': 0, 'penalty': 0, 'contra': 0, 'boya': 0, 'normal': 0 };
            const rivalGoalStats = { 'h+': 0, 'penalty': 0, 'contra': 0, 'boya': 0, 'normal': 0 };
            
            currentMatch.jugadors.forEach(j => {
                if (j.estadistiques.goalTypes) {
                    Object.keys(cntGoalStats).forEach(type => {
                        cntGoalStats[type] += j.estadistiques.goalTypes[type] || 0;
                    });
                }
            });
            
            currentMatch.rivalStats.forEach(j => {
                if (j.goalTypes) {
                    Object.keys(rivalGoalStats).forEach(type => {
                        rivalGoalStats[type] += j.goalTypes[type] || 0;
                    });
                }
            });
            
            const labels = ['H+', 'Penalty', 'Contra', 'Boya', 'Normal'];
            const cntData = [cntGoalStats['h+'], cntGoalStats.penalty, cntGoalStats.contra, cntGoalStats.boya, cntGoalStats.normal];
            const rivalData = [rivalGoalStats['h+'], rivalGoalStats.penalty, rivalGoalStats.contra, rivalGoalStats.boya, rivalGoalStats.normal];
            
            window.offenseDefenseChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Goles a Favor',
                            data: cntData,
                            backgroundColor: '#22c55e'
                        },
                        {
                            label: 'Goles en Contra',
                            data: rivalData,
                            backgroundColor: '#ef4444'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { 
                            display: true,
                            labels: { color: 'white', font: { size: 14 } }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            ticks: { color: 'white', stepSize: 1 },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        x: { 
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
        }

        function renderPlayerEfficiencyChart() {
            const ctx = document.getElementById('playerEfficiencyChart');
            if (!ctx) return;
            
            if (window.playerEfficiencyChartInstance) {
                window.playerEfficiencyChartInstance.destroy();
            }
            
            const playersWithStats = currentMatch.jugadors
                .filter(j => j.estadistiques.gols > 0 || j.estadistiques.exclusions > 0)
                .sort((a, b) => b.estadistiques.gols - a.estadistiques.gols);
            
            const labels = playersWithStats.map(j => `${j.numero}. ${getShortPlayerName(j.nom)}`);
            const goalsData = playersWithStats.map(j => j.estadistiques.gols);
            const exclusionsData = playersWithStats.map(j => j.estadistiques.exclusions);
            
            window.playerEfficiencyChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Goles',
                            data: goalsData,
                            backgroundColor: '#fde047'
                        },
                        {
                            label: 'Exclusiones',
                            data: exclusionsData,
                            backgroundColor: '#f97316'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    indexAxis: 'y',
                    plugins: {
                        legend: { 
                            display: true,
                            labels: { color: 'white', font: { size: 14 } }
                        }
                    },
                    scales: {
                        x: { 
                            beginAtZero: true,
                            ticks: { color: 'white', stepSize: 1 },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        y: { 
                            ticks: { color: 'white', font: { size: 11 } },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
        }

function displayComparison() {
    if (allMatches.length === 0) return;
    
    
    const wins = allMatches.filter(m => m.scoreCNT > m.scoreRival).length;
    const losses = allMatches.filter(m => m.scoreCNT < m.scoreRival).length;
    const draws = allMatches.filter(m => m.scoreCNT === m.scoreRival).length;
    const totalGoals = allMatches.reduce((sum, m) => sum + m.scoreCNT, 0);
    const totalGoalsAgainst = allMatches.reduce((sum, m) => sum + m.scoreRival, 0);
    const avgGoals = (totalGoals / allMatches.length).toFixed(1);
    const avgGoalsAgainst = (totalGoalsAgainst / allMatches.length).toFixed(1);

    // Filtrar nom√©s partits amb dades de xuts fallats
    const matchesWithShotData = allMatches.filter(m => {
        const hasXutsFallats = m.jugadors.some(j => (j.estadistiques.xutsFallats || 0) > 0);
        return hasXutsFallats;
    });

    const totalXutsFallats = matchesWithShotData.reduce((sum, m) => {
        return sum + m.jugadors.reduce((s, j) => s + (j.estadistiques.xutsFallats || 0), 0);
    }, 0);

    const totalGoalsWithShotData = matchesWithShotData.reduce((sum, m) => sum + m.scoreCNT, 0);
    const totalXutsGlobal = totalGoalsWithShotData + totalXutsFallats;
    const eficienciaGlobal = totalXutsGlobal > 0 ? ((totalGoalsWithShotData / totalXutsGlobal) * 100).toFixed(1) : '0.0';
    const numMatchesWithShotData = matchesWithShotData.length;
    
    let totalPenMissedCNT = 0;
    let totalPenMissedRival = 0;
    let totalHPlusCNT = 0;
    let totalExclusionsNoPenaltyRival = 0;
    let totalHPlusRival = 0;
    let totalExclusionsNoPenaltyCNT = 0;

    const globalGoalStats = {
        'h+': 0,
        'penalty': 0,
        'contra': 0,
        'boya': 0,
        'normal': 0
    };

    const globalExcStats = {
        cnt: { normal: 0, penalty: 0 },
        rival: { normal: 0, penalty: 0 }
    };

    allMatches.forEach(match => {
        match.jugadors.forEach(j => {
            totalPenMissedCNT += (j.estadistiques.penaltyMissed || 0);
            if (j.estadistiques.goalTypes) {
                Object.keys(globalGoalStats).forEach(type => {
                    globalGoalStats[type] += j.estadistiques.goalTypes[type] || 0;
                });
                if (j.estadistiques.goalTypes['h+']) {
                    totalHPlusCNT += j.estadistiques.goalTypes['h+'];
                }
            }
            if (j.estadistiques.exclusionTypes) {
                globalExcStats.cnt.normal += j.estadistiques.exclusionTypes.normal || 0;
                globalExcStats.cnt.penalty += j.estadistiques.exclusionTypes.penalty || 0;
                totalExclusionsNoPenaltyCNT += j.estadistiques.exclusionTypes.normal || 0;
            }
        });
        
        match.rivalStats.forEach(j => {
            totalPenMissedRival += (j.penaltyMissed || 0);
            if (j.goalTypes && j.goalTypes['h+']) {
                totalHPlusRival += j.goalTypes['h+'];
            }
            if (j.exclusionTypes) {
                totalExclusionsNoPenaltyRival += (j.exclusionTypes.normal || 0);
                globalExcStats.rival.normal += j.exclusionTypes.normal || 0;
                globalExcStats.rival.penalty += j.exclusionTypes.penalty || 0;
            }
        });
    });

    const conversionRateCNT = totalExclusionsNoPenaltyRival > 0 ? 
        ((totalHPlusCNT / totalExclusionsNoPenaltyRival) * 100).toFixed(1) : '0.0';

    const conversionRateRival = totalExclusionsNoPenaltyCNT > 0 ? 
        ((totalHPlusRival / totalExclusionsNoPenaltyCNT) * 100).toFixed(1) : '0.0';

    // NUEVO: Rendimiento Casa vs Fuera
    const homeMatches = allMatches.filter(m => m.matchLocation === 'home' || !m.matchLocation);
    const awayMatches = allMatches.filter(m => m.matchLocation === 'away');

    const homeWins = homeMatches.filter(m => m.scoreCNT > m.scoreRival).length;
    const homeLosses = homeMatches.filter(m => m.scoreCNT < m.scoreRival).length;
    const homeDraws = homeMatches.filter(m => m.scoreCNT === m.scoreRival).length;

    const awayWins = awayMatches.filter(m => m.scoreCNT > m.scoreRival).length;
    const awayLosses = awayMatches.filter(m => m.scoreCNT < m.scoreRival).length;
    const awayDraws = awayMatches.filter(m => m.scoreCNT === m.scoreRival).length;

    const homeGoalsFor = homeMatches.reduce((sum, m) => sum + m.scoreCNT, 0);
    const homeGoalsAgainst = homeMatches.reduce((sum, m) => sum + m.scoreRival, 0);
    const awayGoalsFor = awayMatches.reduce((sum, m) => sum + m.scoreCNT, 0);
    const awayGoalsAgainst = awayMatches.reduce((sum, m) => sum + m.scoreRival, 0);

    document.getElementById('summaryGrid').innerHTML = `
        <div class="info-item">
            <div class="info-label">Partidos Jugados</div>
            <div class="info-value">${allMatches.length}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Victorias</div>
            <div class="info-value win">${wins}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Derrotas</div>
            <div class="info-value loss">${losses}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Empates</div>
            <div class="info-value draw">${draws}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Goles a Favor</div>
            <div class="info-value">${totalGoals}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Goles en Contra</div>
            <div class="info-value">${totalGoalsAgainst}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Media Goles/Partido</div>
            <div class="info-value">${avgGoals}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Media Goles en Contra</div>
            <div class="info-value">${avgGoalsAgainst}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Penaltis Fallados CNT</div>
            <div class="info-value" style="color: ${totalPenMissedCNT === 0 ? '#22c55e' : '#ef4444'}">${totalPenMissedCNT}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Penaltis Fallados Rival</div>
            <div class="info-value" style="color: ${totalPenMissedRival === 0 ? '#22c55e' : '#ef4444'}">${totalPenMissedRival}</div>
        </div>
        <div class="info-item">
            <div class="info-label">üè† Partidos en Casa</div>
            <div class="info-value">${homeMatches.length}</div>
            <div style="font-size: 10px; color: #bae6fd; margin-top: 4px;">
                ${homeWins}V - ${homeLosses}D - ${homeDraws}E
            </div>
        </div>
        <div class="info-item">
            <div class="info-label">üéØ Efici√®ncia Global de Tir</div>
            <div class="info-value" style="color: ${totalXutsGlobal > 0 ? (eficienciaGlobal >= 50 ? '#22c55e' : eficienciaGlobal >= 30 ? '#fbbf24' : '#ef4444') : '#bae6fd'};">
                ${totalXutsGlobal > 0 ? `${totalGoals}/${totalXutsGlobal}` : 'No hi ha dades'}<br>
                ${totalXutsGlobal > 0 ? `<span style="font-size: 14px;">(${eficienciaGlobal}%)</span>` : ''}
            </div>
        </div>
        <div class="info-item">
            <div class="info-label">‚úàÔ∏è Partidos Fuera</div>
            <div class="info-value">${awayMatches.length}</div>
            <div style="font-size: 10px; color: #bae6fd; margin-top: 4px;">
                ${awayWins}V - ${awayLosses}D - ${awayDraws}E
            </div>
        </div>
        <div class="info-item">
            <div class="info-label">üè† Media Goles Casa</div>
            <div class="info-value" style="color: #fde047;">
                ${homeMatches.length > 0 ? (homeGoalsFor / homeMatches.length).toFixed(1) : '-'}
            </div>
            <div style="font-size: 10px; color: #bae6fd; margin-top: 4px;">
                GC: ${homeMatches.length > 0 ? (homeGoalsAgainst / homeMatches.length).toFixed(1) : '-'}
            </div>
        </div>
        <div class="info-item">
            <div class="info-label">‚úàÔ∏è Media Goles Fuera</div>
            <div class="info-value" style="color: #fde047;">
                ${awayMatches.length > 0 ? (awayGoalsFor / awayMatches.length).toFixed(1) : '-'}
            </div>
            <div style="font-size: 10px; color: #bae6fd; margin-top: 4px;">
                GC: ${awayMatches.length > 0 ? (awayGoalsAgainst / awayMatches.length).toFixed(1) : '-'}
            </div>
        </div>
        <div class="info-item">
            <div class="info-label">Conversi√≥n H+ CNT (Total)</div>
            <div class="info-value" style="color: ${conversionRateCNT >= 50 ? '#22c55e' : conversionRateCNT >= 30 ? '#fbbf24' : '#ef4444'}">
                ${totalHPlusCNT}/${totalExclusionsNoPenaltyRival}<br>
                <span style="font-size: 14px;">(${conversionRateCNT}%)</span>
            </div>
        </div>
        <div class="info-item">
            <div class="info-label">Conversi√≥n H+ Rival (Total)</div>
            <div class="info-value" style="color: ${conversionRateRival >= 50 ? '#ef4444' : conversionRateRival >= 30 ? '#fbbf24' : '#22c55e'}">
                ${totalHPlusRival}/${totalExclusionsNoPenaltyCNT}<br>
                <span style="font-size: 14px;">(${conversionRateRival}%)</span>
            </div>
        </div>
    `;

    const goalLabels = {
        'h+': 'Superioridad (H+)',
        'penalty': 'Penaltis',
        'contra': 'Contraataques',
        'boya': 'Boya',
        'normal': 'Normales'
    };

    document.getElementById('totalGoalsBreakdown').innerHTML = Object.keys(globalGoalStats)
        .filter(type => globalGoalStats[type] > 0)
        .map(type => `
            <div class="breakdown-item">
                <div class="breakdown-label">${goalLabels[type]}</div>
                <div class="breakdown-value">${globalGoalStats[type]}</div>
                <div style="font-size: 11px; color: #bae6fd; margin-top: 4px;">
                    ${((globalGoalStats[type] / totalGoals) * 100).toFixed(1)}%
                </div>
            </div>
        `).join('') || '<p class="no-data" style="padding: 20px;">No hay datos de tipos de goles</p>';

    const globalRivalGoalStats = {
        'h+': 0,
        'penalty': 0,
        'contra': 0,
        'boya': 0,
        'normal': 0
    };
    
    allMatches.forEach(match => {
        match.rivalStats.forEach(j => {
            if (j.goalTypes) {
                Object.keys(globalRivalGoalStats).forEach(type => {
                    globalRivalGoalStats[type] += j.goalTypes[type] || 0;
                });
            }
        });
    });

    document.getElementById('totalGoalsReceivedBreakdown').innerHTML = Object.keys(globalRivalGoalStats)
        .filter(type => globalRivalGoalStats[type] > 0)
        .map(type => `
            <div class="breakdown-item">
                <div class="breakdown-label">${goalLabels[type]}</div>
                <div class="breakdown-value">${globalRivalGoalStats[type]}</div>
                <div style="font-size: 11px; color: #bae6fd; margin-top: 4px;">
                    ${((globalRivalGoalStats[type] / totalGoalsAgainst) * 100).toFixed(1)}%
                </div>
            </div>
        `).join('') || '<p class="no-data" style="padding: 20px;">No hay datos de tipos de goles</p>';

    document.getElementById('totalExclusionsBreakdown').innerHTML = `
        <div class="breakdown-item">
            <div class="breakdown-label">CNT - Normales</div>
            <div class="breakdown-value">${globalExcStats.cnt.normal}</div>
        </div>
        <div class="breakdown-item">
            <div class="breakdown-label">CNT - Penaltis</div>
            <div class="breakdown-value">${globalExcStats.cnt.penalty}</div>
        </div>
        <div class="breakdown-item">
            <div class="breakdown-label">Rival - Normales</div>
            <div class="breakdown-value">${globalExcStats.rival.normal}</div>
        </div>
        <div class="breakdown-item">
            <div class="breakdown-label">Rival - Penaltis</div>
            <div class="breakdown-value">${globalExcStats.rival.penalty}</div>
        </div>
    `;

    const playerStats = {};
    const playerMatchAppearances = {};
    
    allMatches.forEach((match, matchIndex) => {
        match.jugadors.forEach(j => {
            const playerName = j.nom.trim();
            
            if (!playerStats[playerName]) {
                playerStats[playerName] = { 
                    num: j.numero,
                    name: playerName, 
                    gols: 0, 
                    exclusions: 0,
                    penaltyMissed: 0,
                    partidos: 0,
                    goalTypes: { 'h+': 0, penalty: 0, contra: 0, boya: 0, normal: 0 },
                    parades: 0,
                    paradeTypes: { corner: 0, rebuig: 0, atrapa: 0, penal: 0 },
                    assistencies: 0,
					infraccions2m: 0,
					contrafaltes: 0,
                    robatoris: 0,
                    perdues: 0,
                    xutsFallats: 0,
                    blocks: 0,
                    faltesRebudes: 0,
                    exclusionTypes: { normal: 0, penalty: 0 }
                };
                playerMatchAppearances[playerName] = new Set();
            }
            
            playerStats[playerName].num = j.numero;
            playerMatchAppearances[playerName].add(matchIndex);
            
            playerStats[playerName].gols += j.estadistiques.gols;
            playerStats[playerName].exclusions += j.estadistiques.exclusions;
            playerStats[playerName].penaltyMissed += (j.estadistiques.penaltyMissed || 0);
            playerStats[playerName].parades += (j.estadistiques.parades || 0);
            playerStats[playerName].assistencies += (j.estadistiques.assistencies || 0);
			playerStats[playerName].infraccions2m += (j.estadistiques.infraccions2m || 0);
			playerStats[playerName].contrafaltes += (j.estadistiques.contrafaltes || 0);
            playerStats[playerName].robatoris += (j.estadistiques.robatoris || 0);
            playerStats[playerName].perdues += (j.estadistiques.perdues || 0);
            playerStats[playerName].xutsFallats += (j.estadistiques.xutsFallats || 0);
            playerStats[playerName].blocks += (j.estadistiques.blocks || 0);
            playerStats[playerName].faltesRebudes += (j.estadistiques.faltesRebudes || 0);
            playerStats[playerName].blocatges += (j.estadistiques.blocatges || 0);
            
            if (j.estadistiques.goalTypes) {
                Object.keys(playerStats[playerName].goalTypes).forEach(type => {
                    playerStats[playerName].goalTypes[type] += j.estadistiques.goalTypes[type] || 0;
                });
            }
            
            if (j.estadistiques.exclusionTypes) {
                if (playerStats[playerName].exclusionTypes) {
                    Object.keys(playerStats[playerName].exclusionTypes).forEach(type => {
                        playerStats[playerName].exclusionTypes[type] += (j.estadistiques.exclusionTypes[type] || 0);
                    });
                }
            } else {
                if (!playerStats[playerName].exclusionTypes) {
                    playerStats[playerName].exclusionTypes = { normal: 0, penalty: 0 };
                }
            }
            
            if (j.estadistiques.paradeTypes) {
                Object.keys(playerStats[playerName].paradeTypes).forEach(type => {
                    playerStats[playerName].paradeTypes[type] += j.estadistiques.paradeTypes[type] || 0;
                });
            }
        });
    });
    
    Object.keys(playerStats).forEach(name => {
        playerStats[name].partidos = playerMatchAppearances[name].size;
    });

    const players = Object.values(playerStats).map(p => {
    const valor = calculatePlayerValue({
        gols: p.gols,
        goalTypes: p.goalTypes,
        assistencies: p.assistencies,
        infraccions2m: p.infraccions2m || 0,  // ‚úÖ AFEGEIX AQUESTA L√çNIA
		contrafaltes: p.contrafaltes || 0,
        robatoris: p.robatoris,
        blocatges: p.blocks || 0,
        parades: p.parades,
		paradeTypes: p.paradeTypes || {},
        faltesRebudes: p.faltesRebudes || 0,
        exclusions: p.exclusions,
        exclusionTypes: p.exclusionTypes || { normal: 0, penalty: 0 },
        penaltyMissed: p.penaltyMissed,
        perdues: p.perdues,
        xutsFallats: p.xutsFallats
    });
    return { ...p, valor };
}).sort((a, b) => a.num - b.num);

    cachedPlayersData = players;
    currentSortColumn = 'num';
    currentSortOrder = 'asc';

    renderComparisonTable(players);

    const topScorers = Object.values(playerStats)
        .filter(p => p.gols > 0)
        .sort((a, b) => b.gols - a.gols)
        .slice(0, 10);

    document.getElementById('allTimeScorers').innerHTML = topScorers.map((p, i) => {
        let rankClass = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
        return `
            <div class="top-scorer-item">
                <div class="player-info">
                    <div class="rank ${rankClass}">${i + 1}</div>
                    <div class="player-num">${p.num}</div>
                    <div class="player-name">${p.name}</div>
                </div>
                <div style="font-size: 24px; font-weight: bold; color: #fde047;">
                    ${p.gols} ü•Öüèê
                </div>
            </div>
        `;
    }).join('');

    renderResultsEvolution();
    renderQuarterDifference();
    renderBestWorstMatches();
    renderRivalsHistory();

    // ============ RANKING MVP GLOBAL ============
    const playersWithAvgValue = Object.values(playerStats).map(p => {
        const valor = calculatePlayerValue({
            gols: p.gols,
            goalTypes: p.goalTypes,
            assistencies: p.assistencies,
			infraccions2m: p.infraccions2m || 0,
			contrafaltes: p.contrafaltes || 0,
            robatoris: p.robatoris,
            blocatges: p.blocks || 0,
            parades: p.parades,
			paradeTypes: p.paradeTypes || {},
            faltesRebudes: p.faltesRebudes || 0,
            exclusions: p.exclusions,
            exclusionTypes: p.exclusionTypes || { normal: 0, penalty: 0 },
            penaltyMissed: p.penaltyMissed,
            perdues: p.perdues,
            xutsFallats: p.xutsFallats
        });
        const avgValor = p.partidos > 0 ? valor / p.partidos : 0;
        return { ...p, valorTotal: valor, valorMitja: avgValor };
    }).sort((a, b) => b.valorTotal - a.valorTotal);

    const mvpContainer = document.createElement('div');
    mvpContainer.className = 'card';
    mvpContainer.innerHTML = `
        <h2 class="section-title">üèÜ R√†n¬≠¬≠quing MVP de la Temporada</h2>
        <p style="font-size: 12px; color: #bae6fd; margin-bottom: 15px;">
            Top 5 jugadors amb millor valoraci√≥ total acumulada
        </p>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
            ${playersWithAvgValue.slice(0, 5).map((player, index) => {
                const medals = ['ü•á', 'ü•à', 'ü•â'];
                const colors = ['#fbbf24', '#d1d5db', '#d97706'];
                const borderColors = ['#f59e0b', '#9ca3af', '#ea580c'];
                const bgColors = [
                    'linear-gradient(135deg, rgba(251, 191, 36, 0.3), rgba(245, 158, 11, 0.1))',
                    'linear-gradient(135deg, rgba(209, 213, 219, 0.3), rgba(156, 163, 175, 0.1))',
                    'linear-gradient(135deg, rgba(217, 119, 6, 0.3), rgba(234, 88, 12, 0.1))'
                ];
                
                return `
                    <div style="background: ${index < 3 ? bgColors[index] : 'rgba(0,0,0,0.2)'}; 
                                padding: 15px; border-radius: 8px; 
                                border: ${index < 3 ? '3px' : '2px'} solid ${index < 3 ? borderColors[index] : 'rgba(255,255,255,0.2)'}; 
                                position: relative;">
                        <div style="position: absolute; top: 10px; right: 10px; font-size: ${index < 3 ? '36px' : '24px'};">
                            ${index < 3 ? medals[index] : `#${index + 1}`}
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                            <div class="player-num" style="width: ${index < 3 ? '45px' : '40px'}; height: ${index < 3 ? '45px' : '40px'}; font-size: ${index < 3 ? '20px' : '16px'};">${player.num}</div>
                            <div>
                                <div style="font-weight: bold; font-size: ${index < 3 ? '18px' : '16px'}; color: ${index < 3 ? colors[index] : '#fff'};">${player.name}</div>
                                <div style="font-size: 11px; color: #bae6fd;">
                                    Valor/Partit: <strong style="color: ${index < 3 ? colors[index] : '#22d3ee'};">${player.valorMitja.toFixed(1)}</strong>
                                </div>
                                <div style="font-size: 10px; color: #94a3b8;">
                                    ${player.partidos} partits ‚Ä¢ Total: ${player.valorTotal.toFixed(0)}
                                </div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(65px, 1fr)); gap: 6px;">
                            ${player.gols > 0 ? `
                                <div style="background: rgba(253, 224, 71, 0.2); padding: 4px; border-radius: 4px; text-align: center;">
                                    <div style="color: #bae6fd; font-size: 9px;">Gols</div>
                                    <div style="color: #fde047; font-weight: bold; font-size: 13px;">${player.gols}</div>
                                </div>
                            ` : ''}
                            ${(player.assistencies || 0) > 0 ? `
                                <div style="background: rgba(6, 182, 212, 0.2); padding: 4px; border-radius: 4px; text-align: center;">
                                    <div style="color: #bae6fd; font-size: 9px;">Assists</div>
                                    <div style="color: #06b6d4; font-weight: bold; font-size: 13px;">${player.assistencies}</div>
                                </div>
                            ` : ''}
                            ${(player.robatoris || 0) > 0 ? `
                                <div style="background: rgba(59, 130, 246, 0.2); padding: 4px; border-radius: 4px; text-align: center;">
                                    <div style="color: #bae6fd; font-size: 9px;">Rob</div>
                                    <div style="color: #3b82f6; font-weight: bold; font-size: 13px;">${player.robatoris}</div>
                                </div>
                            ` : ''}
                            ${(player.parades || 0) > 0 ? `
                                <div style="background: rgba(139, 92, 246, 0.2); padding: 4px; border-radius: 4px; text-align: center;">
                                    <div style="color: #bae6fd; font-size: 9px;">Parades</div>
                                    <div style="color: #8b5cf6; font-weight: bold; font-size: 13px;">${player.parades}</div>
                                </div>
                            ` : ''}
                            ${(player.faltesRebudes || 0) > 0 ? `
                                <div style="background: rgba(251, 191, 36, 0.2); padding: 4px; border-radius: 4px; text-align: center;">
                                    <div style="color: #bae6fd; font-size: 9px;">FR</div>
                                    <div style="color: #fbbf24; font-weight: bold; font-size: 13px;">${player.faltesRebudes}</div>
                                </div>
                            ` : ''}
							${(player.infraccions2m || 0) > 0 ? `
    <div style="background: rgba(251, 146, 60, 0.2); padding: 4px; border-radius: 4px; text-align: center;">
        <div style="color: #bae6fd; font-size: 9px;">2m</div>
        <div style="color: #fb923c; font-weight: bold; font-size: 13px;">${player.infraccions2m}</div>
    </div>
` : ''}
                            ${player.exclusions > 0 ? `
                                <div style="background: rgba(239, 68, 68, 0.2); padding: 4px; border-radius: 4px; text-align: center;">
                                    <div style="color: #bae6fd; font-size: 9px;">Exc</div>
                                    <div style="color: #ef4444; font-weight: bold; font-size: 13px;">${player.exclusions}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('')}
        </div>
    `;

    const comparisonTable = document.querySelector('#comparisonView');
    const tableCard = comparisonTable.querySelector('.card:has(#comparisonTable)');
    
    // ‚úÖ ELIMINAR TOTS ELS MVP CONTAINERS ANTICS
    document.querySelectorAll('.card').forEach(card => {
        const title = card.querySelector('h2.section-title');
        if (title && title.textContent.includes('MVP de la Temporada')) {
            card.remove();
        }
    });
    
    if (tableCard) {
        tableCard.parentNode.insertBefore(mvpContainer, tableCard);
    }

    renderGoalsDistributionChart(playerStats);

    // ‚úÖ ZONES DE GOL DELS JUGADORS
    renderGoalZoneStats();
	renderFieldZoneStats();  // ‚Üê AFEGEIX AQUESTA L√çNIA

    // ‚úÖ ZONES DE GOLS REBUTS PELS PORTERS
    const goalkeeperZones = renderGoalkeeperZoneStats();

    const goalkeeperZonesHTML = `
        <div class="card" id="goalkeeperZonesCard">
            <h2 class="section-title">üß§ An√†lisi de Gols Rebuts pels Porters</h2>
            <p style="font-size: 12px; color: #bae6fd; margin-bottom: 15px;">
                On reben m√©s gols els nostres porters
            </p>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                ${[1, 13].map(gkNum => {
                    const gk = goalkeeperZones[gkNum];
                    if (gk.totalGolsRebuts === 0) return '';
                    
                    const zoneOrder = [
                        'top-left', 'top-center', 'top-right',
                        'mid-left', 'mid-center', 'mid-right',
                        'bottom-left', 'bottom-center', 'bottom-right'
                    ];
                    
                    const zoneLabels = {
                        'top-left': '‚¨ÜÔ∏è Esq',
                        'top-center': '‚¨ÜÔ∏è Centre',
                        'top-right': '‚¨ÜÔ∏è Dret',
                        'mid-left': '‚û°Ô∏è Esq',
                        'mid-center': 'üéØ Centre',
                        'mid-right': '‚¨ÖÔ∏è Dret',
                        'bottom-left': '‚¨áÔ∏è Esq',
                        'bottom-center': '‚¨áÔ∏è Baix',
                        'bottom-right': '‚¨áÔ∏è Dret'
                    };
                    
                    const maxCount = Math.max(...zoneOrder.map(z => gk.zones[z] || 0));
                    
                    return `
                        <div style="background: rgba(0, 0, 0, 0.2); padding: 15px; border-radius: 8px;">
                            <div style="text-align: center; margin-bottom: 12px;">
                                <div style="font-size: 14px; font-weight: bold; color: #22d3ee;">
                                    ${gk.num}. ${gk.name.split(' ').slice(0, 2).join(' ')}
                                </div>
                                <div style="font-size: 12px; color: #bae6fd; margin-top: 4px;">
                                    Total gols rebuts: ${gk.totalGolsRebuts}
                                </div>
                            </div>
                            
                            <div class="goal-zone-heatmap">
                                ${zoneOrder.map(zone => {
                                    const count = gk.zones[zone] || 0;
                                    const percentage = gk.totalGolsRebuts > 0 ? 
                                        ((count / gk.totalGolsRebuts) * 100).toFixed(1) : 0;
                                    const intensity = maxCount > 0 ? count / maxCount : 0;
                                    const bgColor = getHeatmapColor(intensity);
                                    
                                    return `
                                        <div class="goal-zone-cell" style="background: ${bgColor};">
                                            <div class="zone-label">${zoneLabels[zone]}</div>
                                            <div class="zone-count">${count}</div>
                                            <div style="font-size: 9px; color: rgba(255,255,255,0.7);">
                                                ${percentage}%
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            
                            ${gk.zones.unknown > 0 ? `
                                <div style="text-align: center; margin-top: 10px; font-size: 11px; color: #bae6fd;">
                                    ‚ùì Gols sense zona: ${gk.zones.unknown}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('')}
            </div>
        </div>
    `;

    // Inserir el HTML dels porters ABANS de la taula de comparaci√≥
    const comparisonTableCard = document.querySelector('#comparisonView .card:has(#comparisonTable)');
    if (comparisonTableCard) {
        const existingGKCard = document.getElementById('goalkeeperZonesCard');
        if (existingGKCard) {
            existingGKCard.remove();
        }
        comparisonTableCard.insertAdjacentHTML('beforebegin', goalkeeperZonesHTML);
    }

    // ‚úÖ SWIM RACES I GOALKEEPER SAVES AL FINAL
    document.getElementById('swimRacesStatsContainer').innerHTML = renderSwimRacesStats();
    renderGoalkeeperSavesChart(currentMatch);
}
	

        function renderGoalsDistributionChart(playerStats) {
            const ctx = document.getElementById('goalsDistributionChart');
            
			if (!ctx) return;
            
            if (window.goalsDistributionChartInstance) {
                window.goalsDistributionChartInstance.destroy();
            }
            
            const topPlayers = Object.values(playerStats)
                .filter(p => p.gols > 0)
                .sort((a, b) => b.gols - a.gols)
                .slice(0, 8);
            
            const labels = topPlayers.map(p => `${p.num}. ${p.name.split(' ').slice(0, 2).join(' ')}`);
            const data = topPlayers.map(p => p.gols);
            
            const colors = [
                '#22d3ee', '#06b6d4', '#0891b2', '#0e7490',
                '#fde047', '#fbbf24', '#f59e0b', '#d97706'
            ];
            
            window.goalsDistributionChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#1e3a8a'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { 
                            display: true,
                            position: 'right',
                            labels: { 
                                color: 'white', 
                                font: { size: 12 },
                                padding: 10
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value} goles (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
function renderResultsEvolution() {
    const ctx = document.getElementById('resultsEvolutionChart');
    if (!ctx) return;
    
    if (window.resultsEvolutionChartInstance) {
        window.resultsEvolutionChartInstance.destroy();
    }
    
    if (allMatches.length === 0) return;
    
    // Ordenar partidos cronol√≥gicamente
    const sortedMatches = [...allMatches].sort((a, b) => new Date(a.data) - new Date(b.data));
    
    const labels = sortedMatches.map((m, i) => {
        const date = new Date(m.data);
        const rival = m.rivalTeam || 'Rival';
        return `${date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' })} vs ${rival.substring(0, 15)}`;
    });
    
    const goalDifferences = sortedMatches.map(m => m.scoreCNT - m.scoreRival);
    const colors = goalDifferences.map(diff => {
        if (diff > 0) return '#22c55e'; // Victoria
        if (diff < 0) return '#ef4444'; // Derrota
        return '#fbbf24'; // Empate
    });
    
    // Calcular racha actual
    let currentStreak = 0;
    let streakType = '';
    if (sortedMatches.length > 0) {
        const lastResult = sortedMatches[sortedMatches.length - 1].scoreCNT > sortedMatches[sortedMatches.length - 1].scoreRival ? 'win' : 
                          sortedMatches[sortedMatches.length - 1].scoreCNT < sortedMatches[sortedMatches.length - 1].scoreRival ? 'loss' : 'draw';
        
        for (let i = sortedMatches.length - 1; i >= 0; i--) {
            const result = sortedMatches[i].scoreCNT > sortedMatches[i].scoreRival ? 'win' : 
                          sortedMatches[i].scoreCNT < sortedMatches[i].scoreRival ? 'loss' : 'draw';
            if (result === lastResult) {
                currentStreak++;
            } else {
                break;
            }
        }
        streakType = lastResult === 'win' ? 'victorias' : lastResult === 'loss' ? 'derrotas' : 'empates';
    }
    
    window.resultsEvolutionChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Diferencia de Goles',
                data: goalDifferences,
                backgroundColor: colors,
                borderWidth: 1,
                borderColor: '#1e3a8a'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false },
                title: {
                    display: true,
                    text: `Racha actual: ${currentStreak} ${streakType}`,
                    color: 'white',
                    font: { size: 14, weight: 'bold' }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const diff = context.parsed.y;
                            const result = diff > 0 ? '‚úÖ Victoria' : diff < 0 ? '‚ùå Derrota' : 'ü§ù Empate';
                            return `${result} (${diff > 0 ? '+' : ''}${diff})`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { color: 'white' },
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    title: {
                        display: true,
                        text: 'Diferencia de Goles',
                        color: 'white'
                    }
                },
                x: {
                    ticks: { 
                        color: 'white',
                        font: { size: 9 },
                        maxRotation: 45,
                        minRotation: 45
                    },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            }
        }
    });
}

// NUEVA: Diferencia de Goles por Cuarto
function renderQuarterDifference() {
    const ctx = document.getElementById('quarterDifferenceChart');
    if (!ctx) return;
    
    if (window.quarterDifferenceChartInstance) {
        window.quarterDifferenceChartInstance.destroy();
    }
    
    if (allMatches.length === 0) return;
    
    const quarterStats = {
        q1: { cnt: 0, rival: 0 },
        q2: { cnt: 0, rival: 0 },
        q3: { cnt: 0, rival: 0 },
        q4: { cnt: 0, rival: 0 }
    };
    
    allMatches.forEach(match => {
        ['q1', 'q2', 'q3', 'q4'].forEach(q => {
            quarterStats[q].cnt += match.periodScores[q].cnt;
            quarterStats[q].rival += match.periodScores[q].rival;
        });
    });
    
    const labels = ['1¬∫ Cuarto', '2¬∫ Cuarto', '3¬∫ Cuarto', '4¬∫ Cuarto'];
    const differences = ['q1', 'q2', 'q3', 'q4'].map(q => {
        const diff = quarterStats[q].cnt - quarterStats[q].rival;
        return (diff / allMatches.length).toFixed(2);
    });
    
    const colors = differences.map(diff => parseFloat(diff) >= 0 ? '#22c55e' : '#ef4444');
    
    window.quarterDifferenceChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Diferencia Promedio',
                data: differences,
                backgroundColor: colors,
                borderWidth: 1,
                borderColor: '#1e3a8a'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const q = ['q1', 'q2', 'q3', 'q4'][context.dataIndex];
                            const totalCNT = quarterStats[q].cnt;
                            const totalRival = quarterStats[q].rival;
                            return [
                                `Diferencia: ${context.parsed.y > 0 ? '+' : ''}${context.parsed.y}`,
                                `Total a favor: ${totalCNT}`,
                                `Total en contra: ${totalRival}`
                            ];
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { color: 'white' },
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    title: {
                        display: true,
                        text: 'Diferencia Promedio de Goles',
                        color: 'white'
                    }
                },
                x: {
                    ticks: { color: 'white' },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            }
        }
    });
}

// NUEVA: Mejores y Peores Partidos
function renderBestWorstMatches() {
    const container = document.getElementById('bestWorstGrid');
    if (!container) return;
    
    if (allMatches.length === 0) return;
    
    // Encontrar mejor victoria
    const bestWin = allMatches
        .filter(m => m.scoreCNT > m.scoreRival)
        .sort((a, b) => (b.scoreCNT - b.scoreRival) - (a.scoreCNT - a.scoreRival))[0];
    
    // Encontrar peor derrota
    const worstLoss = allMatches
        .filter(m => m.scoreCNT < m.scoreRival)
        .sort((a, b) => (a.scoreCNT - a.scoreRival) - (b.scoreCNT - b.scoreRival))[0];
    
    // Partido con m√°s goles anotados
    const mostGoals = allMatches.sort((a, b) => b.scoreCNT - a.scoreCNT)[0];
    
    // Partido con menos goles recibidos (solo victorias)
    const bestDefense = allMatches
        .filter(m => m.scoreCNT > m.scoreRival)
        .sort((a, b) => a.scoreRival - b.scoreRival)[0];
    
    let html = '';
    
    if (bestWin) {
        const date = new Date(bestWin.data).toLocaleDateString('es-ES');
        html += `
            <div class="info-item">
                <div class="info-label">üèÜ Mejor Victoria</div>
                <div class="info-value" style="color: #22c55e;">${bestWin.scoreCNT} - ${bestWin.scoreRival}</div>
                <div style="font-size: 10px; color: #bae6fd; margin-top: 4px;">
                    vs ${bestWin.rivalTeam || 'Rival'}<br>${date}
                </div>
            </div>
        `;
    }
    
    if (worstLoss) {
        const date = new Date(worstLoss.data).toLocaleDateString('es-ES');
        html += `
            <div class="info-item">
                <div class="info-label">üòû Peor Derrota</div>
                <div class="info-value" style="color: #ef4444;">${worstLoss.scoreCNT} - ${worstLoss.scoreRival}</div>
                <div style="font-size: 10px; color: #bae6fd; margin-top: 4px;">
                    vs ${worstLoss.rivalTeam || 'Rival'}<br>${date}
                </div>
            </div>
        `;
    }
    
    if (mostGoals) {
        const date = new Date(mostGoals.data).toLocaleDateString('es-ES');
        const result = mostGoals.scoreCNT > mostGoals.scoreRival ? 'win' : mostGoals.scoreCNT < mostGoals.scoreRival ? 'loss' : 'draw';
        html += `
            <div class="info-item">
                <div class="info-label">‚öΩ M√°s Goles Anotados</div>
                <div class="info-value ${result}">${mostGoals.scoreCNT} goles</div>
                <div style="font-size: 10px; color: #bae6fd; margin-top: 4px;">
                    vs ${mostGoals.rivalTeam || 'Rival'} (${mostGoals.scoreCNT}-${mostGoals.scoreRival})<br>${date}
                </div>
            </div>
        `;
    }
    
    if (bestDefense) {
        const date = new Date(bestDefense.data).toLocaleDateString('es-ES');
        html += `
            <div class="info-item">
                <div class="info-label">üõ°Ô∏è Mejor Defensa</div>
                <div class="info-value" style="color: #22d3ee;">${bestDefense.scoreRival} goles</div>
                <div style="font-size: 10px; color: #bae6fd; margin-top: 4px;">
                    vs ${bestDefense.rivalTeam || 'Rival'} (${bestDefense.scoreCNT}-${bestDefense.scoreRival})<br>${date}
                </div>
            </div>
        `;
    }
    
    container.innerHTML = html;
}

// NUEVA: Historial contra Rivales
function renderRivalsHistory() {
    const table = document.getElementById('rivalsHistoryTable');
    if (!table) return;
    
    if (allMatches.length === 0) return;
    
    const rivalsStats = {};
    
    allMatches.forEach(match => {
        const rival = match.rivalTeam || 'Rival Desconocido';
        
        if (!rivalsStats[rival]) {
            rivalsStats[rival] = {
                name: rival,
                played: 0,
                wins: 0,
                losses: 0,
                draws: 0,
                goalsFor: 0,
                goalsAgainst: 0,
                matches: []
            };
        }
        
        rivalsStats[rival].played++;
        rivalsStats[rival].goalsFor += match.scoreCNT;
        rivalsStats[rival].goalsAgainst += match.scoreRival;
        
        if (match.scoreCNT > match.scoreRival) {
            rivalsStats[rival].wins++;
        } else if (match.scoreCNT < match.scoreRival) {
            rivalsStats[rival].losses++;
        } else {
            rivalsStats[rival].draws++;
        }
        
        rivalsStats[rival].matches.push({
            date: match.data,
            score: `${match.scoreCNT}-${match.scoreRival}`,
            result: match.scoreCNT > match.scoreRival ? 'win' : match.scoreCNT < match.scoreRival ? 'loss' : 'draw'
        });
    });
    
    const rivals = Object.values(rivalsStats).sort((a, b) => b.played - a.played);
    
    table.innerHTML = `
        <thead>
            <tr>
                <th>Rival</th>
                <th>PJ</th>
                <th>V</th>
                <th>D</th>
                <th>E</th>
                <th>GF</th>
                <th>GC</th>
                <th>Dif</th>
                <th>%V</th>
                <th>√öltimo Resultado</th>
            </tr>
        </thead>
        <tbody>
            ${rivals.map(r => {
                const diff = r.goalsFor - r.goalsAgainst;
                const winPercentage = r.played > 0 ? ((r.wins / r.played) * 100).toFixed(0) : 0;
                const lastMatch = r.matches.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                const lastDate = new Date(lastMatch.date).toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });
                
                return `
                    <tr>
                        <td><strong>${r.name}</strong></td>
                        <td>${r.played}</td>
                        <td class="win">${r.wins}</td>
                        <td class="loss">${r.losses}</td>
                        <td class="draw">${r.draws}</td>
                        <td>${r.goalsFor}</td>
                        <td>${r.goalsAgainst}</td>
                        <td style="color: ${diff > 0 ? '#22c55e' : diff < 0 ? '#ef4444' : '#fbbf24'}; font-weight: bold;">
                            ${diff > 0 ? '+' : ''}${diff}
                        </td>
                        <td>${winPercentage}%</td>
                        <td>
                            <span class="${lastMatch.result}">${lastMatch.score}</span>
                            <span style="font-size: 10px; color: #bae6fd; margin-left: 4px;">(${lastDate})</span>
                        </td>
                    </tr>
                `;
            }).join('')}
        </tbody>
    `;
}
        function renderTitularityHeatmapChart() {
            const ctx = document.getElementById('titularityHeatmapChart');
            if (!ctx) {
                console.log('Canvas no encontrado');
                return;
            }
            
            if (window.titularityHeatmapChartInstance) {
                window.titularityHeatmapChartInstance.destroy();
            }
            
            if (allMatches.length === 0) {
                console.log('No hay partidos cargados');
                return;
            }
            
            const titularStats = {};
            
            allMatches.forEach(match => {
                const quarters = ['q1', 'q2', 'q3', 'q4'];
                quarters.forEach(q => {
                    const lineup = match.lineups[q] || [];
                    lineup.forEach(playerNum => {
                        const player = match.jugadors.find(j => j.numero === playerNum);
                        if (player) {
                            const playerName = player.nom.trim();
                            if (!titularStats[playerName]) {
                                titularStats[playerName] = { num: player.numero, q1: 0, q2: 0, q3: 0, q4: 0 };
                            }
                            titularStats[playerName].num = player.numero;
                            titularStats[playerName][q]++;
                        }
                    });
                });
            });
            
            const players = Object.keys(titularStats)
                .sort((a, b) => {
                    const totalA = titularStats[a].q1 + titularStats[a].q2 + titularStats[a].q3 + titularStats[a].q4;
                    const totalB = titularStats[b].q1 + titularStats[b].q2 + titularStats[b].q3 + titularStats[b].q4;
                    return totalB - totalA;
                });
            
            if (players.length === 0) {
                console.log('No hay jugadores con titularidades');
                return;
            }
            
            console.log('Jugadores encontrados:', players.length);
            
            const quarters = ['1Q', '2Q', '3Q', '4Q'];
            const datasets = quarters.map((q, qIndex) => {
                const quarterKey = `q${qIndex + 1}`;
                return {
                    label: q,
                    data: players.map(p => titularStats[p][quarterKey]),
                    backgroundColor: ['#22d3ee', '#06b6d4', '#0891b2', '#0e7490'][qIndex]
                };
            });
            
           window.titularityHeatmapChartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
        labels: players.map(p => `${titularStats[p].num}. ${p.split(' ')[0]}`),
        datasets: datasets
    },
    options: {
        responsive: true,
        maintainAspectRatio: false, // ‚¨ÖÔ∏è CAMBIADO
        indexAxis: 'y',
        plugins: {
            legend: { 
                display: true,
                labels: { 
                    color: 'white', 
                    font: { size: window.innerWidth < 768 ? 10 : 14 } // ‚¨ÖÔ∏è A√ëADIDO
                }
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return `${context.dataset.label}: ${context.parsed.x} veces titular`;
                    }
                }
            }
        },
        scales: {
            x: { 
                stacked: true,
                beginAtZero: true,
                ticks: { 
                    color: 'white', 
                    stepSize: 1,
                    font: { size: window.innerWidth < 768 ? 10 : 12 } // ‚¨ÖÔ∏è A√ëADIDO
                },
                grid: { color: 'rgba(255,255,255,0.1)' },
                title: {
                    display: true,
                    text: 'Veces como Titular',
                    color: 'white',
                    font: { size: window.innerWidth < 768 ? 11 : 14 } // ‚¨ÖÔ∏è A√ëADIDO
                }
            },
            y: { 
                stacked: true,
                ticks: { 
                    color: 'white', 
                    font: { size: window.innerWidth < 768 ? 9 : 11 }, // ‚¨ÖÔ∏è MODIFICADO
                    autoSkip: false // ‚¨ÖÔ∏è A√ëADIDO - Muestra todas las etiquetas
                },
                grid: { color: 'rgba(255,255,255,0.1)' }
            }
        }
    }
});
        }

        function displayTitularStats() {
    const container = document.getElementById('titularView');
    
    if (allMatches.length === 0) {
        container.innerHTML = '<div class="no-data">No hay partidos cargados</div>';
        return;
    }

    const titularStats = {};
    
    allMatches.forEach(match => {
        const quarters = ['q1', 'q2', 'q3', 'q4'];
        quarters.forEach(q => {
            const lineup = match.lineups[q] || [];
            lineup.forEach(playerNum => {
                const player = match.jugadors.find(j => j.numero === playerNum);
                if (player) {
                    const playerName = player.nom.trim();
                    
                    if (!titularStats[playerName]) {
                        titularStats[playerName] = {
                            num: player.numero,
                            name: playerName,
                            q1: 0, q2: 0, q3: 0, q4: 0, total: 0
                        };
                    }
                    
                    titularStats[playerName].num = player.numero;
                    titularStats[playerName][q]++;
                    titularStats[playerName].total++;
                }
            });
        });
    });

    const players = Object.values(titularStats).sort((a, b) => b.total - a.total);

    container.innerHTML = `
        <h2 class="section-title">Veces como Titular por Cuarto</h2>
        <p style="margin-bottom: 15px; color: #bae6fd; font-size: 14px;">
            Basado en ${allMatches.length} partido${allMatches.length !== 1 ? 's' : ''}
        </p>
        <div class="titular-stats">
            ${players.map(p => `
                <div class="titular-item">
                    <div class="titular-header">
                        <div class="player-num">${p.num}</div>
                        <div style="flex: 1;">
                            <div class="player-name">${p.name}</div>
                            <div style="font-size: 12px; color: #bae6fd; margin-top: 4px;">
                                Total: <span class="total-badge">${p.total}</span>
                            </div>
                        </div>
                    </div>
                    <div class="titular-quarters">
                        <div class="quarter-badge">1Q: ${p.q1}</div>
                        <div class="quarter-badge">2Q: ${p.q2}</div>
                        <div class="quarter-badge">3Q: ${p.q3}</div>
                        <div class="quarter-badge">4Q: ${p.q4}</div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
    
    // Renderizar nuevos gr√°ficos
    renderConsistencyChart();
    renderQuarterPatterns();
    renderPerformanceTable();
}
function renderLiveActionRow(a) {
  // ‚ûï Cas nou
  if (a.type === 'falta-rebuda') {
    return `<div class="live-action">üü¶ Falta rebuda per <b>${a.playerName}</b></div>`;
  }

  // ‚¨áÔ∏è Exemples m√≠nims; deixa els teus casos existents
  if (a.type === 'goal' && a.team === 'cnt') {
    return `<div class="live-action">‚öΩ Gol de <b>${a.playerName}</b></div>`;
  }
  if (a.type === 'exclusion' && a.team === 'rival') {
    return `<div class="live-action">üü• Exclusi√≥ rival</div>`;
  }

  // fallback
  return `<div class="live-action">‚àô ${a.type}</div>`;
}

function renderLiveActions(match) {
  const cont = document.getElementById('liveActionsList'); // ID del teu contenidor
  if (!cont) return;
  const acts = explodeLiveActions(match);
  cont.innerHTML = acts.map(renderLiveActionRow).join('');
}
// NUEVA FUNCI√ìN: Gr√°fico de Consistencia
function renderConsistencyChart() {
    const ctx = document.getElementById('consistencyChart');
    if (!ctx) return;
    
    if (window.consistencyChartInstance) {
        window.consistencyChartInstance.destroy();
    }
    
    if (allMatches.length === 0) return;
    
    const playerConsistency = {};
    const maxPossibleTitular = allMatches.length * 4; // 4 cuartos por partido
    
    allMatches.forEach(match => {
        match.jugadors.forEach(player => {
            const playerName = player.nom.trim();
            if (!playerConsistency[playerName]) {
                playerConsistency[playerName] = {
                    num: player.numero,
                    name: playerName,
                    titular: 0,
                    total: 0
                };
            }
            playerConsistency[playerName].total += 4; // 4 cuartos posibles
        });
        
        ['q1', 'q2', 'q3', 'q4'].forEach(q => {
            const lineup = match.lineups[q] || [];
            lineup.forEach(playerNum => {
                const player = match.jugadors.find(j => j.numero === playerNum);
                if (player) {
                    const playerName = player.nom.trim();
                    if (playerConsistency[playerName]) {
                        playerConsistency[playerName].titular++;
                    }
                }
            });
        });
    });
    
    const players = Object.values(playerConsistency)
        .map(p => ({
            ...p,
            percentage: p.total > 0 ? (p.titular / p.total * 100).toFixed(1) : 0
        }))
        .sort((a, b) => b.percentage - a.percentage);
    
    const labels = players.map(p => `${p.num}. ${p.name.split(' ').slice(0, 2).join(' ')}`);
    const data = players.map(p => parseFloat(p.percentage));
    
    // Colores seg√∫n porcentaje
    const backgroundColors = data.map(percentage => {
        if (percentage >= 75) return '#22c55e'; // Verde - Titular habitual
        if (percentage >= 50) return '#fbbf24'; // Amarillo - Mixto
        if (percentage >= 25) return '#f97316'; // Naranja - Suplente habitual
        return '#ef4444'; // Rojo - Rara vez titular
    });
    
    window.consistencyChartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
        labels: labels,
        datasets: [{
            label: '% de Titularidad',
            data: data,
            backgroundColor: backgroundColors,
            borderWidth: 1,
            borderColor: '#1e3a8a'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false, // ‚¨ÖÔ∏è CAMBIADO
        indexAxis: 'y',
        plugins: {
            legend: { 
                display: false 
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        const player = players[context.dataIndex];
                        return [
                            `Titularidad: ${context.parsed.x}%`,
                            `Titular: ${player.titular}/${player.total} cuartos`
                        ];
                    }
                }
            }
        },
        scales: {
            x: {
                beginAtZero: true,
                max: 100,
                ticks: { 
                    color: 'white',
                    font: { size: window.innerWidth < 768 ? 10 : 12 }, // ‚¨ÖÔ∏è A√ëADIDO
                    callback: function(value) {
                        return value + '%';
                    }
                },
                grid: { color: 'rgba(255,255,255,0.1)' },
                title: {
                    display: true,
                    text: 'Porcentaje de Titularidad',
                    color: 'white',
                    font: { size: window.innerWidth < 768 ? 11 : 14 } // ‚¨ÖÔ∏è A√ëADIDO
                }
            },
            y: {
                ticks: { 
                    color: 'white', 
                    font: { size: window.innerWidth < 768 ? 9 : 11 }, // ‚¨ÖÔ∏è MODIFICADO
                    autoSkip: false // ‚¨ÖÔ∏è A√ëADIDO - Muestra todas las etiquetas
                },
                grid: { color: 'rgba(255,255,255,0.1)' }
            }
        }
    }
});
}

// NUEVA FUNCI√ìN: Titulars m√©s habituals en forma de piscina
function renderQuarterPatterns() {
    const container = document.getElementById('quarterPatternsGrid');
    if (!container) return;
    
    if (allMatches.length === 0) return;
    
    const playerStarts = {};
    
    // Comptar quantes vegades cada jugador ha estat titular
    allMatches.forEach(match => {
        ['q1', 'q2', 'q3', 'q4'].forEach(q => {
            const lineup = match.lineups[q] || [];
            lineup.forEach(playerNum => {
                const player = match.jugadors.find(j => j.numero === playerNum);
                if (player) {
                    const playerName = player.nom.trim();
                    if (!playerStarts[playerName]) {
                        playerStarts[playerName] = {
                            num: player.numero,
                            name: playerName,
                            starts: 0
                        };
                    }
                    playerStarts[playerName].starts++;
                }
            });
        });
    });
    
    // Ordenar per vegades titular
    const sortedPlayers = Object.values(playerStarts)
        .sort((a, b) => b.starts - a.starts);
    
    // Agafar els 7 m√©s habituals (1 porter + 6 jugadors)
    const goalkeeper = sortedPlayers.find(p => p.num === 1 || p.num === 13) || sortedPlayers[0];
    const fieldPlayers = sortedPlayers
        .filter(p => p.num !== goalkeeper.num)
        .slice(0, 6);
    
    const totalQuarters = allMatches.length * 4;
    
    // Calcular percentatges
    const goalkeeperPercent = ((goalkeeper.starts / totalQuarters) * 100).toFixed(0);
    
    container.innerHTML = `
        <div class="pool-container">
            <div class="pool-goal">
                <div style="font-size: 12px; color: #fca5a5; font-weight: bold;">PORTERIA</div>
            </div>
            
            <div class="pool-players">
                <!-- Porter -->
                <div class="pool-goalkeeper">
                    <div class="pool-player">
                        <div class="pool-player-num" style="background: #8b5cf6;">${goalkeeper.num}</div>
                        <div class="pool-player-name">${goalkeeper.name.split(' ').slice(0, 2).join(' ')}</div>
                        <div class="pool-player-stat">${goalkeeper.starts} titularitats (${goalkeeperPercent}%)</div>
                    </div>
                </div>
                
                <div class="pool-midfield">‚ö° L√çNEA MITJA ‚ö°</div>
                
                <!-- Jugadors de camp (3+3) -->
                <div class="pool-field-players">
                    ${fieldPlayers.map(p => {
                        const percent = ((p.starts / totalQuarters) * 100).toFixed(0);
                        return `
                            <div class="pool-player">
                                <div class="pool-player-num">${p.num}</div>
                                <div class="pool-player-name">${p.name.split(' ').slice(0, 2).join(' ')}</div>
                                <div class="pool-player-stat">${p.starts} (${percent}%)</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 20px; padding-top: 15px; border-top: 2px dashed rgba(255, 255, 255, 0.3);">
                <div style="font-size: 11px; color: #bae6fd;">
                    üí° Basado en ${allMatches.length} partido${allMatches.length !== 1 ? 's' : ''} 
                    (${totalQuarters} cuartos totales)
                </div>
            </div>
        </div>
    `;
}

// NUEVA FUNCI√ìN: Tabla de Rendimiento - CORREGIDA
function renderPerformanceTable() {
    const table = document.getElementById('performanceTable');
    if (!table) return;
    
    if (allMatches.length === 0) return;
    console.log('üéØ renderPerformanceTable - allMatches:', allMatches.length);
    const playerPerformance = {};
    
    allMatches.forEach(match => {
        match.jugadors.forEach(player => {
            const playerName = player.nom.trim();
            if (!playerPerformance[playerName]) {
                playerPerformance[playerName] = {
                    num: player.numero,
                    name: playerName,
                    titular: { teamGoalsFor: 0, teamGoalsAgainst: 0, quarters: 0 },
                    suplente: { teamGoalsFor: 0, teamGoalsAgainst: 0, quarters: 0 }
                };
            }
            
            // Analizar cuarto por cuarto
['q1', 'q2', 'q3', 'q4'].forEach(q => {
    // Validar que periodScores existeix i t√© les dades del quart
    if (!match.periodScores || !match.periodScores[q]) return;
    
    const isInLineup = match.lineups[q] && match.lineups[q].includes(player.numero);
    const quarterGoalsFor = match.periodScores[q].cnt || 0;
    const quarterGoalsAgainst = match.periodScores[q].rival || 0;
                
                if (isInLineup) {
                    // Es titular en este cuarto - contamos goles del EQUIPO
                    playerPerformance[playerName].titular.quarters++;
                    playerPerformance[playerName].titular.teamGoalsFor += quarterGoalsFor;
                    playerPerformance[playerName].titular.teamGoalsAgainst += quarterGoalsAgainst;
                } else {
                    // Es suplente en este cuarto - contamos goles del EQUIPO
                    playerPerformance[playerName].suplente.quarters++;
                    playerPerformance[playerName].suplente.teamGoalsFor += quarterGoalsFor;
                    playerPerformance[playerName].suplente.teamGoalsAgainst += quarterGoalsAgainst;
                }
            });
        });
    });
    console.log('üéØ playerPerformance object:', playerPerformance);
console.log('üéØ players array length:', Object.keys(playerPerformance).length);
    const players = Object.values(playerPerformance)
        .filter(p => p.titular.quarters > 0 || p.suplente.quarters > 0)
        .sort((a, b) => {
            const avgA = a.titular.quarters > 0 ? (a.titular.teamGoalsFor / a.titular.quarters) : 0;
            const avgB = b.titular.quarters > 0 ? (b.titular.teamGoalsFor / b.titular.quarters) : 0;
            return avgB - avgA;
        });
   console.log('üéØ Filtered players:', players.length);
console.log('üéØ First player example:', players[0]); 
    table.innerHTML = `
        <thead>
            <tr>
                <th rowspan="2">N¬∫</th>
                <th rowspan="2">Jugador</th>
                <th colspan="3" style="background: rgba(34, 197, 94, 0.3);">Cuando es Titular</th>
                <th colspan="3" style="background: rgba(239, 68, 68, 0.3);">Cuando es Suplente</th>
                <th rowspan="2">Dif GF/Q</th>
                <th rowspan="2">Dif GC/Q</th>
            </tr>
            <tr>
                <th style="background: rgba(34, 197, 94, 0.2);">Cuartos</th>
                <th style="background: rgba(34, 197, 94, 0.2);">GF/Q Equipo</th>
                <th style="background: rgba(34, 197, 94, 0.2);">GC/Q Equipo</th>
                <th style="background: rgba(239, 68, 68, 0.2);">Cuartos</th>
                <th style="background: rgba(239, 68, 68, 0.2);">GF/Q Equipo</th>
                <th style="background: rgba(239, 68, 68, 0.2);">GC/Q Equipo</th>
            </tr>
        </thead>
        <tbody>
            ${players.map(p => {
                const titularAvgGF = p.titular.quarters > 0 ? (p.titular.teamGoalsFor / p.titular.quarters).toFixed(2) : '-';
                const titularAvgGC = p.titular.quarters > 0 ? (p.titular.teamGoalsAgainst / p.titular.quarters).toFixed(2) : '-';
                
                const suplenteAvgGF = p.suplente.quarters > 0 ? (p.suplente.teamGoalsFor / p.suplente.quarters).toFixed(2) : '-';
                const suplenteAvgGC = p.suplente.quarters > 0 ? (p.suplente.teamGoalsAgainst / p.suplente.quarters).toFixed(2) : '-';
                
                // Diferencia de goles A FAVOR (cuando es titular vs suplente)
                // Positivo = metemos M√ÅS goles cuando es titular (bueno)
                // Negativo = metemos MENOS goles cuando es titular (malo)
                const diffGF = p.titular.quarters > 0 && p.suplente.quarters > 0 
                    ? ((p.titular.teamGoalsFor / p.titular.quarters) - (p.suplente.teamGoalsFor / p.suplente.quarters)).toFixed(2)
                    : '-';
                
                let diffGFColor = 'white';
                if (diffGF !== '-') {
                    // Verde si metemos M√ÅS goles cuando es titular (positivo)
                    // Rojo si metemos MENOS goles cuando es titular (negativo)
                    diffGFColor = parseFloat(diffGF) > 0 ? '#22c55e' : parseFloat(diffGF) < 0 ? '#ef4444' : '#fbbf24';
                }
                
                // Diferencia de goles EN CONTRA (cuando es titular vs suplente)
                // Positivo = recibimos M√ÅS goles cuando es titular (malo)
                // Negativo = recibimos MENOS goles cuando es titular (bueno)
                const diffGC = p.titular.quarters > 0 && p.suplente.quarters > 0 
                    ? ((p.titular.teamGoalsAgainst / p.titular.quarters) - (p.suplente.teamGoalsAgainst / p.suplente.quarters)).toFixed(2)
                    : '-';
                
                let diffGCColor = 'white';
                if (diffGC !== '-') {
                    // Verde si recibimos MENOS goles cuando es titular (negativo)
                    // Rojo si recibimos M√ÅS goles cuando es titular (positivo)
                    diffGCColor = parseFloat(diffGC) < 0 ? '#22c55e' : parseFloat(diffGC) > 0 ? '#ef4444' : '#fbbf24';
                }
                
                return `
                    <tr>
                        <td><div class="player-num" style="width: 30px; height: 30px; font-size: 12px;">${p.num}</div></td>
                        <td><strong>${p.name}</strong></td>
                        <td>${p.titular.quarters}</td>
                        <td><strong style="color: #fde047;">${titularAvgGF}</strong></td>
                        <td><strong style="color: #ef4444;">${titularAvgGC}</strong></td>
                        <td>${p.suplente.quarters}</td>
                        <td><strong style="color: #fde047;">${suplenteAvgGF}</strong></td>
                        <td><strong style="color: #ef4444;">${suplenteAvgGC}</strong></td>
                        <td style="color: ${diffGFColor}; font-weight: bold;">
                            ${diffGF !== '-' ? (diffGF > 0 ? '+' : '') + diffGF : '-'}
                        </td>
                        <td style="color: ${diffGCColor}; font-weight: bold;">
                            ${diffGC !== '-' ? (diffGC > 0 ? '+' : '') + diffGC : '-'}
                        </td>
                    </tr>
                `;
            }).join('')}
        </tbody>
    `;
}


function filterByPlayer() {
    const playerName = document.getElementById('filterPlayer').value;
    
    if (!playerName) {
        document.getElementById('playerStatsCard').classList.add('hidden');
        return;
    }
    
    const playerData = {
        name: playerName,
        num: 0,
        partidos: 0,
        gols: [],
        exclusions: [],
        dates: [],
        totalGols: 0,
        totalExclusions: 0,
        goalTypes: { 'h+': 0, penalty: 0, contra: 0, boya: 0, normal: 0 },
        penaltyMissed: 0,
        titular: { q1: 0, q2: 0, q3: 0, q4: 0 },
        totalParades: 0,
        bestParades: 0,
        paradeTypes: { corner: 0, rebuig: 0, atrapa: 0, penal: 0 },
        totalAssistencies: 0,
        totalRobatoris: 0,
        totalPerdues: 0,
        totalXutsFallats: 0,
        totalBlocks: 0,
        totalFaltesRebudes: 0,
        swimRacesWon: 0,
        swimRacesLost: 0,
        swimRacesTotal: 0
    };
    
    // Ordenar per data (m√©s antic primer)
    const sortedMatches = [...allMatches].sort((a, b) => new Date(a.data) - new Date(b.data));
    
    sortedMatches.forEach(match => {
        const player = match.jugadors.find(j => j.nom.trim() === playerName);
        
        if (player) {
            playerData.num = player.numero;
            playerData.partidos++;
            playerData.gols.push(player.estadistiques.gols);
            playerData.exclusions.push(player.estadistiques.exclusions);
            playerData.dates.push(new Date(match.data).toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' }));
            playerData.totalGols += player.estadistiques.gols;
            playerData.totalExclusions += player.estadistiques.exclusions;
            playerData.penaltyMissed += player.estadistiques.penaltyMissed || 0;
            playerData.totalParades += (player.estadistiques.parades || 0);
            playerData.totalAssistencies += (player.estadistiques.assistencies || 0);
            playerData.totalRobatoris += (player.estadistiques.robatoris || 0);
            playerData.totalPerdues += (player.estadistiques.perdues || 0);
            playerData.totalXutsFallats += (player.estadistiques.xutsFallats || 0);
            playerData.totalBlocks += (player.estadistiques.blocks || 0);
            playerData.totalFaltesRebudes += (player.estadistiques.faltesRebudes || 0);

            if (player.estadistiques.parades && player.estadistiques.parades > playerData.bestParades) {
                playerData.bestParades = player.estadistiques.parades;
            }

            if (player.estadistiques.paradeTypes) {
                Object.keys(playerData.paradeTypes).forEach(type => {
                    playerData.paradeTypes[type] += (player.estadistiques.paradeTypes[type] || 0);
                });
            }
            
            if (player.estadistiques.goalTypes) {
                Object.keys(playerData.goalTypes).forEach(type => {
                    playerData.goalTypes[type] += (player.estadistiques.goalTypes[type] || 0);
                });
            }
            
            ['q1', 'q2', 'q3', 'q4'].forEach(q => {
                if (match.lineups[q] && match.lineups[q].includes(player.numero)) {
                    playerData.titular[q]++;
                }
            });
        }
        
        // ‚úÖ Comptar curses guanyades/perdudes (FORA del if player)
        if (match.chronologicalActions && playerData.num) {
            match.chronologicalActions.forEach(action => {
                if (action.type === 'swim-race' && action.playerNum === playerData.num) {
                    playerData.swimRacesTotal++;
                    if (action.result === 'win') {
                        playerData.swimRacesWon++;
                    } else {
                        playerData.swimRacesLost++;
                    }
                }
            });
        }
    });
    
    // ‚úÖ Cridar displayPlayerStats amb les dades
    displayPlayerStats(playerData);
}
function renderPlayerGoalZones(data) {
     console.log('ü•Ö renderGoalkeeperReceivedZones CRIDAT amb:', data.name);   
    const goalsBreakdown = document.getElementById('playerGoalsBreakdown');
    
    if (!goalsBreakdown) return;
    
    let zonesContainer = document.getElementById('playerGoalZonesContainer');
    if (!zonesContainer) {
        zonesContainer = document.createElement('div');
        zonesContainer.id = 'playerGoalZonesContainer';
        zonesContainer.style.marginTop = '30px';
        goalsBreakdown.parentNode.insertBefore(zonesContainer, goalsBreakdown.nextSibling);
    }
    
    // Calcular zones totals del jugador
    const zones = {
        'top-left': 0, 'top-center': 0, 'top-right': 0,
        'mid-left': 0, 'mid-center': 0, 'mid-right': 0,
        'bottom-left': 0, 'bottom-center': 0, 'bottom-right': 0,
        'unknown': 0
    };
    
    allMatches.forEach(match => {
        const player = match.jugadors.find(j => j.nom.trim() === data.name);
        if (player && player.estadistiques.goalZones) {
            Object.keys(player.estadistiques.goalZones).forEach(zone => {
                zones[zone] = (zones[zone] || 0) + (player.estadistiques.goalZones[zone] || 0);
            });
        }
    });
    
    const totalGols = Object.values(zones).reduce((sum, count) => sum + count, 0) - zones.unknown;
    
    if (totalGols === 0) {
        zonesContainer.innerHTML = `
            <h3 class="section-title">üéØ Zones de Porteria</h3>
            <div class="no-data">No hi ha dades de zones disponibles</div>
        `;
        return;
    }
    
    const zoneOrder = [
        'top-left', 'top-center', 'top-right',
        'mid-left', 'mid-center', 'mid-right',
        'bottom-left', 'bottom-center', 'bottom-right'
    ];
    
    const zoneLabels = {
        'top-left': '‚¨ÜÔ∏è Esq', 'top-center': '‚¨ÜÔ∏è Centre', 'top-right': '‚¨ÜÔ∏è Dret',
        'mid-left': '‚û°Ô∏è Esq', 'mid-center': 'üéØ Centre', 'mid-right': '‚¨ÖÔ∏è Dret',
        'bottom-left': '‚¨áÔ∏è Esq', 'bottom-center': '‚¨áÔ∏è Baix', 'bottom-right': '‚¨áÔ∏è Dret'
    };
    
    const maxCount = Math.max(...zoneOrder.map(z => zones[z] || 0));
    const preferredZone = zoneOrder.reduce((max, zone) => 
        (zones[zone] || 0) > (zones[max] || 0) ? zone : max, zoneOrder[0]);
    
    const preferredZoneNames = {
        'top-left': 'Dalt Esquerra', 'top-center': 'Dalt Centre', 'top-right': 'Dalt Dreta',
        'mid-left': 'Centre Esquerra', 'mid-center': 'Centre', 'mid-right': 'Centre Dreta',
        'bottom-left': 'Baix Esquerra', 'bottom-center': 'Baix Centre', 'bottom-right': 'Baix Dreta'
    };
    
    zonesContainer.innerHTML = `
        <h3 class="section-title">üéØ Zones de Porteria</h3>
        <div style="background: rgba(34, 211, 238, 0.1); padding: 12px; border-radius: 8px; margin-bottom: 15px; text-align: center;">
            <div style="font-size: 12px; color: #bae6fd;">Zona preferida</div>
            <div style="font-size: 18px; color: #22d3ee; font-weight: bold; margin-top: 4px;">
                ${preferredZoneNames[preferredZone]} (${zones[preferredZone]} gols)
            </div>
        </div>
        <div class="goal-zone-heatmap">
            ${zoneOrder.map(zone => {
                const count = zones[zone] || 0;
                const percentage = totalGols > 0 ? ((count / totalGols) * 100).toFixed(1) : 0;
                const intensity = maxCount > 0 ? count / maxCount : 0;
                const bgColor = getHeatmapColor(intensity);
                
                return `
                    <div class="goal-zone-cell" style="background: ${bgColor};">
                        <div class="zone-label">${zoneLabels[zone]}</div>
                        <div class="zone-count">${count}</div>
                        <div style="font-size: 9px; color: rgba(255,255,255,0.7);">${percentage}%</div>
                    </div>
                `;
            }).join('')}
        </div>
        ${zones.unknown > 0 ? `
            <div style="text-align: center; margin-top: 10px; font-size: 11px; color: #bae6fd;">
                ‚ùì Gols sense zona: ${zones.unknown}
            </div>
        ` : ''}
        <div style="text-align: center; margin-top: 10px; font-size: 12px; color: #fde047;">
            Total amb zona: ${totalGols} de ${data.totalGols} gols
        </div>
    `;
}
function renderGoalkeeperReceivedZones(data) {
console.log('üéØ renderPlayerGoalZones CRIDAT amb:', data.name);    
    
    const goalsBreakdown = document.getElementById('playerGoalsBreakdown');

    if (!goalsBreakdown) return;
    
    let zonesContainer = document.getElementById('goalkeeperReceivedZonesContainer');
    if (!zonesContainer) {
        zonesContainer = document.createElement('div');
        zonesContainer.id = 'goalkeeperReceivedZonesContainer';
        zonesContainer.style.marginTop = '30px';
        goalsBreakdown.parentNode.insertBefore(zonesContainer, goalsBreakdown.nextSibling);
    }
    
    // Calcular zones de gols rebuts
    const zones = {
        'top-left': 0, 'top-center': 0, 'top-right': 0,
        'mid-left': 0, 'mid-center': 0, 'mid-right': 0,
        'bottom-left': 0, 'bottom-center': 0, 'bottom-right': 0,
        'unknown': 0
    };
    
    let totalGolsRebuts = 0;
    
    allMatches.forEach(match => {
        const player = match.jugadors.find(j => j.numero === data.num);
        if (player && player.estadistiques.golsRebutsZones) {
            Object.keys(player.estadistiques.golsRebutsZones).forEach(zone => {
                const count = player.estadistiques.golsRebutsZones[zone] || 0;
                zones[zone] = (zones[zone] || 0) + count;
                totalGolsRebuts += count;
            });
        }
    });
    
    if (totalGolsRebuts === 0) {
        zonesContainer.innerHTML = `
            <h3 class="section-title">ü•Ö Zones de Gols Rebuts</h3>
            <div class="no-data">No hi ha dades de zones de gols rebuts</div>
        `;
        return;
    }
    
    const zoneOrder = [
        'top-left', 'top-center', 'top-right',
        'mid-left', 'mid-center', 'mid-right',
        'bottom-left', 'bottom-center', 'bottom-right'
    ];
    
    const zoneLabels = {
        'top-left': '‚¨ÜÔ∏èE', 'top-center': '‚¨ÜÔ∏èC', 'top-right': '‚¨ÜÔ∏èD',
        'mid-left': '‚û°Ô∏èE', 'mid-center': 'üéØ', 'mid-right': '‚¨ÖÔ∏èD',
        'bottom-left': '‚¨áÔ∏èE', 'bottom-center': '‚¨áÔ∏èB', 'bottom-right': '‚¨áÔ∏èD'
    };
    
    const maxCount = Math.max(...zoneOrder.map(z => zones[z] || 0));
    const weakestZone = zoneOrder.reduce((max, zone) => 
        (zones[zone] || 0) > (zones[max] || 0) ? zone : max, zoneOrder[0]);
    
    const weakestZoneNames = {
        'top-left': 'Dalt Esquerra', 'top-center': 'Dalt Centre', 'top-right': 'Dalt Dreta',
        'mid-left': 'Centre Esquerra', 'mid-center': 'Centre', 'mid-right': 'Centre Dreta',
        'bottom-left': 'Baix Esquerra', 'bottom-center': 'Baix Centre', 'bottom-right': 'Baix Dreta'
    };
    
    zonesContainer.innerHTML = `
        <h3 class="section-title">ü•Ö Zones de Gols Rebuts</h3>
        <div style="background: rgba(239, 68, 68, 0.1); padding: 12px; border-radius: 8px; margin-bottom: 15px; text-align: center;">
            <div style="font-size: 12px; color: #fca5a5;">Zona m√©s feble</div>
            <div style="font-size: 18px; color: #ef4444; font-weight: bold; margin-top: 4px;">
                ${weakestZoneNames[weakestZone]} (${zones[weakestZone]} gols)
            </div>
        </div>
        <div class="goal-zone-heatmap">
            ${zoneOrder.map(zone => {
                const count = zones[zone] || 0;
                const percentage = totalGolsRebuts > 0 ? ((count / totalGolsRebuts) * 100).toFixed(1) : 0;
                const intensity = maxCount > 0 ? count / maxCount : 0;
                const bgColor = getHeatmapColor(intensity);
                
                return `
                    <div class="goal-zone-cell" style="background: ${bgColor};">
                        <div class="zone-label">${zoneLabels[zone]}</div>
                        <div class="zone-count">${count}</div>
                        <div style="font-size: 9px; color: rgba(255,255,255,0.7);">${percentage}%</div>
                    </div>
                `;
            }).join('')}
        </div>
        <div style="text-align: center; margin-top: 10px; font-size: 12px; color: #fca5a5;">
            Total de gols rebuts amb zona: ${totalGolsRebuts}
        </div>
    `;
}
function displayPlayerStats(data) {

	document.getElementById('playerStatsCard').classList.remove('hidden');
    document.getElementById('selectedPlayerName').textContent = `${data.num}. ${data.name}`;
    // ‚úÖ NETEJA els contenidors de zones anteriors
    const oldGoalZones = document.getElementById('playerGoalZonesContainer');
    if (oldGoalZones) oldGoalZones.remove();
    
    const oldGkZones = document.getElementById('goalkeeperReceivedZonesContainer');
    if (oldGkZones) oldGkZones.remove();
    
    const avgGols = data.partidos > 0 ? (data.totalGols / data.partidos).toFixed(2) : 0;
    const avgExc = data.partidos > 0 ? (data.totalExclusions / data.partidos).toFixed(2) : 0;
    const totalTitular = data.titular.q1 + data.titular.q2 + data.titular.q3 + data.titular.q4;
    const maxPossibleTitular = data.partidos * 4;
    const titularPercentage = maxPossibleTitular > 0 ? ((totalTitular / maxPossibleTitular) * 100).toFixed(1) : 0;
    
    const bestMatch = Math.max(...data.gols);
    const bestMatchIndex = data.gols.indexOf(bestMatch);
    
    const isGoalkeeper = data.num === 1 || data.num === 13;

document.getElementById('playerSummaryGrid').innerHTML = `
    <div class="info-item">
        <div class="info-label">Partidos Jugados</div>
        <div class="info-value">${data.partidos}</div>
    </div>
    ${isGoalkeeper ? `
    <div class="info-item">
        <div class="info-label">üß§ Total Parades</div>
        <div class="info-value" style="color: #8b5cf6;">${data.totalParades || 0}</div>
    </div>
    <div class="info-item">
        <div class="info-label">Media Parades/Partido</div>
        <div class="info-value">${data.partidos > 0 ? (data.totalParades / data.partidos).toFixed(1) : '0.0'}</div>
    </div>
    ` : `
    <div class="info-item">
        <div class="info-label">Total Goles</div>
        <div class="info-value" style="color: #fde047;">${data.totalGols}</div>
    </div>
    <div class="info-item">
        <div class="info-label">Media Goles/Partido</div>
        <div class="info-value">${avgGols}</div>
    </div>
    `}
    ${!isGoalkeeper ? `
    <div class="info-item">
        <div class="info-label">üéØ Efici√®ncia de Tir</div>
        <div class="info-value" style="color: ${(() => {
            const totalXuts = data.totalGols + (data.totalXutsFallats || 0);
            const efic = totalXuts > 0 ? (data.totalGols / totalXuts * 100) : 0;
            return efic >= 50 ? '#22c55e' : efic >= 30 ? '#fbbf24' : '#ef4444';
        })()};">
            ${(() => {
                const totalXuts = data.totalGols + (data.totalXutsFallats || 0);
                const efic = totalXuts > 0 ? (data.totalGols / totalXuts * 100).toFixed(1) : '0.0';
                return totalXuts > 0 ? `${data.totalGols}/${totalXuts} (${efic}%)` : '-';
            })()}
        </div>
    </div>
    ` : ''}
    <div class="info-item">
        <div class="info-label">Mejor Partido</div>
        <div class="info-value" style="color: #22c55e;">${isGoalkeeper ? (data.bestParades || 0) + ' parades' : bestMatch + ' goles'}</div>
    </div>
    <div class="info-item">
        <div class="info-label">Total Exclusiones</div>
        <div class="info-value" style="color: #f97316;">${data.totalExclusions}</div>
    </div>
    <div class="info-item">
        <div class="info-label">Media Exclusiones/Partido</div>
        <div class="info-value">${avgExc}</div>
    </div>
    <div class="info-item">
        <div class="info-label">üéØ Assist√®ncies</div>
        <div class="info-value" style="color: #22c55e;">${data.totalAssistencies || 0}</div>
    </div>
    <div class="info-item">
        <div class="info-label">üõ°Ô∏è Robatoris</div>
        <div class="info-value" style="color: #06b6d4;">${data.totalRobatoris || 0}</div>
    </div>
    <div class="info-item">
        <div class="info-label">‚ùå P√®rdues</div>
        <div class="info-value" style="color: #ef4444;">${data.totalPerdues || 0}</div>
    </div>
    <div class="info-item">
        <div class="info-label">üéØ‚ùå Xuts Fallats</div>
        <div class="info-value" style="color: #f97316;">${data.totalXutsFallats || 0}</div>
    </div>
    <div class="info-item">
        <div class="info-label">Penaltis Fallados</div>
        <div class="info-value" style="color: ${data.penaltyMissed === 0 ? '#22c55e' : '#ef4444'};">${data.penaltyMissed}</div>
    </div>
    <div class="info-item">
        <div class="info-label">Titularidad</div>
        <div class="info-value">${totalTitular}/${maxPossibleTitular} <span style="font-size: 14px;">(${titularPercentage}%)</span></div>
    </div>
    ${data.swimRacesTotal > 0 ? `
    <div class="info-item">
        <div class="info-label">üèä Curses Guanyades</div>
        <div class="info-value" style="color: #22c55e;">${data.swimRacesWon}/${data.swimRacesTotal}</div>
    </div>
    <div class="info-item">
        <div class="info-label">% Curses</div>
        <div class="info-value" style="color: ${data.swimRacesTotal > 0 && (data.swimRacesWon / data.swimRacesTotal * 100) >= 50 ? '#22c55e' : '#ef4444'};">
            ${data.swimRacesTotal > 0 ? ((data.swimRacesWon / data.swimRacesTotal) * 100).toFixed(1) : '0'}%
        </div>
    </div>
    ` : ''}
`;

// Desglossament de gols o parades segons tipus de jugador
const goalLabels = {
    'h+': 'Superioridad (H+)',
    'penalty': 'Penaltis',
    'contra': 'Contraataques',
    'boya': 'Boya',
    'normal': 'Normales'
};

const paradeLabels = {
    'corner': 'Corner',
    'rebuig': 'Rebuig',
    'atrapa': 'Atrapa',
    'penal': 'Penal'
};
    
    if (isGoalkeeper) {
        // Per porters: mostrar parades
        document.getElementById('playerGoalsBreakdown').innerHTML = Object.keys(data.paradeTypes)
            .filter(type => data.paradeTypes[type] > 0)
            .map(type => `
                <div class="breakdown-item">
                    <div class="breakdown-label">${paradeLabels[type]}</div>
                    <div class="breakdown-value">${data.paradeTypes[type]}</div>
                    <div style="font-size: 11px; color: #bae6fd; margin-top: 4px;">
                        ${data.totalParades > 0 ? ((data.paradeTypes[type] / data.totalParades) * 100).toFixed(1) : 0}%
                    </div>
                </div>
            `).join('') || '<p class="no-data" style="padding: 20px;">No hay datos de tipos de parades</p>';
        
        // Canviar el t√≠tol
        const titleElement = document.querySelector('#playerStatsCard h3');
        if (titleElement && titleElement.textContent.includes('Desglose de Goles')) {
            titleElement.textContent = 'üß§ Desglose de Parades';
        }
        
        // Zones de gols rebuts pels porters
        renderGoalkeeperReceivedZones(data);
        
    } else {
        // Per jugadors de camp: mostrar gols
        document.getElementById('playerGoalsBreakdown').innerHTML = Object.keys(data.goalTypes)
            .filter(type => data.goalTypes[type] > 0)
            .map(type => `
                <div class="breakdown-item">
                    <div class="breakdown-label">${goalLabels[type]}</div>
                    <div class="breakdown-value">${data.goalTypes[type]}</div>
                    <div style="font-size: 11px; color: #bae6fd; margin-top: 4px;">
                        ${data.totalGols > 0 ? ((data.goalTypes[type] / data.totalGols) * 100).toFixed(1) : 0}%
                    </div>
                </div>
            `).join('') || '<p class="no-data" style="padding: 20px;">No hay datos de tipos de goles</p>';
        
        // Zones de gols per jugadors de camp
        renderPlayerGoalZones(data);
    }
    
    renderPlayerEvolutionChart(data);
    renderPlayerExclusionsChart(data);
    
    document.getElementById('playerStatsCard').scrollIntoView({ behavior: 'smooth' });
}
function explodeLiveActions(match) {
  const acts = match?.chronologicalActions || [];
  const out = [];

  for (const a of acts) {
    // deixem passar totes les accions existents
    out.push(a);

    // üëâ crear una acci√≥ virtual de "falta rebuda" quan el RIVAL √©s excl√≤s sobre un jugador CNT
    if (a.type === 'exclusion' && a.team === 'rival' && a.faltaSobreJugador) {
      out.push({
        timestamp: a.timestamp,
        quarter: a.quarter,
        type: 'falta-rebuda',
        team: 'cnt',
        playerNum: Number(a.faltaSobreJugador),
        playerName: (match.players || []).find(p => p.num === Number(a.faltaSobreJugador))?.name || `Jugador ${a.faltaSobreJugador}`
      });
    }
  }
  // ordena per temps per si cal
  out.sort((x,y) => x.timestamp - y.timestamp);
  return out;
}
function renderSwimRacesStats() {
    if (allMatches.length === 0) return;
    
    const swimStats = {};
    
    // Inicialitzar
    players.forEach(p => {
        swimStats[p.name] = { won: 0, lost: 0, total: 0 };
    });
    
    // Comptar curses
    allMatches.forEach(match => {
        if (match.chronologicalActions) {
            match.chronologicalActions.forEach(action => {
                if (action.type === 'swim-race' && action.team === 'cnt') {
                    const playerName = action.playerName;
                    if (swimStats[playerName]) {
                        swimStats[playerName].total++;
                        if (action.result === 'win') {
                            swimStats[playerName].won++;
                        } else {
                            swimStats[playerName].lost++;
                        }
                    }
                }
            });
        }
    });
    
    // Filtrar jugadors amb curses
    const playersWithSwims = Object.entries(swimStats)
        .filter(([name, data]) => data.total > 0)
        .sort((a, b) => b[1].won - a[1].won);
    
    if (playersWithSwims.length === 0) {
        return '<div class="no-data">No hi ha dades de curses</div>';
    }
    
    return `
        <div class="card">
            <h2 class="section-title">üèä Estad√≠stiques de Curses Inicials</h2>
            <div style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Jugador</th>
                            <th>üèÜ Guanyades</th>
                            <th>‚ùå Perdudes</th>
                            <th>Total</th>
                            <th>% √àxit</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${playersWithSwims.map(([name, data]) => {
                            const percentage = ((data.won / data.total) * 100).toFixed(1);
                            const colorClass = percentage >= 50 ? '#22c55e' : '#ef4444';
                            return `
                                <tr>
                                    <td style="font-weight: bold;">${name.split(' ')[0]}</td>
                                    <td style="color: #22c55e; font-weight: bold;">${data.won}</td>
                                    <td style="color: #ef4444;">${data.lost}</td>
                                    <td>${data.total}</td>
                                    <td style="color: ${colorClass}; font-weight: bold;">${percentage}%</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
            <div style="margin-top: 15px; padding: 12px; background: rgba(34, 211, 238, 0.1); border-radius: 8px; text-align: center;">
                <div style="font-size: 12px; color: #bae6fd;">Millor cursador</div>
                <div style="font-size: 18px; color: #22d3ee; font-weight: bold; margin-top: 4px;">
                    ${playersWithSwims[0][0].split(' ')[0]} (${playersWithSwims[0][1].won}/${playersWithSwims[0][1].total})
                </div>
            </div>
        </div>
    `;
}
function renderPlayerEvolutionChart(data) {
    const ctx = document.getElementById('playerEvolutionChart');
    if (!ctx) return;
    
    if (window.playerEvolutionChartInstance) {
        window.playerEvolutionChartInstance.destroy();
    }
    
    window.playerEvolutionChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.dates,
            datasets: [{
                label: 'Goles por Partido',
                data: data.gols,
                borderColor: '#fde047',
                backgroundColor: 'rgba(253, 224, 71, 0.1)',
                tension: 0.3,
                fill: true,
                pointRadius: 5,
                pointHoverRadius: 7,
                pointBackgroundColor: '#fde047'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { 
                    display: true,
                    labels: { color: 'white', font: { size: 14 } }
                }
            },
            scales: {
                y: { 
                    beginAtZero: true,
                    ticks: { color: 'white', stepSize: 1 },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                },
                x: { 
                    ticks: { color: 'white', font: { size: 11 } },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            }
        }
    });
}

function renderPlayerExclusionsChart(data) {
    const ctx = document.getElementById('playerExclusionsChart');
    if (!ctx) return;
    
    if (window.playerExclusionsChartInstance) {
        window.playerExclusionsChartInstance.destroy();
    }
    
    window.playerExclusionsChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.dates,
            datasets: [{
                label: 'Exclusiones por Partido',
                data: data.exclusions,
                backgroundColor: '#f97316',
                borderColor: '#ea580c',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { 
                    display: true,
                    labels: { color: 'white', font: { size: 14 } }
                }
            },
            scales: {
                y: { 
                    beginAtZero: true,
                    ticks: { color: 'white', stepSize: 1 },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                },
                x: { 
                    ticks: { color: 'white', font: { size: 11 } },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            }
        }
    });
}

function clearPlayerFilter() {
    document.getElementById('filterPlayer').value = '';
    document.getElementById('playerStatsCard').classList.add('hidden');
}
function renderMatchTimeline() {
    const container = document.getElementById('matchTimeline');
    const swimRacesContainer = document.getElementById('matchSwimRacesContainer');
    const swimRacesCard = document.getElementById('swimRacesCard');
     // Mapeig de tipus de gol a icones
    const goalTypeIcons = {
        'normal': 'üü¢',
        'boya': '‚öì',
        'h+': '‚ûï',
        'contra': '‚ö°',
        'penalty': 'üéØ'
    };
    
    // Mapeig de zones a text
    const goalZoneNames = {
        'top-left': 'Sup. Esq.',
        'top-center': 'Sup. Centre',
        'top-right': 'Sup. Dreta',
        'mid-left': 'Mig Esq.',
        'mid-center': 'Mig Centre',
        'mid-right': 'Mig Dreta',
        'bottom-left': 'Inf. Esq.',
        'bottom-center': 'Inf. Centre',
        'bottom-right': 'Inf. Dreta',
        // Afegeix les zones que utilitzis si s√≥n diferents
    };
	// Mapeig de zones del camp
const fieldZoneNames = {
    '2m-left': '2m Esq.',
    '2m-center': '2m Centre',
    '2m-right': '2m Dre.',
    '5m-left': '-6m Esq.',
    '5m-center': '-6m Centre',
    '5m-right': '-6m Dre.',
    '+6m-left': '+6m Esq.',
    '+6m-center': '+6m Centre',
    '+6m-right': '+6m Dre.'
};
    if (!container || !currentMatch) return;
    
    // Verificar si hay acciones cronol√≥gicas guardadas
    if (!currentMatch.chronologicalActions || currentMatch.chronologicalActions.length === 0) {
        container.innerHTML = '<div class="no-timeline">‚ö†Ô∏è Este partido no tiene registro cronol√≥gico de acciones.<br><small style="margin-top: 8px; display: block;">Los partidos nuevos registrados con la app actualizada mostrar√°n las acciones en orden.</small></div>';
        
        if (swimRacesCard) swimRacesCard.style.display = 'none';
        return;
    }
    
    // ========== C√ÄLCUL DE TEMPS DE JOC PER QUART ==========
    // Funci√≥ per calcular temps de joc proporcional i temps real del quart
    function calculateTimes(action, quarterStats) {
        const quarter = action.quarter;
        const stats = quarterStats[quarter];
        
        if (!stats) return { gameMinutes: 0, gameSeconds: 0, realMinutes: 0, realSeconds: 0 };
        
        // Temps transcorregut des de l'inici del quart (en ms)
        const elapsedRealTime = action.timestamp - stats.firstTimestamp;
        
        // Durada real total del quart (en ms)
        const totalRealTime = stats.lastTimestamp - stats.firstTimestamp;
        
        // TEMPS DE JOC: proporci√≥ a 8 minuts
        const GAME_TIME_PER_QUARTER = 8 * 60 * 1000; // 8 minuts en ms
        const gameTime = (elapsedRealTime / totalRealTime) * GAME_TIME_PER_QUARTER;
        
        const gameMinutes = Math.floor(gameTime / 60000);
        const gameSeconds = Math.floor((gameTime % 60000) / 1000);
        
        // TEMPS REAL: temps transcorregut des de l'inici del quart
        const realMinutes = Math.floor(elapsedRealTime / 60000);
        const realSeconds = Math.floor((elapsedRealTime % 60000) / 1000);
        
        return { gameMinutes, gameSeconds, realMinutes, realSeconds };
    }
    
    // Calcular estad√≠stiques de cada quart (primera i √∫ltima acci√≥)
    const quarterStats = {};
    const sortedActions = [...currentMatch.chronologicalActions]
        .sort((a, b) => a.timestamp - b.timestamp);
    
    sortedActions.forEach(action => {
        const quarter = action.quarter;
        if (!quarterStats[quarter]) {
            quarterStats[quarter] = {
                firstTimestamp: action.timestamp,
                lastTimestamp: action.timestamp
            };
        } else {
            quarterStats[quarter].lastTimestamp = action.timestamp;
        }
    });
    
    // ========== RENDERITZAR CURSES INICIALS ==========
    const swimRaces = currentMatch.chronologicalActions?.filter(a => a.type === 'swim-race') || [];

    if (swimRaces.length > 0 && swimRacesContainer && swimRacesCard) {
        const swimHTML = `
            ${swimRaces.map(race => {
                const icon = race.result === 'win' ? '‚úÖ' : '‚ùå';
                const color = race.result === 'win' ? '#22c55e' : '#ef4444';
                const quarter = race.quarter.toUpperCase();
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; margin-bottom: 6px; background: rgba(0,0,0,0.2); border-radius: 6px; border-left: 3px solid ${color};">
                        <span style="color: #bae6fd; font-weight: 600; min-width: 80px;">${quarter}</span>
                        <span style="color: white; flex: 1; text-align: center;">${race.playerName.split(' ')[0]}</span>
                        <span style="color: ${color}; font-weight: bold; min-width: 100px; text-align: right;">${icon} ${race.result === 'win' ? 'Guanyada' : 'Perduda'}</span>
                    </div>
                `;
            }).join('')}
        `;
        
        swimRacesContainer.innerHTML = swimHTML;
        swimRacesCard.style.display = 'block';
    } else {
        if (swimRacesCard) swimRacesCard.style.display = 'none';
    }
 
    // ========== RENDERITZAR CRONOLOGIA DEL PARTIT ==========
    const goalTypeLabels = {
        'h+': 'Superioridad (H+)',
        'penalty': 'Penalty',
        'contra': 'Contraataque',
        'boya': 'Boya',
        'normal': 'Normal'
    };
    
    const quarterLabels = {
        'q1': '1¬∫ Cuarto',
        'q2': '2¬∫ Cuarto',
        'q3': '3¬∫ Cuarto',
        'q4': '4¬∫ Cuarto'
    };
    
    container.innerHTML = `
        <div class="timeline">
            ${sortedActions.map(action => {
                let detailText = '';
                let icon = '';
                let cssClass = '';
                const isRival = action.team === 'rival';
                const playerClass = isRival ? 'timeline-rival' : 'timeline-player';
                const teamName = isRival ? (currentMatch.rivalTeam || 'Rival') : 'CN Terrassa';
                
                // Calcular temps de joc i temps real del quart
                const { gameMinutes, gameSeconds, realMinutes, realSeconds } = calculateTimes(action, quarterStats);
                
                // Format de temps millorat amb etiquetes m√©s clares
                const timeDisplay = `
                    <div style="font-size: 11px; margin-top: 6px; display: flex; gap: 12px;">
                        <span style="color: #22c55e; font-weight: 600;">
                            ‚è±Ô∏è ${gameMinutes}:${gameSeconds.toString().padStart(2, '0')}
                            <span style="font-weight: 400; opacity: 0.7; font-size: 10px;"> temps joc</span>
                        </span>
                        <span style="color: #94a3b8;">
                            üïê ${realMinutes}:${realSeconds.toString().padStart(2, '0')}
                            <span style="opacity: 0.7; font-size: 10px;"> temps real</span>
                        </span>
                    </div>
                `;
                
                // TIPUS D'ACCIONS
                if (action.type === 'action') {
                    if (action.actionType === 'robatori') {
                        icon = 'ü§ö';
                        cssClass = 'goal';
                        detailText = 'Robatori';
                    } else if (action.actionType === 'perdua') {
                        icon = 'üîÑ';
                        cssClass = 'exclusion';
                        detailText = 'P√®rdua de pilota';
                    } else if (action.actionType === 'assistencia') {
                        icon = 'üéØ';
                        cssClass = 'goal';
                        detailText = 'Assist√®ncia';
                    } else if (action.actionType === 'xut') {
                        icon = 'ü•Ö‚ùå';
                        cssClass = 'exclusion';
                        detailText = 'Xut fallat';
                    } else if (action.actionType === 'block') {
                        icon = 'üö´';
                        cssClass = 'goal';
                        detailText = 'Blocatge';
                    } else if (action.actionType === '2metres') {  // ‚úÖ AFEGEIX AQUEST BLOC
						icon = 'üìè';
						cssClass = 'exclusion';
						detailText = 'Infracci√≥ 2 metres';
					}
                } else if (action.type === 'save') {
                    icon = 'üß§';
                    cssClass = 'goal';
                    detailText = action.saveType === 'atrapa' ? 'Aturada - Atrapa' : 'Aturada - Desvia';
    } else if (action.type === 'goal') {
    icon = 'ü•ÖüéØ';
    cssClass = 'goal';
    detailText = `Gol ${goalTypeLabels[action.goalType]}`;
    
    // Afegir informaci√≥ de zones si existeix
    const zoneInfo = [];
    if (action.fieldZone && fieldZoneNames[action.fieldZone]) {
        zoneInfo.push(`üìç ${fieldZoneNames[action.fieldZone]}`);
    }
    if (action.goalZone && goalZoneNames[action.goalZone]) {
        zoneInfo.push(`üéØ ${goalZoneNames[action.goalZone]}`);
    }
    
    if (zoneInfo.length > 0) {
        detailText += ` <span style="font-size: 11px; opacity: 0.8;">(${zoneInfo.join(' ¬∑ ')})</span>`;
    }
    
    // ‚úÖ CALCULAR MARCADOR FINS AQUEST MOMENT
    const actionIndex = sortedActions.indexOf(action);
    const actionsUntilNow = sortedActions.slice(0, actionIndex + 1);
    let scoreCNT = 0;
    let scoreRival = 0;
    actionsUntilNow.forEach(a => {
        if (a.type === 'goal') {
            if (a.team === 'rival') {
                scoreRival++;
            } else {
                scoreCNT++;
            }
        }
    });
    detailText += ` <span style="color: #fde047; font-weight: bold; margin-left: 8px;">${scoreCNT}-${scoreRival}</span>`;
} else if (action.type === 'exclusion') {
                    if (action.exclusionType === 'penalty') {
                        icon = 'üî¥üèê';
                        detailText = 'Penalty cometido';
                    } else {
                        icon = 'üî¥‚è±Ô∏è';
                        detailText = 'Exclusi√≥n 20 seg.';
                    }
                    cssClass = 'exclusion';
                    
                    if (isRival && action.faltaSobreJugador) {
                        const jugadorCNT = currentMatch.jugadors.find(j => j.numero == action.faltaSobreJugador);
                        if (jugadorCNT) {
                            detailText += ` <span style="font-size: 11px; opacity: 0.7;">(falta sobre ${jugadorCNT.numero}. ${jugadorCNT.nom.split(' ').slice(0, 2).join(' ')})</span>`;
                        }
                    }
                } else if (action.type === 'water-change') {
                    icon = action.action === 'in' ? 'üèäüü¢' : 'üèäüî¥';
                    cssClass = 'water-change';
                    detailText = action.action === 'in' ? 'Entra al agua' : 'Sale del agua';
                } else if (action.type === 'swim-race') {
                    icon = action.result === 'win' ? 'üèä‚úÖ' : 'üèä‚ùå';
                    cssClass = action.result === 'win' ? 'goal' : 'exclusion';
                    detailText = `Cursa inici quart - ${action.result === 'win' ? 'Guanyada' : 'Perduda'}`;
                } else if (action.type === 'penalty-missed') {
					icon = 'ü•Ö‚ùå';
					cssClass = 'penalty-missed';
				    detailText = 'Penal fallat';
				}
                
                return `
                    <div class="timeline-item ${cssClass}">
                        <div class="timeline-icon">${icon}</div>
                        <div class="timeline-content">
                            <div class="${playerClass}">
                                ${action.playerNum}. ${action.playerName}
                                <span style="font-size: 11px; opacity: 0.8;">(${teamName})</span>
                            </div>
                            <div class="timeline-detail">${detailText}</div>
                            ${timeDisplay}
                        </div>
                        <div class="timeline-quarter">${quarterLabels[action.quarter] || action.quarter}</div>
                    </div>
                `;
            }).join('')}
        </div>
    `;
}

function renderPlayingTimes() {
    const container = document.getElementById('playingTimesContainer');
    
    if (!container || !currentMatch) return;
    
    if (!currentMatch.playerWaterChanges || currentMatch.playerWaterChanges.length === 0 || !currentMatch.quarterStartTimes) {
        container.innerHTML = '<div class="no-data">‚ö†Ô∏è Aquest partit no t√© registre de temps de joc.</div>';
        return;
    }
    
    // Utilitzar la funci√≥ centralitzada
    const playerTimes = calculateMatchPlayingTimes(currentMatch);
    const players = Object.values(playerTimes).sort((a, b) => b.totalTime - a.totalTime);
    
    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }
    
    const maxTime = 32 * 60; // 32 minuts m√†xim
    
    // Els 7 amb m√©s minuts
    const topPlayers = players.slice(0, 7);
    const goalkeeper = topPlayers.find(p => p.num === 1 || p.num === 13) || topPlayers[0];
    const fieldPlayers = topPlayers
        .filter(p => p.num !== goalkeeper.num)
        .slice(0, 6);
    
    container.innerHTML = `
        <div class="pool-container">
            <div class="pool-goal">
                <div style="font-size: 12px; color: #fca5a5; font-weight: bold;">PORTERIA</div>
            </div>
            
            <div class="pool-players">
                <!-- Porter -->
                <div class="pool-goalkeeper">
                    <div class="pool-player">
                        <div class="pool-player-num" style="background: #8b5cf6;">${goalkeeper.num}</div>
                        <div class="pool-player-name">${goalkeeper.name.split(' ').slice(0, 2).join(' ')}</div>
                        <div class="pool-player-stat">
                            ${formatTime(goalkeeper.totalTime)}
                        </div>
                        <div class="pool-player-stat" style="color: #fde047; font-weight: bold;">
                            ${((goalkeeper.totalTime / maxTime) * 100).toFixed(0)}%
                        </div>
                    </div>
                </div>
                
                <!-- Jugadors de camp -->
                <div class="pool-field-players">
                    ${fieldPlayers.map(p => {
                        const percentage = ((p.totalTime / maxTime) * 100).toFixed(0);
                        const opacity = 0.5 + (parseFloat(percentage) / 200);
                        return `
                            <div class="pool-player" style="opacity: ${opacity};">
                                <div class="pool-player-num">${p.num}</div>
                                <div class="pool-player-name">${p.name.split(' ').slice(0, 2).join(' ')}</div>
                                <div class="pool-player-stat">
                                    ${formatTime(p.totalTime)}
                                </div>
                                <div class="pool-player-stat" style="color: #fde047; font-weight: bold;">
                                    ${percentage}%
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
            
            <div class="pool-midfield">
                ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ MIG CAMP ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
            </div>
        </div>
        
        <p style="font-size: 12px; color: #bae6fd; margin-top: 15px; text-align: center;">
            üèä‚Äç‚ôÇÔ∏è Els 7 jugadors amb m√©s temps de joc en aquest partit<br>
            ‚è±Ô∏è Temps m√†xim: 32 minuts (4 quarts √ó 8 minuts)
        </p>
        
        <details open style="margin-top: 20px;">
            <summary style="cursor: pointer; color: #22d3ee; font-weight: bold; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                üìä Veure taula completa de temps
            </summary>
            <table class="stats-table" style="margin-top: 15px;">
                <thead>
                    <tr>
                        <th>N¬∫</th>
                        <th>Jugador</th>
                        <th>1Q</th>
                        <th>2Q</th>
                        <th>3Q</th>
                        <th>4Q</th>
                        <th>TOTAL</th>
                        <th>%</th>
                    </tr>
                </thead>
                <tbody>
                    ${players.map(p => {
                        const percentage = ((p.totalTime / maxTime) * 100).toFixed(1);
                        const color = percentage >= 75 ? '#22c55e' : percentage >= 50 ? '#fbbf24' : '#f97316';
                        
                        return `
                            <tr>
                                <td><div class="player-num" style="width: 30px; height: 30px; font-size: 12px;">${p.num}</div></td>
                                <td><strong>${p.name}</strong></td>
                                <td>${formatTime(p.q1)}</td>
                                <td>${formatTime(p.q2)}</td>
                                <td>${formatTime(p.q3)}</td>
                                <td>${formatTime(p.q4)}</td>
                                <td><strong style="color: #fde047;">${formatTime(p.totalTime)}</strong></td>
                                <td><strong style="color: ${color};">${percentage}%</strong></td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </details>
    `;
}
// ============================================
// FUNCIONES PARA ESTAD√çSTICAS DE TIEMPO
// ============================================

function displayTimeStats() {
    console.log('=== displayTimeStats called ===');
    console.log('Total matches:', allMatches.length);
    console.log('allMatches:', allMatches);
    
    // Filtrar partidos con datos de tiempo
    matchesWithTime = allMatches.filter(m => {
        console.log('Checking match:', m.rivalTeam);
        console.log('- Has playerWaterChanges:', !!m.playerWaterChanges);
        console.log('- playerWaterChanges length:', m.playerWaterChanges ? m.playerWaterChanges.length : 0);
        console.log('- Has quarterStartTimes:', !!m.quarterStartTimes);
        
        // Excluir partidos sin datos de tiempo completos
        const hasTimeData = m.playerWaterChanges && 
                            m.playerWaterChanges.length > 0 && 
                            m.quarterStartTimes;
        
        if (!hasTimeData) {
            console.warn('Partido sin datos de tiempo completos:', m.rivalTeam);
        }
        
        return hasTimeData;
    });
    
    console.log('Matches with time data:', matchesWithTime.length);
    console.log('matchesWithTime:', matchesWithTime);
    
    if (matchesWithTime.length === 0) {
        document.getElementById('tiempoTab').innerHTML = `
            <div class="card">
                <div class="no-data">
                    <p style="color: #fbbf24; font-size: 18px; margin-bottom: 10px;">‚ö†Ô∏è No hay datos de tiempo disponibles</p>
                    <p style="font-size: 14px; color: #bae6fd;">
                        Los partidos deben tener registrados los cambios de agua (playerWaterChanges) y tiempos de cuarto (quarterStartTimes) para mostrar estas estad√≠sticas.
                    </p>
                    <p style="font-size: 12px; color: #bae6fd; margin-top: 10px;">
                        Partidos cargados: ${allMatches.length}<br>
                        Partidos con datos de tiempo: 0
                    </p>
                </div>
            </div>
        `;
        return;
    }
    
    console.log('Calling populatePlayerTimeFilter...');
    populatePlayerTimeFilter();
    
    console.log('Calling renderTotalTimeChart...');
    renderTotalTimeChart();
    console.log('Calling renderGlobalTimePool...');
	renderGlobalTimePool();  // ‚Üê AFEGEIX AQUESTA L√çNIA
    console.log('Calling renderTimeHeatmapTable...');
    renderTimeHeatmapTable();
   
    console.log('Calling other render functions...');
    renderEfficiencyPerMinuteChart();
    renderMinutesDistributionChart();
    renderPlusMinusChart();
    renderLoadBalanceStats();
    renderQuarterAnalysisTable();
    renderPerformanceVsTimeChart();
    renderFatigueAnalysisTable();
    renderRotationStats();
    
    console.log('=== displayTimeStats finished ===');
}
function renderGlobalTimePool() {
    const container = document.getElementById('globalTimePoolContainer');
    if (!container || matchesWithTime.length === 0) return;
    
    // Calcular temps total per jugador
    const playerTotalTimes = {};
    
    matchesWithTime.forEach(match => {
        const playerTimes = calculateMatchPlayingTimes(match);
        Object.values(playerTimes).forEach(pt => {
            const key = `${pt.num}|${pt.name}`;
            if (!playerTotalTimes[key]) {
                playerTotalTimes[key] = {
                    num: pt.num,
                    name: pt.name,
                    totalTime: 0,
                    matches: 0
                };
            }
            playerTotalTimes[key].totalTime += pt.totalTime;
            playerTotalTimes[key].matches++;
        });
    });
    
    // Ordenar per temps total
    const sortedPlayers = Object.values(playerTotalTimes)
        .sort((a, b) => b.totalTime - a.totalTime);
    
    // Els 7 amb m√©s minuts
    const topPlayers = sortedPlayers.slice(0, 7);
    const goalkeeper = topPlayers.find(p => p.num === 1 || p.num === 13) || topPlayers[0];
    const fieldPlayers = topPlayers
        .filter(p => p.num !== goalkeeper.num)
        .slice(0, 6);
    
    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }
    
    const maxPossibleTime = matchesWithTime.length * 32 * 60; // Tots els partits √ó 32 min
    
    container.innerHTML = `
        <div class="pool-container">
            <div class="pool-goal">
                <div style="font-size: 12px; color: #fca5a5; font-weight: bold;">PORTERIA</div>
            </div>
            
            <div class="pool-players">
                <!-- Porter -->
                <div class="pool-goalkeeper">
                    <div class="pool-player">
                        <div class="pool-player-num" style="background: #8b5cf6;">${goalkeeper.num}</div>
                        <div class="pool-player-name">${goalkeeper.name.split(' ').slice(0, 2).join(' ')}</div>
                        <div class="pool-player-stat">
                            ${formatTime(goalkeeper.totalTime)}
                        </div>
                        <div class="pool-player-stat" style="color: #fde047; font-weight: bold;">
                            ${goalkeeper.matches} partits
                        </div>
                        <div class="pool-player-stat" style="color: #bae6fd; font-size: 9px;">
                            ${formatTime(Math.round(goalkeeper.totalTime / goalkeeper.matches))}/partit
                        </div>
                    </div>
                </div>
                
                <!-- Jugadors de camp -->
                <div class="pool-field-players">
                    ${fieldPlayers.map(p => {
                        const avgTimePerMatch = p.totalTime / p.matches;
                        const percentage = ((avgTimePerMatch / (32 * 60)) * 100).toFixed(0);
                        const opacity = 0.5 + (parseFloat(percentage) / 200);
                        return `
                            <div class="pool-player" style="opacity: ${opacity};">
                                <div class="pool-player-num">${p.num}</div>
                                <div class="pool-player-name">${p.name.split(' ').slice(0, 2).join(' ')}</div>
                                <div class="pool-player-stat">
                                    ${formatTime(p.totalTime)}
                                </div>
                                <div class="pool-player-stat" style="color: #fde047; font-weight: bold;">
                                    ${p.matches} partits
                                </div>
                                <div class="pool-player-stat" style="color: #bae6fd; font-size: 9px;">
                                    ${formatTime(Math.round(avgTimePerMatch))}/partit
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
            
            <div class="pool-midfield">
                ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ MIG CAMP ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
            </div>
        </div>
        
        <p style="font-size: 12px; color: #bae6fd; margin-top: 15px; text-align: center;">
            üèä‚Äç‚ôÇÔ∏è Els 7 jugadors amb m√©s temps acumulat<br>
            üìä Partits analitzats: ${matchesWithTime.length}
        </p>
    `;
}
function populatePlayerTimeFilter() {
    const select = document.getElementById('filterPlayerTime');
    
    if (matchesWithTime.length === 0) return;
    
    const playerSet = new Set();
    
    matchesWithTime.forEach(match => {
        match.jugadors.forEach(j => {
            playerSet.add(JSON.stringify({ num: j.numero, name: j.nom.trim() }));
        });
    });
    
    const players = Array.from(playerSet)
        .map(p => JSON.parse(p))
        .sort((a, b) => a.num - b.num);
    
    select.innerHTML = '<option value="">Todos los jugadores</option>' +
    players.map(p => `<option value="${p.num}|${p.name}">${p.num}. ${p.name}</option>`).join('');
}

function filterByPlayerTime() {
    const playerValue = document.getElementById('filterPlayerTime').value;
    
    if (!playerValue) {
        document.getElementById('playerTimeStatsCard').classList.add('hidden');
        return;
    }
    
    // Parsejar el valor: "numero|nom"
    const [numero, ...nameParts] = playerValue.split('|');
    const nom = nameParts.join('|'); // Per si el nom cont√© "|"
    
    const player = {
        numero: parseInt(numero),
        nom: nom
    };
    
    const playerTimeData = calculatePlayerTimeData(player);
    displayPlayerTimeStats(playerTimeData);
}

function clearPlayerTimeFilter() {
    document.getElementById('filterPlayerTime').value = '';
    document.getElementById('playerTimeStatsCard').classList.add('hidden');
}

function calculatePlayerTimeData(player) {
    const data = {
        num: player.numero,
        name: player.nom,
        partidos: 0,
        totalTime: 0,
        timeByQuarter: { q1: 0, q2: 0, q3: 0, q4: 0 },
        timeByMatch: [],
        dates: [],
        gols: 0,
        exclusions: 0,
        titularTime: 0,
        suplenteTime: 0,
        titularGols: 0,
        suplenteGols: 0,
        titularExclusions: 0,
        suplenteExclusions: 0
    };
    
    // Ordenar per data (m√©s antic primer)
    const sortedMatches = [...matchesWithTime].sort((a, b) => new Date(a.data) - new Date(b.data));
    
    sortedMatches.forEach(match => {
        const matchPlayer = match.jugadors.find(j => j.numero === player.numero);
        if (!matchPlayer) return;
        
        data.partidos++;
        data.dates.push(match.data ? new Date(match.data).toLocaleDateString('ca-ES') : 'N/A');
        data.gols += matchPlayer.estadistiques?.gols || 0;
        data.exclusions += matchPlayer.estadistiques?.exclusions || 0;
        
        // Utilitzar la funci√≥ amb ponderaci√≥
        const matchTimes = calculateMatchPlayingTimes(match);
        const playerTime = matchTimes[player.numero];
        
        if (playerTime) {
            let matchTime = 0;
            
            ['q1', 'q2', 'q3', 'q4'].forEach(quarter => {
                const isTitular = match.lineups?.[quarter]?.includes(player.numero);
                const quarterTime = playerTime[quarter];
                
                data.timeByQuarter[quarter] += quarterTime;
                matchTime += quarterTime;
                
                if (isTitular) {
                    data.titularTime += quarterTime;
                } else {
                    data.suplenteTime += quarterTime;
                }
            });
            
            data.timeByMatch.push(matchTime);
            data.totalTime += matchTime;
        }
    });
    
    // Calcular proporci√≥ de gols/exclusions segons temps de titular/suplent
    if (data.totalTime > 0) {
        const titularRatio = data.titularTime / data.totalTime;
        data.titularGols = Math.round(data.gols * titularRatio);
        data.suplenteGols = data.gols - data.titularGols;
        data.titularExclusions = Math.round(data.exclusions * titularRatio);
        data.suplenteExclusions = data.exclusions - data.titularExclusions;
    }
    
    
    
    return data;
}
function displayPlayerTimeStats(data) {
    document.getElementById('playerTimeStatsCard').classList.remove('hidden');
    document.getElementById('selectedPlayerTimeName').textContent = `${data.num}. ${data.name}`;
    
    const avgTime = data.partidos > 0 ? (data.totalTime / data.partidos / 60).toFixed(1) : 0;
    const maxPossibleTime = data.partidos * 32;
    const timePercentage = maxPossibleTime > 0 ? ((data.totalTime / 60 / maxPossibleTime) * 100).toFixed(1) : 0;
    const goalsPerMinute = data.totalTime > 0 ? ((data.gols / (data.totalTime / 60))).toFixed(2) : 0;
    const exclusionsPerMinute = data.totalTime > 0 ? ((data.exclusions / (data.totalTime / 60))).toFixed(2) : 0;
    
  
    
    document.getElementById('playerTimeSummaryGrid').innerHTML = `
        <div class="info-item">
            <div class="info-label">Partidos con Datos</div>
            <div class="info-value">${data.partidos}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Tiempo Total Jugado</div>
            <div class="info-value" style="color: #fde047;">${formatTime(data.totalTime)}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Tiempo Promedio/Partido</div>
            <div class="info-value">${avgTime} min</div>
        </div>
        <div class="info-item">
            <div class="info-label">% del Tiempo M√°ximo</div>
            <div class="info-value" style="color: ${timePercentage >= 75 ? '#22c55e' : timePercentage >= 50 ? '#fbbf24' : '#f97316'};">${timePercentage}%</div>
        </div>
        <div class="info-item">
            <div class="info-label">Total Goles</div>
            <div class="info-value" style="color: #22c55e;">${data.gols}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Goles por Minuto</div>
            <div class="info-value">${goalsPerMinute}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Total Exclusiones</div>
            <div class="info-value" style="color: #f97316;">${data.exclusions}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Exclusiones por Minuto</div>
            <div class="info-value">${exclusionsPerMinute}</div>
        </div>
    `;
    
    // Eficiencia breakdown
    document.getElementById('playerEfficiencyBreakdown').innerHTML = `
        <div class="breakdown-item">
            <div class="breakdown-label">Goles / Minuto</div>
            <div class="breakdown-value" style="color: #22c55e;">${goalsPerMinute}</div>
        </div>
        <div class="breakdown-item">
            <div class="breakdown-label">Exclusiones / Minuto</div>
            <div class="breakdown-value" style="color: #f97316;">${exclusionsPerMinute}</div>
        </div>
        <div class="breakdown-item">
            <div class="breakdown-label">Ratio Gol/Exclusi√≥n</div>
            <div class="breakdown-value">${data.exclusions > 0 ? (data.gols / data.exclusions).toFixed(2) : data.gols}</div>
        </div>
    `;
    
    // Titular vs Suplente
    const titularMinutes = (data.titularTime / 60).toFixed(1);
    const suplenteMinutes = (data.suplenteTime / 60).toFixed(1);
    const titularGoalsPerMin = data.titularTime > 0 ? (data.titularGols / (data.titularTime / 60)).toFixed(2) : 0;
    const suplenteGoalsPerMin = data.suplenteTime > 0 ? (data.suplenteGols / (data.suplenteTime / 60)).toFixed(2) : 0;
    
    document.getElementById('playerTitularVsSuplenteGrid').innerHTML = `
        <div class="info-item">
            <div class="info-label">‚ö™ Tiempo como Titular</div>
            <div class="info-value" style="color: #22c55e;">${titularMinutes} min</div>
            <div style="font-size: 11px; color: #bae6fd; margin-top: 4px;">
                ${data.titularGols} goles (${titularGoalsPerMin}/min)
            </div>
        </div>
        <div class="info-item">
            <div class="info-label">üî¥ Tiempo como Suplente</div>
            <div class="info-value" style="color: #fbbf24;">${suplenteMinutes} min</div>
            <div style="font-size: 11px; color: #bae6fd; margin-top: 4px;">
                ${data.suplenteGols} goles (${suplenteGoalsPerMin}/min)
            </div>
        </div>
        <div class="info-item">
            <div class="info-label">‚ö° Diferencia Eficiencia</div>
            <div class="info-value" style="color: ${titularGoalsPerMin > suplenteGoalsPerMin ? '#22c55e' : '#ef4444'};">
                ${titularGoalsPerMin > suplenteGoalsPerMin ? '+ Titular' : '+ Suplente'}
            </div>
        </div>
    `;
    
    renderPlayerTimeEvolutionChart(data);
    renderPlayerTimeByQuarterChart(data);
    
    document.getElementById('playerTimeStatsCard').scrollIntoView({ behavior: 'smooth' });
}

function renderPlayerTimeEvolutionChart(data) {
    const ctx = document.getElementById('playerTimeEvolutionChart');
    if (!ctx) return;
    
    if (window.playerTimeEvolutionChartInstance) {
        window.playerTimeEvolutionChartInstance.destroy();
    }
    
    const timeInMinutes = data.timeByMatch.map(t => (t / 60).toFixed(1));
    
    window.playerTimeEvolutionChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.dates,
            datasets: [{
                label: 'Minutos Jugados',
                data: timeInMinutes,
                borderColor: '#06b6d4',
                backgroundColor: 'rgba(6, 182, 212, 0.1)',
                tension: 0.3,
                fill: true,
                pointRadius: 5,
                pointHoverRadius: 7,
                pointBackgroundColor: '#06b6d4'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { 
                    display: true,
                    labels: { color: 'white', font: { size: 14 } }
                }
            },
            scales: {
                y: { 
                    beginAtZero: true,
                    max: 32,
                    ticks: { color: 'white', stepSize: 4 },
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    title: {
                        display: true,
                        text: 'Minutos',
                        color: 'white'
                    }
                },
                x: { 
                    ticks: { color: 'white', font: { size: 11 } },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            }
        }
    });
}

function renderPlayerTimeByQuarterChart(data) {
    const ctx = document.getElementById('playerTimeByQuarterChart');
    if (!ctx) return;
    
    if (window.playerTimeByQuarterChartInstance) {
        window.playerTimeByQuarterChartInstance.destroy();
    }
    
    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }
    
    const labels = ['1¬∫ Cuarto', '2¬∫ Cuarto', '3¬∫ Cuarto', '4¬∫ Cuarto'];
    const timeData = [data.timeByQuarter.q1, data.timeByQuarter.q2, data.timeByQuarter.q3, data.timeByQuarter.q4];
    
    window.playerTimeByQuarterChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Tiempo Jugado (segundos)',
                data: timeData,
                backgroundColor: ['#22d3ee', '#06b6d4', '#0891b2', '#0e7490'],
                borderWidth: 1,
                borderColor: '#1e3a8a'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `Tiempo: ${formatTime(context.parsed.y)}`;
                        }
                    }
                }
            },
            scales: {
                y: { 
                    beginAtZero: true,
                    ticks: { 
                        color: 'white',
                        callback: function(value) {
                            return formatTime(value);
                        }
                    },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                },
                x: { 
                    ticks: { color: 'white' },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            }
        }
    });
}


// ============================================
// FUNCIONS AUXILIARS NECESS√ÄRIES (afegir ABANS de renderTotalTimeChart)
// ============================================

function getQuarterEndTimeHelper(quarterStartTimes, quarterRealEndTimes, quarter, quarterDuration) {
    // Prioritzar el temps real de finalitzaci√≥ si existeix
    if (quarterRealEndTimes && quarterRealEndTimes[quarter]) {
        return quarterRealEndTimes[quarter];
    }
    
    // Si no existeix, utilitzar l'inici del seg√ºent quart
    const quarterOrder = ['q1', 'q2', 'q3', 'q4'];
    const currentIndex = quarterOrder.indexOf(quarter);
    
    if (currentIndex < 3) {
        const nextQuarter = quarterOrder[currentIndex + 1];
        if (quarterStartTimes[nextQuarter]) {
            return quarterStartTimes[nextQuarter];
        }
    }
    
    // Si no hi ha res, afegir 8 minuts a l'inici del quart
    return quarterStartTimes[quarter] + (quarterDuration * 1000);
}

function calculatePlayerWaterPercentage(playerNum, quarter, playerWaterChanges, quarterStartTime, quarterEndTime, lineups) {
    // Verificar si el jugador √©s titular
    const lineup = lineups ? lineups[quarter] : [];
    const isTitular = lineup && lineup.includes(playerNum);
    
    // Obtenir els canvis del jugador
    const qChanges = playerWaterChanges
        .filter(c => c.playerNum === playerNum && c.quarter === quarter)
        .sort((a, b) => a.timestamp - b.timestamp);
    
    // Si √©s titular i no t√© canvis ‚Üí 100% del temps
    if (isTitular && qChanges.length === 0) {
        return 1.0; // 100%
    }
    
    // Si NO √©s titular i no t√© canvis ‚Üí 0% del temps
    if (!isTitular && qChanges.length === 0) {
        return 0.0; // 0%
    }
    
    const totalQuarterTime = (quarterEndTime - quarterStartTime) / 1000;
    if (totalQuarterTime <= 0) {
        return 0.0;
    }
    
    // Netejar canvis duplicats consecutius
    const cleanChanges = [];
    let lastAction = null;
    qChanges.forEach(change => {
        if (change.action !== lastAction) {
            cleanChanges.push(change);
            lastAction = change.action;
        }
    });
    
    let timeInWater = 0;
    
    if (isTitular) {
        // Titular: comen√ßa dins
        let lastInTime = quarterStartTime;
        
        cleanChanges.forEach(change => {
            if (change.action === 'out') {
                timeInWater += (change.timestamp - lastInTime) / 1000;
                lastInTime = null;
            } else if (change.action === 'in') {
                lastInTime = change.timestamp;
            }
        });
        
        if (lastInTime !== null) {
            timeInWater += (quarterEndTime - lastInTime) / 1000;
        }
    } else {
        // Suplent: comen√ßa fora
        let lastInTime = null;
        
        cleanChanges.forEach(change => {
            if (change.action === 'in') {
                lastInTime = change.timestamp;
            } else if (change.action === 'out' && lastInTime !== null) {
                timeInWater += (change.timestamp - lastInTime) / 1000;
                lastInTime = null;
            }
        });
        
        if (lastInTime !== null) {
            timeInWater += (quarterEndTime - lastInTime) / 1000;
        }
    }
    
    // Retornar el percentatge (0.0 a 1.0)
    return Math.min(timeInWater / totalQuarterTime, 1.0);
}

/**
 * SUBSTITUIR L'EXISTENT: Calcula el temps real aplicant el percentatge als 8 minuts te√≤rics
 */
function calculateQuarterTimeForPlayerHelper(playerNum, quarter, playerWaterChanges, quarterStartTime, quarterEndTime, lineups) {
    const QUARTER_DURATION = 480; // 8 minuts = 480 segons
    
    if (!quarterStartTime) {
        return 0;
    }
    
    // Obtenir el percentatge de temps dins de l'aigua
    const percentage = calculatePlayerWaterPercentage(
        playerNum, 
        quarter, 
        playerWaterChanges, 
        quarterStartTime, 
        quarterEndTime, 
        lineups
    );
    
    // Aplicar aquest percentatge als 8 minuts te√≤rics
    const adjustedTime = QUARTER_DURATION * percentage;
    
    return Math.round(adjustedTime);
}

function calculateMatchPlayingTimes(match) {
    const playerTimes = {};
    const quarterDuration = 480; // 8 minuts
    const totalQuarterTime = 3360; // 7 jugadors √ó 480s
    
    // Inicialitzar jugadors
    match.jugadors.forEach(player => {
        playerTimes[player.numero] = {
            num: player.numero,
            name: player.nom,
            q1: 0,
            q2: 0,
            q3: 0,
            q4: 0,
            totalTime: 0,
            partidos: 1
        };
    });
    
    const quarters = ['q1', 'q2', 'q3', 'q4'];
    
    quarters.forEach(quarter => {
        const quarterStartTime = match.quarterStartTimes?.[quarter];
        if (!quarterStartTime) return;
        
        // Calcular temps de finalitzaci√≥
        const quarterOrder = ['q1', 'q2', 'q3', 'q4'];
        const currentIndex = quarterOrder.indexOf(quarter);
        let quarterEndTime;
        
        if (match.quarterRealEndTimes && match.quarterRealEndTimes[quarter]) {
            quarterEndTime = match.quarterRealEndTimes[quarter];
        } else if (currentIndex < 3) {
            const nextQuarter = quarterOrder[currentIndex + 1];
            if (match.quarterStartTimes[nextQuarter]) {
                quarterEndTime = match.quarterStartTimes[nextQuarter];
            } else {
                quarterEndTime = quarterStartTime + (quarterDuration * 1000);
            }
        } else {
            quarterEndTime = quarterStartTime + (quarterDuration * 1000);
        }
        
        const realQuarterDuration = (quarterEndTime - quarterStartTime) / 1000;
        console.log(`\n=== ${quarter.toUpperCase()} ===`);
        console.log(`‚è±Ô∏è Temps REAL: ${realQuarterDuration.toFixed(1)}s`);
        
        const quarterChanges = match.playerWaterChanges
            .filter(c => c.quarter === quarter)
            .sort((a, b) => a.timestamp - b.timestamp);
        
        const rawTimes = {};
        const playersFullQuarter = [];
        let sumRawTimesPartial = 0;
        
        match.jugadors.forEach(player => {
            const playerNum = player.numero;
            const isTitular = match.lineups?.[quarter]?.includes(playerNum);
            const playerChanges = quarterChanges.filter(c => c.playerNum === playerNum);
            
            // Netejar duplicats
            const cleanChanges = [];
            let lastAction = null;
            playerChanges.forEach(change => {
                if (change.action !== lastAction) {
                    cleanChanges.push(change);
                    lastAction = change.action;
                }
            });
            
            let timeInWater = 0;
            let playsFullQuarter = false;
            
            if (isTitular) {
                // ‚úÖ Detectar canvis REALS (no els autom√†tics del final)
                const realOuts = cleanChanges.filter(c => 
                    c.action === 'out' && 
                    c.timestamp < (quarterEndTime - 2000)
                );
                
                if (realOuts.length === 0) {
                    // NO t√© canvis reals ‚Üí juga complet
                    playsFullQuarter = true;
                    timeInWater = 0; // No cal calcular
                } else {
                    // T√© canvis reals ‚Üí calcular temps REAL
                    let lastInTime = quarterStartTime;
                    
                    cleanChanges.forEach(change => {
                        if (change.action === 'out' && lastInTime !== null) {
                            timeInWater += (change.timestamp - lastInTime) / 1000;
                            lastInTime = null;
                        } else if (change.action === 'in') {
                            lastInTime = change.timestamp;
                        }
                    });
                    
                    if (lastInTime !== null) {
                        timeInWater += (quarterEndTime - lastInTime) / 1000;
                    }
                }
            } else {
                // Suplent ‚Üí calcular temps REAL
                let lastInTime = null;
                
                cleanChanges.forEach(change => {
                    if (change.action === 'in') {
                        lastInTime = change.timestamp;
                    } else if (change.action === 'out' && lastInTime !== null) {
                        timeInWater += (change.timestamp - lastInTime) / 1000;
                        lastInTime = null;
                    }
                });
                
                if (lastInTime !== null) {
                    timeInWater += (quarterEndTime - lastInTime) / 1000;
                }
            }
            
            rawTimes[playerNum] = Math.round(Math.max(0, timeInWater));
            
            console.log(`üë§ J${playerNum}: ${timeInWater.toFixed(1)}s, Complet: ${playsFullQuarter}, Titular: ${isTitular}, RealOuts: ${isTitular ? cleanChanges.filter(c => c.action === 'out' && c.timestamp < (quarterEndTime - 2000)).length : 'N/A'}`);
            
            if (playsFullQuarter) {
                playersFullQuarter.push(playerNum);
            } else {
                sumRawTimesPartial += rawTimes[playerNum];
            }
        });
        
        // ‚úÖ PONDERAR: Distribuir el temps restant entre jugadors parcials
        const timeUsedByFull = playersFullQuarter.length * quarterDuration;
        const remainingTime = totalQuarterTime - timeUsedByFull;
        
        console.log(`üìä Jugadors complets: ${playersFullQuarter.length} √ó 480s = ${timeUsedByFull}s`);
        console.log(`üìä Temps restant per parcials: ${remainingTime}s`);
        console.log(`üìä Suma temps real parcials: ${sumRawTimesPartial.toFixed(1)}s`);
        
        match.jugadors.forEach(player => {
            const playerNum = player.numero;
            
            if (playersFullQuarter.includes(playerNum)) {
                playerTimes[playerNum][quarter] = quarterDuration;
            } else {
                if (sumRawTimesPartial > 0) {
                    playerTimes[playerNum][quarter] = Math.round((rawTimes[playerNum] / sumRawTimesPartial) * remainingTime);
                } else {
                    playerTimes[playerNum][quarter] = 0;
                }
            }
            
            playerTimes[playerNum].totalTime += playerTimes[playerNum][quarter];
        });
        
        // Verificar suma
        let total = 0;
        match.jugadors.forEach(p => total += playerTimes[p.numero][quarter]);
        console.log(`‚úÖ TOTAL: ${total}s (${(total/60).toFixed(1)} min)`);
    });
    
    return playerTimes;
}
// intervals [in,out) per a un jugador (1 o 13) a partir de canvis (o lineups si no n‚Äôhi ha)
function buildIntervalsForPlayer(match, playerNum){
  const Q = ['q1','q2','q3','q4'];
  const qs = match.quarterStartTimes || {};
  const qe = match.quarterRealEndTimes || {};

  const changes = (match.playerWaterChanges || [])
    .filter(ev => ev.playerNum === playerNum)
    .map(ev => ({...ev, timestamp: toMs(ev.timestamp)}));

  // Sense canvis ‚Üí lineups per cada quart
  if (!changes.length) {
    const ivals = [];
    Q.forEach(q=>{
      const start = toMs(qs[q]); if(!start) return;
      const end = toMs(qe[q]) || (start + 8*60*1000);
      const starters = match.lineups?.[q] || [];
      if (starters.includes(playerNum)) ivals.push([start,end]);
    });
    return ivals;
  }

  // Amb canvis
  const perQ = {};
  changes.forEach(ev=>{
    const t = ev.timestamp;
    if (!t) return;
    let q = ev.quarter;
    if (!q) {
      q = ['q1','q2','q3','q4'].find(qq=>{
        const s = toMs(qs[qq]); const e = toMs(qe[qq]) || (s ? s+8*60*1000 : null);
        return s && e && t>=s && t<=e;
      }) || null;
    }
    if (!q) return;
    (perQ[q] ||= []).push(ev);
  });

  const ivals = [];
  Object.entries(perQ).forEach(([q, evs])=>{
    evs.sort((a,b)=>a.timestamp-b.timestamp);
    const s = toMs(qs[q]); if(!s) return;
    const e = toMs(qe[q]) || (s + 8*60*1000);
    let lastIn = null;
    evs.forEach(ev=>{
      if (ev.action === 'in')  lastIn = Math.max(s, ev.timestamp);
      if (ev.action === 'out' && lastIn!=null) {
        const outTs = Math.min(e, ev.timestamp);
        if (outTs > lastIn) ivals.push([lastIn, outTs]);
        lastIn = null;
      }
    });
    if (lastIn!=null) ivals.push([lastIn, e]);
  });

  return ivals;
}
function whoWasGoalieAt(match, tsMs, cachedIntervals) {
  const iv1 = cachedIntervals[1]  || [];
  const iv13= cachedIntervals[13] || [];
  const in1  = iv1.some(([a,b]) => tsMs>=a && tsMs<b);
  const in13 = iv13.some(([a,b]) => tsMs>=a && tsMs<b);
  if (in1 && !in13) return 1;
  if (in13 && !in1) return 13;

  // Fallback: porter inicial del quart (mai ‚Äúporter actual ara‚Äù ‚Üí no reassignar passat)
  const qs = match.quarterStartTimes || {};
  const qe = match.quarterRealEndTimes || {};
  const q = ['q1','q2','q3','q4'].find(qq=>{
    const s = toMs(qs[qq]); const e = toMs(qe[qq]) || (s ? s+8*60*1000 : null);
    return s && e && tsMs>=s && tsMs<=e;
  }) || null;

  if (q) {
    const starters = match.lineups?.[q] || [];
    if (starters.includes(1) && !starters.includes(13)) return 1;
    if (starters.includes(13) && !starters.includes(1)) return 13;
    // Si inclou ambd√≥s o cap ‚Üí no sabem
  }
  return null;
}
// Retorna {1: golsRebutsPel1, 13: golsRebutsPel13}
function computeLiveGoalsConceded(match){
  const goalieNums = [1,13];
  const intervals = {
    1: buildIntervalsForPlayer(match, 1),
    13: buildIntervalsForPlayer(match, 13)
  };

  const actions = match.chronologicalActions || match.actions || [];
  const conceded = {1:0, 13:0};

  actions.forEach(a=>{
    const isRivalGoal =
      (a.type==='goal' && (a.team==='rival' || a.team==='away')) ||
      (a.tipus==='gol' && a.equip==='rival');
    if(!isRivalGoal) return;

    const t = toMs(a.timestamp);
    if(!t) return;

    // A quin porter li cau?
    let who = null;
    for (const g of goalieNums){
      if (intervals[g].some(([inTs,outTs]) => t>=inTs && t<outTs)) { who = g; break; }
    }
    // Fallback si no trobem interval: usa porter actual dins l‚Äôaigua, si n‚Äôhi ha
    if (!who && Array.isArray(match.playersInWater)){
      if (match.playersInWater.includes(1)) who = 1;
      else if (match.playersInWater.includes(13)) who = 13;
    }
    if (who) conceded[who] += 1;
  });

  return conceded;
}

// Estat incremental per NO reassignar gols antics al porter actual
window.__concededTally = window.__concededTally || {1:0, 13:0};
window.__lastProcessedActionTs = window.__lastProcessedActionTs || 0;
window.__currentMatchKey = window.__currentMatchKey || null;

// crida aix√≤ a cada update amb matchData
function processNewConceded(match) {
  // Detectar canvi de partit per reiniciar comptador
  const key = match.id || `${match.rivalTeam || ''}_${new Date(match.data || 0).toDateString()}`;
  if (window.__currentMatchKey !== key) {
    window.__currentMatchKey = key;
    window.__concededTally = {1:0, 13:0};
    window.__lastProcessedActionTs = 0;
  }

  const actions = (match.chronologicalActions || match.actions || []).slice()
    .map(a => ({...a, __ts: toMs(a.timestamp)}))
    .filter(a => a.__ts) // amb timestamp v√†lid
    .sort((a,b)=>a.__ts - b.__ts);

  // Precompute intervals per porter (1 i 13)
  const intervalsCache = {
    1:  buildIntervalsForPlayer(match, 1),
    13: buildIntervalsForPlayer(match, 13)
  };

  // Processa NOM√âS els gols nous (ts > lastProcessed)
  for (const a of actions) {
    if (a.__ts <= window.__lastProcessedActionTs) continue;

    const isRivalGoal =
      (a.type==='goal' && (a.team==='rival' || a.team==='away')) ||
      (a.tipus==='gol' && a.equip==='rival');

    if (!isRivalGoal) continue;

    let who = whoWasGoalieAt(match, a.__ts, intervalsCache);
    
    // Fallback: si no sabem quin porter, buscar el porter al lineup o el primer porter disponible
    if (!who) {
      const goalkeepers = (match.jugadors || [])
        .filter(p => p.numero === 1 || p.numero === 13 || (p.posicio && String(p.posicio).toLowerCase() === 'porter'))
        .map(p => p.numero);
      if (goalkeepers.length === 1) {
        who = goalkeepers[0]; // Si nom√©s hi ha un porter, √©s ell
      }
    }
    
    if (who) {
      window.__concededTally[who] = (window.__concededTally[who] || 0) + 1;
    } else {
      // sense informaci√≥ fiable: no atribu√Øm
      // (opcional: log) console.warn('Gol rival sense porter atribu√Øt', a);
    }

    window.__lastProcessedActionTs = a.__ts; // avan√ßa el cursor
  }

  return {...window.__concededTally}; // c√≤pia
}
// Converteix qualsevol timestamp de Firebase a mil¬∑lisegons
// --- helpers ---
function toMs(x){
  if (x == null) return null;
  if (typeof x === 'number') return x > 1e12 ? x : x*1000;
  if (typeof x === 'string') { const n=Number(x); return isFinite(n) ? (n>1e12?n:n*1000) : null; }
  if (typeof x === 'object') { if (typeof x.seconds==='number') return x.seconds*1000; if (typeof x.toMillis==='function') return x.toMillis(); }
  return null;
}

// Agafa l‚Äô√∫ltim ‚Äúupdate‚Äù fiable (lastUpdate -> accions -> finals de quart)
function getLastUpdateMs(match){
  const cands = [];
  const lu = toMs(match.lastUpdate || match.updatedAt || match.last_update); if (lu) cands.push(lu);
  const arr = (match.chronologicalActions || match.actions || []);
  for (const a of arr){
    const t = toMs(a.timestamp ?? a.ts ?? a.time); if (t) cands.push(t);
  }
  const qe = match.quarterRealEndTimes || {};
  ['q1','q2','q3','q4'].forEach(q=>{ const t=toMs(qe[q]); if (t) cands.push(t); });
  return cands.length ? Math.max(...cands) : null;
}

function formatAgoFromMs(ms){
  if (ms == null) return '';
  const s = Math.max(0, Math.floor(ms/1000));
  if (s < 60) return `${s}s`;
  const m = Math.floor(s/60);
  if (m < 60) return `${m}‚Ä≤`;
  const h = Math.floor(m/60), mm = m%60;
  return mm ? `${h}h ${mm}‚Ä≤` : `${h}h`;
}

// --- banner ---
let liveBannerTicker;

function detectInOut(action){
  const low = s => (typeof s==='string'? s.toLowerCase(): s);
  const typ = low(action.type || action.tipus || action.event || action.kind || '');
  const act = low(action.action || action.accion || action.state || '');
  const isChangeType = ['change','sub','player_change','water_change','water-change'].includes(typ);
  const isInOutOnly  = act==='in' || act==='out' || action.enter===true || action.leave===true;
  if (!isChangeType && !isInOutOnly) return null;

  const inOut =
    act==='in' || typ==='in' || action.enter===true ? 'in' :
    act==='out'|| typ==='out'|| action.leave===true ? 'out' : null;

  return inOut;
}

// Calcula temps jugat ‚Äúara‚Äù per cada jugador (en segons)
function computeLivePlayingTimes(match) {
  const quarters = ['q1','q2','q3','q4'];
  const SEC_PER_Q = 8 * 60;
  const nowMs = Date.now();

  // Normalitza inicis i finals de quart
  const qStart = {};
  const qEnd   = {};
  quarters.forEach(q => {
    qStart[q] = toMs(match.quarterStartTimes?.[q]);
    // usa final real si hi √©s; sin√≥, assumeix 8:00 des de l‚Äôinici
    const realEnd = toMs(match.quarterRealEndTimes?.[q]);
    qEnd[q] = realEnd || (qStart[q] ? qStart[q] + SEC_PER_Q * 1000 : null);
  });

  // Canvis reals?
  const haveChanges = Array.isArray(match.playerWaterChanges) && match.playerWaterChanges.length > 0;

  // Muntem una llista d'events normalitzats {playerNum, quarter, action, timestamp(ms)}
  const changes = [];
  if (haveChanges) {
    match.playerWaterChanges.forEach(ev => {
      // inferim quart si no ve definit pel rang temporal
      let q = ev.quarter;
      const ts = toMs(ev.timestamp);
      if (!q && ts) {
        q = quarters.find(qq => qStart[qq] && qEnd[qq] && ts >= qStart[qq] && ts <= qEnd[qq]) || null;
      }
      if (!q || !ts) return;
      changes.push({ playerNum: ev.playerNum, quarter: q, action: ev.action, timestamp: ts });
    });
  } else {
    // Fallback: lineups ‚Üí entren a l‚Äôinici, surten al final (fins ara si quart obert)
    quarters.forEach(q => {
      const start = qStart[q], end = qEnd[q] || null;
      if (!start) return;
      const effectiveEnd = end ? Math.min(end, nowMs) : nowMs;
      const starters = match.lineups?.[q] || [];
      starters.forEach(num => {
        changes.push({ playerNum: num, quarter: q, action: 'in',  timestamp: start });
        changes.push({ playerNum: num, quarter: q, action: 'out', timestamp: effectiveEnd });
      });
    });
  }

  // Agrupa per jugador/quart
  const byPlayer = {};
  changes.forEach(ev => {
    const key = ev.playerNum;
    (byPlayer[key] ||= {});
    (byPlayer[key][ev.quarter] ||= []).push(ev);
  });

  // Suma intervals per jugador
  const played = {};
  const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
  Object.keys(byPlayer).forEach(numStr => {
    const num = parseInt(numStr, 10);
    let totalSec = 0;

    quarters.forEach(q => {
      const evs = (byPlayer[num][q] || []).sort((a,b) => a.timestamp - b.timestamp);
      const start = qStart[q];
      const endHard = qEnd[q] || nowMs;
      if (!start) return;

      let lastIn = null;
      evs.forEach(e => {
        if (e.action === 'in') lastIn = clamp(e.timestamp, start, endHard);
        if (e.action === 'out' && lastIn != null) {
          const outTs = clamp(e.timestamp, start, endHard);
          if (outTs > lastIn) totalSec += (outTs - lastIn) / 1000;
          lastIn = null;
        }
      });
      // si encara est√† dins, acumula fins ara o final de quart
      if (lastIn != null) {
        const outTs = endHard ? Math.min(endHard, nowMs) : nowMs;
        if (outTs > lastIn) totalSec += (outTs - lastIn) / 1000;
      }
    });

    // Capar a m√†xim raonable (4 quarts = 32:00)
    totalSec = Math.max(0, Math.min(totalSec, 4 * SEC_PER_Q));
    played[num] = Math.round(totalSec);
  });

  // Assegura 0 per a jugadors sense events
  (match.jugadors || []).forEach(j => { if (!(j.numero in played)) played[j.numero] = 0; });

  return played;
}
// Format helper
function fmtMMSS(sec) {
  const s = Math.max(0, Math.round(sec));
  const m = Math.floor(s/60), r = s%60;
  return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`;
}
function upsertTempsColumn() {
  const root = document.getElementById('liveStatsView') || document;
  // Intenta trobar la taula de live stats:
  const table =
    root.querySelector('#liveStatsTable') ||
    root.querySelector('#statsTable') ||
    root.querySelector('table');

  if (!table) return;

  // ---- cap√ßalera
  const theadRow =
    table.querySelector('thead tr') ||
    (table.tHead && table.tHead.rows[0]) ||
    table.querySelector('tr');
  if (!theadRow) return;

  let tempsTh = theadRow.querySelector('th[data-col="temps"]');
  if (!tempsTh) {
    tempsTh = document.createElement('th');
    tempsTh.setAttribute('data-col', 'temps');
    tempsTh.textContent = 'Temps';
    theadRow.appendChild(tempsTh);
  }

  // ---- files
  const tbody = table.tBodies[0] || table.querySelector('tbody') || table;
  const rows = Array.from(tbody.rows);
  rows.forEach(tr => {
    // dorsal: preferim dataset.num; sin√≥, prova cel¬∑la amb classe .num o [data-num]
    const ds = tr.dataset?.num;
    let num = ds ? parseInt(ds, 10) : NaN;

    if (Number.isNaN(num)) {
      const numCell =
        tr.querySelector('[data-num]') ||
        tr.querySelector('.num') ||
        tr.cells[0];
      if (numCell) {
        const parsed = parseInt(numCell.getAttribute('data-num') || numCell.textContent, 10);
        if (!Number.isNaN(parsed)) num = parsed;
      }
    }

    // busca/crea la cel¬∑la de temps
    let timeTd = tr.querySelector('td.col-time');
    if (!timeTd) {
      timeTd = document.createElement('td');
      timeTd.className = 'col-time';
      tr.appendChild(timeTd);
    }

    const secs = (window.currentLivePlayingTimes && num in window.currentLivePlayingTimes)
      ? window.currentLivePlayingTimes[num]
      : 0;

    timeTd.textContent = fmtMMSS(secs);
  });
}
function renderTotalTimeChart() {
    const ctx = document.getElementById('totalTimeChart');
    if (!ctx) return;
    
    if (window.totalTimeChartInstance) {
        window.totalTimeChartInstance.destroy();
    }
    
    const playerTimes = {};
    
    matchesWithTime.forEach(match => {
        // Utilitzar la funci√≥ amb ponderaci√≥
        const matchTimes = calculateMatchPlayingTimes(match);
        
        Object.values(matchTimes).forEach(playerTime => {
            const playerName = playerTime.name.trim();
            
            if (!playerTimes[playerName]) {
                playerTimes[playerName] = {
                    num: playerTime.num,
                    name: playerName,
                    totalTime: 0,
                    partidos: 0
                };
            }
            
            playerTimes[playerName].totalTime += playerTime.totalTime;
            playerTimes[playerName].partidos += 1;
        });
    });
    
    const players = Object.values(playerTimes)
        .sort((a, b) => b.totalTime - a.totalTime)
        .slice(0, 15);
    
    document.getElementById('timeChartSubtitle').textContent = 
        `Basado en ${matchesWithTime.length} partido(s) con datos de tiempo`;
    
    window.totalTimeChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: players.map(p => `${p.num}. ${p.name}`),
            datasets: [{
                label: 'Tiempo Total (segundos)',
                data: players.map(p => p.totalTime),
                backgroundColor: 'rgba(34, 211, 238, 0.7)',
                borderColor: 'rgba(34, 211, 238, 1)',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const seconds = context.parsed.y;
                            const minutes = Math.floor(seconds / 60);
                            const secs = seconds % 60;
                            return `${minutes}:${secs.toString().padStart(2, '0')} minutos`;
                        }
                    }
                }
            },
            scales: {
                y: { 
                    beginAtZero: true,
                    ticks: { 
                        color: 'white',
                        callback: function(value) {
                            return formatTime(value);
                        }
                    },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                },
                x: { 
                    ticks: { color: 'white' },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            }
        }
    });
}
function renderTimeHeatmapTable() {
    const table = document.getElementById('timeHeatmapTable');
    if (!table) return;
    
    const playerTimes = {};
    
    matchesWithTime.forEach(match => {
        // Utilitzar la funci√≥ amb ponderaci√≥
        const matchTimes = calculateMatchPlayingTimes(match);
        
        Object.values(matchTimes).forEach(playerTime => {
            const playerName = playerTime.name.trim();
            
            if (!playerTimes[playerName]) {
                playerTimes[playerName] = {
                    num: playerTime.num,
                    name: playerName,
                    q1: 0, q2: 0, q3: 0, q4: 0, total: 0
                };
            }
             playerTimes[playerName].total += playerTime.totalTime;
            playerTimes[playerName].q1 += playerTime.q1;
            playerTimes[playerName].q2 += playerTime.q2;
            playerTimes[playerName].q3 += playerTime.q3;
            playerTimes[playerName].q4 += playerTime.q4;
           
        });
    });
    
    const players = Object.values(playerTimes).sort((a, b) => b.total - a.total);
    
    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }
    
    function getHeatColor(seconds, maxSeconds) {
        const ratio = seconds / maxSeconds;
        if (ratio >= 0.75) return 'background: rgba(34, 197, 94, 0.3);';
        if (ratio >= 0.5) return 'background: rgba(251, 191, 36, 0.3);';
        if (ratio >= 0.25) return 'background: rgba(249, 115, 22, 0.3);';
        return 'background: rgba(239, 68, 68, 0.3);';
    }
    
    const maxTime = Math.max(...players.map(p => p.total));
    
    const quarterTotals = { q1: 0, q2: 0, q3: 0, q4: 0, total: 0 };
    players.forEach(p => {
        quarterTotals.q1 += p.q1;
        quarterTotals.q2 += p.q2;
        quarterTotals.q3 += p.q3;
        quarterTotals.q4 += p.q4;
        quarterTotals.total += p.total;
    });
    
    table.innerHTML = `
        <thead>
            <tr>
                <th>N¬∫</th>
                <th>Jugador</th>
                  <th>TOTAL</th>
				<th>1Q</th>
                <th>2Q</th>
                <th>3Q</th>
                <th>4Q</th>
              
            </tr>
        </thead>
        <tbody>
            ${players.map(p => `
                <tr>
                    <td><div class="player-num" style="width: 30px; height: 30px; font-size: 12px;">${p.num}</div></td>
                    <td><strong>${p.name}</strong></td>
					<td style="background: rgba(34, 211, 238, 0.3);"><strong>${formatTime(p.total)}</strong></td>                   
				   <td style="${getHeatColor(p.q1, maxTime / 4)}">${formatTime(p.q1)}</td>
                    <td style="${getHeatColor(p.q2, maxTime / 4)}">${formatTime(p.q2)}</td>
                    <td style="${getHeatColor(p.q3, maxTime / 4)}">${formatTime(p.q3)}</td>
                    <td style="${getHeatColor(p.q4, maxTime / 4)}">${formatTime(p.q4)}</td>
                   
                </tr>
            `).join('')}
            <tr style="background: rgba(34, 211, 238, 0.2); font-weight: bold; border-top: 2px solid #22d3ee;">
                <td colspan="2">TOTAL PER QUART</td>
				<td>${formatTime(quarterTotals.total)}</td>               
			   <td>${formatTime(quarterTotals.q1)}</td>
                <td>${formatTime(quarterTotals.q2)}</td>
                <td>${formatTime(quarterTotals.q3)}</td>
                <td>${formatTime(quarterTotals.q4)}</td>
               
            </tr>
          
        </tbody>
    `;
}
  
function renderEfficiencyPerMinuteChart() {
    const ctx = document.getElementById('efficiencyPerMinuteChart');
    if (!ctx) return;
    
    if (window.efficiencyPerMinuteChartInstance) {
        window.efficiencyPerMinuteChartInstance.destroy();
    }
    
    const playerStats = {};
    
    matchesWithTime.forEach(match => {
        // Utilitzar la funci√≥ centralitzada
        const playerTimes = calculateMatchPlayingTimes(match);
        
        Object.values(playerTimes).forEach(playerTime => {
            const player = match.jugadors.find(j => j.numero === playerTime.num);
            if (!player) return;
            
            const playerName = playerTime.name;
            
            if (!playerStats[playerName]) {
                playerStats[playerName] = {
                    num: playerTime.num,
                    name: playerName,
                    totalTime: 0,
                    gols: 0,
                    exclusions: 0
                };
            }
            
            playerStats[playerName].totalTime += playerTime.total;
            playerStats[playerName].gols += player.estadistiques.gols;
            playerStats[playerName].exclusions += player.estadistiques.exclusions;
        });
    });
    
    const players = Object.values(playerStats)
        .filter(p => p.totalTime > 0)
        .map(p => ({
            ...p,
            goalsPerMinute: (p.gols / (p.totalTime / 60)).toFixed(2),
            exclusionsPerMinute: (p.exclusions / (p.totalTime / 60)).toFixed(2)
        }))
        .sort((a, b) => b.goalsPerMinute - a.goalsPerMinute);
    
    const labels = players.map(p => `${p.num}. ${p.name.split(' ').slice(0, 2).join(' ')}`);
    const goalsData = players.map(p => parseFloat(p.goalsPerMinute));
    const exclusionsData = players.map(p => parseFloat(p.exclusionsPerMinute));
    
    window.efficiencyPerMinuteChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Goles/Minuto',
                    data: goalsData,
                    backgroundColor: '#22c55e',
                    borderWidth: 1,
                    borderColor: '#1e3a8a'
                },
                {
                    label: 'Exclusiones/Minuto',
                    data: exclusionsData,
                    backgroundColor: '#f97316',
                    borderWidth: 1,
                    borderColor: '#1e3a8a'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            indexAxis: 'y',
            plugins: {
                legend: { 
                    display: true,
                    labels: { color: 'white', font: { size: 14 } }
                }
            },
            scales: {
                x: { 
                    beginAtZero: true,
                    ticks: { color: 'white' },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                },
                y: { 
                    ticks: { color: 'white', font: { size: 11 } },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            }
        }
    });
}
// Funci√≥n para calcular valoraci√≥n de jugador
function calculatePlayerValue(stats) {
    // Assegurar que stats existeix
    if (!stats) return 0;
    
    // Obtenir estad√≠stiques amb valors per defecte
    const gols = stats.gols ?? 0;
    const goalTypes = stats.goalTypes || {};
    const exclusionTypes = stats.exclusionTypes || {};
    const paradeTypes = stats.paradeTypes || {};
    
    // Accions positives
    const normalGoals = (goalTypes.normal || 0) + (goalTypes['h+'] || 0) + 
                       (goalTypes.contra || 0) + (goalTypes.boya || 0);
    const penaltyGoals = goalTypes.penalty || 0;
    
    // Altres accions positives
    const assists = stats.assistencies || stats.assists || 0;
    const steals = stats.robatoris || stats.steals || 0;
    const blocks = stats.blocks || stats.blocatges || 0;
    const foulsReceived = stats.faltesRebudes || stats.foulReceived || 0;
    
    // ‚ö†Ô∏è CANVI: Parades ara sumen +1 (abans +2)
    const saves = (paradeTypes.corner || 0) + (paradeTypes.rebuig || 0) + 
                 (paradeTypes.atrapa || 0);
    const penaltySaves = paradeTypes.penal || 0;
    
    // Accions negatives
    const exclusions = stats.exclusions || 0;
    const penaltyMissed = stats.penaltyMissed || 0;
    const turnovers = stats.perdues || stats.turnovers || 0;
    const shotsMissed = stats.xutsFallats || stats.shotsMissed || 0;
    
    // ‚ö†Ô∏è NOU: Gols rebuts pel porter
    const golsRebuts = stats.golsRebuts || 0;
    
    // C√ÄLCUL DEL VALOR
    let valor = 0;
    
    // Positives
    valor += normalGoals * 2;      // Gols normals: +2
    valor += penaltyGoals * 1;     // Gols penalty: +1
    valor += assists * 1;          // Assist√®ncies: +1
    valor += steals * 1;           // Robatoris: +1
    valor += blocks * 1;           // Blocks: +1
    valor += saves * 1;            // ‚ö†Ô∏è CANVI: Parades: +1 (abans +2)
    valor += penaltySaves * 2;     // ‚ö†Ô∏è CANVI: Parades penalty: +2 (abans +3)
    valor += foulsReceived * 1;    // Faltes rebudes: +1
    
    // Negatives
    valor += exclusions * (-1);    // Exclusions: -1
    valor += penaltyMissed * (-2); // Penalty fallat: -2
    valor += turnovers * (-0.5);   // P√®rdues: -0.5
    valor += shotsMissed * (-0.5); // Xuts fallats: -0.5
	valor += (stats.infraccions2m || 0) * (-0.5);
	valor += (stats.contrafaltes || 0) * (-0.75);  // Contrafaltes: -0.75
    valor += golsRebuts * (-0.5);    // ‚ö†Ô∏è NOU: Gols rebuts: -0.5
    return valor;
}
function renderMinutesDistributionChart() {
    const ctx = document.getElementById('minutesDistributionChart');
    if (!ctx) return;
    
    if (window.minutesDistributionChartInstance) {
        window.minutesDistributionChartInstance.destroy();
    }
    
    const playerTimes = {};
    
    matchesWithTime.forEach(match => {
        match.jugadors.forEach(player => {
            const playerName = player.nom.trim();
            
            if (!playerTimes[playerName]) {
                playerTimes[playerName] = {
                    num: player.numero,
                    name: playerName,
                    totalTime: 0
                };
            }
            
            const quarterDuration = 480; // 8 minutos m√°ximo por cuarto
            
            ['q1', 'q2', 'q3', 'q4'].forEach(quarter => {
                const qChanges = match.playerWaterChanges.filter(c => c.playerNum === player.numero && c.quarter === quarter);
                if (qChanges.length === 0) return;
                
                // Eliminar duplicados
                const uniqueChanges = [];
                const seenTimestamps = new Set();
                qChanges.sort((a, b) => a.timestamp - b.timestamp);
                qChanges.forEach(change => {
                    if (!seenTimestamps.has(change.timestamp)) {
                        seenTimestamps.add(change.timestamp);
                        uniqueChanges.push(change);
                    }
                });
                
                let timeInWater = 0;
                let lastInTime = null;
                const quarterStartTime = getQuarterRealStartTime(match, quarter);
                const quarterEndTime = quarterStartTime + quarterDuration * 1000;
                
                if (!quarterStartTime) return;
                
                uniqueChanges.forEach(change => {
                    if (change.timestamp < quarterStartTime || change.timestamp > quarterEndTime) return;
                    
                    if (change.action === 'in' && lastInTime === null) {
                        lastInTime = change.timestamp;
                    } else if (change.action === 'out' && lastInTime !== null) {
                        const duration = (change.timestamp - lastInTime) / 1000;
                        if (duration > 0 && duration <= quarterDuration) {
                            timeInWater += duration;
                        }
                        lastInTime = null;
                    }
                });
                
                // Si todav√≠a est√° dentro al final del cuarto
                if (lastInTime !== null && lastInTime < quarterEndTime) {
                    const duration = (quarterEndTime - lastInTime) / 1000;
                    if (duration > 0 && duration <= quarterDuration) {
                        timeInWater += duration;
                    }
                }
                
                // ‚úÖ LIMITAR A 8 MINUTOS (480 segundos) POR CUARTO
                const quarterTime = Math.min(Math.max(0, Math.round(timeInWater)), quarterDuration);
                playerTimes[playerName].totalTime += quarterTime;
            });
        });
    });
    
    const players = Object.values(playerTimes)
        .sort((a, b) => b.totalTime - a.totalTime)
        .slice(0, 10);
    
    const labels = players.map(p => `${p.num}. ${p.name.split(' ').slice(0, 2).join(' ')}`);
    const timeInMinutes = players.map(p => (p.totalTime / 60).toFixed(1));
    
    const colors = [
        '#22d3ee', '#06b6d4', '#0891b2', '#0e7490',
        '#fde047', '#fbbf24', '#f59e0b', '#d97706',
        '#22c55e', '#16a34a'
    ];
    
    window.minutesDistributionChartInstance = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: timeInMinutes,
                backgroundColor: colors,
                borderWidth: 2,
                borderColor: '#1e3a8a'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { 
                    display: true,
                    position: 'right',
                    labels: { 
                        color: 'white', 
                        font: { size: 12 },
                        padding: 10
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const total = context.dataset.data.reduce((a, b) => parseFloat(a) + parseFloat(b), 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${label}: ${value} min (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

function renderPlusMinusChart() {
    const ctx = document.getElementById('plusMinusChart');
    if (!ctx) return;
    
    if (window.plusMinusChartInstance) {
        window.plusMinusChartInstance.destroy();
    }
    
    const playerPlusMinus = {};
    
    matchesWithTime.forEach(match => {
        ['q1', 'q2', 'q3', 'q4'].forEach(quarter => {
            const quarterStartTime = match.quarterStartTimes[quarter];
            if (!quarterStartTime) return;
            
            const quarterEndTime = match.quarterRealEndTimes?.[quarter] || (quarterStartTime + 480000);
            
            // Obtenir canvis d'aigua d'aquest quart
            const qChanges = match.playerWaterChanges.filter(c => c.quarter === quarter)
                .sort((a, b) => a.timestamp - b.timestamp);
            
            // Processar cada jugador
            match.jugadors.forEach(jugador => {
                const playerNum = jugador.numero;
                const playerName = jugador.nom.trim();
                
                if (!playerPlusMinus[playerName]) {
                    playerPlusMinus[playerName] = {
                        num: playerNum,
                        name: playerName,
                        plusMinus: 0,
                        intervals: 0,
                        details: []
                    };
                }
                
                // Obtenir intervals d'aquest jugador
                const playerChanges = qChanges.filter(c => c.playerNum === playerNum);
                let lastInTime = null;
                
                playerChanges.forEach(change => {
                    if (change.action === 'in') {
                        lastInTime = change.timestamp;
                    } else if (change.action === 'out' && lastInTime !== null) {
                        const scoreIn = getScoreAtTime(match, lastInTime, quarter);
                        const scoreOut = getScoreAtTime(match, change.timestamp, quarter);
                        const plusMinus = (scoreOut.cnt - scoreIn.cnt) - (scoreOut.rival - scoreIn.rival);
                        
                        playerPlusMinus[playerName].plusMinus += plusMinus;
                        playerPlusMinus[playerName].intervals++;
                        playerPlusMinus[playerName].details.push({
                            match: match.rivalTeam || 'Rival',
                            quarter: quarter,
                            timeIn: lastInTime,
                            timeOut: change.timestamp,
                            scoreIn: scoreIn,
                            scoreOut: scoreOut,
                            plusMinus: plusMinus
                        });
                        
                        lastInTime = null;
                    }
                });
                
                // Si encara est√† dins al final del quart
                if (lastInTime !== null) {
                    const scoreIn = getScoreAtTime(match, lastInTime, quarter);
                    const scoreOut = getScoreAtTime(match, quarterEndTime, quarter);
                    const plusMinus = (scoreOut.cnt - scoreIn.cnt) - (scoreOut.rival - scoreIn.rival);
                    
                    playerPlusMinus[playerName].plusMinus += plusMinus;
                    playerPlusMinus[playerName].intervals++;
                    playerPlusMinus[playerName].details.push({
                        match: match.rivalTeam || 'Rival',
                        quarter: quarter,
                        timeIn: lastInTime,
                        timeOut: quarterEndTime,
                        scoreIn: scoreIn,
                        scoreOut: scoreOut,
                        plusMinus: plusMinus
                    });
                }
            });
        });
    });
    
    const players = Object.values(playerPlusMinus)
        .filter(p => p.intervals > 0)
        .map(p => ({
            ...p,
            avgPlusMinus: (p.plusMinus / p.intervals).toFixed(2)
        }))
        .sort((a, b) => b.plusMinus - a.plusMinus);
    
    // ‚úÖ GR√ÄFICA RESUM AMB TOTS ELS JUGADORS
    const labels = players.map(p => `${p.num}. ${p.name.split(' ').slice(0, 2).join(' ')}`);
    const data = players.map(p => p.plusMinus);
    const colors = data.map(pm => pm >= 0 ? '#22c55e' : '#ef4444');
    
    window.plusMinusChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Plus/Minus Total',
                data: data,
                backgroundColor: colors,
                borderWidth: 1,
                borderColor: '#1e3a8a'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const idx = context.dataIndex;
                            const player = players[idx];
                            return [
                                `Plus/Minus Total: ${context.parsed.x > 0 ? '+' : ''}${context.parsed.x}`,
                                `Promedio: ${player.avgPlusMinus > 0 ? '+' : ''}${player.avgPlusMinus}`,
                                `Intervals: ${player.intervals}`
                            ];
                        }
                    }
                }
            },
            scales: {
                x: { 
                    ticks: { 
                        color: 'white',
                        font: { size: window.innerWidth < 768 ? 10 : 12 }
                    },
                    grid: { 
                        color: 'rgba(255,255,255,0.1)',
                        drawBorder: false
                    },
                    title: {
                        display: true,
                        text: 'Diferencia de Goles',
                        color: 'white',
                        font: { size: window.innerWidth < 768 ? 11 : 14 }
                    }
                },
                y: { 
                    ticks: { 
                        color: 'white', 
                        font: { size: window.innerWidth < 768 ? 9 : 11 },
                        autoSkip: false
                    },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            }
        }
    });
    
    // ‚úÖ CREAR SELECTOR DE JUGADOR I DETALL
    renderPlusMinusSelector(players);
}

// ‚úÖ NOVA FUNCI√ì: Selector de jugador + detall
function renderPlusMinusSelector(players) {
    const chartSection = document.getElementById('plusMinusChart').parentElement;
    
    // Esborrar selector anterior si existeix
    const oldSelector = document.getElementById('plusMinusSelectorContainer');
    if (oldSelector) oldSelector.remove();
    
    const selectorContainer = document.createElement('div');
    selectorContainer.id = 'plusMinusSelectorContainer';
    selectorContainer.style.marginTop = '30px';
    
    selectorContainer.innerHTML = `
        <h3 class="section-title" style="font-size: 18px; margin-bottom: 15px;">
            üîç Detall d'Intervals per Jugador
        </h3>
        <div style="margin-bottom: 20px;">
            <label style="font-size: 14px; color: #bae6fd; display: block; margin-bottom: 8px;">
                Selecciona un jugador:
            </label>
            <select id="plusMinusPlayerSelect" style="
    width: 100%;
    padding: 12px;
    background: rgba(30, 58, 138, 0.8);
    border: 2px solid #22d3ee;
    border-radius: 8px;
    color: white;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
" onchange="showPlayerPlusMinusDetail()">
    <option value="" style="background: #1e3a8a; color: white;">-- Selecciona un jugador --</option>
    ${players.map(p => `
        <option value="${p.name}" style="background: #1e3a8a; color: white;">
            ${p.num}. ${p.name} (${p.plusMinus > 0 ? '+' : ''}${p.plusMinus})
        </option>
    `).join('')}
</select>
        </div>
        <div id="plusMinusPlayerDetail"></div>
    `;
    
    chartSection.appendChild(selectorContainer);
    
    // Guardar dades dels jugadors globalment
    window.plusMinusPlayersData = players;
}

// ‚úÖ NOVA FUNCI√ì: Mostrar detall del jugador seleccionat
function showPlayerPlusMinusDetail() {
    const select = document.getElementById('plusMinusPlayerSelect');
    const detailContainer = document.getElementById('plusMinusPlayerDetail');
    const selectedName = select.value;
    
    if (!selectedName) {
        detailContainer.innerHTML = '';
        return;
    }
    
    const player = window.plusMinusPlayersData.find(p => p.name === selectedName);
    if (!player) return;
    
    const plusMinusColor = player.plusMinus >= 0 ? '#22c55e' : '#ef4444';
    const plusMinusSign = player.plusMinus > 0 ? '+' : '';
    
    detailContainer.innerHTML = `
        <div style="
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid ${plusMinusColor};
        ">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <div>
                    <span style="font-weight: bold; font-size: 20px;">${player.num}. ${player.name}</span>
                </div>
                <div style="font-size: 28px; font-weight: bold; color: ${plusMinusColor};">
                    ${plusMinusSign}${player.plusMinus}
                </div>
            </div>
            <div style="font-size: 12px; color: #94a3b8; margin-bottom: 15px;">
                ${player.intervals} intervals ‚Ä¢ Mitjana: ${player.avgPlusMinus > 0 ? '+' : ''}${player.avgPlusMinus} per interval
            </div>
            <div style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
                <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
                    <thead>
                        <tr style="background: rgba(255,255,255,0.1);">
                            <th style="padding: 8px; text-align: left;">Partit</th>
                            <th style="padding: 8px; text-align: center;">Q</th>
                            <th style="padding: 8px; text-align: center;">Interval amb temps real</th>
                            <th style="padding: 8px; text-align: center;">Marcador</th>
                            <th style="padding: 8px; text-align: center;">+/-</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${player.details.map(detail => {
                            const qNum = detail.quarter.replace('q', '');
                            const qStart = matchesWithTime.find(m => m.rivalTeam === detail.match)?.quarterStartTimes?.[detail.quarter] || detail.timeIn;
                            const timeInStr = formatTimestamp(detail.timeIn, qStart);
                            const timeOutStr = formatTimestamp(detail.timeOut, qStart);
                            const pmColor = detail.plusMinus >= 0 ? '#22c55e' : '#ef4444';
                            const pmSign = detail.plusMinus > 0 ? '+' : '';
                            
                            return `
                                <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                                    <td style="padding: 8px; font-size: 11px; color: #bae6fd;">${detail.match}</td>
                                    <td style="padding: 8px; text-align: center; font-weight: bold;">Q${qNum}</td>
                                    <td style="padding: 8px; text-align: center; font-size: 11px;">${timeInStr} - ${timeOutStr}</td>
                                    <td style="padding: 8px; text-align: center; font-size: 11px;">${detail.scoreIn.cnt}-${detail.scoreIn.rival} ‚Üí ${detail.scoreOut.cnt}-${detail.scoreOut.rival}</td>
                                    <td style="padding: 8px; text-align: center; font-weight: bold; color: ${pmColor}; font-size: 14px;">${pmSign}${detail.plusMinus}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

// ‚úÖ Funcions auxiliars (ja les tenies abans)
function getScoreAtTime(match, timestamp, quarter) {
    const goalsUntilNow = (match.chronologicalActions || []).filter(a => 
        a.type === 'goal' && 
        a.quarter === quarter && 
        a.timestamp <= timestamp
    );
    
    const quarters = ['q1', 'q2', 'q3', 'q4'];
    const currentIndex = quarters.indexOf(quarter);
    
    let cntScore = 0;
    let rivalScore = 0;
    
    for (let i = 0; i < currentIndex; i++) {
        cntScore += (match.periodScores[quarters[i]]?.cnt || 0);
        rivalScore += (match.periodScores[quarters[i]]?.rival || 0);
    }
    
    goalsUntilNow.forEach(goal => {
        if (goal.team === 'cnt') {
            cntScore++;
        } else {
            rivalScore++;
        }
    });
    
    return { cnt: cntScore, rival: rivalScore };
}

function formatTimestamp(timestamp, quarterStart) {
    const elapsedSeconds = Math.floor((timestamp - quarterStart) / 1000);
    const minutes = Math.floor(elapsedSeconds / 60);
    const seconds = elapsedSeconds % 60;
    return `${minutes}:${seconds.toString().padStart(2, '0')}`;
}

function renderLoadBalanceStats() {
    const container = document.getElementById('loadBalanceGrid');
    const chartCtx = document.getElementById('loadBalanceChart');
    if (!container || !chartCtx) return;
    
    const playerTimes = {};
    
    matchesWithTime.forEach(match => {
        match.jugadors.forEach(player => {
            const playerName = player.nom.trim();
            
            if (!playerTimes[playerName]) {
                playerTimes[playerName] = {
                    num: player.numero,
                    name: playerName,
                    totalTime: 0
                };
            }
            
            const quarterDuration = 480;
            
            ['q1', 'q2', 'q3', 'q4'].forEach(quarter => {
                const qChanges = match.playerWaterChanges.filter(c => c.playerNum === player.numero && c.quarter === quarter);
                if (qChanges.length === 0) return;
                
                qChanges.sort((a, b) => a.timestamp - b.timestamp);
                
                let timeInWater = 0;
                let lastInTime = null;
                const quarterStartTime = getQuarterRealStartTime(match, quarter);
                
                if (!quarterStartTime) return;
                
                qChanges.forEach(change => {
                    if (change.action === 'in') {
                        lastInTime = change.timestamp;
                    } else if (change.action === 'out' && lastInTime !== null) {
                        timeInWater += (change.timestamp - lastInTime) / 1000;
                        lastInTime = null;
                    }
                });
                
                if (lastInTime !== null) {
                    const quarterEndTime = quarterStartTime + quarterDuration * 1000;
                    timeInWater += (quarterEndTime - lastInTime) / 1000;
                }
                
                playerTimes[playerName].totalTime += Math.round(timeInWater);
            });
        });
    });
    
    const players = Object.values(playerTimes);
    const times = players.map(p => p.totalTime / 60);
    
    const maxTime = Math.max(...times);
    const minTime = Math.min(...times);
    const avgTime = times.reduce((a, b) => a + b, 0) / times.length;
    
    const variance = times.reduce((sum, time) => sum + Math.pow(time - avgTime, 2), 0) / times.length;
    const stdDev = Math.sqrt(variance);
    
    const maxPlayer = players.find(p => (p.totalTime / 60) === maxTime);
    const minPlayer = players.find(p => (p.totalTime / 60) === minTime);
    
    function formatTime(minutes) {
        const mins = Math.floor(minutes);
        const secs = Math.round((minutes - mins) * 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }
    
    let balanceStatus = '';
    let balanceColor = '';
    if (stdDev < 3) {
        balanceStatus = '‚úÖ Excelente equidad';
        balanceColor = '#22c55e';
    } else if (stdDev < 5) {
        balanceStatus = '‚ö†Ô∏è Rotaci√≥n moderada';
        balanceColor = '#fbbf24';
    } else {
        balanceStatus = '‚ùå Rotaci√≥n desigual';
        balanceColor = '#ef4444';
    }
    
    container.innerHTML = `
        <div class="info-item">
            <div class="info-label">Desviaci√≥n Est√°ndar</div>
            <div class="info-value" style="color: ${balanceColor};">${stdDev.toFixed(1)} min</div>
        </div>
        <div class="info-item">
            <div class="info-label">Tiempo Promedio</div>
            <div class="info-value">${formatTime(avgTime)}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Jugador con M√°s Minutos</div>
            <div class="info-value">${maxPlayer.num}. ${maxPlayer.name.split(' ').slice(0, 2).join(' ')}</div>
            <div style="font-size: 11px; color: #bae6fd; margin-top: 4px;">
                ${formatTime(maxTime)}
            </div>
        </div>
        <div class="info-item">
            <div class="info-label">Jugador con Menos Minutos</div>
            <div class="info-value">${minPlayer.num}. ${minPlayer.name.split(' ').slice(0, 2).join(' ')}</div>
            <div style="font-size: 11px; color: #bae6fd; margin-top: 4px;">
                ${formatTime(minTime)}
            </div>
        </div>
        <div class="info-item">
            <div class="info-label">Diferencia M√°x-M√≠n</div>
            <div class="info-value" style="color: ${balanceColor};">${formatTime(maxTime - minTime)}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Estado de Balance</div>
            <div class="info-value" style="color: ${balanceColor}; font-size: 16px;">${balanceStatus}</div>
        </div>
    `;
    
    if (window.loadBalanceChartInstance) {
        window.loadBalanceChartInstance.destroy();
    }
    
    window.loadBalanceChartInstance = new Chart(chartCtx, {
        type: 'bar',
        data: {
            labels: ['< 15min', '15-20min', '20-25min', '25-30min', '> 30min'],
            datasets: [{
                label: 'N√∫mero de Jugadores',
                data: [
                    times.filter(t => t < 15).length,
                    times.filter(t => t >= 15 && t < 20).length,
                    times.filter(t => t >= 20 && t < 25).length,
                    times.filter(t => t >= 25 && t < 30).length,
                    times.filter(t => t >= 30).length
                ],
                backgroundColor: ['#ef4444', '#f97316', '#fbbf24', '#22c55e', '#06b6d4'],
                borderWidth: 1,
                borderColor: '#1e3a8a'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { 
                    beginAtZero: true,
                    ticks: { color: 'white', stepSize: 1 },
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    title: {
                        display: true,
                        text: 'Jugadores',
                        color: 'white'
                    }
                },
                x: { 
                    ticks: { color: 'white' },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            }
        }
    });
}

function renderQuarterAnalysisTable() {
    const table = document.getElementById('quarterAnalysisTable');
    if (!table) return;
    
    const quarterStats = {
        q1: { changes: 0, uniquePlayers: new Set(), totalTime: 0 },
        q2: { changes: 0, uniquePlayers: new Set(), totalTime: 0 },
        q3: { changes: 0, uniquePlayers: new Set(), totalTime: 0 },
        q4: { changes: 0, uniquePlayers: new Set(), totalTime: 0 }
    };
    
    matchesWithTime.forEach(match => {
        ['q1', 'q2', 'q3', 'q4'].forEach(quarter => {
            const qChanges = match.playerWaterChanges.filter(c => c.quarter === quarter);
            const quarterStartTime = getQuarterRealStartTime(match, quarter);
            const lineup = match.lineups[quarter] || [];
            
            // Ordenar cambios por timestamp
            qChanges.sort((a, b) => a.timestamp - b.timestamp);
            
            let realChanges = 0;
            
            // Contar solo entradas que NO sean las iniciales de los titulares
            // Una entrada de un suplente = 1 cambio real
            qChanges.forEach(change => {
                const isTitular = lineup.includes(change.playerNum);
                const isInitialEntry = change.action === 'in' && 
                                      Math.abs(change.timestamp - quarterStartTime) < 5000;
                
                // Contar solo ENTRADAS de jugadores que NO sean titulares iniciales
                // Esto cuenta las rotaciones reales (cuando entra un suplente)
                if (change.action === 'in' && !(isTitular && isInitialEntry)) {
                    realChanges++;
                }
                
                quarterStats[quarter].uniquePlayers.add(change.playerNum);
            });
            
            quarterStats[quarter].changes += realChanges;
            quarterStats[quarter].totalTime += 480;
        });
    });
    
    const quarters = ['q1', 'q2', 'q3', 'q4'];
    const labels = ['1¬∫ Cuarto', '2¬∫ Cuarto', '3¬∫ Cuarto', '4¬∫ Cuarto'];
    
    table.innerHTML = `
        <thead>
            <tr>
                <th>Cuarto</th>
                <th>Total Cambios</th>
                <th>Promedio Cambios/Partido</th>
                <th>Jugadores √önicos</th>
                <th>Promedio Jugadores/Partido</th>
            </tr>
        </thead>
        <tbody>
            ${quarters.map((q, i) => {
                const avgChanges = (quarterStats[q].changes / matchesWithTime.length).toFixed(1);
                const avgPlayers = (quarterStats[q].uniquePlayers.size / matchesWithTime.length).toFixed(1);
                
                return `
                    <tr>
                        <td><strong>${labels[i]}</strong></td>
                        <td>${quarterStats[q].changes}</td>
                        <td>${avgChanges}</td>
                        <td>${quarterStats[q].uniquePlayers.size}</td>
                        <td>${avgPlayers}</td>
                    </tr>
                `;
            }).join('')}
        </tbody>
    `;
}


function renderPerformanceVsTimeChart() {
    const ctx = document.getElementById('performanceVsTimeChart');
    if (!ctx) return;
    console.log('üéØ renderPerformanceVsTimeChart called');
    console.log('matchesWithTime length:', matchesWithTime.length);
	 // ‚ö†Ô∏è MISSATGE SI HI HA POCS PARTITS
    if (matchesWithTime.length < 3) {
        const canvas = ctx;
        const context = canvas.getContext('2d');
        
        // Obtenir dimensions del canvas
        const width = canvas.width;
        const height = canvas.height;
        
        // Netejar canvas
        context.clearRect(0, 0, width, height);
        
        // Configurar text
        context.fillStyle = '#bae6fd';
        context.font = '16px Arial';
        context.textAlign = 'center';
        context.textBaseline = 'middle';
        
        // Missatge principal
        context.fillText('‚ö†Ô∏è Necessites almenys 3 partits amb dades de temps', width / 2, height / 2 - 20);
        context.fillStyle = '#94a3b8';
        context.font = '14px Arial';
        context.fillText(`Partits disponibles: ${matchesWithTime.length} / 3`, width / 2, height / 2 + 10);
        context.fillText('Aquesta gr√†fica mostrar√† la correlaci√≥ quan tinguis m√©s dades', width / 2, height / 2 + 35);
        
        return;
    }
    if (window.performanceVsTimeChartInstance) {
        window.performanceVsTimeChartInstance.destroy();
    }
    
    const playerMatchData = [];
    
    matchesWithTime.forEach(match => {
        const teamResult = match.scoreCNT - match.scoreRival;
        
        // Utilitzar la funci√≥ centralitzada
        const playerTimes = calculateMatchPlayingTimes(match);
        
        Object.values(playerTimes).forEach(playerTime => {
            const player = match.jugadors.find(j => j.numero === playerTime.num);
            if (!player) return;
            
            playerMatchData.push({
                player: `${playerTime.num}. ${playerTime.name}`,
                time: playerTime.total / 60, // convertir a minuts
                gols: player.estadistiques.gols,
                result: teamResult
            });
        });
    });
    
    const playerAvgs = {};
    playerMatchData.forEach(data => {
        if (!playerAvgs[data.player]) {
            playerAvgs[data.player] = { times: [], results: [] };
        }
        playerAvgs[data.player].times.push(data.time);
        playerAvgs[data.player].results.push(data.result);
    });
    
    const scatterData = Object.keys(playerAvgs).map(player => {
        const avgTime = playerAvgs[player].times.reduce((a, b) => a + b, 0) / playerAvgs[player].times.length;
        const avgResult = playerAvgs[player].results.reduce((a, b) => a + b, 0) / playerAvgs[player].results.length;
        return {
            x: avgTime,
            y: avgResult,
            label: player
        };
    });
    
    window.performanceVsTimeChartInstance = new Chart(ctx, {
        type: 'scatter',
        data: {
            datasets: [{
                label: 'Jugadores',
                data: scatterData,
                backgroundColor: '#22d3ee',
                borderColor: '#06b6d4',
                pointRadius: 8,
                pointHoverRadius: 12
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return [
                                context.raw.label,
                                `Tiempo promedio: ${context.parsed.x.toFixed(1)} min`,
                                `Diferencia promedio: ${context.parsed.y > 0 ? '+' : ''}${context.parsed.y.toFixed(1)} goles`
                            ];
                        }
                    }
                }
            },
            scales: {
                x: { 
                    beginAtZero: true,
                    ticks: { color: 'white' },
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    title: {
                        display: true,
                        text: 'Tiempo Promedio Jugado (minutos)',
                        color: 'white'
                    }
                },
                y: { 
                    ticks: { color: 'white' },
                    grid: { 
                        color: 'rgba(255,255,255,0.1)',
                        drawBorder: false
                    },
                    title: {
                        display: true,
                        text: 'Diferencia de Goles Promedio',
                        color: 'white'
                    }
                }
            }
        }
    });
}

function renderFatigueAnalysisTable() {
    const table = document.getElementById('fatigueAnalysisTable');
    if (!table) return;
    
    const playerFatigue = {};
    
    matchesWithTime.forEach(match => {
        match.jugadors.forEach(player => {
            const playerName = player.nom.trim();
            
            if (!playerFatigue[playerName]) {
                playerFatigue[playerName] = {
                    num: player.numero,
                    name: playerName,
                    q1: { gols: 0, exclusions: 0, matches: 0 },
                    q4: { gols: 0, exclusions: 0, matches: 0 }
                };
            }
            
            const playedQ1 = match.lineups.q1 && match.lineups.q1.includes(player.numero);
            const playedQ4 = match.lineups.q4 && match.lineups.q4.includes(player.numero);
            
            if (playedQ1) {
                playerFatigue[playerName].q1.matches++;
                playerFatigue[playerName].q1.gols += player.estadistiques.gols / 4;
                playerFatigue[playerName].q1.exclusions += player.estadistiques.exclusions / 4;
            }
            
            if (playedQ4) {
                playerFatigue[playerName].q4.matches++;
                playerFatigue[playerName].q4.gols += player.estadistiques.gols / 4;
                playerFatigue[playerName].q4.exclusions += player.estadistiques.exclusions / 4;
            }
        });
    });
    
    const players = Object.values(playerFatigue)
        .filter(p => p.q1.matches > 0 && p.q4.matches > 0)
        .sort((a, b) => a.num - b.num);
    
    table.innerHTML = `
        <thead>
            <tr>
                <th>N¬∫</th>
                <th>Jugador</th>
                <th colspan="2">1¬∫ Cuarto (Inicio)</th>
                <th colspan="2">4¬∫ Cuarto (Final)</th>
                <th>Cambio Goles</th>
                <th>Cambio Exc</th>
                <th>Fatiga</th>
            </tr>
            <tr style="font-size: 11px;">
                <th></th>
                <th></th>
                <th>Goles</th>
                <th>Exc</th>
                <th>Goles</th>
                <th>Exc</th>
                <th></th>
                <th></th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            ${players.map(p => {
                const q1GoalsAvg = (p.q1.gols / p.q1.matches).toFixed(2);
                const q4GoalsAvg = (p.q4.gols / p.q4.matches).toFixed(2);
                const q1ExcAvg = (p.q1.exclusions / p.q1.matches).toFixed(2);
                const q4ExcAvg = (p.q4.exclusions / p.q4.matches).toFixed(2);
                
                const goalsDiff = (q4GoalsAvg - q1GoalsAvg).toFixed(2);
                const excDiff = (q4ExcAvg - q1ExcAvg).toFixed(2);
                
                let fatigueIndicator = '';
                let fatigueColor = '';
                
                if (goalsDiff < -0.2 && excDiff > 0.2) {
                    fatigueIndicator = 'üòì Alta';
                    fatigueColor = '#ef4444';
                } else if (goalsDiff < -0.1 || excDiff > 0.1) {
                    fatigueIndicator = '‚ö†Ô∏è Media';
                    fatigueColor = '#fbbf24';
                } else if (goalsDiff >= 0) {
                    fatigueIndicator = '‚úÖ Baja';
                    fatigueColor = '#22c55e';
                } else {
                    fatigueIndicator = '‚ûñ Normal';
                    fatigueColor = '#06b6d4';
                }
                
                return `
                    <tr>
                        <td><div class="player-num" style="width: 30px; height: 30px; font-size: 12px;">${p.num}</div></td>
                        <td><strong>${p.name}</strong></td>
                        <td>${q1GoalsAvg}</td>
                        <td>${q1ExcAvg}</td>
                        <td>${q4GoalsAvg}</td>
                        <td>${q4ExcAvg}</td>
                        <td style="color: ${goalsDiff >= 0 ? '#22c55e' : '#ef4444'}; font-weight: bold;">
                            ${goalsDiff > 0 ? '+' : ''}${goalsDiff}
                        </td>
                        <td style="color: ${excDiff <= 0 ? '#22c55e' : '#ef4444'}; font-weight: bold;">
                            ${excDiff > 0 ? '+' : ''}${excDiff}
                        </td>
                        <td style="color: ${fatigueColor}; font-weight: bold;">
                            ${fatigueIndicator}
                        </td>
                    </tr>
                `;
            }).join('')}
        </tbody>
    `;
}

function renderRotationStats() {
    const container = document.getElementById('rotationStatsGrid');
    if (!container) return;
    
    let totalChanges = 0;
    let totalQuarters = 0;
    const playerRotations = {};
    
    matchesWithTime.forEach(match => {
        ['q1', 'q2', 'q3', 'q4'].forEach(quarter => {
            const qChanges = match.playerWaterChanges.filter(c => c.quarter === quarter);
            const quarterStartTime = match.quarterStartTimes[quarter];
            const lineup = match.lineups[quarter] || [];
            
            // Ordenar cambios por timestamp
            qChanges.sort((a, b) => a.timestamp - b.timestamp);
            
            // Contar solo entradas de no-titulares (rotaciones reales)
            qChanges.forEach(change => {
                const isTitular = lineup.includes(change.playerNum);
                const isInitialEntry = change.action === 'in' && 
                                      Math.abs(change.timestamp - quarterStartTime) < 5000;
                
                // Contar solo ENTRADAS que no sean iniciales de titulares
                if (change.action === 'in' && !(isTitular && isInitialEntry)) {
                    totalChanges++;
                    
                    if (!playerRotations[change.playerNum]) {
                        playerRotations[change.playerNum] = 0;
                    }
                    playerRotations[change.playerNum]++;
                }
            });
        });
        
        totalQuarters += 4;
    });
    
    const avgChangesPerMatch = (totalChanges / matchesWithTime.length).toFixed(1);
    const avgChangesPerQuarter = (totalChanges / totalQuarters).toFixed(1);
    
    const rotationCounts = Object.values(playerRotations);
    
    if (rotationCounts.length === 0) {
        container.innerHTML = `
            <div class="info-item">
                <div class="info-label">Total de Cambios</div>
                <div class="info-value">0</div>
            </div>
            <div class="info-item" style="grid-column: 1 / -1;">
                <div style="text-align: center; color: #bae6fd; font-size: 14px;">
                    No hay cambios registrados durante los cuartos
                </div>
            </div>
        `;
        return;
    }
    
    const maxRotations = Math.max(...rotationCounts);
    const minRotations = Math.min(...rotationCounts);
    const avgRotations = (rotationCounts.reduce((a, b) => a + b, 0) / rotationCounts.length).toFixed(1);
    
    const mostRotatedPlayerNum = Object.keys(playerRotations).find(
        num => playerRotations[num] === maxRotations
    );
    const leastRotatedPlayerNum = Object.keys(playerRotations).find(
        num => playerRotations[num] === minRotations
    );
    
    let mostRotatedPlayer = 'N/A';
    let leastRotatedPlayer = 'N/A';
    
    matchesWithTime.forEach(match => {
        const playerMost = match.jugadors.find(j => j.numero === parseInt(mostRotatedPlayerNum));
        const playerLeast = match.jugadors.find(j => j.numero === parseInt(leastRotatedPlayerNum));
        
        if (playerMost) mostRotatedPlayer = `${playerMost.numero}. ${playerMost.nom.split(' ').slice(0, 2).join(' ')}`;
        if (playerLeast) leastRotatedPlayer = `${playerLeast.numero}. ${playerLeast.nom.split(' ').slice(0, 2).join(' ')}`;
    });
    
    container.innerHTML = `
        <div class="info-item">
            <div class="info-label">Total de Cambios (Rotaciones)</div>
            <div class="info-value">${totalChanges}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Promedio Cambios/Partido</div>
            <div class="info-value">${avgChangesPerMatch}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Promedio Cambios/Cuarto</div>
            <div class="info-value">${avgChangesPerQuarter}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Jugador M√°s Rotado</div>
            <div class="info-value">${mostRotatedPlayer}</div>
            <div style="font-size: 11px; color: #bae6fd; margin-top: 4px;">
                ${maxRotations} entradas al agua
            </div>
        </div>
        <div class="info-item">
            <div class="info-label">Jugador Menos Rotado</div>
            <div class="info-value">${leastRotatedPlayer}</div>
            <div style="font-size: 11px; color: #bae6fd; margin-top: 4px;">
                ${minRotations} entradas al agua
            </div>
        </div>
        <div class="info-item">
            <div class="info-label">Promedio Rotaciones/Jugador</div>
            <div class="info-value">${avgRotations}</div>
        </div>
    `;
}

// ============================================
// FIN FUNCIONES PARA ESTAD√çSTICAS DE TIEMPO
// ============================================
function renderGoalkeeperSavesChart(singleMatch = null) {
    const ctx = document.getElementById('goalkeeperSavesChart');
    if (!ctx) return;
    
    if (window.goalkeeperSavesChartInstance) {
        window.goalkeeperSavesChartInstance.destroy();
    }
    
    const goalkeeperStats = {};
    
    // ‚úÖ Si es passa un partit, nom√©s mostrar aquell
    const matchesToShow = singleMatch ? [singleMatch] : allMatches;
    
    matchesToShow.forEach(match => {
        match.jugadors.forEach(j => {
            const isGoalkeeper = j.numero === 1 || j.numero === 13;
            if (!isGoalkeeper) return;
            
            // ‚úÖ Nom√©s comptar si ha fet almenys 1 parada
            const totalParades = j.estadistiques.parades || 0;
            if (totalParades === 0) return;
            
            const playerName = j.nom.trim();
            
            if (!goalkeeperStats[playerName]) {
                goalkeeperStats[playerName] = {
                    num: j.numero,
                    name: playerName,
                    parades: 0,
                    paradeTypes: { corner: 0, rebuig: 0, atrapa: 0, penal: 0 }
                };
            }
            
            goalkeeperStats[playerName].parades += totalParades;
            
            if (j.estadistiques.paradeTypes) {
                goalkeeperStats[playerName].paradeTypes.corner += (j.estadistiques.paradeTypes.corner || 0);
                goalkeeperStats[playerName].paradeTypes.rebuig += (j.estadistiques.paradeTypes.rebuig || 0);
                goalkeeperStats[playerName].paradeTypes.atrapa += (j.estadistiques.paradeTypes.atrapa || 0);
                goalkeeperStats[playerName].paradeTypes.penal += (j.estadistiques.paradeTypes.penal || 0);
            }
        });
    });
    
    const goalkeepers = Object.values(goalkeeperStats);
    
    if (goalkeepers.length === 0) {
        ctx.parentElement.innerHTML = '<div class="no-data">No hay datos de paradas de porteros</div>';
        return;
    }
    
    const labels = goalkeepers.map(gk => `${gk.num}. ${gk.name.split(' ').slice(0, 2).join(' ')}`);
    
    window.goalkeeperSavesChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Corner',
                    data: goalkeepers.map(gk => (gk.paradeTypes?.corner ?? 0)),
                    backgroundColor: '#3b82f6'
                },
                {
                    label: 'Rebuig',
                    data: goalkeepers.map(gk => (gk.paradeTypes?.rebuig ?? 0)),
                    backgroundColor: '#f97316'
                },
                {
                    label: 'Atrapa',
                    data: goalkeepers.map(gk => (gk.paradeTypes?.atrapa ?? 0)),
                    backgroundColor: '#22c55e'
                },
                {
                    label: 'Penal',
                    data: goalkeepers.map(gk => (gk.paradeTypes?.penal ?? 0)),
                    backgroundColor: '#eab308'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { 
                    display: true,
                    labels: { color: 'white', font: { size: 14 } }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.dataset.label || '';
                            const value = context.parsed.y || 0;
                            return `${label}: ${value} parades`;
                        }
                    }
                }
            },
            scales: {
                y: { 
                    beginAtZero: true,
                    ticks: { color: 'white', stepSize: 1 },
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    title: {
                        display: true,
                        text: 'Parades',
                        color: 'white'
                    }
                },
                x: { 
                    ticks: { color: 'white' },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            }
        }
    });
}
// ‚úÖ NUEVO: Variables globals per ordenaci√≥
let currentSortColumn = 'num';
let currentSortOrder = 'asc';
let cachedPlayersData = [];
let singleMatchSortColumn = 'num';
let singleMatchSortOrder = 'asc';

function sortTable(column, tableId = 'comparisonTable') {
    if (currentSortColumn === column) {
        currentSortOrder = currentSortOrder === 'desc' ? 'asc' : 'desc';
    } else {
        currentSortColumn = column;
        currentSortOrder = 'desc';
    }
    
    let sortedPlayers;
    
    // Determinar quins jugadors ordenar segons la taula
    if (tableId === 'comparisonTableIndividual') {
        sortedPlayers = [...getAllUniquePlayers()];
    } else {
        // Per la taula de comparaci√≥, obtenim els jugadors directament de la taula actual
        const tableElement = document.getElementById(tableId);
        if (!tableElement || !tableElement.querySelector('tbody')) {
            console.error('No s\'ha trobat la taula:', tableId);
            return;
        }
        
        // Extreure les dades de la taula actual
        const rows = Array.from(tableElement.querySelectorAll('tbody tr'));
        sortedPlayers = rows.map(row => {
            const cells = row.querySelectorAll('td');
            const numText = cells[0].textContent.trim();
            const num = parseInt(numText);
            const name = cells[1].textContent.trim();
            
            // Trobar el jugador complet a comparisonPlayers o getAllUniquePlayers
            let player = comparisonPlayers?.find(p => p.num === num && p.name === name);
            if (!player) {
                player = getAllUniquePlayers().find(p => p.num === num && p.name === name);
            }
            return player;
        }).filter(p => p); // Eliminar nulls
    }
    
    if (!sortedPlayers || sortedPlayers.length === 0) {
        console.error('No hi ha jugadors per ordenar');
        return;
    }
    
    sortedPlayers.sort((a, b) => {
        let valA, valB;
        
        switch(column) {
            case 'num': valA = a.num; valB = b.num; break;
            case 'name': valA = a.name.toLowerCase(); valB = b.name.toLowerCase(); break;
            case 'partidos': valA = a.partidos; valB = b.partidos; break;
            case 'gols': valA = a.gols; valB = b.gols; break;
            case 'h+': valA = a.goalTypes['h+'] || 0; valB = b.goalTypes['h+'] || 0; break;
            case 'penalty': valA = a.goalTypes.penalty || 0; valB = b.goalTypes.penalty || 0; break;
            case 'contra': valA = a.goalTypes.contra || 0; valB = b.goalTypes.contra || 0; break;
            case 'boya': valA = a.goalTypes.boya || 0; valB = b.goalTypes.boya || 0; break;
            case 'normal': valA = a.goalTypes.normal || 0; valB = b.goalTypes.normal || 0; break;
            case 'parades': valA = a.parades || 0; valB = b.parades || 0; break;
            case 'assistencies': valA = a.assistencies || 0; valB = b.assistencies || 0; break;
            case 'robatoris': valA = a.robatoris || 0; valB = b.robatoris || 0; break;
            case 'blocks': 
                valA = (a.blocks || 0) + (a.blocatges || 0); 
                valB = (b.blocks || 0) + (b.blocatges || 0); 
                break;
            case 'faltesRebudes': valA = a.faltesRebudes || 0; valB = b.faltesRebudes || 0; break;
            case 'exclusions': valA = a.exclusions; valB = b.exclusions; break;
            case 'infraccions2m': valA = a.infraccions2m || 0; valB = b.infraccions2m || 0; break;
            case 'contrafaltes': valA = a.contrafaltes || 0; valB = b.contrafaltes || 0; break;
            case 'perdues': valA = a.perdues || 0; valB = b.perdues || 0; break;
            case 'xutsFallats': valA = a.xutsFallats || 0; valB = b.xutsFallats || 0; break;
            case 'penaltyMissed': valA = a.penaltyMissed || 0; valB = b.penaltyMissed || 0; break;
            case 'eficienciaTir':
                const totalXutsA = a.gols + (a.xutsFallats || 0);
                const totalXutsB = b.gols + (b.xutsFallats || 0);
                valA = totalXutsA > 0 ? (a.gols / totalXutsA * 100) : 0;
                valB = totalXutsB > 0 ? (b.gols / totalXutsB * 100) : 0;
                break;
            case 'mediaGols':
                valA = a.partidos > 0 ? (a.gols / a.partidos) : 0;
                valB = b.partidos > 0 ? (b.gols / b.partidos) : 0;
                break;
            case 'valor':
                valA = calculatePlayerValue(a);
                valB = calculatePlayerValue(b);
                break;
            default: valA = 0; valB = 0;
        }
        
        if (typeof valA === 'string') {
            return currentSortOrder === 'desc' 
                ? valB.localeCompare(valA)
                : valA.localeCompare(valB);
        }
        
        return currentSortOrder === 'desc' ? valB - valA : valA - valB;
    });
    
    // Re-renderitzar la taula corresponent
    renderComparisonTable(sortedPlayers, tableId === 'comparisonTableIndividual', tableId);
    
    // Si √©s la taula individual, tornar a afegir els event listeners
    if (tableId === 'comparisonTableIndividual') {
        document.querySelectorAll('.player-row-clickable').forEach(row => {
            row.addEventListener('click', function() {
                const playerNum = parseInt(this.dataset.playerNum);
                const playerName = this.dataset.playerName;
                showIndividualPlayerDetails({ num: playerNum, name: playerName });
            });
        });
    }
}

function renderComparisonTable(players, clickable = false, tableId = 'comparisonTable') {
    const getSortIndicator = (column) => {
        if (currentSortColumn !== column) return '';
        return currentSortOrder === 'desc' ? ' ‚ñº' : ' ‚ñ≤';
    };
    
    document.getElementById(tableId).innerHTML = `
      <thead>
<tr>
        <th rowspan="2" onclick="sortTable('num', '${tableId}')" style="cursor: pointer; vertical-align: middle;">N¬∫${getSortIndicator('num')}</th>
        <th rowspan="2" onclick="sortTable('name', '${tableId}')" style="cursor: pointer; vertical-align: middle;">Jugador${getSortIndicator('name')}</th>
        <th rowspan="2" onclick="sortTable('partidos', '${tableId}')" style="cursor: pointer; vertical-align: middle;">Part${getSortIndicator('partidos')}</th>
        <th rowspan="2" onclick="sortTable('gols', '${tableId}')" style="cursor: pointer; vertical-align: middle;">Goles${getSortIndicator('gols')}</th>
        <th colspan="5" style="background: rgba(34, 211, 238, 0.2); text-align: center;" title="Tipus de Gols">üéØ TIPUS GOLSs</th>
        <th colspan="5" style="background: rgba(34, 197, 94, 0.2); text-align: center;" title="Accions Positives">‚úÖ POSITIVES</th>
        <th colspan="6" style="background: rgba(239, 68, 68, 0.2); text-align: center;" title="Accions Negatives">‚ùå NEGATIVES</th>
        <th rowspan="2" onclick="sortTable('eficienciaTir', '${tableId}')" style="cursor: pointer; vertical-align: middle;">üéØ Efic.${getSortIndicator('eficienciaTir')}</th>
        <th rowspan="2" onclick="sortTable('mediaGols', '${tableId}')" style="cursor: pointer; vertical-align: middle;">Media G/P${getSortIndicator('mediaGols')}</th>
    </tr>
    <tr style="font-size: 11px;">
        <!-- Tipus de Gols (5 columnes) -->
        <th onclick="sortTable('h+', '${tableId}')" style="cursor: pointer;">H+${getSortIndicator('h+')}</th>
        <th onclick="sortTable('penalty', '${tableId}')" style="cursor: pointer;">Pen${getSortIndicator('penalty')}</th>
        <th onclick="sortTable('contra', '${tableId}')" style="cursor: pointer;">Con${getSortIndicator('contra')}</th>
        <th onclick="sortTable('boya', '${tableId}')" style="cursor: pointer;">Boy${getSortIndicator('boya')}</th>
        <th onclick="sortTable('normal', '${tableId}')" style="cursor: pointer;">Nor${getSortIndicator('normal')}</th>
        
        <!-- Positives (5 columnes) -->
        <th onclick="sortTable('parades', '${tableId}')" style="cursor: pointer;">üß§ Par${getSortIndicator('parades')}</th>
        <th onclick="sortTable('assistencies', '${tableId}')" style="cursor: pointer;">üéØ Ast${getSortIndicator('assistencies')}</th>
        <th onclick="sortTable('robatoris', '${tableId}')" style="cursor: pointer;">üõ°Ô∏è Rob${getSortIndicator('robatoris')}</th>
        <th onclick="sortTable('blocks', '${tableId}')" style="cursor: pointer;">üö´ Blk${getSortIndicator('blocks')}</th>
        <th onclick="sortTable('faltesRebudes', '${tableId}')" style="cursor: pointer;">‚ö†Ô∏è FR${getSortIndicator('faltesRebudes')}</th>
        
        <!-- Negatives (6 columnes) -->
        <th onclick="sortTable('exclusions', '${tableId}')" style="cursor: pointer;">Exc${getSortIndicator('exclusions')}</th>
        <th onclick="sortTable('infraccions2m', '${tableId}')" style="cursor: pointer;">üìè 2m${getSortIndicator('infraccions2m')}</th>
        <th onclick="sortTable('contrafaltes', '${tableId}')" style="cursor: pointer;">‚ö†Ô∏è CF${getSortIndicator('contrafaltes')}</th>
        <th onclick="sortTable('perdues', '${tableId}')" style="cursor: pointer;">‚ùå P√®r${getSortIndicator('perdues')}</th>
        <th onclick="sortTable('xutsFallats', '${tableId}')" style="cursor: pointer;">üö´ Xut${getSortIndicator('xutsFallats')}</th>
        <th onclick="sortTable('penaltyMissed', '${tableId}')" style="cursor: pointer;">PenF${getSortIndicator('penaltyMissed')}</th>
    </tr>
</thead>
        <tbody>
          ${players.map(p => {
                const totalBlocks = (p.blocks || 0) + (p.blocatges || 0);
                const totalXuts = p.gols + (p.xutsFallats || 0);
                const efic = totalXuts > 0 ? (p.gols / totalXuts * 100) : 0;
                const eficColor = efic >= 50 ? '#22c55e' : efic >= 30 ? '#fbbf24' : '#ef4444';
                const mediaGols = p.partidos > 0 ? (p.gols / p.partidos) : 0;
                
                const valor = calculatePlayerValue({
                    gols: p.gols,
                    goalTypes: p.goalTypes,
                    assistencies: p.assistencies,
                    infraccions2m: p.infraccions2m || 0,
                    contrafaltes: p.contrafaltes || 0,
                    robatoris: p.robatoris,
                    blocatges: totalBlocks,
                    parades: p.parades,
                    paradeTypes: p.paradeTypes || {},
                    faltesRebudes: p.faltesRebudes || 0,
                    exclusions: p.exclusions,
                    exclusionTypes: p.exclusionTypes || { normal: 0, penalty: 0 },
                    penaltyMissed: p.penaltyMissed,
                    perdues: p.perdues,
                    xutsFallats: p.xutsFallats
                });
                
                const valorColor = valor >= 10 ? '#22c55e' : valor >= 5 ? '#fbbf24' : '#ef4444';
                
                const clickableClass = clickable ? 'player-row-clickable' : '';
                const clickableStyle = clickable ? 'cursor: pointer;' : '';
                const hoverEvents = clickable ? `onmouseover="this.style.background='rgba(34,211,238,0.2)'" onmouseout="this.style.background=''"` : '';
                
                return `
                <tr class="${clickableClass}" 
                    data-player-num="${p.num}" 
                    data-player-name="${p.name}"
                    style="${clickableStyle}"
                    ${hoverEvents}>
    <td><div class="player-num" style="width: 30px; height: 30px; font-size: 12px;">${p.num}</div></td>
    <td><strong>${p.name}</strong></td>
    <td>${p.partidos}</td>
    <td><strong style="color: #fde047;">${p.gols}</strong></td>
    <td>${p.goalTypes['h+'] || 0}</td>
    <td>${p.goalTypes.penalty || 0}</td>
    <td>${p.goalTypes.contra || 0}</td>
    <td>${p.goalTypes.boya || 0}</td>
    <td>${p.goalTypes.normal || 0}</td>
    <td style="color: #8b5cf6; font-weight: bold;">${p.parades || 0}</td>
    <td style="color: #22c55e; font-weight: bold;">${p.assistencies || 0}</td>
    <td style="color: #06b6d4; font-weight: bold;">${p.robatoris || 0}</td>
    <td style="color: #a78bfa; font-weight: bold;">${totalBlocks}</td>
    <td style="color: #fbbf24; font-weight: bold;">${p.faltesRebudes || 0}</td>
    <td style="color: #ef4444; font-weight: bold;">${p.exclusions}</td>
    <td style="color: #fb923c; font-weight: bold;">${p.infraccions2m || 0}</td>
    <td style="color: #fbbf24; font-weight: bold;">${p.contrafaltes || 0}</td>
    <td style="color: #ef4444; font-weight: bold;">${p.perdues || 0}</td>
    <td style="color: #f97316; font-weight: bold;">${p.xutsFallats || 0}</td>
    <td style="color: ${(p.penaltyMissed || 0) > 0 ? '#ef4444' : '#22c55e'}; font-weight: bold;">${p.penaltyMissed || 0}</td>
    <td style="color: ${eficColor}; font-weight: bold;">${efic.toFixed(1)}%</td>
    <td>${mediaGols.toFixed(1)}</td>
    
</tr>
                `;
            }).join('')}
        </tbody>
    `;
}

function normalizeAllPlayers(matchData) {
  const norm = (p) => {
    p.estadistiques = p.estadistiques || {};
    p.estadistiques.goalTypes = { normal:0, 'h+':0, penalty:0, contra:0, boya:0, ...(p.estadistiques.goalTypes||{}) };
    p.estadistiques.exclusionTypes = { normal:0, penalty:0, ...(p.estadistiques.exclusionTypes||{}) };
    p.estadistiques.paradeTypes = { corner:0, rebuig:0, atrapa:0, penal:0, ...(p.estadistiques.paradeTypes||{}) };
    p.estadistiques.gols = p.estadistiques.gols ?? (
      (p.estadistiques.goalTypes.normal||0) + (p.estadistiques.goalTypes['h+']||0) +
      (p.estadistiques.goalTypes.penalty||0) + (p.estadistiques.goalTypes.contra||0) +
      (p.estadistiques.goalTypes.boya||0)
    );
    return p;
  };
  if (matchData?.data?.players) matchData.data.players = matchData.data.players.map(norm);
  if (matchData?.data?.rivalPlayers) matchData.data.rivalPlayers = matchData.data.rivalPlayers.map(norm);
}
// ============================================
// FUNCIONS PER ESTAD√çSTIQUES DE ZONES
// ============================================

function renderGoalZoneStats() {
    if (allMatches.length === 0) return;
    
    console.log('üéØ renderGoalZoneStats INICIADA');
    
    // Calcular zones globals
    const globalZones = {
        'top-left': 0, 'top-center': 0, 'top-right': 0,
        'mid-left': 0, 'mid-center': 0, 'mid-right': 0,
        'bottom-left': 0, 'bottom-center': 0, 'bottom-right': 0,
        'unknown': 0
    };
    
    const playerZones = {};
    
    allMatches.forEach(match => {
    // NOM√âS jugadors del CN Terrassa (no rivals)
    match.jugadors.forEach(j => {
        // Saltar jugadors que no tenen n√∫mero (indicaria que s√≥n rivals)
        if (!j.numero) return;
        
        const playerName = j.nom.trim();
            
            if (!playerZones[playerName]) {
                playerZones[playerName] = {
                    num: j.numero,
                    name: playerName,
                    totalGols: 0,
                    zones: {
    'top-left': 0, 'top-center': 0, 'top-right': 0,
    'mid-left': 0, 'mid-center': 0, 'mid-right': 0,
    'bottom-left': 0, 'bottom-center': 0, 'bottom-right': 0,
    'unknown': 0
}
                };
            }
            
            playerZones[playerName].totalGols += j.estadistiques.gols || 0;
            
            // Debug: Comprovar si hi ha dades de zones
            if (j.estadistiques.goalZones) {
               console.log(`Jugador ${playerName} (${j.numero}) t√© zones:`, JSON.stringify(j.estadistiques.goalZones), 'Total gols:', j.estadistiques.gols);
                Object.keys(j.estadistiques.goalZones).forEach(zone => {
                    const count = j.estadistiques.goalZones[zone] || 0;
                    globalZones[zone] = (globalZones[zone] || 0) + count;
                    playerZones[playerName].zones[zone] = (playerZones[playerName].zones[zone] || 0) + count;
                });
            }
        });
    });
    
    const totalGols = Object.values(globalZones).reduce((sum, count) => sum + count, 0) - globalZones.unknown;
    
    console.log('üìä Total gols amb zona:', totalGols);
    console.log('üìä Zones globals:', globalZones);
    
    // Si no hi ha dades de zones, mostrar missatge informatiu
    if (totalGols === 0) {
        console.warn('‚ö†Ô∏è No hi ha dades de zones de porteria');
        
        const noDataHTML = `
            <div class="card" id="goalZonesAnalysisCard">
                <h2 class="section-title">üéØ An√†lisi de Zones de Porteria</h2>
                <div class="no-data" style="padding: 40px; text-align: center;">
                    <p style="font-size: 16px; color: #fbbf24; margin-bottom: 10px;">‚ö†Ô∏è No hi ha dades de zones de porteria</p>
                    <p style="font-size: 14px; color: #bae6fd;">
                        Els partits nous registrats amb l'app actualitzada mostraran les zones on es marquen els gols.
                    </p>
                    <p style="font-size: 12px; color: #bae6fd; margin-top: 10px;">
                        Partits analitzats: ${allMatches.length}
                    </p>
                </div>
            </div>
        `;
        
        const comparisonTable = document.querySelector('#comparisonView .card:has(#comparisonTable)');
        
        if (comparisonTable) {
            const existingCard = document.getElementById('goalZonesAnalysisCard');
            if (existingCard) existingCard.remove();
            
            comparisonTable.insertAdjacentHTML('beforebegin', noDataHTML);
            console.log('‚úÖ Card "no data" inserit');
        }
        
        return;
    }
    
    // Top 6 golejadors
    const topScorers = Object.values(playerZones)
        .filter(p => p.totalGols > 0)
        .sort((a, b) => b.totalGols - a.totalGols)
        .slice(0, 6);
    
    console.log('üë§ Top scorers:', topScorers.length);
    
    const zoneOrder = [
        'top-left', 'top-center', 'top-right',
        'mid-left', 'mid-center', 'mid-right',
        'bottom-left', 'bottom-center', 'bottom-right'
    ];
    
    const zoneLabels = {
        'top-left': '‚¨ÜÔ∏è Esq',
        'top-center': '‚¨ÜÔ∏è Centre',
        'top-right': '‚¨ÜÔ∏è Dret',
        'mid-left': '‚û°Ô∏è Esq',
        'mid-center': 'üéØ Centre',
        'mid-right': '‚¨ÖÔ∏è Dret',
        'bottom-left': '‚¨áÔ∏è Esq',
        'bottom-center': '‚¨áÔ∏è Baix',
        'bottom-right': '‚¨áÔ∏è Dret'
    };
    
    const zoneLabelsShort = {
        'top-left': '‚¨ÜÔ∏èE',
        'top-center': '‚¨ÜÔ∏èC',
        'top-right': '‚¨ÜÔ∏èD',
        'mid-left': '‚û°Ô∏èE',
        'mid-center': 'üéØ',
        'mid-right': '‚¨ÖÔ∏èD',
        'bottom-left': '‚¨áÔ∏èE',
        'bottom-center': '‚¨áÔ∏èB',
        'bottom-right': '‚¨áÔ∏èD'
    };
    
    const maxCountGlobal = Math.max(...zoneOrder.map(z => globalZones[z] || 0));
    
    // Crear el HTML complet del card
    const goalZonesHTML = `
        <div class="card" id="goalZonesAnalysisCard">
            <h2 class="section-title">üéØ An√†lisi de Zones de Porteria</h2>
            <p style="font-size: 12px; color: #bae6fd; margin-bottom: 15px;">
                On marquen m√©s gols els jugadors del CN Terrassa  (Els del centre s√≥n gols de vaselina)
            </p>
            
            <!-- Heatmap Global -->
            <div style="margin-bottom: 30px;">
                <h3 style="color: #22d3ee; font-size: 14px; margin-bottom: 10px;">üìä Mapa Global d'Equip</h3>
                <div class="goal-zone-heatmap">
                    ${zoneOrder.map(zone => {
                        const count = globalZones[zone] || 0;
                        const percentage = totalGols > 0 ? ((count / totalGols) * 100).toFixed(1) : 0;
                        const intensity = maxCountGlobal > 0 ? count / maxCountGlobal : 0;
                        const bgColor = getHeatmapColor(intensity);
                        
                        return `
                            <div class="goal-zone-cell" style="background: ${bgColor};">
                                <div class="zone-label">${zoneLabels[zone]}</div>
                                <div class="zone-count">${count}</div>
                                <div style="font-size: 9px; color: rgba(255,255,255,0.7);">${percentage}%</div>
                            </div>
                        `;
                    }).join('')}
                </div>
                ${globalZones.unknown > 0 ? `
                    <div style="text-align: center; margin-top: 10px; font-size: 11px; color: #bae6fd;">
                        ‚ùì Gols sense zona registrada: ${globalZones.unknown}
                    </div>
                ` : ''}
                <div style="text-align: center; margin-top: 10px; font-size: 12px; color: #fde047;">
                    Total de gols amb zona: ${totalGols}
                </div>
            </div>
            
            <!-- Heatmaps Individuals -->
            <div style="margin-top: 20px;">
                <h3 style="color: #22d3ee; font-size: 14px; margin-bottom: 10px;">üë§ Mapes Individuals (Top 6 Golejadors)</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    ${topScorers.map(player => {
                        console.log(`üîç ${player.name} zones individuals:`, JSON.stringify(player.zones));
                        const totalWithZone = Object.values(player.zones).reduce((sum, count) => sum + count, 0) - (player.zones.unknown || 0);
                        const maxCount = Math.max(...zoneOrder.map(z => player.zones[z] || 0));
                        
                        const preferredZone = zoneOrder.reduce((max, zone) => 
                            (player.zones[zone] || 0) > (player.zones[max] || 0) ? zone : max
                        , zoneOrder[0]);
                        
                        const preferredZoneLabel = {
                            'top-left': 'Dalt Esquerra',
                            'top-center': 'Dalt Centre',
                            'top-right': 'Dalt Dreta',
                            'mid-left': 'Centre Esquerra',
                            'mid-center': 'Centre',
                            'mid-right': 'Centre Dreta',
                            'bottom-left': 'Baix Esquerra',
                            'bottom-center': 'Baix Centre',
                            'bottom-right': 'Baix Dreta'
                        }[preferredZone];
                        
                        return `
                            <div style="background: rgba(0, 0, 0, 0.2); padding: 12px; border-radius: 8px;">
                                <div style="text-align: center; margin-bottom: 8px;">
                                    <div style="font-size: 12px; font-weight: bold; color: #22d3ee;">
                                        ${player.num}. ${player.name.split(' ').slice(0, 2).join(' ')}
                                    </div>
                                    <div style="font-size: 10px; color: #bae6fd; margin-top: 2px;">
                                        ${player.totalGols} gols (${totalWithZone} amb zona)
                                    </div>
                                </div>
                                
                                <div class="goal-zone-heatmap" style="max-width: 180px; margin: 0 auto;">
                                    ${zoneOrder.map(zone => {
                                        const count = player.zones[zone] || 0;
                                        const intensity = maxCount > 0 ? count / maxCount : 0;
                                        const bgColor = getHeatmapColor(intensity);
                                        
                                        return `
                                            <div class="goal-zone-cell" style="background: ${bgColor};">
                                                <div class="zone-label">${zoneLabelsShort[zone]}</div>
                                                <div class="zone-count">${count}</div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                                
                                ${totalWithZone > 0 && player.zones[preferredZone] > 0 ? `
                                    <div style="font-size: 10px; color: #fde047; text-align: center; margin-top: 8px;">
                                        ‚≠ê ${preferredZoneLabel} (${player.zones[preferredZone]})
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        </div>
    `;
    
    // Inserir el card abans de la taula de comparaci√≥
    const comparisonTable = document.querySelector('#comparisonView .card:has(#comparisonTable)');
    
    if (comparisonTable) {
        // Eliminar card anterior si existeix
        const existingCard = document.getElementById('goalZonesAnalysisCard');
        if (existingCard) {
            existingCard.remove();
        }
        
        comparisonTable.insertAdjacentHTML('beforebegin', goalZonesHTML);
        console.log('‚úÖ Card de zones inserit correctament amb dades');
    } else {
        console.error('‚ùå No s\'ha trobat #comparisonTable');
    }
}
function renderFieldZoneStats() {
    if (allMatches.length === 0) return;
    
    console.log('üéØ renderFieldZoneStats INICIADA');
    
    // Calcular zones globals del camp
    const globalFieldZones = {
        '2m-left': 0, '2m-center': 0, '2m-right': 0,
        '5m-left': 0, '5m-center': 0, '5m-right': 0,
        '+6m-left': 0, '+6m-center': 0, '+6m-right': 0,
        'unknown': 0
    };
    
    const playerFieldZones = {};
    
    allMatches.forEach(match => {
        // NOM√âS jugadors del CN Terrassa (no rivals)
        match.jugadors.forEach(j => {
            if (!j.numero) return;
            
            const playerName = j.nom.trim();
            
            if (!playerFieldZones[playerName]) {
                playerFieldZones[playerName] = {
                    num: j.numero,
                    name: playerName,
                    totalGols: 0,
                    zones: {
                        '2m-left': 0, '2m-center': 0, '2m-right': 0,
                        '5m-left': 0, '5m-center': 0, '5m-right': 0,
                        '+6m-left': 0, '+6m-center': 0, '+6m-right': 0,
                        'unknown': 0
                    }
                };
            }
            
            playerFieldZones[playerName].totalGols += j.estadistiques.gols || 0;
            
            // Comprovar si hi ha dades de fieldZones
            if (j.estadistiques.fieldZones) {
                console.log(`Jugador ${playerName} (${j.numero}) t√© fieldZones:`, JSON.stringify(j.estadistiques.fieldZones), 'Total gols:', j.estadistiques.gols);
                Object.keys(j.estadistiques.fieldZones).forEach(zone => {
                    const count = j.estadistiques.fieldZones[zone] || 0;
                    globalFieldZones[zone] = (globalFieldZones[zone] || 0) + count;
                    playerFieldZones[playerName].zones[zone] = (playerFieldZones[playerName].zones[zone] || 0) + count;
                });
            }
        });
    });
    
    const totalGols = Object.values(globalFieldZones).reduce((sum, count) => sum + count, 0) - globalFieldZones.unknown;
    
    console.log('üìä Total gols amb zona del camp:', totalGols);
    console.log('üìä Zones del camp globals:', globalFieldZones);
    
    // Si no hi ha dades de zones del camp, mostrar missatge informatiu
    if (totalGols === 0) {
        console.warn('‚ö†Ô∏è No hi ha dades de zones del camp');
        
        const noDataHTML = `
            <div class="card" id="fieldZonesAnalysisCard">
                <h2 class="section-title">üìç An√†lisi de Zones del Camp</h2>
                <div class="no-data" style="padding: 40px; text-align: center;">
                    <p style="font-size: 16px; color: #fbbf24; margin-bottom: 10px;">‚ö†Ô∏è No hi ha dades de zones del camp</p>
                    <p style="font-size: 14px; color: #bae6fd;">
                        Els partits nous registrats amb l'app actualitzada mostraran des d'on del camp es marquen els gols.
                    </p>
                    <p style="font-size: 12px; color: #bae6fd; margin-top: 10px;">
                        Partits analitzats: ${allMatches.length}
                    </p>
                </div>
            </div>
        `;
        
        const zonesCard = document.getElementById('goalZonesAnalysisCard');
        
        if (zonesCard) {
            const existingCard = document.getElementById('fieldZonesAnalysisCard');
            if (existingCard) existingCard.remove();
            
            zonesCard.insertAdjacentHTML('afterend', noDataHTML);
            console.log('‚úÖ Card "no data" de fieldZones inserit');
        }
        
        return;
    }
    
    // Top 6 golejadors
    const topScorers = Object.values(playerFieldZones)
        .filter(p => p.totalGols > 0)
        .sort((a, b) => b.totalGols - a.totalGols)
        .slice(0, 6);
    
    console.log('üë§ Top scorers per fieldZones:', topScorers.length);
    
    const zoneOrder = [
        '2m-left', '2m-center', '2m-right',
        '5m-left', '5m-center', '5m-right',
        '+6m-left', '+6m-center', '+6m-right'
    ];
    
    const zoneLabels = {
        '2m-left': '‚¨ÖÔ∏è Esq 2m',
        '2m-center': 'üéØ Cen 2m',
        '2m-right': '‚û°Ô∏è Dre 2m',
        '5m-left': '‚¨ÖÔ∏è Esq -6m',
        '5m-center': 'üéØ Cen -6m',
        '5m-right': '‚û°Ô∏è Dre -6m',
        '+6m-left': '‚¨ÖÔ∏è Esq +6m',
        '+6m-center': 'üéØ Cen +6m',
        '+6m-right': '‚û°Ô∏è Dre +6m'
    };
    
    const zoneLabelsShort = {
        '2m-left': '‚¨ÖÔ∏èE',
        '2m-center': 'üéØ',
        '2m-right': '‚û°Ô∏èD',
        '5m-left': '‚¨ÖÔ∏èE',
        '5m-center': 'üéØ',
        '5m-right': '‚û°Ô∏èD',
        '+6m-left': '‚¨ÖÔ∏èE',
        '+6m-center': 'üéØ',
        '+6m-right': '‚û°Ô∏èD'
    };
    
    const maxCountGlobal = Math.max(...zoneOrder.map(z => globalFieldZones[z] || 0));
    
    // Crear el HTML complet del card
    const fieldZonesHTML = `
        <div class="card" id="fieldZonesAnalysisCard">
            <h2 class="section-title">üìç An√†lisi de Zones del Camp</h2>
            <p style="font-size: 12px; color: #bae6fd; margin-bottom: 15px;">
                Des d'on marquen els gols els jugadors del CN Terrassa (üî¥ a 2m | üü° a 5m | üîµ +6m)
            </p>
            
            <!-- Indicador de porteria rival -->
            <div style="text-align: center; margin: 10px auto 15px auto; max-width: 280px; padding: 8px; background: rgba(239, 68, 68, 0.2); border-radius: 8px; border: 2px solid #ef4444;">
                <div style="font-size: 20px; margin-bottom: 4px;">ü•Ö</div>
                <div style="font-size: 11px; font-weight: bold; color: #fca5a5;">PORTERIA RIVAL</div>
            </div>
            
            <!-- Heatmap Global del Camp -->
            <div style="margin-bottom: 30px;">
                <h3 style="color: #22d3ee; font-size: 14px; margin-bottom: 10px;">üìä Mapa Global d'Equip - Zones del Camp</h3>
                <div class="field-zone-heatmap">
                    ${zoneOrder.map((zone, index) => {
                        const count = globalFieldZones[zone] || 0;
                        const percentage = totalGols > 0 ? ((count / totalGols) * 100).toFixed(1) : 0;
                        const intensity = maxCountGlobal > 0 ? count / maxCountGlobal : 0;
                        const bgColor = getHeatmapColor(intensity);
                        
                        // Afegir separadors visuals cada 3 zones
                        const extraStyle = (index === 2 || index === 5) ? 'border-bottom: 2px dashed rgba(255,255,255,0.3);' : '';
                        
                        return `
                            <div class="goal-zone-cell" style="background: ${bgColor}; ${extraStyle}">
                                <div class="zone-label">${zoneLabels[zone]}</div>
                                <div class="zone-count">${count}</div>
                                <div style="font-size: 9px; color: rgba(255,255,255,0.7);">${percentage}%</div>
                            </div>
                        `;
                    }).join('')}
                </div>
                ${globalFieldZones.unknown > 0 ? `
                    <div style="text-align: center; margin-top: 10px; font-size: 11px; color: #bae6fd;">
                        ‚ùì Gols sense zona del camp registrada: ${globalFieldZones.unknown}
                    </div>
                ` : ''}
                <div style="text-align: center; margin-top: 10px; font-size: 12px; color: #fde047;">
                    Total de gols amb zona del camp: ${totalGols}
                </div>
            </div>
            
            <!-- Heatmaps Individuals -->
            <div style="margin-top: 20px;">
                <h3 style="color: #22d3ee; font-size: 14px; margin-bottom: 10px;">üë§ Mapes Individuals (Top 6 Golejadors)</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    ${topScorers.map(player => {
                        console.log(`üîç ${player.name} fieldZones individuals:`, JSON.stringify(player.zones));
                        const totalWithZone = Object.values(player.zones).reduce((sum, count) => sum + count, 0) - (player.zones.unknown || 0);
                        const maxCount = Math.max(...zoneOrder.map(z => player.zones[z] || 0));
                        
                        const preferredZone = zoneOrder.reduce((max, zone) => 
                            (player.zones[zone] || 0) > (player.zones[max] || 0) ? zone : max
                        , zoneOrder[0]);
                        
                        const preferredZoneLabel = {
                            '2m-left': 'Esquerra 2m',
                            '2m-center': 'Centre 2m',
                            '2m-right': 'Dreta 2m',
                            '5m-left': 'Esquerra -6m',
                            '5m-center': 'Centre -6m',
                            '5m-right': 'Dreta -6m',
                            '+6m-left': 'Esquerra +6m',
                            '+6m-center': 'Centre +6m',
                            '+6m-right': 'Dreta +6m'
                        }[preferredZone];
                        
                        return `
                            <div style="background: rgba(0, 0, 0, 0.2); padding: 12px; border-radius: 8px;">
                                <div style="text-align: center; margin-bottom: 8px;">
                                    <div style="font-size: 12px; font-weight: bold; color: #22d3ee;">
                                        ${player.num}. ${player.name.split(' ').slice(0, 2).join(' ')}
                                    </div>
                                    <div style="font-size: 10px; color: #bae6fd; margin-top: 2px;">
                                        ${player.totalGols} gols (${totalWithZone} amb zona)
                                    </div>
                                </div>
                                
                                <div class="field-zone-heatmap" style="max-width: 180px; margin: 0 auto;">
                                    ${zoneOrder.map((zone, index) => {
                                        const count = player.zones[zone] || 0;
                                        const intensity = maxCount > 0 ? count / maxCount : 0;
                                        const bgColor = getHeatmapColor(intensity);
                                        const extraStyle = (index === 2 || index === 5) ? 'border-bottom: 2px dashed rgba(255,255,255,0.3);' : '';
                                        
                                        return `
                                            <div class="goal-zone-cell" style="background: ${bgColor}; ${extraStyle}">
                                                <div class="zone-label">${zoneLabelsShort[zone]}</div>
                                                <div class="zone-count">${count}</div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                                
                                ${totalWithZone > 0 && player.zones[preferredZone] > 0 ? `
                                    <div style="font-size: 10px; color: #fde047; text-align: center; margin-top: 8px;">
                                        ‚≠ê ${preferredZoneLabel} (${player.zones[preferredZone]})
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        </div>
    `;
    
    // Inserir el card despr√©s del card de zones de porteria
    const goalZonesCard = document.getElementById('goalZonesAnalysisCard');
    
    if (goalZonesCard) {
        // Eliminar card anterior si existeix
        const existingCard = document.getElementById('fieldZonesAnalysisCard');
        if (existingCard) {
            existingCard.remove();
        }
        
        goalZonesCard.insertAdjacentHTML('afterend', fieldZonesHTML);
        console.log('‚úÖ Card de zones del camp inserit correctament amb dades');
    } else {
        console.error('‚ùå No s\'ha trobat #goalZonesAnalysisCard');
    }
}
function renderSwimRacesStats() {
    if (allMatches.length === 0) return '';
    
    const swimStats = {};
    
    // ‚úÖ FIX: Primer obtenim tots els jugadors dels partits
    const allPlayers = new Set();
    allMatches.forEach(match => {
        match.jugadors.forEach(j => {
            allPlayers.add(j.nom.trim());
        });
    });
    
    // Inicialitzar tots els jugadors
    allPlayers.forEach(playerName => {
        swimStats[playerName] = { won: 0, lost: 0, total: 0 };
    });
    
    // Comptar curses
    allMatches.forEach(match => {
        if (match.chronologicalActions) {
            match.chronologicalActions.forEach(action => {
                if (action.type === 'swim-race' && action.team === 'cnt') {
                    const playerName = action.playerName;
                    if (swimStats[playerName]) {
                        swimStats[playerName].total++;
                        if (action.result === 'win') {
                            swimStats[playerName].won++;
                        } else {
                            swimStats[playerName].lost++;
                        }
                    }
                }
            });
        }
    });
    
    // Filtrar jugadors amb curses
    const playersWithSwims = Object.entries(swimStats)
        .filter(([name, data]) => data.total > 0)
        .sort((a, b) => b[1].won - a[1].won);
    
    if (playersWithSwims.length === 0) {
        return '';
    }
    
    return `
        <div class="card">
            <h2 class="section-title">üèä Estad√≠stiques de Curses Inicials</h2>
            <div style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Jugador</th>
                            <th>üèÜ Guanyades</th>
                            <th>‚ùå Perdudes</th>
                            <th>Total</th>
                            <th>% √àxit</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${playersWithSwims.map(([name, data]) => {
                            const percentage = ((data.won / data.total) * 100).toFixed(1);
                            const colorClass = percentage >= 50 ? '#22c55e' : '#ef4444';
                            return `
                                <tr>
                                    <td style="font-weight: bold;">${name.split(' ')[0]}</td>
                                    <td style="color: #22c55e; font-weight: bold;">${data.won}</td>
                                    <td style="color: #ef4444;">${data.lost}</td>
                                    <td>${data.total}</td>
                                    <td style="color: ${colorClass}; font-weight: bold;">${percentage}%</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
            <div style="margin-top: 15px; padding: 12px; background: rgba(34, 211, 238, 0.1); border-radius: 8px; text-align: center;">
                <div style="font-size: 12px; color: #bae6fd;">Millor cursador</div>
                <div style="font-size: 18px; color: #22d3ee; font-weight: bold; margin-top: 4px;">
                    ${playersWithSwims[0][0].split(' ')[0]} (${playersWithSwims[0][1].won}/${playersWithSwims[0][1].total})
                </div>
            </div>
        </div>
    `;
}
function renderGoalkeeperZoneStats() {
    // Detectar autom√†ticament els noms dels porters des dels partits
    const goalkeeperNames = {
        1: 'Porter 1',
        13: 'Porter 13'
    };
    
    // Buscar els noms reals dels porters als partits
    allMatches.forEach(match => {
        match.jugadors.forEach(j => {
            if (j.numero === 1 || j.numero === 13) {
                goalkeeperNames[j.numero] = j.nom;
            }
        });
    });
    
    const goalkeeperZones = {
        1: {
            num: 1,
            name: goalkeeperNames[1],
            totalGolsRebuts: 0,
            zones: {
                'top-left': 0, 'top-center': 0, 'top-right': 0,
                'mid-left': 0, 'mid-center': 0, 'mid-right': 0,
                'bottom-left': 0, 'bottom-center': 0, 'bottom-right': 0,
                'unknown': 0
            }
        },
        13: {
            num: 13,
            name: goalkeeperNames[13],
            totalGolsRebuts: 0,
            zones: {
                'top-left': 0, 'top-center': 0, 'top-right': 0,
                'mid-left': 0, 'mid-center': 0, 'mid-right': 0,
                'bottom-left': 0, 'bottom-center': 0, 'bottom-right': 0,
                'unknown': 0
            }
        }
    };
    
    // Acumular dades de tots els partits
    allMatches.forEach(match => {
        match.jugadors.forEach(j => {
            if ((j.numero === 1 || j.numero === 13) && j.estadistiques.golsRebutsZones) {
                Object.keys(j.estadistiques.golsRebutsZones).forEach(zone => {
                    const count = j.estadistiques.golsRebutsZones[zone] || 0;
                    goalkeeperZones[j.numero].zones[zone] += count;
                    goalkeeperZones[j.numero].totalGolsRebuts += count;
                });
            }
        });
    });
    
    return goalkeeperZones;
}
function renderGlobalZoneHeatmap(zones) {
    const container = document.getElementById('globalGoalZoneHeatmap');
    if (!container) return;
    
    const totalGols = Object.values(zones).reduce((sum, count) => sum + count, 0) - zones.unknown;
    
    if (totalGols === 0) {
        container.innerHTML = '<div class="no-data">No hi ha dades de zones disponibles</div>';
        return;
    }
    
    const zoneOrder = [
        'top-left', 'top-center', 'top-right',
        'mid-left', 'mid-center', 'mid-right',
        'bottom-left', 'bottom-center', 'bottom-right'
    ];
    
    const zoneLabels = {
        'top-left': '‚¨ÜÔ∏è Esq',
        'top-center': '‚¨ÜÔ∏è Centre',
        'top-right': '‚¨ÜÔ∏è Dret',
        'mid-left': '‚û°Ô∏è Esq',
        'mid-center': 'üéØ Centre',
        'mid-right': '‚¨ÖÔ∏è Dret',
        'bottom-left': '‚¨áÔ∏è Esq',
        'bottom-center': '‚¨áÔ∏è Baix',
        'bottom-right': '‚¨áÔ∏è Dret'
    };
    
    const maxCount = Math.max(...zoneOrder.map(z => zones[z] || 0));
    
    container.innerHTML = `
        <div class="goal-zone-heatmap">
            ${zoneOrder.map(zone => {
                const count = zones[zone] || 0;
                const percentage = totalGols > 0 ? ((count / totalGols) * 100).toFixed(1) : 0;
                const intensity = maxCount > 0 ? count / maxCount : 0;
                
                // Color segons intensitat
                const bgColor = getHeatmapColor(intensity);
                
                return `
                    <div class="goal-zone-cell" style="background: ${bgColor};">
                        <div class="zone-label">${zoneLabels[zone]}</div>
                        <div class="zone-count">${count}</div>
                        <div style="font-size: 9px; color: rgba(255,255,255,0.7);">${percentage}%</div>
                    </div>
                `;
            }).join('')}
        </div>
        ${zones.unknown > 0 ? `
            <div style="text-align: center; margin-top: 10px; font-size: 11px; color: #bae6fd;">
                ‚ùì Gols sense zona registrada: ${zones.unknown}
            </div>
        ` : ''}
        <div style="text-align: center; margin-top: 15px; font-size: 12px; color: #bae6fd;">
            Total de gols amb zona: ${totalGols}
        </div>
    `;
}

function renderIndividualZoneMaps(players) {
    const container = document.getElementById('individualGoalZoneMaps');
    if (!container) return;
    
    if (players.length === 0) {
        container.innerHTML = '<div class="no-data">No hi ha dades disponibles</div>';
        return;
    }
    
    const zoneOrder = [
        'top-left', 'top-center', 'top-right',
        'mid-left', 'mid-center', 'mid-right',
        'bottom-left', 'bottom-center', 'bottom-right'
    ];
    
    const zoneLabels = {
        'top-left': '‚¨ÜÔ∏èE',
        'top-center': '‚¨ÜÔ∏èC',
        'top-right': '‚¨ÜÔ∏èD',
        'mid-left': '‚û°Ô∏èE',
        'mid-center': 'üéØ',
        'mid-right': '‚¨ÖÔ∏èD',
        'bottom-left': '‚¨áÔ∏èE',
        'bottom-center': '‚¨áÔ∏èB',
        'bottom-right': '‚¨áÔ∏èD'
    };
    
    container.innerHTML = players.map(player => {
        const totalWithZone = Object.values(player.zones).reduce((sum, count) => sum + count, 0) - (player.zones.unknown || 0);
        const maxCount = Math.max(...zoneOrder.map(z => player.zones[z] || 0));
        
        // Trobar zona preferida
        const preferredZone = zoneOrder.reduce((max, zone) => 
            (player.zones[zone] || 0) > (player.zones[max] || 0) ? zone : max
        , zoneOrder[0]);
        
        const preferredZoneLabel = {
            'top-left': 'Dalt Esquerra',
            'top-center': 'Dalt Centre',
            'top-right': 'Dalt Dreta',
            'mid-left': 'Centre Esquerra',
            'mid-center': 'Centre',
            'mid-right': 'Centre Dreta',
            'bottom-left': 'Baix Esquerra',
            'bottom-center': 'Baix Centre',
            'bottom-right': 'Baix Dreta'
        }[preferredZone];
        
        return `
            <div class="individual-zone-card">
                <div class="player-name">${player.num}. ${player.name.split(' ').slice(0, 2).join(' ')}</div>
                <div style="font-size: 10px; color: #bae6fd; text-align: center; margin-bottom: 8px;">
                    ${player.totalGols} gols (${totalWithZone} amb zona)
                </div>
                <div class="goal-zone-heatmap">
                    ${zoneOrder.map(zone => {
                        const count = player.zones[zone] || 0;
                        const intensity = maxCount > 0 ? count / maxCount : 0;
                        const bgColor = getHeatmapColor(intensity);
                        
                        return `
                            <div class="goal-zone-cell" style="background: ${bgColor};">
                                <div class="zone-label">${zoneLabels[zone]}</div>
                                <div class="zone-count">${count}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
                <div style="font-size: 10px; color: #fde047; text-align: center; margin-top: 8px;">
                    ‚≠ê Zona preferida: ${preferredZoneLabel}
                </div>
            </div>
        `;
    }).join('');
}

function getHeatmapColor(intensity) {
    if (intensity === 0) return 'rgba(50, 50, 50, 0.3)';
    
    // Gradient de verd (menys) a groc (mitj√†) a vermell (m√©s)
    if (intensity < 0.33) {
        const r = Math.round(34 + (251 - 34) * (intensity / 0.33));
        const g = Math.round(197 + (191 - 197) * (intensity / 0.33));
        const b = Math.round(94 + (36 - 94) * (intensity / 0.33));
        return `rgba(${r}, ${g}, ${b}, 0.8)`;
    } else if (intensity < 0.66) {
        const adjusted = (intensity - 0.33) / 0.33;
        const r = Math.round(251 + (249 - 251) * adjusted);
        const g = Math.round(191 + (115 - 191) * adjusted);
        const b = Math.round(36 + (22 - 36) * adjusted);
        return `rgba(${r}, ${g}, ${b}, 0.8)`;
    } else {
        const adjusted = (intensity - 0.66) / 0.34;
        const r = Math.round(249 + (239 - 249) * adjusted);
        const g = Math.round(115 + (68 - 115) * adjusted);
        const b = Math.round(22 + (68 - 22) * adjusted);
        return `rgba(${r}, ${g}, ${b}, 0.9)`;
    }
}
function renderMatchGoalZones() {
    const container = document.getElementById('matchGoalZonesContainer');
    if (!container || !currentMatch) return;
    
    // ‚úÖ Calcular zones NOM√âS d'aquest partit (no acumular de tots)
    const matchZones = {
        'top-left': 0, 'top-center': 0, 'top-right': 0,
        'mid-left': 0, 'mid-center': 0, 'mid-right': 0,
        'bottom-left': 0, 'bottom-center': 0, 'bottom-right': 0,
        'unknown': 0
    };
    
    const playerZones = {};
    
    currentMatch.jugadors.forEach(j => {
        if ((j.estadistiques.gols || 0) === 0) return;
        
        const playerName = j.nom.trim();
        
        playerZones[playerName] = {
            num: j.numero,
            name: playerName,
            totalGols: j.estadistiques.gols || 0,  // ‚úÖ Gols NOM√âS d'aquest partit
            zones: {
                'top-left': 0, 'top-center': 0, 'top-right': 0,
                'mid-left': 0, 'mid-center': 0, 'mid-right': 0,
                'bottom-left': 0, 'bottom-center': 0, 'bottom-right': 0,
                'unknown': 0
            }
        };
        
        // ‚úÖ Nom√©s les zones d'aquest partit
        if (j.estadistiques.goalZones) {
            Object.keys(j.estadistiques.goalZones).forEach(zone => {
                const count = j.estadistiques.goalZones[zone] || 0;
                matchZones[zone] = (matchZones[zone] || 0) + count;
                playerZones[playerName].zones[zone] = count;  // ‚úÖ Assignar directament, no sumar
            });
        }
    });
    
    const totalGols = Object.values(matchZones).reduce((sum, count) => sum + count, 0) - matchZones.unknown;
    
    if (totalGols === 0) {
        container.innerHTML = `
            <div class="no-data">
                ‚ö†Ô∏è Aquest partit no t√© dades de zones de porteria.<br>
                <small style="margin-top: 8px; display: block;">
                    Els partits nous registrats amb l'app actualitzada mostraran les zones.
                </small>
            </div>
        `;
        return;
    }
    
    const zoneOrder = [
        'top-left', 'top-center', 'top-right',
        'mid-left', 'mid-center', 'mid-right',
        'bottom-left', 'bottom-center', 'bottom-right'
    ];
    
    const zoneLabels = {
        'top-left': '‚¨ÜÔ∏è Esq',
        'top-center': '‚¨ÜÔ∏è Centre',
        'top-right': '‚¨ÜÔ∏è Dret',
        'mid-left': '‚û°Ô∏è Esq',
        'mid-center': 'üéØ Centre',
        'mid-right': '‚¨ÖÔ∏è Dret',
        'bottom-left': '‚¨áÔ∏è Esq',
        'bottom-center': '‚¨áÔ∏è Baix',
        'bottom-right': '‚¨áÔ∏è Dret'
    };
    
    const maxCount = Math.max(...zoneOrder.map(z => matchZones[z] || 0));
    
    // Mapa global del partit
    container.innerHTML = `
        <div style="margin-bottom: 25px;">
            <h3 style="color: #22d3ee; font-size: 14px; margin-bottom: 10px; text-align: center;">
                üìä Mapa Global del Partit
            </h3>
            <div class="goal-zone-heatmap">
                ${zoneOrder.map(zone => {
                    const count = matchZones[zone] || 0;
                    const percentage = totalGols > 0 ? ((count / totalGols) * 100).toFixed(1) : 0;
                    const intensity = maxCount > 0 ? count / maxCount : 0;
                    const bgColor = getHeatmapColor(intensity);
                    
                    return `
                        <div class="goal-zone-cell" style="background: ${bgColor};">
                            <div class="zone-label">${zoneLabels[zone]}</div>
                            <div class="zone-count">${count}</div>
                            <div style="font-size: 9px; color: rgba(255,255,255,0.7);">${percentage}%</div>
                        </div>
                    `;
                }).join('')}
            </div>
            ${matchZones.unknown > 0 ? `
                <div style="text-align: center; margin-top: 10px; font-size: 11px; color: #bae6fd;">
                    ‚ùì Gols sense zona registrada: ${matchZones.unknown}
                </div>
            ` : ''}
            <div style="text-align: center; margin-top: 10px; font-size: 12px; color: #fde047;">
                Total de gols amb zona: ${totalGols}
            </div>
        </div>
        
        <div style="margin-top: 25px;">
            <h3 style="color: #22d3ee; font-size: 14px; margin-bottom: 10px; text-align: center;">
                üë§ Zones per Jugador
            </h3>
            <div id="individualGoalZoneMaps" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                ${Object.values(playerZones).map(player => {
                    const totalWithZone = Object.values(player.zones).reduce((sum, count) => sum + count, 0) - (player.zones.unknown || 0);
                    const maxPlayerCount = Math.max(...zoneOrder.map(z => player.zones[z] || 0));
                    
                    // Trobar zona preferida
                    const preferredZone = zoneOrder.reduce((max, zone) => 
                        (player.zones[zone] || 0) > (player.zones[max] || 0) ? zone : max
                    , zoneOrder[0]);
                    
                    const preferredZoneLabel = {
                        'top-left': 'Dalt Esquerra',
                        'top-center': 'Dalt Centre',
                        'top-right': 'Dalt Dreta',
                        'mid-left': 'Centre Esquerra',
                        'mid-center': 'Centre',
                        'mid-right': 'Centre Dreta',
                        'bottom-left': 'Baix Esquerra',
                        'bottom-center': 'Baix Centre',
                        'bottom-right': 'Baix Dreta'
                    }[preferredZone];
                    
                    const zoneLabelsShort = {
                        'top-left': '‚¨ÜÔ∏èE',
                        'top-center': '‚¨ÜÔ∏èC',
                        'top-right': '‚¨ÜÔ∏èD',
                        'mid-left': '‚û°Ô∏èE',
                        'mid-center': 'üéØ',
                        'mid-right': '‚¨ÖÔ∏èD',
                        'bottom-left': '‚¨áÔ∏èE',
                        'bottom-center': '‚¨áÔ∏èB',
                        'bottom-right': '‚¨áÔ∏èD'
                    };
                    
                    return `
                        <div class="individual-zone-card">
                            <div class="player-name">${player.num}. ${player.name.split(' ').slice(0, 2).join(' ')}</div>
                            <div style="font-size: 10px; color: #bae6fd; text-align: center; margin-bottom: 8px;">
                                ${player.totalGols} gols (${totalWithZone} amb zona)
                            </div>
                            <div class="goal-zone-heatmap">
                                ${zoneOrder.map(zone => {
                                    const count = player.zones[zone] || 0;
                                    const intensity = maxPlayerCount > 0 ? count / maxPlayerCount : 0;
                                    const bgColor = getHeatmapColor(intensity);
                                    
                                    return `
                                        <div class="goal-zone-cell" style="background: ${bgColor};">
                                            <div class="zone-label">${zoneLabelsShort[zone]}</div>
                                            <div class="zone-count">${count}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            ${totalWithZone > 0 && player.zones[preferredZone] > 0 ? `
                                <div style="font-size: 10px; color: #fde047; text-align: center; margin-top: 8px;">
                                    ‚≠ê ${preferredZoneLabel} (${player.zones[preferredZone]})
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('')}
            </div>
        </div>
    `;
}
function renderMatchFieldZones() {
    const container = document.getElementById('matchFieldZonesContainer');
    if (!container || !currentMatch) return;
    
    // ‚úÖ Calcular zones del camp NOM√âS d'aquest partit
    const matchFieldZones = {
        '2m-left': 0, '2m-center': 0, '2m-right': 0,
        '5m-left': 0, '5m-center': 0, '5m-right': 0,
        '+6m-left': 0, '+6m-center': 0, '+6m-right': 0,
        'unknown': 0
    };
    
    const playerFieldZones = {};
    
    currentMatch.jugadors.forEach(j => {
        if ((j.estadistiques.gols || 0) === 0) return;
        
        const playerName = j.nom.trim();
        
        playerFieldZones[playerName] = {
            num: j.numero,
            name: playerName,
            totalGols: j.estadistiques.gols || 0,
            zones: {
                '2m-left': 0, '2m-center': 0, '2m-right': 0,
                '5m-left': 0, '5m-center': 0, '5m-right': 0,
                '+6m-left': 0, '+6m-center': 0, '+6m-right': 0,
                'unknown': 0
            }
        };
        
        // ‚úÖ Nom√©s les zones del camp d'aquest partit
        if (j.estadistiques.fieldZones) {
            Object.keys(j.estadistiques.fieldZones).forEach(zone => {
                const count = j.estadistiques.fieldZones[zone] || 0;
                matchFieldZones[zone] = (matchFieldZones[zone] || 0) + count;
                playerFieldZones[playerName].zones[zone] = count;
            });
        }
    });
    
    const totalGols = Object.values(matchFieldZones).reduce((sum, count) => sum + count, 0) - matchFieldZones.unknown;
    
    if (totalGols === 0) {
        container.innerHTML = `
            <div class="no-data">
                ‚ö†Ô∏è Aquest partit no t√© dades de zones del camp.<br>
                <small style="margin-top: 8px; display: block;">
                    Els partits nous registrats amb l'app actualitzada mostraran les zones del camp.
                </small>
            </div>
        `;
        return;
    }
    
    const zoneOrder = [
        '2m-left', '2m-center', '2m-right',
        '5m-left', '5m-center', '5m-right',
        '+6m-left', '+6m-center', '+6m-right'
    ];
    
    const zoneLabels = {
        '2m-left': '‚¨ÖÔ∏è Esq 2m',
        '2m-center': 'üéØ Cen 2m',
        '2m-right': '‚û°Ô∏è Dre 2m',
        '5m-left': '‚¨ÖÔ∏è Esq -6m',
        '5m-center': 'üéØ Cen -6m',
        '5m-right': '‚û°Ô∏è Dre -6m',
        '+6m-left': '‚¨ÖÔ∏è Esq +6m',
        '+6m-center': 'üéØ Cen +6m',
        '+6m-right': '‚û°Ô∏è Dre +6m'
    };
    
    const maxCount = Math.max(...zoneOrder.map(z => matchFieldZones[z] || 0));
    
    // Mapa global del partit - zones del camp
    container.innerHTML = `
        <!-- Indicador de porteria rival -->
        <div style="text-align: center; margin: 10px auto 15px auto; max-width: 280px; padding: 8px; background: rgba(239, 68, 68, 0.2); border-radius: 8px; border: 2px solid #ef4444;">
            <div style="font-size: 20px; margin-bottom: 4px;">ü•Ö</div>
            <div style="font-size: 11px; font-weight: bold; color: #fca5a5;">PORTERIA RIVAL</div>
        </div>
        
        <div style="margin-bottom: 25px;">
            <h3 style="color: #22d3ee; font-size: 14px; margin-bottom: 10px; text-align: center;">
                üìä Mapa Global del Partit - Zones del Camp
            </h3>
            <div class="field-zone-heatmap">
                ${zoneOrder.map((zone, index) => {
                    const count = matchFieldZones[zone] || 0;
                    const percentage = totalGols > 0 ? ((count / totalGols) * 100).toFixed(1) : 0;
                    const intensity = maxCount > 0 ? count / maxCount : 0;
                    const bgColor = getHeatmapColor(intensity);
                    
                    const extraStyle = (index === 2 || index === 5) ? 'border-bottom: 2px dashed rgba(255,255,255,0.3);' : '';
                    
                    return `
                        <div class="goal-zone-cell" style="background: ${bgColor}; ${extraStyle}">
                            <div class="zone-label">${zoneLabels[zone]}</div>
                            <div class="zone-count">${count}</div>
                            <div style="font-size: 9px; color: rgba(255,255,255,0.7);">${percentage}%</div>
                        </div>
                    `;
                }).join('')}
            </div>
            ${matchFieldZones.unknown > 0 ? `
                <div style="text-align: center; margin-top: 10px; font-size: 11px; color: #bae6fd;">
                    ‚ùì Gols sense zona del camp registrada: ${matchFieldZones.unknown}
                </div>
            ` : ''}
            <div style="text-align: center; margin-top: 10px; font-size: 12px; color: #fde047;">
                Total de gols amb zona del camp: ${totalGols}
            </div>
        </div>
        
        <div style="margin-top: 25px;">
            <h3 style="color: #22d3ee; font-size: 14px; margin-bottom: 10px; text-align: center;">
                üë§ Zones del Camp per Jugador
            </h3>
            <div id="individualFieldZoneMaps" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                ${Object.values(playerFieldZones).map(player => {
                    const totalWithZone = Object.values(player.zones).reduce((sum, count) => sum + count, 0) - (player.zones.unknown || 0);
                    const maxPlayerCount = Math.max(...zoneOrder.map(z => player.zones[z] || 0));
                    
                    // Trobar zona preferida
                    const preferredZone = zoneOrder.reduce((max, zone) => 
                        (player.zones[zone] || 0) > (player.zones[max] || 0) ? zone : max
                    , zoneOrder[0]);
                    
                    const preferredZoneLabel = {
                        '2m-left': 'Esquerra 2m',
                        '2m-center': 'Centre 2m',
                        '2m-right': 'Dreta 2m',
                        '5m-left': 'Esquerra 5m',
                        '5m-center': 'Centre 5m',
                        '5m-right': 'Dreta 5m',
                        '+6m-left': 'Esquerra +6m',
                        '+6m-center': 'Centre +6m',
                        '+6m-right': 'Dreta +6m'
                    }[preferredZone];
                    
                    const zoneLabelsShort = {
                        '2m-left': '‚¨ÖÔ∏èE',
                        '2m-center': 'üéØ',
                        '2m-right': '‚û°Ô∏èD',
                        '5m-left': '‚¨ÖÔ∏èE',
                        '5m-center': 'üéØ',
                        '5m-right': '‚û°Ô∏èD',
                        '+6m-left': '‚¨ÖÔ∏èE',
                        '+6m-center': 'üéØ',
                        '+6m-right': '‚û°Ô∏èD'
                    };
                    
                    return `
                        <div class="individual-zone-card">
                            <div class="player-name">${player.num}. ${player.name.split(' ').slice(0, 2).join(' ')}</div>
                            <div style="font-size: 10px; color: #bae6fd; text-align: center; margin-bottom: 8px;">
                                ${player.totalGols} gols (${totalWithZone} amb zona)
                            </div>
                            <div class="field-zone-heatmap">
                                ${zoneOrder.map((zone, index) => {
                                    const count = player.zones[zone] || 0;
                                    const intensity = maxPlayerCount > 0 ? count / maxPlayerCount : 0;
                                    const bgColor = getHeatmapColor(intensity);
                                    const extraStyle = (index === 2 || index === 5) ? 'border-bottom: 2px dashed rgba(255,255,255,0.3);' : '';
                                    
                                    return `
                                        <div class="goal-zone-cell" style="background: ${bgColor}; ${extraStyle}">
                                            <div class="zone-label">${zoneLabelsShort[zone]}</div>
                                            <div class="zone-count">${count}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            ${totalWithZone > 0 && player.zones[preferredZone] > 0 ? `
                                <div style="font-size: 10px; color: #fde047; text-align: center; margin-top: 8px;">
                                    ‚≠ê ${preferredZoneLabel} (${player.zones[preferredZone]})
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('')}
            </div>
        </div>
    `;
}
/**
 * Obtenir el temps de finalitzaci√≥ d'un quart
 */
function getQuarterEndTime(quarterStartTimes, quarterRealEndTimes, quarter) {
    const QUARTER_DURATION = 480;
    
    // Prioritzar el temps real de finalitzaci√≥ si existeix
    if (quarterRealEndTimes && quarterRealEndTimes[quarter]) {
        return quarterRealEndTimes[quarter];
    }
    
    // Si no existeix, utilitzar l'inici del seg√ºent quart
    const quarterOrder = ['q1', 'q2', 'q3', 'q4'];
    const currentIndex = quarterOrder.indexOf(quarter);
    
    if (currentIndex < 3) {
        const nextQuarter = quarterOrder[currentIndex + 1];
        if (quarterStartTimes[nextQuarter]) {
            return quarterStartTimes[nextQuarter];
        }
    }
    
    // Si no hi ha res, afegir 8 minuts a l'inici del quart
    return quarterStartTimes[quarter] + (QUARTER_DURATION * 1000);
}
// ‚úÖ GESTI√ì DE SELECCI√ì D'EQUIP
let selectedTeam = localStorage.getItem('selectedTeam') || null;

function selectTeam(team) {
    console.log('üîç Team seleccionat:', team);
    
    selectedTeam = team;
    localStorage.setItem('selectedTeam', team);
    document.getElementById('teamSelectionModal').style.display = 'none';
    
    // ‚úÖ APLICAR TEMA VISUAL SEGONS L'EQUIP
    document.body.className = team === 'cadet' ? 'theme-cadet' : 'theme-juvenil';
    
    // ‚úÖ ACTUALITZAR T√çTOL I SUBT√çTOL
    const teamName = team === 'cadet' ? 'CADET' : 'JUVENIL';
    const emoji = team === 'cadet' ? '‚¨õ' : 'üü¶';
    const coach = team === 'cadet' ? 'Didac Cobacho' : 'Jordi Busquets';
    document.getElementById('mainTitle').innerHTML = `${emoji} üìä Estad√≠stiques CN Terrassa - ${teamName} ${emoji}`;
    document.getElementById('coachName').innerHTML = `üë®‚Äçüè´ Entrenador: ${coach}`;
    //document.getElementById('mainSubtitle').innerHTML = `Temporada 25/26 ‚Ä¢ ${allMatches.length} partits`;
    
    // Carregar dades
    loadAllMatches(team);
	 // Av√≠s partit a casa Juvenil
    if (team === 'juvenil') {
        setTimeout(() => { alert('‚ö†Ô∏è ATENCI√ì: El proper partit del Juvenil es juga a CASA!'); }, 500);
    }
}

async function changeTeam() {
    // Actualitzar si estem al tab ACTAWP
    if (!document.getElementById('actawpTab').classList.contains('hidden')) {
        await checkLastUpdate();
    }
    
    // Netejar i recarregar
    localStorage.removeItem('selectedTeam');
    location.reload();
}

// ‚úÖ COMPROVAR SI JA HI HA EQUIP SELECCIONAT
window.addEventListener('DOMContentLoaded', () => {
    if (selectedTeam) {
        document.getElementById('teamSelectionModal').style.display = 'none';
        
        // ‚úÖ APLICAR TEMA VISUAL SEGONS L'EQUIP
        document.body.className = selectedTeam === 'cadet' ? 'theme-cadet' : 'theme-juvenil';
        
        // ‚úÖ ACTUALITZAR T√çTOL I SUBT√çTOL
        const teamName = selectedTeam === 'cadet' ? 'CADET' : 'JUVENIL';
        const emoji = selectedTeam === 'cadet' ? '‚¨õ' : 'üü¶';
        const coach = selectedTeam === 'cadet' ? 'D√≠dac Cobacho' : 'Jordi Busquets';
        document.getElementById('mainTitle').innerHTML = `${emoji} üìä Estad√≠stiques CN Terrassa - ${teamName} ${emoji}`;
        document.getElementById('coachName').innerHTML = `üë®‚Äçüè´ Entrenador: ${coach}`;
        document.getElementById('mainSubtitle').innerHTML = `Temporada 25/26`;
        
        loadAllMatches(selectedTeam);
    }
});
// ============================================
// FUNCIONS PER ESTAD√çSTIQUES INDIVIDUALS
// ============================================

let selectedPlayer = null;
let allPlayersData = {};
let comparisonPlayers = [];

function initializePlayerSelector() {
    const container = document.getElementById('individualTab');
    
    // Crear la taula de tots els jugadors (igual que a comparaci√≥)
    container.innerHTML = `
        <div class="card">
            <h2 class="section-title">üë§ Selecciona un Jugador</h2>
            <p style="color: #bae6fd; margin-bottom: 20px; font-size: 14px;">
                Fes clic sobre un jugador per veure les seves estad√≠stiques detallades
            </p>
            <div style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
                <table class="comparison-table" id="comparisonTableIndividual"></table>
            </div>
        </div>
        
        <div id="individualPlayerDetails" class="hidden"></div>
    `;
    
    // Generar la taula amb tots els jugadors
    renderPlayerSelectionTable();
}
function getAllUniquePlayers() {
    const playersMap = new Map();
    
    allMatches.forEach(match => {
        if (!match.jugadors) return;
        
        match.jugadors.forEach(jugador => {
            const key = `${jugador.numero}-${jugador.nom}`;
            
            if (!playersMap.has(key)) {
                playersMap.set(key, {
                    num: jugador.numero,
                    name: jugador.nom,
                    partidos: 0,
                    gols: 0,
                    goalTypes: { 'h+': 0, penalty: 0, contra: 0, boya: 0, normal: 0 },
                    assistencies: 0,
                    robatoris: 0,
                    blocks: 0,
                    blocatges: 0,
                    parades: 0,
                    faltesRebudes: 0,
                    exclusions: 0,
                    exclusionTypes: { normal: 0, penalty: 0 },
                    infraccions2m: 0,
                    contrafaltes: 0,
                    perdues: 0,
                    xutsFallats: 0,
                    penaltyMissed: 0
                });
            }
            
            const player = playersMap.get(key);
            const stats = jugador.estadistiques || {};
            
            player.partidos++;
            player.gols += stats.gols || 0;
            
            // Goal types
            if (stats.goalTypes) {
                Object.keys(stats.goalTypes).forEach(type => {
                    player.goalTypes[type] = (player.goalTypes[type] || 0) + (stats.goalTypes[type] || 0);
                });
            }
            
            player.assistencies += stats.assistencies || 0;
            player.robatoris += stats.robatoris || 0;
            player.blocks += stats.blocks || 0;
            player.blocatges += stats.blocatges || 0;
            player.parades += stats.parades || 0;
            player.faltesRebudes += stats.faltesRebudes || 0;
            player.exclusions += stats.exclusions || 0;
            
            if (stats.exclusionTypes) {
                player.exclusionTypes.normal += stats.exclusionTypes.normal || 0;
                player.exclusionTypes.penalty += stats.exclusionTypes.penalty || 0;
            }
            
            player.infraccions2m += stats.infraccions2m || 0;
            player.contrafaltes += stats.contrafaltes || 0;
            player.perdues += stats.perdues || 0;
            player.xutsFallats += stats.xutsFallats || 0;
            player.penaltyMissed += stats.penaltyMissed || 0;
        });
    });
    
    return Array.from(playersMap.values()).sort((a, b) => a.num - b.num);
}
function renderPlayerSelectionTable() {
    const allPlayers = getAllUniquePlayers();
    renderComparisonTable(allPlayers, true, 'comparisonTableIndividual');
    
    // Afegir event listeners per fer clic als jugadors
    document.querySelectorAll('.player-row-clickable').forEach(row => {
        row.addEventListener('click', function() {
            const playerNum = parseInt(this.dataset.playerNum);
            const playerName = this.dataset.playerName;
            showIndividualPlayerDetails({ num: playerNum, name: playerName });
        });
    });
}

function showIndividualPlayerDetails(player) {
    selectedPlayer = player;
    
    // Amagar la taula de selecci√≥
    document.querySelector('#individualTab .card').classList.add('hidden');
    
    // Mostrar el contenidor de detalls
    const detailsContainer = document.getElementById('individualPlayerDetails');
    detailsContainer.classList.remove('hidden');
    
    // Calcular totes les dades del jugador
    const playerData = calculatePlayerFullStats(selectedPlayer);
    
    // Detectar si √©s porter
    const isGoalkeeper = selectedPlayer.num === 1 || selectedPlayer.num === 13 || playerData.totalSaves > 0;
    
   if (isGoalkeeper) {
    // Bot√≥ tornar + contingut porter
    detailsContainer.innerHTML = `
        <div class="card">
            <button class="btn" onclick="backToPlayerSelection()" style="margin-bottom: 20px; background: #64748b;">
                ‚Üê Tornar a la Llista de Jugadors
            </button>
        </div>
        
        <div class="card">
            <h2 class="section-title">üìä Resum Estad√≠stic Porter</h2>
            <div class="info-grid" id="goalkeeperSummaryGrid"></div>
        </div>
        
        <div class="card">
            <h2 class="section-title">üìà Percentatge de Parades</h2>
            <canvas id="goalkeeperSavePercentageChart" style="max-height: 300px;"></canvas>
        </div>
        
        <div class="card">
            <h2 class="section-title">üß§ Tipus de Parades</h2>
            <canvas id="goalkeeperSaveTypeChart" style="max-height: 300px;"></canvas>
        </div>
        
        <div class="card">
            <h2 class="section-title">üéØ Zones de Parades</h2>
            <div id="goalkeeperZonesHeatmap"></div>
        </div>
        
        <div class="card">
            <h2 class="section-title">üìä Rendiment per Rival</h2>
            <div style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
    <table class="comparison-table" id="goalkeeperByRivalTable" style="min-width: 800px;"></table>
</div>
        </div>
        
        <div class="card">
            <h2 class="section-title">üìà Evoluci√≥ del Percentatge de Parades</h2>
            <canvas id="goalkeeperEvolutionChart" style="max-height: 300px;"></canvas>
        </div>
        
        <div class="card">
            <h2 class="section-title">‚öñÔ∏è Comparativa amb Altres Porters</h2>
            <canvas id="goalkeeperComparisonChart" style="max-height: 300px;"></canvas>
        </div>
        
        <div class="card">
            <h2 class="section-title">üéØ Estad√≠stiques de Penalties</h2>
            <div class="info-grid" id="goalkeeperPenaltiesGrid"></div>
        </div>
    `;
    
    // Esperar que el DOM es renderitzi abans de cridar les funcions
    setTimeout(() => {
        renderGoalkeeperStats(playerData);
    }, 100);
    
} else {
    // Bot√≥ tornar + contingut jugador normal
    detailsContainer.innerHTML = `
        <div class="card">
            <button class="btn" onclick="backToPlayerSelection()" style="margin-bottom: 20px; background: #64748b;">
                ‚Üê Tornar a la Llista de Jugadors
            </button>
        </div>
        
        <div class="card">
            <div id="playerHeader" style="text-align: center;"></div>
        </div>
        
        <div class="card">
            <h2 class="section-title">üìä Resum Estad√≠stic</h2>
            <div class="info-grid" id="playerSummaryGrid"></div>
        </div>
        
        <!-- SUBSTITUEIX AQUEST BLOC AL TEU index.html -->
<!-- Busca la secci√≥ "Evoluci√≥ per Partit" i substitueix-la per aquest codi: -->

<div class="card">
    <h2 class="section-title">üìà Evoluci√≥ per Partit</h2>
    
    <!-- Llegenda explicativa -->
    <div style="margin-bottom: 15px; padding: 12px; background: rgba(34, 211, 238, 0.1); border-radius: 8px; font-size: 13px; color: #bae6fd;">
        <strong>üìä Visualitzaci√≥ completa:</strong> Totes les m√®triques positives del jugador per partit
        <br>
        <span style="font-size: 11px; opacity: 0.8;">
            Eix esquerre: Accions | Eix dret: Valoraci√≥ MVP | 
            <span style="border-bottom: 2px dashed #f87171; padding: 0 4px;">L√≠nia discont√≠nua = Exclusions</span>
        </span>
    </div>
    
    <!-- Gr√†fic (m√©s alt per tenir espai per totes les l√≠nies) -->
    <canvas id="playerEvolutionChart" style="max-height: 450px;"></canvas>
    
    <!-- Llegenda de colors -->
    <div style="margin-top: 15px; display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; font-size: 11px; text-align: center;">
        <span style="color: #fde047; font-weight: bold;">‚öΩ Gols</span>
        <span style="color: #a78bfa; font-weight: bold;">üéØ Assist√®ncies</span>
        <span style="color: #fb923c; font-weight: bold;">üí™ Robades</span>
        <span style="color: #34d399; font-weight: bold;">üõ°Ô∏è Blocatges</span>
        <span style="color: #38bdf8; font-weight: bold;">üü¶ Faltes Rebudes</span>
        <span style="color: #f87171; font-weight: bold;">üü• Exclusions</span>
        <span style="color: #22d3ee; font-weight: bold; font-size: 12px;">üìä MVP</span>
        <span style="color: #60a5fa; font-weight: bold;">üß§ Parades</span>
    </div>
</div>
    
    <!-- GR√ÄFIC -->
    <canvas id="playerEvolutionChart" style="max-height: 300px;"></canvas>
    
  </div>
        
        <div class="card">
            <h2 class="section-title">üéØ Zones de Gol</h2>
            <div id="playerGoalZonesHeatmap"></div>
        </div>
        <!-- AFEGEIX AIX√í AQU√ç -->
<div class="card">
    <h2 class="section-title">üèä Zones de Tir (Piscina)</h2>
    <p style="font-size: 12px; color: #bae6fd; margin-bottom: 15px;">Des d'on marca els gols</p>
    <div id="playerFieldZonesHeatmap"></div>
</div>
        <div class="card">
            <h2 class="section-title">‚öñÔ∏è Rendiment vs Equip</h2>
            <canvas id="playerVsTeamChart" style="max-height: 300px;"></canvas>
        </div>
        
        <div class="card">
            <h2 class="section-title">üè† Rendiment Local vs Visitant</h2>
            <canvas id="homeAwayChart" style="max-height: 250px;"></canvas>
        </div>
        
        <div class="card">
            <h2 class="section-title">‚è±Ô∏è Rendiment per Quart</h2>
            <canvas id="quarterPerformanceChart" style="max-height: 250px;"></canvas>
        </div>
        
        <div class="card">
            <h2 class="section-title">üìú Historial de Partits</h2>
            <div style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
                <table class="comparison-table" id="playerMatchHistoryTable"></table>
            </div>
        </div>
        
        <div class="card">
            <h2 class="section-title">üë• Comparar amb Altres Jugadors</h2>
            <div id="comparePlayersCheckboxes"></div>
            <button class="btn" onclick="compareSelectedPlayers()" style="margin-top: 15px; background: #06b6d4;">
                Comparar Seleccionats
            </button>
        </div>
        
        <div id="multiPlayerComparisonContent" class="hidden">
            <div class="card">
                <h2 class="section-title">üìä Comparativa Multi-Jugador</h2>
                <canvas id="multiPlayerComparisonChart" style="max-height: 400px;"></canvas>
            </div>
        </div>
    `;
 // ============================================
// üìà EVOLUCI√ì TEMPORAL DEL JUGADOR - VERSI√ì MILLORADA
// ============================================

// Variable global per mantenir les dades del jugador actual
let currentPlayerData = null;

// Funci√≥ per actualitzar el gr√†fic quan canvia la m√®trica seleccionada
function updateEvolutionChart() {
    if (!currentPlayerData) return;
    
    const metric = document.getElementById('evolutionMetricSelector').value;
    renderPlayerEvolutionChartImproved(currentPlayerData, metric);
}


// Funci√≥ per renderitzar el gr√†fic amb TOTES les m√®triques
function renderPlayerEvolutionChartImproved(data, metric = 'all') {
    const ctx = document.getElementById('playerEvolutionChart');
    if (!ctx) {
        console.error('No s\'ha trobat el canvas playerEvolutionChart');
        return;
    }
    
    // Comprovar que data.evolution existeix i t√© dades
    if (!data.evolution || data.evolution.length === 0) {
        console.warn('No hi ha dades d\'evoluci√≥ per mostrar');
        return;
    }
    
    // Destruir gr√†fic anterior si existeix
    if (window.playerEvolutionChartInstance) {
        window.playerEvolutionChartInstance.destroy();
    }
    
    // Preparar labels (dates)
    const labels = data.evolution.map(match => [match.date, match.rival]);
    const rivals = data.evolution.map(match => match.rival);
    
    // Detectar si √©s porter
    const isGoalkeeper = data.totalSaves > 0 || data.num === 1 || data.num === 13;
    
    // Crear datasets per cada m√®trica POSITIVA
    const datasets = [
        {
            label: '‚öΩ Gols',
            data: data.evolution.map(m => m.goals || 0),
            borderColor: '#fde047',
            backgroundColor: 'rgba(253, 224, 71, 0.1)',
            tension: 0.3,
            borderWidth: 2.5,
            pointRadius: 5,
            pointHoverRadius: 7
        },
        {
            label: 'üéØ Assist√®ncies',
            data: data.evolution.map(m => m.assists || 0),
            borderColor: '#a78bfa',
            backgroundColor: 'rgba(167, 139, 250, 0.1)',
            tension: 0.3,
            borderWidth: 2.5,
            pointRadius: 5,
            pointHoverRadius: 7
        },
        {
            label: 'üí™ Robades',
            data: data.evolution.map(m => m.steals || 0),
            borderColor: '#fb923c',
            backgroundColor: 'rgba(251, 146, 60, 0.1)',
            tension: 0.3,
            borderWidth: 2.5,
            pointRadius: 5,
            pointHoverRadius: 7
        },
        {
            label: 'üõ°Ô∏è Blocatges',
            data: data.evolution.map(m => m.blocks || 0),
            borderColor: '#34d399',
            backgroundColor: 'rgba(52, 211, 153, 0.1)',
            tension: 0.3,
            borderWidth: 2.5,
            pointRadius: 5,
            pointHoverRadius: 7
        },
        {
            label: 'üü¶ Faltes Rebudes',
            data: data.evolution.map(m => m.foulsReceived || 0),
            borderColor: '#38bdf8',
            backgroundColor: 'rgba(56, 189, 248, 0.1)',
            tension: 0.3,
            borderWidth: 2.5,
            pointRadius: 5,
            pointHoverRadius: 7
        },
        {
            label: 'üü• Exclusions',
            data: data.evolution.map(m => m.exclusions || 0),
            borderColor: '#f87171',
            backgroundColor: 'rgba(248, 113, 113, 0.1)',
            tension: 0.3,
            borderWidth: 2,
            pointRadius: 4,
            pointHoverRadius: 6,
            borderDash: [5, 5] // L√≠nia discont√≠nua per diferenciar que √©s negatiu
        },
        {
            label: 'üìä MVP',
            data: data.evolution.map(m => m.mvp || 0),
            borderColor: '#22d3ee',
            backgroundColor: 'rgba(34, 211, 238, 0.1)',
            tension: 0.3,
            borderWidth: 3,
            pointRadius: 6,
            pointHoverRadius: 8,
            yAxisID: 'y1' // Eix secundari per MVP
        }
    ];
    
    // Si √©s porter, afegir parades
    if (isGoalkeeper) {
        datasets.push({
            label: 'üß§ Parades',
            data: data.evolution.map(m => m.saves || 0),
            borderColor: '#60a5fa',
            backgroundColor: 'rgba(96, 165, 250, 0.1)',
            tension: 0.3,
            borderWidth: 2.5,
            pointRadius: 5,
            pointHoverRadius: 7
        });
    }
    
    window.playerEvolutionChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            interaction: { 
                mode: 'index', 
                intersect: false 
            },
            plugins: {
                legend: { 
                    display: true,
                    position: 'top',
                    labels: { 
                        color: 'white',
                        font: { size: 11 },
                        padding: 8,
                        usePointStyle: true,
                        pointStyle: 'line'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.9)',
                    titleColor: '#22d3ee',
                    bodyColor: 'white',
                    borderColor: '#22d3ee',
                    borderWidth: 1,
                    padding: 15,
                    titleFont: { size: 14, weight: 'bold' },
                    bodyFont: { size: 12 },
                    callbacks: {
                        title: function(context) {
                            const index = context[0].dataIndex;
                            return `${rivals[index]} - ${labels[index]}`;
                        },
                        label: function(context) {
                            const label = context.dataset.label || '';
                            const value = context.parsed.y;
                            
                            // Format segons la m√®trica
                            if (label.includes('MVP')) {
                                return `${label}: ${value.toFixed(1)}`;
                            }
                            return `${label}: ${value}`;
                        },
                        afterBody: function(context) {
                            const index = context[0].dataIndex;
                            const match = data.evolution[index];
                            return `\n‚è±Ô∏è Minuts: ${match.minutes}'`;
                        }
                    }
                }
            },
            scales: {
            x: { 
    ticks: { 
        color: 'white',
        font: { size: 9 },      // AFEGIR
        maxRotation: 0,          // CANVIAR de 45 a 0
        minRotation: 0,          // CANVIAR de 45 a 0
        autoSkip: false          // AFEGIR
    },
                    grid: { 
                        color: 'rgba(255,255,255,0.1)',
                        drawOnChartArea: true
                    }
                },
                y: {
                    type: 'linear',
                    position: 'left',
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Accions per Partit',
                        color: 'white',
                        font: { size: 12 }
                    },
                    ticks: { 
                        color: 'white',
                        stepSize: 1
                    },
                    grid: { 
                        color: 'rgba(255,255,255,0.1)'
                    }
                },
                y1: {
                    type: 'linear',
                    position: 'right',
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Valoraci√≥ MVP',
                        color: '#22d3ee',
                        font: { size: 12 }
                    },
                    ticks: { 
                        color: '#22d3ee',
                        callback: function(value) {
                            return value.toFixed(1);
                        }
                    },
                    grid: { 
                        display: false // No mostrar grid de l'eix secundari
                    }
                }
            }
        }
    });
}

console.log('‚úÖ Gr√†fic d\'evoluci√≥ multi-m√®trica (versi√≥ completa) carregat correctament');


// Funci√≥ per preparar dades segons la m√®trica
function prepareChartData(data, metric) {
    const labels = [];
    const values = [];
    const rivals = [];
    const extraInfo = [];
    
    let datasetLabel, color, bgColor, formatValue, yAxisFormat;
    
    // Configuraci√≥ per cada m√®trica
    switch(metric) {
        case 'mvp':
            datasetLabel = 'Valoraci√≥ MVP';
            color = '#22d3ee';
            bgColor = 'rgba(34, 211, 238, 0.1)';
            formatValue = (v) => v.toFixed(1);
            yAxisFormat = (v) => v.toFixed(1);
            
            data.evolution.forEach(match => {
                labels.push(match.date);
                values.push(match.mvp);
                rivals.push(match.rival);
                extraInfo.push(`Minuts: ${match.minutes}'`);
            });
            break;
            
        case 'goals':
            datasetLabel = 'Gols per Partit';
            color = '#fde047';
            bgColor = 'rgba(253, 224, 71, 0.1)';
            formatValue = (v) => v;
            yAxisFormat = (v) => v;
            
            data.evolution.forEach(match => {
                labels.push(match.date);
                values.push(match.goals);
                rivals.push(match.rival);
                extraInfo.push(`Minuts: ${match.minutes}'`);
            });
            break;
            
        case 'assists':
            datasetLabel = 'Assist√®ncies per Partit';
            color = '#a78bfa';
            bgColor = 'rgba(167, 139, 250, 0.1)';
            formatValue = (v) => v;
            yAxisFormat = (v) => v;
            
            data.evolution.forEach(match => {
                labels.push(match.date);
                values.push(match.assists);
                rivals.push(match.rival);
                extraInfo.push(`Gols: ${match.goals}`);
            });
            break;
            
        case 'efficiency':
            datasetLabel = 'Efic√†cia en Tirs (%)';
            color = '#34d399';
            bgColor = 'rgba(52, 211, 153, 0.1)';
            formatValue = (v) => v.toFixed(1) + '%';
            yAxisFormat = (v) => v.toFixed(0) + '%';
            
            data.evolution.forEach(match => {
                const totalShots = match.goals + match.missedShots;
                const efficiency = totalShots > 0 ? (match.goals / totalShots) * 100 : 0;
                labels.push(match.date);
                values.push(efficiency);
                rivals.push(match.rival);
                extraInfo.push(`${match.goals}/${totalShots} gols`);
            });
            break;
            
        case 'exclusions':
            datasetLabel = 'Exclusions per Partit';
            color = '#f87171';
            bgColor = 'rgba(248, 113, 113, 0.1)';
            formatValue = (v) => v;
            yAxisFormat = (v) => v;
            
            data.evolution.forEach(match => {
                labels.push(match.date);
                values.push(match.exclusions);
                rivals.push(match.rival);
                extraInfo.push(`Minuts: ${match.minutes}'`);
            });
            break;
            
        case 'steals':
            datasetLabel = 'Robades per Partit';
            color = '#fb923c';
            bgColor = 'rgba(251, 146, 60, 0.1)';
            formatValue = (v) => v;
            yAxisFormat = (v) => v;
            
            data.evolution.forEach(match => {
                labels.push(match.date);
                values.push(match.steals);
                rivals.push(match.rival);
                extraInfo.push(`P√®rdues: ${match.losses}`);
            });
            break;
            
        case 'saves':
            datasetLabel = 'Parades per Partit';
            color = '#60a5fa';
            bgColor = 'rgba(96, 165, 250, 0.1)';
            formatValue = (v) => v;
            yAxisFormat = (v) => v;
            
            data.evolution.forEach(match => {
                labels.push(match.date);
                values.push(match.saves || 0);
                rivals.push(match.rival);
                extraInfo.push(`Gols rebuts: ${match.goalsConceded || 0}`);
            });
            break;
            
        case 'savePercentage':
            datasetLabel = '% Parades';
            color = '#c084fc';
            bgColor = 'rgba(192, 132, 252, 0.1)';
            formatValue = (v) => v.toFixed(1) + '%';
            yAxisFormat = (v) => v.toFixed(0) + '%';
            
            data.evolution.forEach(match => {
                const totalShots = (match.saves || 0) + (match.goalsConceded || 0);
                const savePercentage = totalShots > 0 ? ((match.saves || 0) / totalShots) * 100 : 0;
                labels.push(match.date);
                values.push(savePercentage);
                rivals.push(match.rival);
                extraInfo.push(`${match.saves || 0}/${totalShots} parades`);
            });
            break;
    }
    
    return {
        labels,
        values,
        rivals,
        extraInfo,
        datasetLabel,
        color,
        bgColor,
        formatValue,
        yAxisFormat
    };
}

// Funci√≥ per calcular la l√≠nia de tend√®ncia (regressi√≥ lineal simple)
function calculateTrendLine(values) {
    const n = values.length;
    if (n === 0) return [];
    
    let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
    
    for (let i = 0; i < n; i++) {
        sumX += i;
        sumY += values[i];
        sumXY += i * values[i];
        sumX2 += i * i;
    }
    
    const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
    const intercept = (sumY - slope * sumX) / n;
    
    const trendLine = [];
    for (let i = 0; i < n; i++) {
        trendLine.push(slope * i + intercept);
    }
    
    return trendLine;
}

console.log('‚úÖ Codi d\'evoluci√≥ temporal del jugador carregat correctament');
   
    // Esperar que el DOM es renderitzi abans de cridar les funcions
    setTimeout(() => {
        renderPlayerHeader(playerData);
        renderPlayerSummary(playerData);
        renderPlayerEvolutionChartImproved(playerData, 'mvp');
        renderPlayerGoalZones(playerData);
		renderPlayerFieldZones(playerData);
        renderPlayerVsTeamChart(playerData);
        renderHomeAwayChart(playerData);
        renderQuarterPerformanceChart(playerData);
        renderPlayerMatchHistory(playerData);
        initializeComparePlayersCheckboxes(selectedPlayer);
    }, 100);
}
}
function backToPlayerSelection() {
    // Mostrar la taula de selecci√≥
    document.querySelector('#individualTab .card').classList.remove('hidden');
    
    // Amagar els detalls
    document.getElementById('individualPlayerDetails').classList.add('hidden');
}

// Mostrar estad√≠stiques del jugador seleccionat
function showPlayerStats() {
    const select = document.getElementById('playerSelector');
    const value = select.value;
    
    if (!value) {
        document.getElementById('playerStatsContent').classList.add('hidden');
        document.getElementById('goalkeeperStatsContent').classList.add('hidden');
        return;
    }
    
    const [num, name] = value.split('|');
    selectedPlayer = { num: parseInt(num), name: name };
    
    // Calcular totes les dades del jugador
    const playerData = calculatePlayerFullStats(selectedPlayer);
    
    // ‚úÖ DETECTAR SI √âS PORTER (n√∫mero 1 o 13, o t√© parades)
    const isGoalkeeper = selectedPlayer.num === 1 || selectedPlayer.num === 13 || playerData.totalSaves > 0;
    
    if (isGoalkeeper) {
        // Mostrar estad√≠stiques de porter
        document.getElementById('playerStatsContent').classList.add('hidden');
        document.getElementById('goalkeeperStatsContent').classList.remove('hidden');
        
        renderGoalkeeperStats(playerData);
    } else {
        // Mostrar estad√≠stiques normals
        document.getElementById('playerStatsContent').classList.remove('hidden');
        document.getElementById('goalkeeperStatsContent').classList.add('hidden');
        
        renderPlayerHeader(playerData);
        renderPlayerSummary(playerData);
        renderPlayerEvolutionChartImproved(playerData, 'mvp');
        renderPlayerGoalZones(playerData);
        renderPlayerVsTeamChart(playerData);
        renderHomeAwayChart(playerData);
        renderQuarterPerformanceChart(playerData);
        renderPlayerMatchHistory(playerData);
        initializeComparePlayersCheckboxes(selectedPlayer);
    }
}

// Calcular estad√≠stiques completes del jugador
function calculatePlayerFullStats(player) {
    const data = {
        num: player.num,
        name: player.name,
        totalMatches: 0,
        totalMinutes: 0,
        totalGoals: 0,
        totalAssists: 0,
        totalExclusions: 0,
        totalSteals: 0,
        totalLosses: 0,
        totalSaves: 0,
        mvpCount: 0,  // ‚Üê Comptarem aqu√≠
        matchDetails: [],
        goalsByType: {},
        goalsByZone: {},
		goalsByFieldZone: {},
        goalsByQuarter: { q1: 0, q2: 0, q3: 0, q4: 0 },
        minutesByQuarter: { q1: 0, q2: 0, q3: 0, q4: 0 },
        homeStats: { matches: 0, goals: 0, minutes: 0 },
        awayStats: { matches: 0, goals: 0, minutes: 0 },
        evolution: []
    };
    
    allMatches.forEach(match => {
        const matchPlayer = match.jugadors?.find(j => 
            j.numero === player.num && j.nom.trim() === player.name
        );
        
        if (!matchPlayer) return;
        
        data.totalMatches++;
        
        const stats = matchPlayer.estadistiques || {};
        
        // ‚úÖ CALCULAR MVP: qui t√© la millor valoraci√≥ del partit?
        const playersWithValue = match.jugadors.map(j => {
            const valor = calculatePlayerValue({
                gols: j.estadistiques.gols,
                goalTypes: j.estadistiques.goalTypes,
                assistencies: j.estadistiques.assistencies,
                robatoris: j.estadistiques.robatoris,
                blocatges: j.estadistiques.blocks || 0,
                parades: j.estadistiques.parades,
				paradeTypes: j.estadistiques.paradeTypes || {},
                faltesRebudes: j.estadistiques.faltesRebudes || 0,
                exclusions: j.estadistiques.exclusions,
                exclusionTypes: j.estadistiques.exclusionTypes || { normal: 0, penalty: 0 },
                penaltyMissed: j.estadistiques.penaltyMissed,
                perdues: j.estadistiques.perdues,
                xutsFallats: j.estadistiques.xutsFallats,
                golsRebuts: j.estadistiques.golsRebuts || 0
            });
            return { numero: j.numero, nom: j.nom.trim(), valor };
        }).sort((a, b) => a.num - b.num);
        
        const mvp = playersWithValue[0];
        
        // ‚úÖ Comprovar si aquest jugador √©s l'MVP del partit
        if (mvp && mvp.numero === player.num && mvp.nom === player.name) {
            data.mvpCount++;
        }
        
        // Calcular minuts
        let minutes = 0;
        let minutesByQ = { q1: 0, q2: 0, q3: 0, q4: 0 };
        
        if (match.playerWaterChanges && match.playerWaterChanges.length > 0 && match.quarterStartTimes) {
            const playerTimes = calculateMatchPlayingTimes(match);
            const playerTimeData = playerTimes[player.num];
            
            if (playerTimeData) {
                minutes = Math.round(playerTimeData.totalTime / 60);
                minutesByQ.q1 = playerTimeData.q1;
                minutesByQ.q2 = playerTimeData.q2;
                minutesByQ.q3 = playerTimeData.q3;
                minutesByQ.q4 = playerTimeData.q4;
            }
        } else {
            minutes = matchPlayer.temps || 0;
        }
        
        data.totalMinutes += minutes;
        data.totalGoals += stats.gols || 0;
        data.totalAssists += stats.assistencies || 0;
        data.totalExclusions += stats.exclusions || 0;
        data.totalSteals += stats.robatoris || 0;
        data.totalLosses += stats.perdues || 0;
        data.totalSaves += stats.parades || 0;
        
        // Goals by type
        if (stats.goalTypes) {
            Object.keys(stats.goalTypes).forEach(type => {
                data.goalsByType[type] = (data.goalsByType[type] || 0) + (stats.goalTypes[type] || 0);
            });
        }
        
        // Goals by zone
        if (stats.goalZones) {
            Object.keys(stats.goalZones).forEach(zone => {
                data.goalsByZone[zone] = (data.goalsByZone[zone] || 0) + (stats.goalZones[zone] || 0);
            });
        }
        // Field zones (des d'on tira)
if (stats.fieldZones) {
    Object.keys(stats.fieldZones).forEach(zone => {
        data.goalsByFieldZone[zone] = (data.goalsByFieldZone[zone] || 0) + (stats.fieldZones[zone] || 0);
    });
}
        // Goals by quarter
        if (match.chronologicalActions) {
            match.chronologicalActions
                .filter(a => a.type === 'goal' && a.playerNum === player.num)
                .forEach(a => {
                    if (a.quarter) data.goalsByQuarter[a.quarter]++;
                });
        }
        
        // Minutes by quarter (en segons)
        data.minutesByQuarter.q1 += minutesByQ.q1;
        data.minutesByQuarter.q2 += minutesByQ.q2;
        data.minutesByQuarter.q3 += minutesByQ.q3;
        data.minutesByQuarter.q4 += minutesByQ.q4;
        
        // Home vs Away
        const isHome = match.matchLocation === 'casa';
        if (isHome) {
            data.homeStats.matches++;
            data.homeStats.goals += stats.gols || 0;
            data.homeStats.minutes += minutes;
        } else {
            data.awayStats.matches++;
            data.awayStats.goals += stats.gols || 0;
            data.awayStats.minutes += minutes;
        }
        
        // Evolution (per gr√†fic temporal) - VERSI√ì MILLORADA
        // Calcular MVP del jugador en aquest partit
        const playingTime = matchPlayer.temps?.total || (minutes * 60);
        const isGoalkeeperMatch = matchPlayer.numero === 1 || matchPlayer.numero === 13 || (stats.parades || 0) > 0;
        const conceded = isGoalkeeperMatch ? (matchPlayer.golsRebuts || stats.golsRebuts || 0) : 0;
        
        // Calcular MVP espec√≠fic d'aquest partit
        const matchMVP = calculatePlayerValue({
            gols: stats.gols || 0,
            goalTypes: stats.goalTypes || {},
            assistencies: stats.assistencies || 0,
            robatoris: stats.robatoris || 0,
            blocatges: stats.blocks || 0,
            parades: stats.parades || 0,
			paradeTypes: stats.paradeTypes || {},
            faltesRebudes: stats.faltesRebudes || 0,
            exclusions: stats.exclusions || 0,
            exclusionTypes: stats.exclusionTypes || { normal: 0, penalty: 0 },
            penaltyMissed: stats.penaltyMissed || 0,
            perdues: stats.perdues || 0,
            xutsFallats: stats.xutsFallats || 0,
            golsRebuts: conceded
        });
        
        data.evolution.push({
		dateRaw: match.data || '',
            date: match.data ? match.data.split('-').reverse().join('/') : (match.rival || `Partit ${data.totalMatches}`),
            rival: match.rivalTeam || match.rival || 'Desconegut',
            goals: stats.gols || 0,
            assists: stats.assistencies || 0,
            exclusions: stats.exclusions || 0,
            steals: stats.robatoris || 0,
            losses: stats.perdues || 0,
            blocks: stats.blocks || 0,  // ‚Üê AFEGIT
            foulsReceived: stats.faltesRebudes || 0,  // ‚Üê AFEGIT
            saves: stats.parades || 0,
            goalsConceded: conceded,
            missedShots: (stats.xutsFallats || 0) + (stats.penaltyMissed || 0),
            minutes: minutes,
            mvp: matchMVP
        });

        
        // Match details (per taula)
        const isMVP = mvp && mvp.numero === player.num && mvp.nom === player.name;
        
        data.matchDetails.push({
            date: match.data || '',
            rival: match.rivalTeam || match.rival || 'Desconocido',
            location: (match.matchLocation === 'home' || match.matchLocation === 'casa' || match.homeAway === 'casa') ? 'üè†' : '‚úàÔ∏è',
            minutes: minutes,
            goals: stats.gols || 0,
            assists: stats.assistencies || 0,
            exclusions: stats.exclusions || 0,
            steals: stats.robatoris || 0,
            saves: stats.parades || 0,
            blocks: stats.blocks || 0,
            turnovers: stats.perdues || 0,
            shotsMissed: stats.xutsFallats || 0,
            infraccions2m: stats.infraccions2m || 0,
            contrafaltes: stats.contrafaltes || 0,
            foulsReceived: stats.faltesRebudes || 0,
            penaltyMissed: stats.penaltyMissed || 0,
            mvp: isMVP ? '‚≠ê' : ''
        });
    });
    
    // Ordenar evoluci√≥ per data
    data.evolution.sort((a, b) => {
    const dateA = parseSpanishDate(a.dateRaw);  // CANVIAR date ‚Üí dateRaw
    const dateB = parseSpanishDate(b.dateRaw);  // CANVIAR date ‚Üí dateRaw
    return dateA - dateB;
});
    console.log('üîç DEBUG: Dades evolution', data.evolution);
    return data;
}
// Funci√≥ auxiliar per formatar segons a format mm:ss
function formatTimeFromSeconds(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}
// Renderitzar cap√ßalera del jugador
function renderPlayerHeader(data) {
    const header = document.getElementById('playerHeader');
    header.innerHTML = `
        <div class="player-number-big">${data.num}</div>
        <h3 style="font-size: 24px; margin-bottom: 10px;">${data.name}</h3>
        <p style="font-size: 16px; color: #bae6fd; margin-top: 10px;">
            ${data.totalMatches} partits jugats | ${data.totalMinutes} minuts totals
        </p>
    `;
}

// Renderitzar resum estad√≠stic
function renderPlayerSummary(data) {
    const grid = document.getElementById('playerSummaryGrid');
    
    const avgGoals = (data.totalGoals / data.totalMatches).toFixed(2);
    const avgMinutes = (data.totalMinutes / data.totalMatches).toFixed(1);
    const avgAssists = (data.totalAssists / data.totalMatches).toFixed(2);
    const avgExclusions = (data.totalExclusions / data.totalMatches).toFixed(2);
    
    grid.innerHTML = `
        <div class="stat-card">
            <div class="stat-value">${data.totalGoals}</div>
            <div class="stat-label">Gols Totals</div>
            <div class="stat-sublabel">${avgGoals} per partit</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${data.totalMinutes}'</div>
            <div class="stat-label">Minuts Totals</div>
            <div class="stat-sublabel">${avgMinutes}' per partit</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${avgGoals}</div>
            <div class="stat-label">Mitjana Gols</div>
            <div class="stat-sublabel">per partit</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${data.totalAssists}</div>
            <div class="stat-label">Assist√®ncies</div>
            <div class="stat-sublabel">${avgAssists} per partit</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${data.totalExclusions}</div>
            <div class="stat-label">Exclusions</div>
            <div class="stat-sublabel">${avgExclusions} per partit</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${data.totalSteals}</div>
            <div class="stat-label">Robatoris</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${data.mvpCount}</div>
            <div class="stat-label">MVP</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${data.totalSaves}</div>
            <div class="stat-label">Parades</div>
        </div>
    `;
}

// Gr√†fic d'evoluci√≥ temporal
function renderPlayerEvolutionChart(data) {
    const ctx = document.getElementById('playerEvolutionChart');
    
    if (window.playerEvolutionChartInstance) {
        window.playerEvolutionChartInstance.destroy();
    }
    
    window.playerEvolutionChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.evolution.map(e => e.date),
            datasets: [
                {
                    label: 'Gols',
                    data: data.evolution.map(e => e.goals),
                    borderColor: '#22d3ee',
                    backgroundColor: 'rgba(34, 211, 238, 0.1)',
                    tension: 0.3,
                    yAxisID: 'y'
                },
                {
                    label: 'Minuts',
                    data: data.evolution.map(e => e.minutes),
                    borderColor: '#fbbf24',
                    backgroundColor: 'rgba(251, 191, 36, 0.1)',
                    tension: 0.3,
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: { labels: { color: 'white' } },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return data.evolution[context[0].dataIndex].rival;
                        }
                    }
                }
            },
            scales: {
                x: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                y: {
                    type: 'linear',
                    position: 'left',
                    title: { display: true, text: 'Gols', color: 'white' },
                    ticks: { color: 'white' },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                },
                y1: {
                    type: 'linear',
                    position: 'right',
                    title: { display: true, text: 'Minuts', color: 'white' },
                    ticks: { color: 'white' },
                    grid: { display: false }
                }
            }
        }
    });
}

// Mapa de zones de gol
function renderPlayerGoalZones(data) {
    const container = document.getElementById('playerGoalZonesHeatmap');
    
    const zones = [
        ['top-left', 'top-center', 'top-right'],
        ['mid-left', 'mid-center', 'mid-right'],
        ['bottom-left', 'bottom-center', 'bottom-right']
    ];
    
    const zoneLabels = {
        'top-left': 'Superior Esq.',
        'top-center': 'Superior Centre',
        'top-right': 'Superior Dret',
        'mid-left': 'Mig Esq.',
        'mid-center': 'Mig Centre',
        'mid-right': 'Mig Dret',
        'bottom-left': 'Inferior Esq.',
        'bottom-center': 'Inferior Centre',
        'bottom-right': 'Inferior Dret'
    };
    
    const maxGoals = Math.max(...Object.values(data.goalsByZone), 1);
    
    let html = '<div class="zone-heatmap-container">';
    
    zones.forEach(row => {
        row.forEach(zone => {
            const count = data.goalsByZone[zone] || 0;
            const intensity = count / maxGoals;
            const bgColor = `rgba(34, 197, 94, ${intensity})`;
            
            html += `
                <div class="zone-cell" style="background: ${bgColor};">
                    <div class="zone-label">${zoneLabels[zone]}</div>
                    <div class="zone-count">${count}</div>
                </div>
            `;
        });
    });
    
    html += '</div>';
    container.innerHTML = html;
}
// Mapa de zones de tir (piscina)
function renderPlayerFieldZones(data) {
    console.log('üèä renderPlayerFieldZones cridat');
    console.log('üìä goalsByFieldZone:', data.goalsByFieldZone);
    
    const container = document.getElementById('playerFieldZonesHeatmap');
    console.log('üì¶ Container:', container);
    
    if (!container) {
        console.error('‚ùå No es troba el container playerFieldZonesHeatmap');
        return;
    }
    
    // Si no hi ha dades
    if (!data.goalsByFieldZone || Object.keys(data.goalsByFieldZone).length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #9ca3af;">No hi ha dades de zones de tir</p>';
        return;
    }
    
    const zones = [
        ['2m-left', '2m-center', '2m-right'],
        ['5m-left', '5m-center', '5m-right'],
        ['+6m-left', '+6m-center', '+6m-right']
    ];
    
    const zoneLabels = {
        '2m-left': '2m Esq.',
        '2m-center': '2m Centre',
        '2m-right': '2m Dret',
        '5m-left': '5m Esq.',
        '5m-center': '5m Centre',
        '5m-right': '5m Dret',
        '+6m-left': '+6m Esq.',
        '+6m-center': '+6m Centre',
        '+6m-right': '+6m Dret'
    };
    
    const maxGoals = Math.max(...Object.values(data.goalsByFieldZone), 1);
    
    let html = `
        <div style="text-align: center; margin-bottom: 10px; font-size: 12px; color: #67e8f9;">ü•Ö PORTERIA ü•Ö</div>
        <div class="zone-heatmap-container">
    `;
    
    zones.forEach(row => {
        row.forEach(zone => {
            const count = data.goalsByFieldZone[zone] || 0;
            const intensity = count / maxGoals;
            const bgColor = `rgba(59, 130, 246, ${intensity})`; // Blau per diferenciar
            
            html += `
                <div class="zone-cell" style="background: ${bgColor};">
                    <div class="zone-label">${zoneLabels[zone] || zone}</div>
                    <div class="zone-count">${count}</div>
                </div>
            `;
        });
    });
    
    html += '</div>';
    html += '<div style="text-align: center; margin-top: 10px; font-size: 12px; color: #67e8f9;">üèä PISCINA üèä</div>';
    
    container.innerHTML = html;
}
// Comparativa jugador vs mitjana equip
function renderPlayerVsTeamChart(data) {
    const ctx = document.getElementById('playerVsTeamChart');
    
    // Calcular mitjanes de l'equip
    const teamAvg = calculateTeamAverages();
    
    const playerAvg = {
        goalsPerMatch: data.totalGoals / data.totalMatches,
        assistsPerMatch: data.totalAssists / data.totalMatches,
        exclusionsPerMatch: data.totalExclusions / data.totalMatches,
        minutesPerMatch: data.totalMinutes / data.totalMatches
    };
    
    if (window.playerVsTeamChartInstance) {
        window.playerVsTeamChartInstance.destroy();
    }
    
    window.playerVsTeamChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Gols/Partit', 'Assist./Partit', 'Excl./Partit', 'Min/Partit'],
            datasets: [
                {
                    label: data.name,
                    data: [
                        playerAvg.goalsPerMatch,
                        playerAvg.assistsPerMatch,
                        playerAvg.exclusionsPerMatch,
                        playerAvg.minutesPerMatch
                    ],
                    backgroundColor: '#22d3ee'
                },
                {
                    label: 'Mitjana Equip',
                    data: [
                        teamAvg.goalsPerMatch,
                        teamAvg.assistsPerMatch,
                        teamAvg.exclusionsPerMatch,
                        teamAvg.minutesPerMatch
                    ],
                    backgroundColor: '#fbbf24'
                }
            ]
        },
        options: {
            responsive: true,
            plugins: { legend: { labels: { color: 'white' } } },
            scales: {
                x: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                y: { 
                    ticks: { color: 'white' }, 
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    title: { display: true, text: 'Mitjana', color: 'white' }
                }
            }
        }
    });
}

// Calcular mitjanes de tot l'equip
function calculateTeamAverages() {
    let totalGoals = 0, totalAssists = 0, totalExclusions = 0, totalMinutes = 0, totalPlayers = 0;
    
    allMatches.forEach(match => {
        match.jugadors?.forEach(j => {
            if (!j.numero) return;
            const stats = j.estadistiques || {};
            totalGoals += stats.gols || 0;
            totalAssists += stats.assistencies || 0;
            totalExclusions += stats.exclusions || 0;
            totalMinutes += j.temps || 0;
            totalPlayers++;
        });
    });
    
    return {
        goalsPerMatch: totalGoals / totalPlayers,
        assistsPerMatch: totalAssists / totalPlayers,
        exclusionsPerMatch: totalExclusions / totalPlayers,
        minutesPerMatch: totalMinutes / totalPlayers
    };
}

// Rendiment casa vs fora
function renderHomeAwayChart(data) {
    const ctx = document.getElementById('homeAwayChart');
    
    const homeAvg = data.homeStats.matches > 0 ? data.homeStats.goals / data.homeStats.matches : 0;
    const awayAvg = data.awayStats.matches > 0 ? data.awayStats.goals / data.awayStats.matches : 0;
    const homeMinAvg = data.homeStats.matches > 0 ? data.homeStats.minutes / data.homeStats.matches : 0;
    const awayMinAvg = data.awayStats.matches > 0 ? data.awayStats.minutes / data.awayStats.matches : 0;
    
    if (window.homeAwayChartInstance) {
        window.homeAwayChartInstance.destroy();
    }
    
    window.homeAwayChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Partits', 'Gols/Partit', 'Minuts/Partit'],
            datasets: [
                {
                    label: 'üè† Casa',
                    data: [data.homeStats.matches, homeAvg, homeMinAvg],
                    backgroundColor: '#22c55e'
                },
                {
                    label: '‚úàÔ∏è Fora',
                    data: [data.awayStats.matches, awayAvg, awayMinAvg],
                    backgroundColor: '#3b82f6'
                }
            ]
        },
        options: {
            responsive: true,
            plugins: { legend: { labels: { color: 'white' } } },
            scales: {
                x: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                y: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } }
            }
        }
    });
}

// Rendiment per quarter
function renderQuarterPerformanceChart(data) {
    const ctx = document.getElementById('quarterPerformanceChart');
    
    // Convertir segons a minuts per mostrar
    const minutesPerQuarter = {
        q1: (data.minutesByQuarter.q1 / 60).toFixed(1),
        q2: (data.minutesByQuarter.q2 / 60).toFixed(1),
        q3: (data.minutesByQuarter.q3 / 60).toFixed(1),
        q4: (data.minutesByQuarter.q4 / 60).toFixed(1)
    };
    
    const avgGoals = ['q1', 'q2', 'q3', 'q4'].map(q => {
        const mins = data.minutesByQuarter[q] / 60;
        const goals = data.goalsByQuarter[q];
        return mins > 0 ? (goals / mins * 60).toFixed(2) : 0;
    });
    
    if (window.quarterPerformanceChartInstance) {
        window.quarterPerformanceChartInstance.destroy();
    }
    
    window.quarterPerformanceChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['1r Quarter', '2n Quarter', '3r Quarter', '4t Quarter'],
            datasets: [
                {
                    label: 'Minuts Jugats',
                    data: [minutesPerQuarter.q1, minutesPerQuarter.q2, minutesPerQuarter.q3, minutesPerQuarter.q4],
                    backgroundColor: '#8b5cf6',
                    yAxisID: 'y'
                },
                {
                    label: 'Gols',
                    data: [data.goalsByQuarter.q1, data.goalsByQuarter.q2, data.goalsByQuarter.q3, data.goalsByQuarter.q4],
                    backgroundColor: '#22d3ee',
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            plugins: { legend: { labels: { color: 'white' } } },
            scales: {
                x: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                y: {
                    type: 'linear',
                    position: 'left',
                    title: { display: true, text: 'Minuts', color: 'white' },
                    ticks: { color: 'white' },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                },
                y1: {
                    type: 'linear',
                    position: 'right',
                    title: { display: true, text: 'Gols', color: 'white' },
                    ticks: { color: 'white' },
                    grid: { display: false }
                }
            }
        }
    });
}

// Taula hist√≤ric de partits
function renderPlayerMatchHistory(data) {
    const table = document.getElementById('playerMatchHistoryTable');
    
    // Ordenar per data (m√©s recent primer)
    const sortedMatches = [...data.matchDetails].sort((a, b) => {
        const dateA = parseSpanishDate(a.date);
        const dateB = parseSpanishDate(b.date);
        return dateB - dateA;
    });
    
    // Calcular totals
    const totals = {
        goals: 0,
        assists: 0,
        exclusions: 0,
        steals: 0,
        saves: 0,
        blocks: 0,
        turnovers: 0,
        shotsMissed: 0,
        infraccions2m: 0,
        contrafaltes: 0,
        foulsReceived: 0,
        penaltyMissed: 0,
        mvpCount: 0
    };
    
    sortedMatches.forEach(m => {
        totals.goals += m.goals;
        totals.assists += m.assists;
        totals.exclusions += m.exclusions;
        totals.steals += m.steals;
        totals.saves += m.saves;
        totals.blocks += m.blocks;
        totals.turnovers += m.turnovers;
        totals.shotsMissed += m.shotsMissed;
        totals.infraccions2m += m.infraccions2m;
        totals.contrafaltes += m.contrafaltes;
        totals.foulsReceived += m.foulsReceived;
        totals.penaltyMissed += m.penaltyMissed;
        if (m.mvp === '‚≠ê') totals.mvpCount++;
    });
    
    table.innerHTML = `
        <thead>
            <tr>
                <th>Data</th>
                <th>Rival</th>
                <th>Lloc</th>
                <th>Min</th>
                <th style="background: rgba(34, 197, 94, 0.2);" title="Accions Positives" colspan="6">‚úÖ POSITIVES</th>
                <th style="background: rgba(239, 68, 68, 0.2);" title="Accions Negatives" colspan="6">‚ùå NEGATIVES</th>
                <th>MVP</th>
            </tr>
            <tr style="font-size: 11px;">
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th title="Gols">‚öΩ G</th>
                <th title="Assist√®ncies">üéØ A</th>
                <th title="Robatoris">üõ°Ô∏è R</th>
                <th title="Parades">üß§ P</th>
                <th title="Blocks">üö´ B</th>
                <th title="Faltes Rebudes">‚ö†Ô∏è FR</th>
                <th title="Exclusions">üü• E</th>
                <th title="P√®rdues">‚ùå P√®r</th>
                <th title="Xuts Fallats">üéØ‚ùå XF</th>
                <th title="Infraccions 2m">üìè 2m</th>
                <th title="Contrafaltes">‚ö†Ô∏è CF</th>
                <th title="Penalties Fallats">PenF</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            ${sortedMatches.map(m => `
                <tr>
                    <td>${m.date}</td>
                    <td>${m.rival}</td>
                    <td style="text-align: center;">${m.location}</td>
                    <td>${m.minutes}'</td>
                    <td style="font-weight: bold; color: #22d3ee;">${m.goals}</td>
                    <td style="color: #22c55e;">${m.assists}</td>
                    <td style="color: #06b6d4;">${m.steals}</td>
                    <td style="color: #8b5cf6;">${m.saves}</td>
                    <td style="color: #a78bfa;">${m.blocks}</td>
                    <td style="color: #fbbf24;">${m.foulsReceived}</td>
                    <td style="color: #ef4444;">${m.exclusions}</td>
                    <td style="color: #fca5a5;">${m.turnovers}</td>
                    <td style="color: #f97316;">${m.shotsMissed}</td>
                    <td style="color: #fb923c;">${m.infraccions2m}</td>
                    <td style="color: #fbbf24;">${m.contrafaltes}</td>
                    <td style="color: ${m.penaltyMissed > 0 ? '#ef4444' : '#22c55e'};">${m.penaltyMissed}</td>
                    <td style="text-align: center;">${m.mvp}</td>
                </tr>
            `).join('')}
        </tbody>
        <tfoot>
            <tr style="font-weight: bold; background: rgba(34, 211, 238, 0.2);">
                <td colspan="3">TOTALS</td>
                <td>${data.totalMinutes}'</td>
                <td style="color: #22d3ee;">${totals.goals}</td>
                <td style="color: #22c55e;">${totals.assists}</td>
                <td style="color: #06b6d4;">${totals.steals}</td>
                <td style="color: #8b5cf6;">${totals.saves}</td>
                <td style="color: #a78bfa;">${totals.blocks}</td>
                <td style="color: #fbbf24;">${totals.foulsReceived}</td>
                <td style="color: #ef4444;">${totals.exclusions}</td>
                <td style="color: #fca5a5;">${totals.turnovers}</td>
                <td style="color: #f97316;">${totals.shotsMissed}</td>
                <td style="color: #fb923c;">${totals.infraccions2m}</td>
                <td style="color: #fbbf24;">${totals.contrafaltes}</td>
                <td style="color: ${totals.penaltyMissed > 0 ? '#ef4444' : '#22c55e'};">${totals.penaltyMissed}</td>
                <td style="text-align: center;">${totals.mvpCount} ‚≠ê</td>
            </tr>
        </tfoot>
    `;
}

// Inicialitzar checkboxes per comparar jugadors
function initializeComparePlayersCheckboxes(currentPlayer) {
    const container = document.getElementById('comparePlayersCheckboxes');
    const playerSet = new Set();
    
    allMatches.forEach(match => {
        match.jugadors?.forEach(j => {
            if (j.numero && !(j.numero === currentPlayer.num && j.nom.trim() === currentPlayer.name)) {
                playerSet.add(JSON.stringify({ num: j.numero, name: j.nom.trim() }));
            }
        });
    });
    
    const players = Array.from(playerSet)
        .map(p => JSON.parse(p))
        .sort((a, b) => a.num - b.num);
    
    container.innerHTML = players.map(p => `
        <label>
            <input type="checkbox" value="${p.num}|${p.name}" class="compare-player-checkbox">
            ${p.num}. ${p.name}
        </label>
    `).join('');
}

// Comparar jugadors seleccionats
function compareSelectedPlayers() {
    const checkboxes = document.querySelectorAll('.compare-player-checkbox:checked');
    
    if (checkboxes.length === 0) {
        alert('Selecciona almenys un jugador per comparar');
        return;
    }
    
    if (checkboxes.length > 4) {
        alert('M√†xim 4 jugadors per comparar (a m√©s del jugador principal)');
        return;
    }
    
    const playersToCompare = [selectedPlayer];
    
    checkboxes.forEach(cb => {
        const [num, name] = cb.value.split('|');
        playersToCompare.push({ num: parseInt(num), name: name });
    });
    
    renderMultiPlayerComparison(playersToCompare);
    document.getElementById('multiPlayerComparisonContent').classList.remove('hidden');
}

// Gr√†fic comparatiu multi-jugador
function renderMultiPlayerComparison(players) {
    const ctx = document.getElementById('multiPlayerComparisonChart');
    
    const datasets = players.map((player, idx) => {
        const data = calculatePlayerFullStats(player);
        const colors = ['#22d3ee', '#fbbf24', '#22c55e', '#8b5cf6', '#ef4444'];
        
        return {
            label: `${player.num}. ${player.name}`,
            data: [
                (data.totalGoals / data.totalMatches).toFixed(2),
                (data.totalAssists / data.totalMatches).toFixed(2),
                (data.totalMinutes / data.totalMatches).toFixed(1),
                (data.totalExclusions / data.totalMatches).toFixed(2)
            ],
            backgroundColor: colors[idx % colors.length]
        };
    });
    
    if (window.multiPlayerComparisonChartInstance) {
        window.multiPlayerComparisonChartInstance.destroy();
    }
    
    window.multiPlayerComparisonChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Gols/Partit', 'Assist./Partit', 'Min/Partit', 'Excl./Partit'],
            datasets: datasets
        },
        options: {
            responsive: true,
            plugins: { legend: { labels: { color: 'white' } } },
            scales: {
                x: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                y: { 
                    ticks: { color: 'white' }, 
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    title: { display: true, text: 'Mitjana per Partit', color: 'white' }
                }
            }
        }
    });
}
// ============================================
// FUNCIONS ESPEC√çFIQUES PER PORTERS
// ============================================

function calculateGoalkeeperStats(player) {
    const data = {
        num: player.num,
        name: player.name,
        totalMatches: 0,
        totalMinutes: 0,
        totalSaves: 0,
        totalGoalsAgainst: 0,
        savesByType: { corner: 0, rebuig: 0, atrapa: 0, penal: 0 },
        savesByZone: {},
        goalZonesAgainst: {},  // ‚úÖ ZONES DELS GOLS REBUTS
        savesByRival: {},
        evolution: [],
        penalties: { faced: 0, saved: 0 }
    };
    
    allMatches.forEach(match => {
        const matchPlayer = match.jugadors?.find(j => 
            j.numero === player.num && j.nom.trim() === player.name
        );
        
        if (!matchPlayer) return;
        
        data.totalMatches++;
        
        const stats = matchPlayer.estadistiques || {};
        
        // Calcular minuts
        let minutes = 0;
        if (match.playerWaterChanges && match.playerWaterChanges.length > 0 && match.quarterStartTimes) {
            const playerTimes = calculateMatchPlayingTimes(match);
            const playerTimeData = playerTimes[player.num];
            if (playerTimeData) {
                minutes = Math.round(playerTimeData.totalTime / 60);
            }
        } else {
            minutes = matchPlayer.temps || 0;
        }
        
        data.totalMinutes += minutes;
        data.totalSaves += stats.parades || 0;
        
        // ‚úÖ ZONES DELS GOLS REBUTS (des de golsRebutsZones)
        if (stats.golsRebutsZones) {
            Object.keys(stats.golsRebutsZones).forEach(zone => {
                data.goalZonesAgainst[zone] = (data.goalZonesAgainst[zone] || 0) + (stats.golsRebutsZones[zone] || 0);
            });
        }
        
        // Gols encaixats
        const golsRebuts = stats.golsRebuts || 0;
        data.totalGoalsAgainst += golsRebuts;
        
         // Parades per tipus
        if (stats.paradeTypes) {
            Object.keys(stats.paradeTypes).forEach(type => {
                data.savesByType[type] = (data.savesByType[type] || 0) + (stats.paradeTypes[type] || 0);
            });
        }
        
        // ‚úÖ Penalties parats d'AQUEST partit
        data.penalties.saved += (stats.paradeTypes?.penal || 0);
        
        // Calcular penalties afrontats des de chronologicalActions
        if (match.chronologicalActions) {
            const penaltiesAgainst = match.chronologicalActions.filter(a => 
                a.type === 'goal' && 
                a.team === 'rival' && 
                a.goalType === 'penalty' &&
                a.goalkeeperNum === player.num
            ).length;
            data.penalties.faced += penaltiesAgainst;
        }
        
        // Per rival
        const rivalName = match.rivalTeam || match.rival || 'Desconocido';
        if (!data.savesByRival[rivalName]) {
            data.savesByRival[rivalName] = { 
                matches: 0, 
                saves: 0, 
                goalsAgainst: 0,
                minutes: 0
            };
        }
        data.savesByRival[rivalName].matches++;
        data.savesByRival[rivalName].saves += stats.parades || 0;
        data.savesByRival[rivalName].goalsAgainst += golsRebuts;
        data.savesByRival[rivalName].minutes += minutes;
        
        // Evoluci√≥ temporal
        const totalShots = (stats.parades || 0) + golsRebuts;
        const savePercentage = totalShots > 0 ? ((stats.parades || 0) / totalShots * 100).toFixed(1) : 0;
        
        data.evolution.push({
            date: match.data || match.rival || `Partit ${data.totalMatches}`,
            rival: rivalName,
            saves: stats.parades || 0,
            goalsAgainst: golsRebuts,
            savePercentage: savePercentage,
            minutes: minutes
        });
    });
    
    // Ordenar evoluci√≥ per data
    data.evolution.sort((a, b) => {
        const dateA = parseSpanishDate(a.date);
        const dateB = parseSpanishDate(b.date);
        return dateA - dateB;
    });
    
    return data;
}
function renderGoalkeeperStats(playerData) {
    const gkData = calculateGoalkeeperStats(selectedPlayer);
    
    renderGoalkeeperSummary(gkData);
    renderGoalkeeperSavePercentageChart(gkData);
    renderGoalkeeperSaveTypeChart(gkData);
    renderGoalkeeperZonesHeatmap(gkData);
    renderGoalkeeperByRivalTable(gkData);
    renderGoalkeeperEvolutionChart(gkData);
    renderGoalkeeperComparisonChart(gkData);
    renderGoalkeeperPenalties(gkData);
}

function renderGoalkeeperSummary(data) {
    const grid = document.getElementById('goalkeeperSummaryGrid');
    
    const totalShots = data.totalSaves + data.totalGoalsAgainst;
    const savePercentage = totalShots > 0 ? ((data.totalSaves / totalShots) * 100).toFixed(1) : 0;
    const savesPerMatch = (data.totalSaves / data.totalMatches).toFixed(1);
    const goalsPerMatch = (data.totalGoalsAgainst / data.totalMatches).toFixed(1);
    const avgMinutes = (data.totalMinutes / data.totalMatches).toFixed(1);
    
    grid.innerHTML = `
        <div class="stat-card">
            <div class="stat-value" style="color: #22c55e;">${savePercentage}%</div>
            <div class="stat-label">% Parades</div>
            <div class="stat-sublabel">${data.totalSaves}/${totalShots} tirs</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${data.totalSaves}</div>
            <div class="stat-label">Parades Totals</div>
            <div class="stat-sublabel">${savesPerMatch} per partit</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${data.totalGoalsAgainst}</div>
            <div class="stat-label">Gols Encaixats</div>
            <div class="stat-sublabel">${goalsPerMatch} per partit</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${data.totalMatches}</div>
            <div class="stat-label">Partits Jugats</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${avgMinutes}'</div>
            <div class="stat-label">Min/Partit</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${data.totalMinutes}'</div>
            <div class="stat-label">Minuts Totals</div>
        </div>
    `;
}

function renderGoalkeeperSavePercentageChart(data) {
    const ctx = document.getElementById('goalkeeperSavePercentageChart');
    
    const totalShots = data.totalSaves + data.totalGoalsAgainst;
    const savePercentage = totalShots > 0 ? ((data.totalSaves / totalShots) * 100).toFixed(1) : 0;
    const goalPercentage = (100 - savePercentage).toFixed(1);
    
    if (window.goalkeeperSavePercentageChartInstance) {
        window.goalkeeperSavePercentageChartInstance.destroy();
    }
    
    window.goalkeeperSavePercentageChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Parades', 'Gols Encaixats'],
            datasets: [{
                data: [data.totalSaves, data.totalGoalsAgainst],
                backgroundColor: ['#22c55e', '#ef4444']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,  // ‚úÖ AFEGIR AQUESTA L√çNIA
            aspectRatio: 2,  // ‚úÖ AFEGIR: controla la relaci√≥ ample/alt (2 = m√©s ample que alt)
            plugins: {
                legend: { 
                    labels: { color: 'white', font: { size: 14 } },
                    position: 'bottom'  // ‚úÖ Posar llegenda a baix
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed;
                            const total = data.totalSaves + data.totalGoalsAgainst;
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

function renderGoalkeeperSaveTypeChart(data) {
    const ctx = document.getElementById('goalkeeperSaveTypeChart');
    
    const types = Object.keys(data.savesByType);
    const values = Object.values(data.savesByType);
    
    const labels = {
        corner: 'üéØ C√≥rner',
        rebuig: 'üëä Rebuig',
        atrapa: 'ü§≤ Atrapa',
        penal: 'üéØ Penalty'
    };
    
    if (window.goalkeeperSaveTypeChartInstance) {
        window.goalkeeperSaveTypeChartInstance.destroy();
    }
    
    window.goalkeeperSaveTypeChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: types.map(t => labels[t] || t),
            datasets: [{
                label: 'Parades',
                data: values,
                backgroundColor: ['#3b82f6', '#8b5cf6', '#22c55e', '#fbbf24']
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
                x: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                y: { 
                    ticks: { color: 'white', stepSize: 1 }, 
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    beginAtZero: true
                }
            }
        }
    });
}

function renderGoalkeeperZonesHeatmap(data) {
    const container = document.getElementById('goalkeeperZonesHeatmap');
    
    // Si no hi ha dades de zones, mostrar missatge
    if (Object.keys(data.goalZonesAgainst).length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #bae6fd;">
                <p style="font-size: 16px; margin-bottom: 10px;">‚ÑπÔ∏è No hi ha dades de zones de gols rebuts</p>
                <p style="font-size: 12px;">Aquesta funcionalitat registra les zones on el porter ha encaixat gols</p>
            </div>
        `;
        return;
    }
    
    const zones = [
        ['top-left', 'top-center', 'top-right'],
        ['mid-left', 'mid-center', 'mid-right'],
        ['bottom-left', 'bottom-center', 'bottom-right']
    ];
    
    const zoneLabels = {
        'top-left': 'Sup. Esq.',
        'top-center': 'Sup. Centre',
        'top-right': 'Sup. Dret',
        'mid-left': 'Mig Esq.',
        'mid-center': 'Mig Centre',
        'mid-right': 'Mig Dret',
        'bottom-left': 'Inf. Esq.',
        'bottom-center': 'Inf. Centre',
        'bottom-right': 'Inf. Dret'
    };
    
    const maxGoals = Math.max(...Object.values(data.goalZonesAgainst), 1);
    
    let html = '<div class="zone-heatmap-container">';
    
    zones.forEach(row => {
        row.forEach(zone => {
            const count = data.goalZonesAgainst[zone] || 0;
            const intensity = count / maxGoals;
            // ‚úÖ Vermell per gols rebuts (m√©s intens = m√©s gols)
            const bgColor = `rgba(239, 68, 68, ${intensity})`;
            
            html += `
                <div class="zone-cell" style="background: ${bgColor};">
                    <div class="zone-label">${zoneLabels[zone]}</div>
                    <div class="zone-count">${count}</div>
                </div>
            `;
        });
    });
    
    html += '</div>';
    
    // ‚úÖ Afegir llegenda
    html += `
        <div style="margin-top: 20px; text-align: center;">
            <p style="font-size: 14px; color: #bae6fd; margin-bottom: 10px;">
                üéØ Mapa de Calor: Zones on ha encaixat m√©s gols
            </p>
            <div style="display: flex; justify-content: center; gap: 20px; font-size: 12px;">
                <div><span style="color: rgba(239, 68, 68, 0.3);">‚¨§</span> Pocs gols</div>
                <div><span style="color: rgba(239, 68, 68, 1);">‚¨§</span> Molts gols</div>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
}
function renderGoalkeeperByRivalTable(data) {
    const table = document.getElementById('goalkeeperByRivalTable');
    
    const rivals = Object.entries(data.savesByRival)
        .map(([name, stats]) => {
            const totalShots = stats.saves + stats.goalsAgainst;
            const savePercentage = totalShots > 0 ? ((stats.saves / totalShots) * 100).toFixed(1) : 0;
            return { name, ...stats, savePercentage };
        })
        .sort((a, b) => b.savePercentage - a.savePercentage);
    
    table.innerHTML = `
        <thead>
            <tr>
                <th>Rival</th>
                <th>Partits</th>
                <th>Parades</th>
                <th>Gols Enc.</th>
                <th>% Parades</th>
                <th>Min</th>
            </tr>
        </thead>
        <tbody>
            ${rivals.map(r => {
                const color = r.savePercentage >= 50 ? '#22c55e' : r.savePercentage >= 30 ? '#fbbf24' : '#ef4444';
                return `
                    <tr>
                        <td><strong>${r.name}</strong></td>
                        <td>${r.matches}</td>
                        <td>${r.saves}</td>
                        <td>${r.goalsAgainst}</td>
                        <td style="font-weight: bold; color: ${color};">${r.savePercentage}%</td>
                        <td>${r.minutes}'</td>
                    </tr>
                `;
            }).join('')}
        </tbody>
    `;
}

function renderGoalkeeperEvolutionChart(data) {
    const ctx = document.getElementById('goalkeeperEvolutionChart');
    
    if (window.goalkeeperEvolutionChartInstance) {
        window.goalkeeperEvolutionChartInstance.destroy();
    }
    
    window.goalkeeperEvolutionChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.evolution.map(e => e.date),
            datasets: [
                {
                    label: '% Parades',
                    data: data.evolution.map(e => e.savePercentage),
                    borderColor: '#22c55e',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    tension: 0.3,
                    fill: true
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { labels: { color: 'white' } },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            const idx = context[0].dataIndex;
                            return data.evolution[idx].rival;
                        },
                        afterLabel: function(context) {
                            const idx = context.dataIndex;
                            const ev = data.evolution[idx];
                            return `Parades: ${ev.saves} | Gols: ${ev.goalsAgainst}`;
                        }
                    }
                }
            },
            scales: {
                x: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                y: { 
                    ticks: { 
                        color: 'white',
                        callback: function(value) {
                            return value + '%';
                        }
                    }, 
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    min: 0,
                    max: 100
                }
            }
        }
    });
}

function renderGoalkeeperComparisonChart(gkData) {
    const ctx = document.getElementById('goalkeeperComparisonChart');
    
    // Trobar tots els porters
    const allGoalkeepers = [];
    const goalkeeperStats = {};
    
    allMatches.forEach(match => {
        match.jugadors?.forEach(j => {
            if ((j.numero === 1 || j.numero === 13) && j.estadistiques?.parades > 0) {
                const key = `${j.numero}|${j.nom.trim()}`;
                if (!goalkeeperStats[key]) {
                    goalkeeperStats[key] = {
                        num: j.numero,
                        name: j.nom.trim(),
                        totalSaves: 0,
                        totalGoalsAgainst: 0,
                        matches: 0
                    };
                }
                goalkeeperStats[key].totalSaves += j.estadistiques.parades || 0;
                
                const rivalScore = match.periodScores ? 
                    (match.periodScores.q1?.rival || 0) + 
                    (match.periodScores.q2?.rival || 0) + 
                    (match.periodScores.q3?.rival || 0) + 
                    (match.periodScores.q4?.rival || 0) : 0;
                
                goalkeeperStats[key].totalGoalsAgainst += rivalScore;
                goalkeeperStats[key].matches++;
            }
        });
    });
    
    const goalkeepers = Object.values(goalkeeperStats);
    
    if (goalkeepers.length <= 1) {
        ctx.parentElement.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #bae6fd;">
                <p>‚ÑπÔ∏è No hi ha altres porters per comparar</p>
            </div>
        `;
        return;
    }
    
    if (window.goalkeeperComparisonChartInstance) {
        window.goalkeeperComparisonChartInstance.destroy();
    }
    
    const datasets = goalkeepers.map((gk, idx) => {
        const totalShots = gk.totalSaves + gk.totalGoalsAgainst;
        const savePercentage = totalShots > 0 ? ((gk.totalSaves / totalShots) * 100).toFixed(1) : 0;
        const savesPerMatch = (gk.totalSaves / gk.matches).toFixed(1);
        
        const colors = ['#22d3ee', '#fbbf24', '#22c55e', '#8b5cf6'];
        const isCurrentPlayer = gk.num === selectedPlayer.num && gk.name === selectedPlayer.name;
        
        return {
            label: `${gk.num}. ${gk.name}`,
            data: [parseFloat(savePercentage), parseFloat(savesPerMatch), gk.matches],
            backgroundColor: isCurrentPlayer ? '#22c55e' : colors[idx % colors.length],
            borderWidth: isCurrentPlayer ? 3 : 0,
            borderColor: isCurrentPlayer ? '#fff' : 'transparent'
        };
    });
    
    window.goalkeeperComparisonChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['% Parades', 'Parades/Partit', 'Partits'],
            datasets: datasets
        },
        options: {
            responsive: true,
            plugins: { legend: { labels: { color: 'white' } } },
            scales: {
                x: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                y: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } }
            }
        }
    });
}

function renderGoalkeeperPenalties(data) {
    const grid = document.getElementById('goalkeeperPenaltiesGrid');
    
    const penaltySavePercentage = data.penalties.faced > 0 ? 
        ((data.penalties.saved / data.penalties.faced) * 100).toFixed(1) : 0;
    
    grid.innerHTML = `
        <div class="stat-card">
            <div class="stat-value">${data.penalties.faced}</div>
            <div class="stat-label">Penalties Afrontats</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" style="color: #22c55e;">${data.penalties.saved}</div>
            <div class="stat-label">Penalties Parats</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" style="color: ${penaltySavePercentage >= 50 ? '#22c55e' : '#fbbf24'};">
                ${penaltySavePercentage}%
            </div>
            <div class="stat-label">% √àxit Penalties</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${data.penalties.faced - data.penalties.saved}</div>
            <div class="stat-label">Penalties Gol</div>
        </div>
    `;
}
// Funci√≥ auxiliar per parsejar dates en espanyol
function parseSpanishDate(dateStr) {
    if (!dateStr) return new Date(0);
    
    const parts = dateStr.split('-');
    if (parts.length === 3) {
        return new Date(parts[0], parts[1] - 1, parts[2]);
    }
    
    return new Date(dateStr);
}


// ============================================
// FUNCIONS PER CARREGAR DADES ACTAWP
// ============================================

let actawpData = null;

async function loadActawpData(team = 'juvenil') {
    try {
        console.log('üîÑ Carregant dades ACTAWP per:', team);
        
        const repos = {
            cadet: 'joseprico/cnt_cadet_25-26',
            juvenil: 'joseprico/CNT_juvenil_25_26'
        };
        
        const selectedRepo = repos[team];
        
        // Carregar el fitxer ACTAWP des de GitHub (ARREGLA ELS BACKTICKS!)
        const response = await fetch(`https://raw.githubusercontent.com/${selectedRepo}/main/actawp_${team}_data.json`);
        
        if (!response.ok) {
            throw new Error(`Error carregant dades ACTAWP: ${response.status}`);
        }
        
        actawpData = await response.json();
        console.log('‚úÖ Dades ACTAWP carregades:', actawpData);
        
        await checkLastUpdate();
        
        // ‚≠ê AFEGEIX AIX√í AL FINAL:
        await loadRankingACTAWP(team);
        
        return actawpData;
        
    } catch (error) {
        console.error('‚ùå Error carregant dades ACTAWP:', error);
        return null;
    }
}
// Funci√≥ per mostrar l'√∫ltima actualitzaci√≥ i detectar canvis recents
async function checkLastUpdate() {
    try {
        // ‚≠ê ACTUALITZAR AMBDUES UBICACIONS: Tab ACTAWP i Tab Inici
        const timeSpan = document.getElementById('lastUpdateTime');
        const timeSpanHome = document.getElementById('lastUpdateTimeHome');
        const badge = document.getElementById('recentUpdateBadge');
        const badgeHome = document.getElementById('recentUpdateBadgeHome');
        
        if (!timeSpan && !timeSpanHome) {
            console.log('‚ö†Ô∏è Elements lastUpdateTime no trobats');
            return;
        }
        
        // Si ja tenim actawpData carregat, usar-lo directament
        if (actawpData && actawpData.last_update) {
            const updateDate = new Date(actawpData.last_update);
            const now = new Date();
            const hoursDiff = (now - updateDate) / (1000 * 60 * 60);
            
            console.log('‚úÖ Last update trobat:', actawpData.last_update);
            console.log(`‚è±Ô∏è Hores de difer√®ncia: ${hoursDiff.toFixed(1)}h`);
            
            // Mostrar data formatada EN HORA CATALANA
            const options = { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit',
                timeZone: 'Europe/Madrid'
            };
            const formattedDate = updateDate.toLocaleString('ca-ES', options);
            
            // Sistema de colors segons l'antiguitat
            let badgeColor, badgeText, badgeIcon, timeColor;
            
            if (hoursDiff < 2) {
                badgeColor = '#10b981';
                badgeText = 'Actualitzat recentment';
                badgeIcon = 'üü¢';
                timeColor = '#22d3ee';
            } else if (hoursDiff < 5) {
                badgeColor = '#f59e0b';
                badgeText = 'Dades recents';
                badgeIcon = 'üü°';
                timeColor = '#22d3ee';
            } else if (hoursDiff < 12) {
                badgeColor = '#f97316';
                badgeText = 'Pendent actualitzaci√≥';
                badgeIcon = 'üü†';
                timeColor = '#fbbf24';
            } else {
                badgeColor = '#ef4444';
                badgeText = 'Dades antigues';
                badgeIcon = 'üî¥';
                timeColor = '#ef4444';
            }
            
            // ‚≠ê ACTUALITZAR TAB ACTAWP
            if (timeSpan) {
                timeSpan.textContent = formattedDate;
                timeSpan.style.color = timeColor;
            }
            
            // ‚≠ê ACTUALITZAR TAB INICI
            if (timeSpanHome) {
                timeSpanHome.textContent = formattedDate;
                timeSpanHome.style.color = timeColor;
            }
            
            // ‚≠ê ACTUALITZAR BADGES (ambdues ubicacions)
            [badge, badgeHome].forEach(b => {
                if (b) {
                    b.style.display = 'inline-block';
                    b.style.background = badgeColor;
                    b.innerHTML = `${badgeIcon} ${badgeText}`;
                    
                    if (hoursDiff < 2) {
                        setTimeout(() => {
                            b.style.display = 'none';
                        }, 10000);
                    }
                }
            });
        } else {
            console.log('‚ö†Ô∏è actawpData no t√© last_update');
            if (timeSpan) {
                timeSpan.textContent = 'Actualitzaci√≥ autom√†tica cada 30min';
                timeSpan.style.color = '#93c5fd';
            }
            if (timeSpanHome) {
                timeSpanHome.textContent = 'Actualitzaci√≥ autom√†tica cada 30min';
                timeSpanHome.style.color = '#93c5fd';
            }
        }
    } catch (error) {
        console.error('‚ùå Error checking last update:', error);
        const timeSpan = document.getElementById('lastUpdateTime');
        const timeSpanHome = document.getElementById('lastUpdateTimeHome');
        
        if (timeSpan) {
            timeSpan.textContent = 'Error carregant data';
            timeSpan.style.color = '#ef4444';
        }
        if (timeSpanHome) {
            timeSpanHome.textContent = 'Error carregant data';
            timeSpanHome.style.color = '#ef4444';
        }
    }
}

function displayUpcomingMatches() {
    console.log('üìÖ displayUpcomingMatches() - INICI');
    console.log('üìÖ actawpData:', actawpData);
    console.log('üìÖ actawpData.upcoming_matches:', actawpData?.upcoming_matches);
    
    const matches = actawpData.upcoming_matches || [];
    console.log('üìÖ matches.length:', matches.length);
    
    // ‚úÖ FUNCI√ì PRIMER
    function parseActawpDate(dateTimeStr) {
        if (!dateTimeStr) return new Date(9999, 0, 1);
        const match = dateTimeStr.match(/(\d{2})\/(\d{2})\/(\d{4})\s+(\d{2}):(\d{2})/);
        if (!match) return new Date(9999, 0, 1);
        const [_, day, month, year, hour, minute] = match;
        return new Date(year, month - 1, day, hour, minute);
    }
    
    const sortedMatches = [...matches].sort((a, b) => {
        const dateA = parseActawpDate(a.date_time);
        const dateB = parseActawpDate(b.date_time);
        return dateA - dateB;
    });
    
    console.log('üìÖ sortedMatches:', sortedMatches);
    
    const container = document.getElementById('actawp-upcoming-matches');
    console.log('üìÖ container:', container);
    
    if (matches.length === 0) {
        console.log('üìÖ No hi ha partits!');
        container.innerHTML = '<p style="color: #bae6fd;">No hi ha pr√≤xims partits programats</p>';
        return;
    }
    
    console.log('üìÖ Generant HTML per', matches.length, 'partits...');
    
    let html = '<div style="display: flex; flex-direction: column; gap: 15px;">';
    // Bot√≥ per descarregar tots els partits
    html += `
        <div style="text-align: center; margin-bottom: 15px;">
            <button onclick="window.downloadAllUpcomingMatches()" style="padding: 10px 20px; background: rgba(168, 85, 247, 0.2); color: #a855f7; border: 2px solid #a855f7; border-radius: 8px; font-size: 15px; cursor: pointer; font-family: inherit; font-weight: bold;">
                üìÖ Descarregar tots els partits al teu calendari Google o Apple
            </button>
        </div>
    `;
    // Funci√≥ per generar fitxer ICS
 function generateICS(match, isHome, rival) {
        let dateStr = match.date || match.date_time || '';
        const timeStr = match.time || '';
        const venue = match.venue || '';
        
        // Eliminar dia de la setmana: "Dom 09/11/2025" -> "09/11/2025"
        dateStr = dateStr.replace(/^[A-Za-z√†√®√©√≠√≤√≥√∫√ß√Ä√à√â√ç√í√ì√ö√á]+\s+/, '');
        
        let dtstart = '';
        let dtend = '';
        
        if (dateStr && timeStr && dateStr.includes('/') && timeStr.includes(':')) {
            const dateParts = dateStr.trim().split('/');
            const timeParts = timeStr.trim().split(':');
            
            if (dateParts.length === 3 && timeParts.length >= 2) {
                const day = parseInt(dateParts[0], 10);
                const month = parseInt(dateParts[1], 10) - 1; // 0-indexed
                const year = parseInt(dateParts[2], 10);
                const hours = parseInt(timeParts[0], 10);
                const minutes = parseInt(timeParts[1], 10);
                
                // Validar que tots els valors s√≥n n√∫meros v√†lids
                if (!isNaN(day) && !isNaN(month) && !isNaN(year) && !isNaN(hours) && !isNaN(minutes)) {
                    const startDate = new Date(year, month, day, hours, minutes, 0);
                    
                    // Validar que la data √©s v√†lida
                    if (startDate && startDate.getTime && !isNaN(startDate.getTime())) {
                        const endDate = new Date(startDate.getTime() + 90 * 60000); // +90 minuts
                        
                        try {
                            dtstart = startDate.toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '');
                            dtend = endDate.toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '');
                        } catch (e) {
                            console.error('Error converting date to ISO:', e);
                        }
                    }
                }
            }
        }
        
        const homeTeam = match.home_team || match.team1 || '?';
        const awayTeam = match.away_team || match.team2 || '?';
        const summary = `${homeTeam} vs ${awayTeam}`;
        const location = venue || '';
        const description = `Partit de waterpolo - ${isHome ? 'Local' : 'Visitant'}`;
        const uid = `match-${Date.now()}-${Math.random().toString(36).substr(2, 9)}@cnterrassa.com`;
        const dtstamp = new Date().toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '');
        
        const icsLines = [
            'BEGIN:VCALENDAR',
            'VERSION:2.0',
            'PRODID:-//CN Terrassa//Water Polo Stats//EN',
            'CALSCALE:GREGORIAN',
            'METHOD:PUBLISH',
            'BEGIN:VEVENT',
            `UID:${uid}`,
            `DTSTAMP:${dtstamp}`
        ];
        
        if (dtstart) icsLines.push(`DTSTART:${dtstart}`);
        if (dtend) icsLines.push(`DTEND:${dtend}`);
        
        icsLines.push(
            `SUMMARY:${summary}`,
            location ? `LOCATION:${location}` : null,
            `DESCRIPTION:${description}`,
            'STATUS:CONFIRMED',
            'END:VEVENT',
            'END:VCALENDAR'
        );
        
        return icsLines.filter(line => line !== null).join('\r\n');
    }
    
    function downloadICS(match, isHome, rival) {
        const icsContent = generateICS(match, isHome, rival);
        const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        
        const date = match.date || match.date_time || 'partit';
        const fileName = `CNTerrassa-${date.replace(/\//g, '-')}.ics`;
        link.download = fileName;
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(link.href);
    }
    matches.forEach((match, index) => {
        const date = match.date || match.date_time || 'Data desconeguda';
        const time = match.time || '';
        const homeTeam = match.home_team || match.team1 || '?';
        const awayTeam = match.away_team || match.team2 || '?';
        const venue = match.venue || '';
        const url = match.url || '#';
		const isHome = homeTeam.toUpperCase().includes('TERRASSA');
        
        // LOGOS
        const homeLogo = match.home_team_logo || match.team1_logo || null;
        const awayLogo = match.away_team_logo || match.team2_logo || null;
        
        // Debug
        if (index === 0) {
            console.log('DEBUG Propers partits - Logos:', { homeLogo, awayLogo, match });
    console.log('DEBUG Propers partits - URL:', url, 'match.url:', match.url);
        }
        
        const homeLogoHtml = homeLogo 
            ? `<img src="${homeLogo}" style="width: 28px; height: 28px; object-fit: contain; background: white; border-radius: 4px; padding: 2px; margin-right: 8px;" alt="${homeTeam}" onerror="console.error('Error logo home:', this.src); this.style.display='none';">` 
            : '';
        
        const awayLogoHtml = awayLogo 
            ? `<img src="${awayLogo}" style="width: 28px; height: 28px; object-fit: contain; background: white; border-radius: 4px; padding: 2px; margin-left: 8px;" alt="${awayTeam}" onerror="console.error('Error logo away:', this.src); this.style.display='none';">` 
            : '';
        
		 // üöó Dades del despla√ßament (nom√©s si √©s fora)
    let travelInfo = '';
    if (!isHome) {
        const clubLocations = {
            'C.N. TERRASSA': { name: 'CN Terrassa', address: 'Av. del Vall√®s, 115, Terrassa', lat: 41.5654, lng: 2.0089 },
            'C.N. MANRESA': { name: 'CN Manresa', address: 'Passeig del Riu, 22, Manresa', lat: 41.7285, lng: 1.8262 },
            'C.N. ATL BARCELONETA': { name: 'CN Atl Barceloneta', address: 'Pl. del Mar, s/n, Barcelona', lat: 41.3788, lng: 2.1894 },
            'C.N. BARCELONA': { name: 'CN Barcelona', address: 'Carrer Escullera Llevant, 389, Barcelona', lat: 41.3874, lng: 2.1686 },
            'C.N. MONTJUIC': { name: 'CN Montju√Øc', address: 'Av. de l\'Estadi, 30-38, Barcelona', lat: 41.3644, lng: 2.1519 },
            'C.E. MEDITERRANI': { name: 'CE Mediterrani', address: 'Passeig Mar√≠tim Barceloneta, 33, Barcelona', lat: 41.3851, lng: 2.1734 },
            'C.N. MOLINS DE REI': { name: 'CN Molins de Rei', address: 'C/ Jacint Verdaguer, 10, Molins de Rei', lat: 41.4115, lng: 2.0169 },
            'C.N. RUB√ç': { name: 'CN Rub√≠', address: 'C/ del Pla de les Vinyes, s/n, Rub√≠', lat: 41.4930, lng: 2.0311 },
            'U.E. D\'HORTA': { name: 'UE d\'Horta', address: 'C/ Feliu i Codina, 27, Barcelona', lat: 41.4285, lng: 2.1425 },
            'C.N. SANT ANDREU': { name: 'CN Sant Andreu', address: 'C/ Santa Coloma, 33, Barcelona', lat: 41.4358, lng: 2.1897 },
            'C.N. SABADELL': { name: 'CN Sabadell', address: 'C/ de la Borriana, 45, Sabadell', lat: 41.5463, lng: 2.1086 },
            'C.N. POBLE NOU': { name: 'CN Poble Nou', address: 'C/ Escullera Llevant, 1, Barcelona', lat: 41.4033, lng: 2.2047 }
        };
        
        const rivalName = homeTeam.toUpperCase().trim();
        let rivalData = null;
        
        for (const [key, value] of Object.entries(clubLocations)) {
            const normalizedKey = key.toUpperCase();
            if (normalizedKey === rivalName || 
                rivalName.includes(normalizedKey.replace('C.N. ', '').replace('C.E. ', '').replace('U.E. ', '')) ||
                normalizedKey.includes(rivalName.replace('C.N. ', '').replace('C.E. ', '').replace('U.E. ', ''))) {
                rivalData = value;
                break;
            }
        }
        
        if (rivalData) {
            const homeLat = 41.5654, homeLng = 2.0089;
            const R = 6371;
            const dLat = (rivalData.lat - homeLat) * Math.PI / 180;
            const dLon = (rivalData.lng - homeLng) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(homeLat * Math.PI / 180) * Math.cos(rivalData.lat * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const distance = R * c;
            const drivingTime = Math.round(distance * 2);
            
            travelInfo = `
                <div style="margin-top: 12px; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 12px;">
                    <div style="font-size: 11px; color: #94a3b8; margin-bottom: 6px;">üìç ADRE√áA</div>
                    <div style="font-size: 13px; color: white; margin-bottom: 10px;">${rivalData.address}</div>
                    <div style="display: flex; gap: 12px; justify-content: center;">
                        <div style="background: rgba(255,255,255,0.1); padding: 6px 12px; border-radius: 8px;">
                            <span style="font-size: 11px; color: #94a3b8;">üìè</span>
                            <span style="font-size: 13px; font-weight: 600;">${distance.toFixed(1)} km</span>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); padding: 6px 12px; border-radius: 8px;">
                            <span style="font-size: 11px; color: #94a3b8;">üöó</span>
                            <span style="font-size: 13px; font-weight: 600;">~${drivingTime} min</span>
                        </div>
                    </div>
                </div>
            `;
        }
    }
        // Determinar si CN Terrassa juga a casa o fora
        
        const locationIcon = isHome ? 'üè†' : '‚úàÔ∏è';
        const locationText = isHome ? 'Local' : 'Visitant';
        
        html += `
                <div style="background: rgba(34, 211, 238, 0.1); border-left: 4px solid #22d3ee; border-radius: 8px; padding: 12px;">
                    <!-- Data i hora -->
                    <div style="font-size: 12px; color: #94a3b8; margin-bottom: 12px;">
                         <strong>Jornada ${match.jornada || '?'}</strong> ‚Ä¢ üìÖ ${date} ${time ? `‚Ä¢ ‚è∞ ${time}` : ''}
                    </div>
                    
                    <!-- Equips en vertical -->
                    <div style="display: flex; flex-direction: column; gap: 8px; align-items: center;">
                        <!-- Equip Local -->
                        <div style="font-size: 15px; font-weight: ${isHome ? 'bold' : 'normal'}; color: ${isHome ? '#bae6fd' : '#94a3b8'}; display: flex; align-items: center; gap: 8px; justify-content: center; text-align: center;">
                            ${homeLogoHtml}
                            <span>${homeTeam}</span>
                        </div>
                        
                        <!-- VS i icona -->
                        <div style="display: flex; align-items: center; gap: 12px; margin: 4px 0;">
                            <span style="color: #67e8f9; font-size: 18px;">vs</span>
                            <span style="font-size: 32px;">${locationIcon}</span>
                        </div>
                        
                        <!-- Equip Visitant -->
                        <div style="font-size: 15px; font-weight: ${!isHome ? 'bold' : 'normal'}; color: ${!isHome ? '#bae6fd' : '#94a3b8'}; display: flex; align-items: center; gap: 8px; justify-content: center; text-align: center;">
                            ${awayLogoHtml}
                            <span>${awayTeam}</span>
                        </div>
                    </div>
                    
                    <!-- Ubicaci√≥ i estat -->
                    ${venue ? `<div style="font-size: 11px; color: #94a3b8; margin-top: 8px; text-align: center;">üìç ${venue}</div>` : ''}
                    <div style="font-size: 11px; color: #94a3b8; margin-top: 4px; text-align: center;">
                        ${locationIcon} ${locationText}
                    </div>
                    
                    <!-- Bot√≥ -->
                    <div style="text-align: center; margin-top: 12px;">
                        <a href="${url}" target="_blank" rel="noopener noreferrer" style="display: inline-block; background: #06b6d4; color: white; padding: 8px 20px; border-radius: 6px; text-decoration: none; font-size: 13px;">
                            Veure m√©s ‚Üí
                        </a>
                    </div>
                </div>
            `;
    
    // Crear funci√≥ per aquest partit
      
	});
    html += '</div>';
    container.innerHTML = html;
	// Guardar matches en una variable accessible globalment
    const matchesToDownload = matches;
    
    // Funci√≥ global per descarregar tots els partits en UN SOL FITXER
    window.downloadAllUpcomingMatches = function() {
        // Comen√ßar el fitxer ICS
        let icsLines = [
            'BEGIN:VCALENDAR',
            'VERSION:2.0',
            'PRODID:-//CN Terrassa//Water Polo Stats//EN',
            'CALSCALE:GREGORIAN',
            'METHOD:PUBLISH'
        ];
        
        // Afegir cada partit com un VEVENT
        matchesToDownload.forEach(match => {
            const homeTeam = match.home_team || match.team1 || '?';
            const awayTeam = match.away_team || match.team2 || '?';
            const isHome = homeTeam.toUpperCase().includes('TERRASSA');
            const rival = isHome ? awayTeam : homeTeam;
            
            let dateStr = match.date || match.date_time || '';
            const timeStr = match.time || '';
            const venue = match.venue || '';
            
            // Eliminar dia de la setmana
            dateStr = dateStr.replace(/^[A-Za-z√†√®√©√≠√≤√≥√∫√ß√Ä√à√â√ç√í√ì√ö√á]+\s+/, '');
            
            let dtstart = '';
            let dtend = '';
            
            if (dateStr && timeStr && dateStr.includes('/') && timeStr.includes(':')) {
                const dateParts = dateStr.trim().split('/');
                const timeParts = timeStr.trim().split(':');
                
                if (dateParts.length === 3 && timeParts.length >= 2) {
                    const day = parseInt(dateParts[0], 10);
                    const month = parseInt(dateParts[1], 10) - 1;
                    const year = parseInt(dateParts[2], 10);
                    const hours = parseInt(timeParts[0], 10);
                    const minutes = parseInt(timeParts[1], 10);
                    
                    if (!isNaN(day) && !isNaN(month) && !isNaN(year) && !isNaN(hours) && !isNaN(minutes)) {
                        const startDate = new Date(year, month, day, hours, minutes, 0);
                        
                        if (startDate && !isNaN(startDate.getTime())) {
                            const endDate = new Date(startDate.getTime() + 90 * 60000);
                            
                            try {
                                dtstart = startDate.toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '');
                                dtend = endDate.toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '');
                            } catch (e) {
                                console.error('Error converting date:', e);
                            }
                        }
                    }
                }
            }
            
            // Afegir VEVENT per aquest partit
            const summary = `${homeTeam} vs ${awayTeam}`;
            const description = `Partit de waterpolo - ${isHome ? 'Local' : 'Visitant'}`;
            const uid = `match-${dateStr.replace(/\//g, '')}-${timeStr.replace(/:/g, '')}-${Math.random().toString(36).substr(2, 9)}@cnterrassa.com`;
            const dtstamp = new Date().toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '');
            
            icsLines.push('BEGIN:VEVENT');
            icsLines.push(`UID:${uid}`);
            icsLines.push(`DTSTAMP:${dtstamp}`);
            if (dtstart) icsLines.push(`DTSTART:${dtstart}`);
            if (dtend) icsLines.push(`DTEND:${dtend}`);
            icsLines.push(`SUMMARY:${summary}`);
            if (venue) icsLines.push(`LOCATION:${venue}`);
            icsLines.push(`DESCRIPTION:${description}`);
            icsLines.push('STATUS:CONFIRMED');
            icsLines.push('END:VEVENT');
        });
        
        // Tancar el fitxer ICS
        icsLines.push('END:VCALENDAR');
        
        // Crear i descarregar el fitxer
        const icsContent = icsLines.join('\r\n');
        const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'CNTerrassa-ProximsPartits.ics';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(link.href);
    };
}

// Fer funcions accessibles globalment
window.generateICS = generateICS;
window.downloadICS = downloadICS;


function displayLastResults() {
    const results = actawpData.last_results || [];
	// ‚úÖ ORDENAR PER DATA (m√©s recent primer)
const sortedResults = [...results].sort((a, b) => {
    const dateA = parseActawpDate(a.date_time || '');
    const dateB = parseActawpDate(b.date_time || '');
    return dateB - dateA; // Ordre invers (m√©s recent primer)
});

function parseActawpDate(dateTimeStr) {
    if (!dateTimeStr) return new Date(0);
    const match = dateTimeStr.match(/(\d{2})\/(\d{2})\/(\d{4})/);
    if (!match) return new Date(0);
    const [_, day, month, year] = match;
    return new Date(year, month - 1, day);
}
    const container = document.getElementById('actawp-last-results');
    
    if (sortedResults.length === 0) {
        container.innerHTML = '<p style="color: #bae6fd;">No hi ha resultats recents</p>';
        return;
    }
    
    let html = '<div style="display: flex; flex-direction: column; gap: 15px;">';
    
    sortedResults.forEach((result, index) => {
        const homeTeam = result.home_team || result.team1 || '?';
        const awayTeam = result.away_team || result.team2 || '?';
        const homeScore = result.home_score || result.score_team1 || 0;
        const awayScore = result.away_score || result.score_team2 || 0;
        const url = result.url || '#';
        
        // LOGOS
        const homeLogo = result.home_team_logo || result.team1_logo || null;
        const awayLogo = result.away_team_logo || result.team2_logo || null;
        
        // Debug
        if (index === 0) {
            console.log('DEBUG Ultims resultats - Logos:', { homeLogo, awayLogo, result });
        }
        
        const homeLogoHtml = homeLogo 
            ? `<img src="${homeLogo}" style="width: 28px; height: 28px; object-fit: contain; background: white; border-radius: 4px; padding: 2px; margin-right: 8px;" alt="${homeTeam}" onerror="console.error('Error logo home:', this.src); this.style.display='none';">` 
            : '';
        
        const awayLogoHtml = awayLogo 
            ? `<img src="${awayLogo}" style="width: 28px; height: 28px; object-fit: contain; background: white; border-radius: 4px; padding: 2px; margin-left: 8px;" alt="${awayTeam}" onerror="console.error('Error logo away:', this.src); this.style.display='none';">` 
            : '';
        
        // Determinar resultat
        const homeWon = homeScore > awayScore;
        const awayWon = awayScore > homeScore;
        const draw = homeScore === awayScore;
        
        // Determinar si CN Terrassa va guanyar, empatar o perdre
        const isHomeTerrassa = homeTeam.toUpperCase().includes('TERRASSA');
        const isAwayTerrassa = awayTeam.toUpperCase().includes('TERRASSA');
        
        let resultIcon = '';
        let resultText = '';
        let borderColor = '';
        
        if (draw) {
            resultIcon = 'üü°';
            resultText = 'Empat';
            borderColor = '#fbbf24';
        } else if ((isHomeTerrassa && homeWon) || (isAwayTerrassa && awayWon)) {
            resultIcon = 'üü¢';
            resultText = 'Vict√≤ria';
            borderColor = '#4ade80';
        } else {
            resultIcon = 'üî¥';
            resultText = 'Derrota';
            borderColor = '#ef4444';
        }
        
        // Colors dels equips segons el resultat
        const homeColor = homeWon ? '#4ade80' : (draw ? '#fbbf24' : '#e0f2fe');
        const awayColor = awayWon ? '#4ade80' : (draw ? '#fbbf24' : '#e0f2fe');
        const homeWeight = homeWon ? '600' : '500';
        const awayWeight = awayWon ? '600' : '500';
        
         html += `
            <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; border-left: 4px solid ${borderColor};">
                <!-- Indicador de resultat -->
                <div style="font-size: 12px; color: #bae6fd; margin-bottom: 12px;">
                     ‚Ä¢ ${resultIcon} ${resultText}
                </div>
                
                <!-- Equips i marcador en vertical -->
                <div style="display: flex; flex-direction: column; gap: 8px; align-items: center;">
                    <!-- Equip Local -->
                    <div style="display: flex; align-items: center; gap: 8px; color: ${homeColor}; font-weight: ${homeWeight}; font-size: 15px; width: 100%; justify-content: center; text-align: center;">
                        ${homeLogoHtml}
                        <span>${homeTeam}</span>
                    </div>
                    
                    <!-- Marcador gran -->
                    <div style="background: rgba(34, 211, 238, 0.2); padding: 10px 24px; border-radius: 8px; font-weight: bold; font-size: 28px; color: #22d3ee; margin: 8px 0;">
                        ${homeScore} - ${awayScore}
                    </div>
                    
                    <!-- Equip Visitant -->
                    <div style="display: flex; align-items: center; gap: 8px; color: ${awayColor}; font-weight: ${awayWeight}; font-size: 15px; width: 100%; justify-content: center; text-align: center;">
                        ${awayLogoHtml}
                        <span>${awayTeam}</span>
                    </div>
                </div>
                
                <!-- Bot√≥ detalls -->
                <div style="text-align: center; margin-top: 12px;">
                    <a href="${url}" target="_blank" rel="noopener noreferrer" style="display: inline-block; background: #06b6d4; color: white; padding: 8px 20px; border-radius: 6px; text-decoration: none; font-size: 13px;">
                        Detalls ‚Üí
                    </a>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
	
}
function displayActawpData() {
    if (!actawpData) {
        document.getElementById('actawpLoading').innerHTML = `
            <div style="text-align: center; padding: 40px;">
                <div style="font-size: 48px;">‚ö†Ô∏è</div>
                <p style="color: #fbbf24;">No s'han pogut carregar les dades d'ACTAWP</p>
                <p style="color: #bae6fd; font-size: 14px; margin-top: 10px;">
                    Assegura't que el fitxer actawp_data.json existeix al repositori de GitHub
                </p>
            </div>
        `;
        return;
    }
    
    // Amagar loading i mostrar contingut
    document.getElementById('actawpLoading').style.display = 'none';
    document.getElementById('actawpContent').style.display = 'block';
    
     // ‚úÖ Calcular estad√≠stiques des de la classificaci√≥ (ranking)
    let stats = {};
    if (actawpData.ranking && actawpData.ranking.length > 0) {
        // Buscar CN TERRASSA a la classificaci√≥
        const cntTeam = actawpData.ranking.find(team => 
            team.equip && team.equip.toUpperCase().includes('TERRASSA')
        );
        
        if (cntTeam) {
            stats = {
                'Punts': cntTeam.punts || 0,
                'Partits jugats': cntTeam.partits || 0,
                'Partits guanyats': cntTeam.guanyats || 0,
                'Partits empatats': cntTeam.empatats || 0,
                'Partits perduts': cntTeam.perduts || 0,
                'Gols a favor': cntTeam.gols_favor || 0,
                'Gols en contra': cntTeam.gols_contra || 0
            };
        }
    }
    
    // Mapper de noms d'estad√≠stiques (catal√†/castell√†)
    const statNames = {
        points: ['Puntos', 'Punts'],
        matchesPlayed: ['Partidos jugados', 'Partits jugats'],
        wins: ['Partidos ganados', 'Partits guanyats'],
        draws: ['Partidos empatados', 'Partits empatats'],
        losses: ['Partidos perdidos', 'Partits perduts'],
        goalsFor: ['A favor', 'Goles a favor', 'Gols a favor'],
        goalsAgainst: ['En contra', 'Gols en contra', 'Goles en contra']
    };
    
    function getStatValue(possibleNames) {
        for (const name of possibleNames) {
            if (stats[name] !== undefined) {
                return stats[name];
            }
        }
        return 0;
    }
    
    const points = getStatValue(statNames.points);
    const matchesPlayed = getStatValue(statNames.matchesPlayed);
    const wins = getStatValue(statNames.wins);
    const draws = getStatValue(statNames.draws);
    const losses = getStatValue(statNames.losses);
    const goalsFor = getStatValue(statNames.goalsFor);
    const goalsAgainst = getStatValue(statNames.goalsAgainst);
    const goalDiff = goalsFor - goalsAgainst;
    
    document.getElementById('actawp-points').textContent = points;
    document.getElementById('actawp-matches-played').textContent = matchesPlayed;
    document.getElementById('actawp-wins').textContent = wins;
    document.getElementById('actawp-draws').textContent = draws;
    document.getElementById('actawp-losses').textContent = losses;
    document.getElementById('actawp-goals-for').textContent = goalsFor;
    document.getElementById('actawp-goals-against').textContent = goalsAgainst;
    document.getElementById('actawp-goal-diff').textContent = goalDiff >= 0 ? `+${goalDiff}` : goalDiff;
    document.getElementById('actawp-goal-diff').style.color = goalDiff >= 0 ? '#4ade80' : '#ef4444';
    
    // Mostrar pr√≤xims partits
    displayUpcomingMatches();
    
    // Mostrar √∫ltims resultats
    displayLastResults();
    
    // Mostrar comparativa de jugadors
    displayPlayerComparison();
	if (typeof displayActawpMatches === 'function') {
       displayActawpMatches();
   }
}



function displayPlayerComparison() {
    console.log('\nüîç displayPlayerComparison() executant...');
    
    function cleanNameForDisplay(name) {
        if (!name) return '';
        let cleaned = name.replace(/^Veure/i, '').replace(/^Ver/i, '').trim();
        return cleaned
            .split(' ')
            .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
            .join(' ');
    }
    
    if (!actawpData) {
        console.error('‚ùå actawpData null!');
        const container = document.getElementById('actawp-comparison-table');
        if (container) {
            container.innerHTML = '<p style="color: #fbbf24;">‚è≥ Carregant dades ACTAWP...</p>';
        }
        return;
    }
    
    const actawpPlayers = actawpData.players || [];
    const container = document.getElementById('actawp-comparison-table');
    
    if (!container) {
        console.error('‚ùå Container no trobat');
        return;
    }
    
    if (actawpPlayers.length === 0) {
        container.innerHTML = '<p style="color: #bae6fd;">No hi ha dades</p>';
        return;
    }
    
    console.log('üìä ACTAWP:', actawpPlayers.length, 'jugadors');
    
    const localPlayers = getAllUniquePlayers();
    console.log('üìä Locals:', localPlayers.length, 'jugadors');
    
    // Crear mapa
    const localPlayersMap = new Map();
    localPlayers.forEach(p => {
        const normalized = normalizeName(p.name);
        localPlayersMap.set(normalized, p);
    });
    
    // Taula HTML
    let html = `
        <div style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
            <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                <thead>
                    <tr style="background: rgba(255,255,255,0.05);">
                        <th style="padding: 10px; text-align: left; border-bottom: 2px solid #334155; min-width: 150px;">Jugador</th>
                        <th style="padding: 10px; text-align: left; border-bottom: 2px solid #334155;">Font</th>
                        <th style="padding: 10px; text-align: center; border-bottom: 2px solid #334155;" title="Partits Jugats">PJ</th>
                        <th style="padding: 10px; text-align: center; border-bottom: 2px solid #334155;" title="Gols Totals">Gols</th>
                        <th style="padding: 10px; text-align: center; border-bottom: 2px solid #334155;" title="Gols de Penal">G.Pen</th>
                        <th style="padding: 10px; text-align: center; border-bottom: 2px solid #334155;" title="Exclusions 20seg">Excl</th>
                        <th style="padding: 10px; text-align: center; border-bottom: 2px solid #334155;" title="Penals Fallats">P.Fall</th>
                        <th style="padding: 10px; text-align: center; border-bottom: 2px solid #334155; background: rgba(100,116,139,0.1);" title="Nom√©s ACTAWP">TA</th>
                        <th style="padding: 10px; text-align: center; border-bottom: 2px solid #334155; background: rgba(100,116,139,0.1);" title="Nom√©s ACTAWP">TR</th>
                        <th style="padding: 10px; text-align: center; border-bottom: 2px solid #334155; background: rgba(100,116,139,0.1);" title="Nom√©s ACTAWP">MVP</th>
                        <th style="padding: 10px; text-align: center; border-bottom: 2px solid #334155;">Estat</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    let matchedCount = 0;
    let unmatchedCount = 0;
    
    actawpPlayers.forEach(actawpPlayer => {
        const actawpName = actawpPlayer['Nombre'] || '';
        const cleanedActawpName = cleanNameForDisplay(actawpName);
        
        console.log(`\nüîé Buscant: "${actawpName}"`);
        
        // Buscar coincid√®ncia
        let localPlayer = null;
        for (const [localNormalized, player] of localPlayersMap.entries()) {
            if (nameMatches(actawpName, player.name)) {
                localPlayer = player;
                console.log(`  ‚úÖ MATCH amb "${player.name}"`);
                break;
            }
        }
        
        // Dades ACTAWP
        const actawpPJ = actawpPlayer['PJ'] || 0;
        const actawpGols = actawpPlayer['GT'] || 0;
        const actawpGP = actawpPlayer['GP'] || 0;
        const actawpExcl = actawpPlayer['EX'] || 0;
        const actawpPF = actawpPlayer['PF'] || 0;
        const actawpTA = actawpPlayer['TA'] || 0;
        const actawpTR = actawpPlayer['TR'] || 0;
        const actawpMVP = actawpPlayer['MVP'] || 0;
        
        if (localPlayer) {
            matchedCount++;
            
            // Dades locals
            const localPJ = localPlayer.partidos || 0;
            const localGols = localPlayer.gols || 0;
            const localGP = localPlayer.goalTypes?.penalty || 0;
            const localExcl = localPlayer.exclusions || 0;
            const localPF = localPlayer.penaltyMissed || 0;
            
            console.log(`  üìä ACTAWP: PJ=${actawpPJ} G=${actawpGols} GP=${actawpGP} EX=${actawpExcl} PF=${actawpPF}`);
            console.log(`  üìä Local:  PJ=${localPJ} G=${localGols} GP=${localGP} EX=${localExcl} PF=${localPF}`);
            
            // Difer√®ncies (nom√©s camps comparables)
            const diffPJ = actawpPJ - localPJ;
            const diffGols = actawpGols - localGols;
            const diffGP = actawpGP - localGP;
            const diffExcl = actawpExcl - localExcl;
            const diffPF = actawpPF - localPF;
            
            const hasDiff = diffPJ !== 0 || diffGols !== 0 || diffGP !== 0 || diffExcl !== 0 || diffPF !== 0;
            
            html += `
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <td rowspan="2" style="padding: 10px; font-weight: bold; vertical-align: middle;">${cleanedActawpName}</td>
                    <td style="padding: 10px; color: #22d3ee;">ACTAWP</td>
                    <td style="padding: 10px; text-align: center;">${actawpPJ}</td>
                    <td style="padding: 10px; text-align: center;">${actawpGols}</td>
                    <td style="padding: 10px; text-align: center;">${actawpGP}</td>
                    <td style="padding: 10px; text-align: center;">${actawpExcl}</td>
                    <td style="padding: 10px; text-align: center;">${actawpPF}</td>
                    <td style="padding: 10px; text-align: center; background: rgba(100,116,139,0.05);">${actawpTA > 0 ? `<span style="color: #fbbf24;">${actawpTA}</span>` : '-'}</td>
                    <td style="padding: 10px; text-align: center; background: rgba(100,116,139,0.05);">${actawpTR > 0 ? `<span style="color: #ef4444;">${actawpTR}</span>` : '-'}</td>
                    <td style="padding: 10px; text-align: center; background: rgba(100,116,139,0.05);">${actawpMVP > 0 ? '<span style="color: #fbbf24; font-size: 16px;">‚≠ê</span>' : '-'}</td>
                    <td rowspan="2" style="padding: 10px; text-align: center; vertical-align: middle;">
                        ${hasDiff ? '<span style="color: #fbbf24; font-size: 20px;">‚ö†Ô∏è</span>' : '<span style="color: #4ade80; font-size: 20px;">‚úì</span>'}
                    </td>
                </tr>
                <tr style="border-bottom: 2px solid rgba(255,255,255,0.1);">
                    <td style="padding: 10px; color: #a78bfa;">Local</td>
                    <td style="padding: 10px; text-align: center;">
                        ${localPJ}
                        ${diffPJ !== 0 ? `<span style="color: ${diffPJ > 0 ? '#ef4444' : '#4ade80'}; font-size: 10px; margin-left: 2px;">(${diffPJ > 0 ? '+' : ''}${diffPJ})</span>` : ''}
                    </td>
                    <td style="padding: 10px; text-align: center;">
                        ${localGols}
                        ${diffGols !== 0 ? `<span style="color: ${diffGols > 0 ? '#ef4444' : '#4ade80'}; font-size: 10px; margin-left: 2px;">(${diffGols > 0 ? '+' : ''}${diffGols})</span>` : ''}
                    </td>
                    <td style="padding: 10px; text-align: center;">
                        ${localGP}
                        ${diffGP !== 0 ? `<span style="color: ${diffGP > 0 ? '#ef4444' : '#4ade80'}; font-size: 10px; margin-left: 2px;">(${diffGP > 0 ? '+' : ''}${diffGP})</span>` : ''}
                    </td>
                    <td style="padding: 10px; text-align: center;">
                        ${localExcl}
                        ${diffExcl !== 0 ? `<span style="color: ${diffExcl > 0 ? '#ef4444' : '#4ade80'}; font-size: 10px; margin-left: 2px;">(${diffExcl > 0 ? '+' : ''}${diffExcl})</span>` : ''}
                    </td>
                    <td style="padding: 10px; text-align: center;">
                        ${localPF}
                        ${diffPF !== 0 ? `<span style="color: ${diffPF > 0 ? '#ef4444' : '#4ade80'}; font-size: 10px; margin-left: 2px;">(${diffPF > 0 ? '+' : ''}${diffPF})</span>` : ''}
                    </td>
                    <td colspan="3" style="padding: 10px; text-align: center; color: #64748b; font-size: 11px; background: rgba(100,116,139,0.05);">Nom√©s ACTAWP</td>
                </tr>
            `;
        } else {
            unmatchedCount++;
            console.log(`  ‚ùå NO TROBAT`);
            
            html += `
                <tr style="background: rgba(239, 68, 68, 0.05); border-bottom: 2px solid rgba(255,255,255,0.1);">
                    <td style="padding: 10px; font-weight: bold;">${cleanedActawpName}</td>
                    <td style="padding: 10px; color: #22d3ee;">ACTAWP</td>
                    <td style="padding: 10px; text-align: center;">${actawpPJ}</td>
                    <td style="padding: 10px; text-align: center;">${actawpGols}</td>
                    <td style="padding: 10px; text-align: center;">${actawpGP}</td>
                    <td style="padding: 10px; text-align: center;">${actawpExcl}</td>
                    <td style="padding: 10px; text-align: center;">${actawpPF}</td>
                    <td style="padding: 10px; text-align: center; background: rgba(100,116,139,0.05);">${actawpTA > 0 ? `<span style="color: #fbbf24;">${actawpTA}</span>` : '-'}</td>
                    <td style="padding: 10px; text-align: center; background: rgba(100,116,139,0.05);">${actawpTR > 0 ? `<span style="color: #ef4444;">${actawpTR}</span>` : '-'}</td>
                    <td style="padding: 10px; text-align: center; background: rgba(100,116,139,0.05);">${actawpMVP > 0 ? '<span style="color: #fbbf24; font-size: 16px;">‚≠ê</span>' : '-'}</td>
                    <td style="padding: 10px; color: #ef4444; text-align: center; font-size: 11px;">‚ùå No convocat</td>
                </tr>
            `;
        }
    });
    
    html += `
                </tbody>
            </table>
        </div>
        <div style="margin-top: 15px; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 8px;">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                <div style="color: #bae6fd; font-size: 14px;">
                    üìä <strong>Resum:</strong> ${matchedCount} jugadors coincidents, ${unmatchedCount} nom√©s a ACTAWP
                </div>
                <div style="color: #94a3b8; font-size: 12px;">
                    ‚úì Comparables: PJ, Gols, G.Penal, Exclusions, P.Fallats
                    <br>
                    ‚ÑπÔ∏è Nom√©s info ACTAWP: Targetes, MVP
                </div>
            </div>
            ${matchedCount > 0 ? `<div style="color: #4ade80; margin-top: 10px; font-size: 14px;">‚úÖ Comparativa funcionant correctament!</div>` : ''}
        </div>
    `;
    
    container.innerHTML = html;
    
    console.log('\nüìä RESUM:');
    console.log('  ‚úÖ Coincidents:', matchedCount);
    console.log('  ‚ùå No trobats:', unmatchedCount);
}

// ============================================
// EXEMPLE D'√öS (per testejar)
// ============================================

// Pots descomentar aix√≤ per testejar:

console.log('üß™ TEST DE COMPARACI√ì DE NOMS:');
console.log('Test 1:', nameMatches('VerMARC MORENO FOLCH', 'Marc Moreno'));
console.log('Test 2:', nameMatches('VeureLLATZER PEREZ BARADAD', 'Llatzer Perez'));
console.log('Test 3:', nameMatches('VerBIEL GARCIA ARJONA', 'Biel Garcia'));
console.log('Test 4:', nameMatches('VerARNAU MERCADE SEGURA', 'Arnau Mercade'));


function normalizeName(name) {
    if (!name) return '';
    
    let normalized = name
        .toLowerCase()
        .trim();
    
    // Eliminar "veure" i "ver" del principi
    normalized = normalized.replace(/^veure/i, '');
    normalized = normalized.replace(/^ver/i, '');
    
    // Eliminar accents i diacr√≠tics (√±‚Üín, √ß‚Üíc, √†‚Üía, etc.)
    normalized = normalized
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/√±/g, 'n')  // √± espec√≠fica
        .replace(/√ß/g, 'c')  // √ß espec√≠fica
        .replace(/¬∑/g, ' ')  // punt volat
        .replace(/[.,'''`\-]/g, '')  // puntuaci√≥
        .replace(/\s+/g, ' ')  // m√∫ltiples espais
        .trim();
    
    return normalized;
}

function nameMatches(name1, name2) {
    const n1 = normalizeName(name1);
    const n2 = normalizeName(name2);
    
    console.log(`  üîé Comparant: "${n1}" vs "${n2}"`);
    
    // Coincid√®ncia exacta
    if (n1 === n2) {
        console.log(`    ‚úÖ EXACTE!`);
        return true;
    }
    
    // Separar en paraules
    const words1 = n1.split(' ').filter(w => w.length > 1);  // Filtrar paraules molt curtes
    const words2 = n2.split(' ').filter(w => w.length > 1);
    
    console.log(`    Paraules 1: [${words1.join(', ')}]`);
    console.log(`    Paraules 2: [${words2.join(', ')}]`);
    
    // Si alguna llista est√† buida, no podem comparar
    if (words1.length === 0 || words2.length === 0) {
        console.log(`    ‚ùå Llistes buides`);
        return false;
    }
    
    // Cas especial: nom√©s 1 paraula a cada llista
    if (words1.length === 1 && words2.length === 1) {
        const match = words1[0] === words2[0];
        console.log(`    ${match ? '‚úÖ' : '‚ùå'} Una paraula cada: ${match}`);
        return match;
    }
    
    // Extreure primer nom
    const firstName1 = words1[0];
    const firstName2 = words2[0];
    
    console.log(`    Noms: "${firstName1}" vs "${firstName2}"`);
    
    // El nom ha de coincidir sempre
    if (firstName1 !== firstName2) {
        console.log(`    ‚ùå Noms diferents`);
        return false;
    }
    
    console.log(`    ‚úÖ Mateix nom!`);
    
    // Si ambd√≥s nom√©s tenen nom (sense cognoms), ja hem validat
    if (words1.length === 1 && words2.length === 1) {
        console.log(`    ‚úÖ Nom√©s nom, i coincideix`);
        return true;
    }
    
    // Obtenir cognoms (tot excepte la primera paraula)
    const lastNames1 = words1.slice(1);
    const lastNames2 = words2.slice(1);
    
    console.log(`    Cognoms 1: [${lastNames1.join(', ')}]`);
    console.log(`    Cognoms 2: [${lastNames2.join(', ')}]`);
    
    // Si un t√© cognoms i l'altre no, coincid√®ncia pel nom
    if (lastNames1.length === 0 || lastNames2.length === 0) {
        console.log(`    ‚ö†Ô∏è Un sense cognoms, coincid√®ncia pel nom`);
        return true;
    }
    
    // Comprovar si algun cognom coincideix
    for (let ln1 of lastNames1) {
        for (let ln2 of lastNames2) {
            if (ln1 === ln2) {
                console.log(`    ‚úÖ Cognom com√∫: "${ln1}"`);
                return true;
            }
        }
    }
    
    console.log(`    ‚ùå Cap cognom coincideix`);
    return false;
}








// ============================================
// SECCI√ì DE PARTITS ACTAWP
// Afegir despr√©s de displayPlayerComparison()
// ============================================

function displayActawpMatches() {
    console.log('\nüèê displayActawpMatches() executant...');
    
    if (!actawpData) {
        console.error('‚ùå actawpData null!');
        return;
    }
    
    const lastResults = actawpData.last_results || [];
    const upcomingMatches = actawpData.upcoming_matches || [];
    
    console.log('üìä √öltims resultats:', lastResults.length);
    console.log('üìÖ Pr√≤xims partits:', upcomingMatches.length);
    
    // Funci√≥ MILLORADA per detectar si som Terrassa
    function isOurTeam(teamName) {
        if (!teamName) return false;
        const normalized = teamName.toUpperCase().replace(/\s+/g, ' ').trim();
        
        // Buscar "C.N. TERRASSA" seguit de " A" o final de l√≠nia
        // Aix√≤ detecta: "C.N. TERRASSA A", "C.N. TERRASSA" (exacte)
        // Per√≤ NO: "C.N. MONTJUIC" o altres equips
        
        return normalized === 'C.N. TERRASSA' || 
               normalized === 'CN TERRASSA' ||
               normalized === 'C.N. TERRASSA A' ||
               normalized === 'C.N.TERRASSA' ||
               normalized.match(/^C\.?N\.?\s*TERRASSA\s*A?$/);
    }
    // Funci√≥ per generar fitxer ICS

	
    // ==========================================
    // PR√íXIMS PARTITS
    // ==========================================
    const upcomingContainer = document.getElementById('actawp-upcoming-matches');
    if (upcomingContainer && upcomingMatches.length > 0) {
        let html = '<div style="display: grid; gap: 15px;">';
        // Bot√≥ √∫nic per descarregar TOTS els partits
html += `
    <div style="text-align: center; margin-bottom: 15px;">
        <button onclick="window.downloadAllUpcomingMatches()" style="padding: 10px 20px; background: rgba(168, 85, 247, 0.2); color: #a855f7; border: 2px solid #a855f7; border-radius: 8px; font-size: 15px; cursor: pointer; font-family: inherit; font-weight: bold;">
            üìÖ Descarregar tots els partits al teu calendari Google o Apple
        </button>
    </div>
`;
        upcomingMatches.forEach((match, index) => {
            console.log('\nüìÖ Processant pr√≤xim:', match);
            console.log('URL del partit:', match.url);
            const team1 = match.team1 || '';
            const team2 = match.team2 || '';
            
            console.log(`  Team1: "${team1}"`);
            console.log(`  Team2: "${team2}"`);
            console.log(`  isOurTeam(team1): ${isOurTeam(team1)}`);
            console.log(`  isOurTeam(team2): ${isOurTeam(team2)}`);
            
            // SEGONS L'ESTRUCTURA D'ACTAWP:
            // - team1 = SEMPRE local (columna esquerra)
            // - team2 = SEMPRE visitant (columna dreta)
            
            let isHome, rival;
            if (isOurTeam(team1)) {
                // Som a l'esquerra ‚Üí Som locals
                isHome = true;
                rival = team2;
            } else if (isOurTeam(team2)) {
                // Som a la dreta ‚Üí Som visitants
                isHome = false;
                rival = team1;
            } else {
                // Error: no ens trobem
                console.warn('‚ö†Ô∏è No trobem el nostre equip!', {team1, team2});
                isHome = false;
                rival = team2 || team1 || 'Rival desconegut';
            }
            
            console.log(`  ‚Üí isHome: ${isHome}, rival: "${rival}"`);
            
            const date = match.date || '';
            const time = match.time || '';
            const venue = match.venue || '';
            // Logos
const logo1 = match.team1_logo || '';
const logo2 = match.team2_logo || '';
const ourLogo = isHome ? logo1 : logo2;
const rivalLogo = isHome ? logo2 : logo1;

const ourLogoHtml = ourLogo ? `<img src="${ourLogo}" style="width: 24px; height: 24px; object-fit: contain; background: white; border-radius: 4px; padding: 2px; margin-right: 8px; vertical-align: middle;" onerror="this.style.display='none';">` : '';
const rivalLogoHtml = rivalLogo ? `<img src="${rivalLogo}" style="width: 24px; height: 24px; object-fit: contain; background: white; border-radius: 4px; padding: 2px; margin-right: 8px; vertical-align: middle;" onerror="this.style.display='none';">` : '';
            html += `
                <div style="background: rgba(34, 211, 238, 0.1); border-left: 4px solid #22d3ee; border-radius: 8px; padding: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <div style="flex: 1; min-width: 200px;">
                            <div style="font-size: 12px; color: #94a3b8; margin-bottom: 5px;">
                                 ‚Ä¢ üìÖ ${date} ${time ? `‚Ä¢ ‚è∞ ${time}` : ''}
                            </div>
                            
							${isHome ? `
    <div style="font-size: 16px; font-weight: bold; color: #bae6fd; display: flex; align-items: center;">
        ${ourLogoHtml}
        <span>CN Terrassa</span>
    </div>
    <div style="font-size: 14px; color: #94a3b8; margin-top: 2px; display: flex; align-items: center;">
        <span style="margin-right: 8px;">vs</span>
        ${rivalLogoHtml}
        <span>${rival}</span>
    </div>
` : `
    <div style="font-size: 16px; font-weight: bold; color: #bae6fd; display: flex; align-items: center;">
        ${rivalLogoHtml}
        <span>${rival}</span>
    </div>
    <div style="font-size: 14px; color: #94a3b8; margin-top: 2px; display: flex; align-items: center;">
        <span style="margin-right: 8px;">vs</span>
        ${ourLogoHtml}
        <span>CN Terrassa</span>
    </div>
`}
                            
							${venue ? `<div style="font-size: 12px; color: #64748b; margin-top: 5px;">üìç ${venue}</div>` : ''}
                        </div>
                        <div style="text-align: center; min-width: 100px;">
    <div style="font-size: 32px; color: #22d3ee;">
        ${isHome ? 'üè†' : '‚úàÔ∏è'}
    </div>
    <div style="font-size: 12px; color: #94a3b8; margin-top: 5px;">
        ${isHome ? 'Local' : 'Visitant'}
    </div>
</div>
                       <div style="min-width: 100px; text-align: right; display: flex; flex-direction: column; gap: 8px;">
    <a href="${match.url || '#'}" target="_blank" style="display: inline-block; padding: 8px 16px; background: rgba(34, 211, 238, 0.2); color: #22d3ee; border-radius: 6px; text-decoration: none; font-size: 13px; text-align: center;">
        ‚ÑπÔ∏è Detalls
    </a>
     ${rival ? `
    <a href="https://www.google.com/maps/dir/Terrassa,+Barcelona,+Spain/${encodeURIComponent(isHome ? 'CN Terrassa, Terrassa' : rival)}"
       target="_blank" 
       rel="noopener noreferrer"
       style="display: inline-block; padding: 8px 16px; background: rgba(34, 211, 238, 0.2); color: #22d3ee; border-radius: 6px; text-decoration: none; font-size: 13px; text-align: center;">
        üöó Com arribar
    </a>
    ` : ''}
</div>
                    </div>
                </div>
            `;
			// Crear funci√≥ espec√≠fica per aquest partit
            window[`downloadMatchICS_${index}`] = function() {
                downloadICS(match, isHome, rival);
            };
        });
        
        html += '</div>';
        upcomingContainer.innerHTML = html;
    } else if (upcomingContainer) {
        upcomingContainer.innerHTML = '<p style="color: #94a3b8; text-align: center; padding: 20px;">No hi ha pr√≤xims partits programats</p>';
    }
    
    // ==========================================
    // √öLTIMS RESULTATS
    // ==========================================
    const resultsContainer = document.getElementById('actawp-last-results');
    if (resultsContainer && lastResults.length > 0) {
        let html = '<div style="display: grid; gap: 15px;">';
        
        lastResults.forEach(match => {
            console.log('\nüìä Processant resultat:', match);
            
            const team1 = match.team1 || '';
            const team2 = match.team2 || '';
            
            console.log(`  Team1: "${team1}"`);
            console.log(`  Team2: "${team2}"`);
            
            // SEGONS L'ESTRUCTURA D'ACTAWP:
            // - team1 = Equip esquerra
            // - team2 = Equip dreta
            // - score_team1 = Gols de team1
            // - score_team2 = Gols de team2
            
 // Parsejar el score (format "13-14")
let score1 = null, score2 = null;
if (match.score) {
    const parts = match.score.split('-');
    if (parts.length === 2) {
        score1 = parseInt(parts[0]) || 0;
        score2 = parseInt(parts[1]) || 0;
    }
}

let isHome, rival, ourScore, theirScore;
if (isOurTeam(team1)) {
    // Som team1
    isHome = true;
    rival = team2;
    ourScore = score1;
    theirScore = score2;
} else if (isOurTeam(team2)) {
    // Som team2
    isHome = false;
    rival = team1;
    ourScore = score2;
    theirScore = score1;
} else {
    console.warn('‚ö†Ô∏è No trobem el nostre equip!', {team1, team2});
    isHome = false;
    rival = team2 || team1 || 'Rival desconegut';
    ourScore = score1;
    theirScore = score2;
}
            
            console.log(`  ‚Üí isHome: ${isHome}, rival: "${rival}"`);
            console.log(`  ‚Üí Marcador: ${ourScore} - ${theirScore}`);
            
            const date = match.date || '';
            const venue = match.venue || '';
            
            const hasScore = ourScore !== undefined && theirScore !== undefined;
            
            if (hasScore) {
                // AMB MARCADOR
                let resultClass, resultIcon;
                if (ourScore > theirScore) {
                    resultClass = 'win';
                    resultIcon = '‚úÖ';
                } else if (ourScore < theirScore) {
                    resultClass = 'loss';
                    resultIcon = '‚ùå';
                } else {
                    resultClass = 'draw';
                    resultIcon = '‚ûñ';
                }
                
                const bgColor = resultClass === 'win' ? 'rgba(74, 222, 128, 0.1)' : 
                               resultClass === 'loss' ? 'rgba(239, 68, 68, 0.1)' : 
                               'rgba(148, 163, 184, 0.1)';
                
                const borderColor = resultClass === 'win' ? '#4ade80' : 
                                   resultClass === 'loss' ? '#ef4444' : 
                                   '#94a3b8';
				// Logos
const logo1_res = match.team1_logo || '';
const logo2_res = match.team2_logo || '';
const ourLogo_res = isHome ? logo1_res : logo2_res;
const rivalLogo_res = isHome ? logo2_res : logo1_res;

const ourLogoHtml_res = ourLogo_res ? `<img src="${ourLogo_res}" style="width: 24px; height: 24px; object-fit: contain; background: white; border-radius: 4px; padding: 2px; margin-right: 8px; vertical-align: middle;" onerror="this.style.display='none';">` : '';
const rivalLogoHtml_res = rivalLogo_res ? `<img src="${rivalLogo_res}" style="width: 24px; height: 24px; object-fit: contain; background: white; border-radius: 4px; padding: 2px; margin-right: 8px; vertical-align: middle;" onerror="this.style.display='none';">` : '';
                
                html += `
                    <div style="background: ${bgColor}; border-left: 4px solid ${borderColor}; border-radius: 8px; padding: 12px;">
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <!-- Data i lloc -->
                            <div style="font-size: 11px; color: #94a3b8;">
                                ${date} ${venue ? '‚Ä¢ ' + venue : ''}
                            </div>
                            
                            <!-- Equips -->
                            <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
                                <div style="flex: 1; min-width: 0;">
                                    ${isHome ? `
                                        <div style="font-size: 14px; font-weight: bold; color: #bae6fd; display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
                                            ${ourLogoHtml_res}
                                            <span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">CN Terrassa</span>
                                        </div>
                                        <div style="font-size: 13px; color: #94a3b8; display: flex; align-items: center; gap: 6px;">
                                            <span>vs</span>
                                            ${rivalLogoHtml_res}
                                            <span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${rival}</span>
                                        </div>
                                    ` : `
                                        <div style="font-size: 14px; font-weight: bold; color: #bae6fd; display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
                                            ${rivalLogoHtml_res}
                                            <span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${rival}</span>
                                        </div>
                                        <div style="font-size: 13px; color: #94a3b8; display: flex; align-items: center; gap: 6px;">
                                            <span>vs</span>
                                            ${ourLogoHtml_res}
                                            <span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">CN Terrassa</span>
                                        </div>
                                    `}
                                    <div style="font-size: 11px; color: #64748b; margin-top: 4px;">
                                        ${isHome ? 'üè† Local' : '‚úàÔ∏è Visitant'}
                                    </div>
                                </div>
                                
                                <!-- Marcador -->
                                <div style="text-align: center; flex-shrink: 0;">
                                    <div style="font-size: 24px; font-weight: bold; color: #bae6fd;">
                                        ${isHome ? `${ourScore} - ${theirScore}` : `${theirScore} - ${ourScore}`}
                                    </div>
                                    <div style="font-size: 16px; margin-top: 2px;">
                                        ${resultIcon}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Bot√≥ acta -->
                            <div style="text-align: center;">
                                <a href="${match.url || '#'}" target="_blank" style="display: inline-block; padding: 8px 20px; background: rgba(34, 211, 238, 0.2); color: #22d3ee; border-radius: 6px; text-decoration: none; font-size: 12px;">
                                    üìä Acta
                                </a>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // SENSE MARCADOR
                html += `
                    <div style="background: rgba(148, 163, 184, 0.1); border-left: 4px solid #94a3b8; border-radius: 8px; padding: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                            <div style="flex: 1; min-width: 200px;">
                                <div style="font-size: 12px; color: #94a3b8; margin-bottom: 5px;">
                                    ${date} ${venue ? '‚Ä¢ ' + venue : ''}
                                </div>
                                <div style="font-size: 16px; font-weight: bold; color: #bae6fd;">
                                    CN Terrassa
                                </div>
                                <div style="font-size: 14px; color: #94a3b8; margin-top: 2px;">
                                    vs ${rival}
                                </div>
                                <div style="font-size: 12px; color: #64748b; margin-top: 5px;">
                                    ${isHome ? 'üè† Local' : '‚úàÔ∏è Visitant'}
                                </div>
                            </div>
                            <div style="text-align: center; min-width: 120px;">
                                <div style="font-size: 16px; color: #94a3b8;">
                                    Partit finalitzat
                                </div>
                                <div style="font-size: 12px; color: #64748b; margin-top: 5px;">
                                    Marcador pendent
                                </div>
                            </div>
                            <div style="min-width: 100px; text-align: right;">
                                <a href="${match.url || '#'}" target="_blank" style="display: inline-block; padding: 8px 16px; background: rgba(34, 211, 238, 0.2); color: #22d3ee; border-radius: 6px; text-decoration: none; font-size: 13px;">
                                    üìä Acta
                                </a>
                            </div>
                        </div>
                    </div>
                `;
            }
        });
        
        html += '</div>';
        resultsContainer.innerHTML = html;
    } else if (resultsContainer) {
        resultsContainer.innerHTML = '<p style="color: #94a3b8; text-align: center; padding: 20px;">No hi ha resultats disponibles</p>';
    }
    
    console.log('‚úÖ Partits mostrats!');
}
// Funci√≥ per carregar la classificaci√≥
function loadRankingACTAWP() {
    console.log('üèÜ Carregant classificaci√≥ ACTAWP...');
    
    const teamKey = localStorage.getItem('selectedTeam') || 'juvenil';
    const container = document.getElementById('actawp-ranking-container');
    
    if (!container) {
        console.error('‚ùå No es troba el contenidor actawp-ranking-container');
        return;
    }
    
    // Definir les URLs dels JSON per cada equip
const jsonUrls = {
    'juvenil': 'https://joseprico.github.io/CNT_juvenil_25_26/actawp_juvenil_data.json',
    'cadet': 'https://joseprico.github.io/cnt_cadet_25-26/actawp_cadet_data.json'
};

fetch(jsonUrls[teamKey])
        .then(response => {
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return response.json();
        })
        .then(data => {
            console.log('‚úÖ Dades carregades:', data);
            
            if (!data.ranking || data.ranking.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #bae6fd;">No hi ha classificaci√≥ disponible</p>';
                return;
            }
            
            console.log(`üìä ${data.ranking.length} equips a la classificaci√≥`);
            mostrarClassificacio(data.ranking);
        })
        .catch(error => {
            console.error('‚ùå Error carregant classificaci√≥:', error);
            container.innerHTML = '<p style="text-align: center; color: #ef4444;">Error al carregar la classificaci√≥</p>';
        });
}

function mostrarClassificacio(ranking) {
    const container = document.getElementById('actawp-ranking-container');
    
    let html = `
        <div style="overflow-x: auto; -webkit-overflow-scrolling: touch; margin: 0 -12px; padding: 0 12px;">
            <table class="ranking-table" style="min-width: 600px;">
                <thead>
                    <tr>
                        <th style="width: 50px; padding: 10px 6px; font-size: 11px;">Pos</th>
                        <th style="text-align: left; padding-left: 12px; min-width: 160px; font-size: 11px;">Equip</th>
                        <th style="padding: 10px 6px; font-size: 11px;">PJ</th>
                        <th style="padding: 10px 6px; font-size: 11px;">G</th>
                        <th style="padding: 10px 6px; font-size: 11px;">E</th>
                        <th style="padding: 10px 6px; font-size: 11px;">P</th>
                        <th style="padding: 10px 6px; font-size: 11px;">GF</th>
                        <th style="padding: 10px 6px; font-size: 11px;">GC</th>
                        <th style="padding: 10px 6px; font-size: 11px;">Pts</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    ranking.forEach(team => {
        const isOurTeam = team.equip.toUpperCase().includes('TERRASSA');
        const rowClass = isOurTeam ? 'highlight-team' : '';
        
        // Badge per les primeres 3 posicions
        let posDisplay = team.posicio;
        if (team.posicio === '1') {
            posDisplay = `<span class="position-badge gold" style="width: 22px; height: 22px; line-height: 22px; font-size: 11px;">${team.posicio}</span>`;
        } else if (team.posicio === '2') {
            posDisplay = `<span class="position-badge silver" style="width: 22px; height: 22px; line-height: 22px; font-size: 11px;">${team.posicio}</span>`;
        } else if (team.posicio === '3') {
            posDisplay = `<span class="position-badge bronze" style="width: 22px; height: 22px; line-height: 22px; font-size: 11px;">${team.posicio}</span>`;
        }
        
        // Logo m√©s petit per m√≤bil
        const logoHtml = team.logo 
            ? `<img src="${team.logo}" class="team-logo" style="width: 22px; height: 22px; flex-shrink: 0;" alt="${team.equip}" onerror="this.style.display='none'">` 
            : '<div style="width: 22px; flex-shrink: 0;"></div>';
        
        html += `
            <tr class="${rowClass}">
                <td style="font-weight: bold; color: #22d3ee; padding: 10px 6px; font-size: 12px;">${posDisplay}</td>
                <td style="padding: 10px 8px;">
                    <div class="team-cell" style="gap: 8px; padding-left: 8px !important; min-width: 160px;">
                        ${logoHtml}
                        <span style="color: #e0f2fe; font-weight: 500; font-size: 12px;">${team.equip}</span>
                    </div>
                </td>
                <td style="padding: 10px 6px; font-size: 12px;">${team.partits || 0}</td>
                <td class="stat-wins" style="padding: 10px 6px; font-size: 12px;">${team.guanyats || 0}</td>
                <td class="stat-draws" style="padding: 10px 6px; font-size: 12px;">${team.empatats || 0}</td>
                <td class="stat-losses" style="padding: 10px 6px; font-size: 12px;">${team.perduts || 0}</td>
                <td style="padding: 10px 6px; font-size: 12px;">${team.gols_favor || 0}</td>
                <td style="padding: 10px 6px; font-size: 12px;">${team.gols_contra || 0}</td>
                <td class="stat-points" style="padding: 10px 6px; font-size: 13px; font-weight: bold;">${team.punts || 0}</td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
    console.log('‚úÖ Classificaci√≥ mostrada correctament');
}

// Carregar quan es mostra el tab ACTAWP
console.log('üîß Script de classificaci√≥ carregat');

// Opci√≥ 1: Si ja tens una funci√≥ loadACTAWPData, afegim-hi la classificaci√≥
if (typeof loadACTAWPData === 'function') {
    const originalFunction = loadACTAWPData;
    loadACTAWPData = function() {
        originalFunction();
        setTimeout(loadRankingACTAWP, 500);
    };
    console.log('‚úÖ Classificaci√≥ integrada amb loadACTAWPData');
}

// Opci√≥ 2: Carregar quan es clica el tab ACTAWP
document.addEventListener('DOMContentLoaded', function() {
    const actawpButton = document.querySelector('button[onclick*="actawpTab"]');
    if (actawpButton) {
        actawpButton.addEventListener('click', function() {
            setTimeout(loadRankingACTAWP, 500);
        });
        console.log('‚úÖ Event afegit al bot√≥ ACTAWP');
    }
    
    // Si ja estem al tab ACTAWP, carregar directament
    const actawpTab = document.getElementById('actawpTab');
    if (actawpTab && !actawpTab.classList.contains('hidden')) {
        loadRankingACTAWP();
    }
});


console.log('‚úÖ Funcions de visualitzaci√≥ amb logos carregades');
// ‚òÅÔ∏è Funci√≥ per obtenir el temps
async function getWeatherForMatch(matchDate, location) {
    console.log('üå§Ô∏è getWeatherForMatch cridat!', {matchDate, location}); // ‚¨ÖÔ∏è AFEGIR
    
    if (!WEATHER_API_KEY) {
        console.log('‚ùå No hi ha API key!'); // ‚¨ÖÔ∏è AFEGIR
        return null;
    }
    
    try {
        // Convertir data del partit a format YYYY-MM-DD
        const dateObj = new Date(matchDate);
        const dateStr = dateObj.toISOString().split('T')[0];
        
        console.log('üìÖ Data processada:', dateStr); // ‚¨ÖÔ∏è AFEGIR
        
        // Determinar ubicaci√≥
        let city = 'Terrassa';
        if (location && location.toLowerCase().includes('terrassa')) {
            city = 'Terrassa';
        } else if (location && location.toLowerCase().includes('barcelona')) {
            city = 'Barcelona';
        } else if (location && location.toLowerCase().includes('sabadell')) {
            city = 'Sabadell';
        } else if (location && location.toLowerCase().includes('montju√Øc')) {
            city = 'Barcelona';
        } else if (location) {
            const parts = location.split('-');
            city = parts[0].trim();
        }
        
        console.log('üèôÔ∏è Ciutat detectada:', city); // ‚¨ÖÔ∏è AFEGIR
        
        // Cridar API
        const daysAhead = Math.ceil((dateObj - new Date()) / (1000 * 60 * 60 * 24));
        
        console.log('üìä Dies fins al partit:', daysAhead); // ‚¨ÖÔ∏è AFEGIR
        
        if (daysAhead < 0 || daysAhead > 14) {
            console.log('‚ö†Ô∏è Partit fora del rang (0-14 dies)'); // ‚¨ÖÔ∏è AFEGIR
            return null;
        }
        
        const url = `https://api.weatherapi.com/v1/forecast.json?key=${WEATHER_API_KEY}&q=${city}&days=${Math.min(daysAhead + 1, 14)}&lang=ca`;
        
        console.log('üåê Cridant API:', url); // ‚¨ÖÔ∏è AFEGIR
        
        const response = await fetch(url);
        if (!response.ok) {
            console.log('‚ùå Error API:', response.status); // ‚¨ÖÔ∏è AFEGIR
            return null;
        }
        
        const data = await response.json();
        console.log('‚úÖ Dades rebudes:', data); // ‚¨ÖÔ∏è AFEGIR
        
        // Buscar previsi√≥ del dia del partit
        const forecast = data.forecast.forecastday.find(day => day.date === dateStr);
        
        if (!forecast) {
            console.log('‚ùå No s\'ha trobat previsi√≥ per la data:', dateStr); // ‚¨ÖÔ∏è AFEGIR
            return null;
        }
        
        const weatherResult = {
            temp: Math.round(forecast.day.avgtemp_c),
            condition: forecast.day.condition.text,
            icon: forecast.day.condition.icon
        };
        
        console.log('‚úÖ Temps retornat:', weatherResult); // ‚¨ÖÔ∏è AFEGIR
        
        return weatherResult;
        
    } catch (error) {
        console.log('‚ùå Error obtenir temps:', error); // ‚¨ÖÔ∏è MODIFICAR (ja existeix)
        return null;
    }
}
async function loadNextMatchPill() {
    const container = document.getElementById('next-match-pill');
    
    if (!container) {
        console.error('‚ùå Container next-match-pill no trobat');
        return;
    }
    
    console.log('üìç Carregant pr√≤xim partit...');
    
    if (!actawpData || !actawpData.upcoming_matches || actawpData.upcoming_matches.length === 0) {
        container.innerHTML = '<div>No hi ha pr√≤xims partits</div>';
        return;
    }

    // ‚úÖ FUNCI√ì PER PARSEJAR DATES
    const parseDate = (str) => {
        if (!str) return new Date(9999, 0, 1);
        const m = str.match(/(\d{2})\/(\d{2})\/(\d{4})\s+(\d{2}):(\d{2})/);
        if (!m) return new Date(9999, 0, 1);
        return new Date(m[3], m[2] - 1, m[1], m[4], m[5]);
    };

    const now = new Date();

    // ‚úÖ FILTRAR partits que ja han passat (marge 3h per si est√† en joc)
    const futureMatches = actawpData.upcoming_matches.filter(m => {
        const matchDate = parseDate(m.date_time);
        const matchEndEstimate = new Date(matchDate.getTime() + 3 * 60 * 60 * 1000);
        return matchEndEstimate > now;
    });

    if (futureMatches.length === 0) {
        container.innerHTML = '<div style="color: #fbbf24;">‚è≥ Esperant nous partits de la federaci√≥</div>';
        return;
    }

    // ‚úÖ ORDENAR per data (m√©s proper primer)
    const sortedMatches = futureMatches.sort((a, b) => {
        return parseDate(a.date_time) - parseDate(b.date_time);
    });

    const match = sortedMatches[0];
    const date = match.date || '';
    const time = match.time || '';
    const homeTeam = match.team1 || '?';
    const awayTeam = match.team2 || '?';
    const homeLogo = match.team1_logo || '';
    const awayLogo = match.team2_logo || '';
    const isHome = homeTeam.toUpperCase().includes('TERRASSA');
    
    console.log('‚úÖ Pr√≤xim partit:', homeTeam, 'vs', awayTeam);
    
    // Calcular compte enrere
    let countdownHtml = '';
    if (match.date_time) {
        try {
            const dateStr = match.date_time.replace(/^\w+,?\s+/, '');
            const [datePart, timePart] = dateStr.split(' ');
            const [day, month, year] = datePart.split('/');
            const [hours, minutes] = timePart.split(':');
            
            const matchDate = new Date(year, month - 1, day, hours, minutes);
            const now = new Date();
            const diff = matchDate - now;
            
            if (diff > 0) {
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hrs = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const secs = Math.floor((diff % (1000 * 60)) / 1000);
                
                if (days > 0) {
                    countdownHtml = `
                        <div style="margin-top: 10px; padding: 8px 15px; background: rgba(255,255,255,0.15); border-radius: 20px; display: inline-block;">
                            <span style="font-size: 12px;">‚è±Ô∏è Falten <strong>${days}d ${hrs}h ${mins}m</strong></span>
                        </div>
                    `;
                } else if (hrs > 0) {
                    countdownHtml = `
                        <div style="margin-top: 10px; padding: 8px 15px; background: rgba(251, 191, 36, 0.3); border-radius: 20px; display: inline-block;">
                            <span style="font-size: 12px;">‚è±Ô∏è Falten <strong>${hrs}h ${mins}m ${secs}s</strong></span>
                        </div>
                    `;
                } else if (mins > 0) {
                    countdownHtml = `
                        <div style="margin-top: 10px; padding: 8px 15px; background: rgba(239, 68, 68, 0.4); border-radius: 20px; display: inline-block; animation: pulse 2s infinite;">
                            <span style="font-size: 12px;">üî• Comen√ßa en <strong>${mins}m ${secs}s</strong>!</span>
                        </div>
                    `;
                } else {
                    countdownHtml = `
                        <div style="margin-top: 10px; padding: 8px 15px; background: rgba(239, 68, 68, 0.5); border-radius: 20px; display: inline-block; animation: pulse 1s infinite;">
                            <span style="font-size: 13px; font-weight: bold;">üö® COMEN√áA EN ${secs}s! üö®</span>
                        </div>
                    `;
                }
            }
        } catch (e) {
            console.log('‚ö†Ô∏è Error calculant compte enrere:', e);
        }
    }
    
    // ‚òÅÔ∏è Obtenir el temps
    let weather = null;
    if (match.date_time) {
        const dateStr = match.date_time.replace(/^\w+,?\s+/, '');
        const [datePart, timePart] = dateStr.split(' ');
        const [day, month, year] = datePart.split('/');
        const [hours, minutes] = timePart.split(':');
        const matchDate = new Date(year, month - 1, day, hours, minutes);
        
        let location = 'Barcelona';
        if (isHome) {
            location = 'Terrassa';
        } else {
            const rivalName = homeTeam.toUpperCase();
            if (rivalName.includes('MONTJUIC') || rivalName.includes('MONTJU√èC') || rivalName.includes('BARCELONETA')) {
                location = 'Barcelona';
            } else if (rivalName.includes('SABADELL')) {
                location = 'Sabadell';
            } else if (rivalName.includes('TERRASSA')) {
                location = 'Terrassa';
            } else if (rivalName.includes('MANRESA')) {
                location = 'Manresa';
            } else if (rivalName.includes('MOLINS')) {
                location = 'Barcelona';
            }
        }
        
        weather = await getWeatherForMatch(matchDate, location);
    }
    
    const homeLogoHtml = homeLogo 
        ? `<img src="${homeLogo}" style="width: 40px; height: 40px; object-fit: contain; background: white; border-radius: 50%; padding: 4px;" alt="${homeTeam}" onerror="this.style.display='none';">` 
        : '';
    
    const awayLogoHtml = awayLogo 
        ? `<img src="${awayLogo}" style="width: 40px; height: 40px; object-fit: contain; background: white; border-radius: 50%; padding: 4px;" alt="${awayTeam}" onerror="this.style.display='none';">` 
        : '';

    // üöó Dades del despla√ßament (nom√©s si √©s fora)
    let travelInfo = '';
    if (!isHome) {
        const clubLocations = {
            'C.N. TERRASSA': { name: 'CN Terrassa', address: 'Av. del Vall√®s, 115, Terrassa', lat: 41.5654, lng: 2.0089 },
            'C.N. MANRESA': { name: 'CN Manresa', address: 'Passeig del Riu, 22, Manresa', lat: 41.7285, lng: 1.8262 },
            'C.N. ATL BARCELONETA': { name: 'CN Atl Barceloneta', address: 'Pl. del Mar, s/n, Barcelona', lat: 41.3788, lng: 2.1894 },
            'C.N. BARCELONA': { name: 'CN Barcelona', address: 'Carrer Escullera Llevant, 389, Barcelona', lat: 41.3874, lng: 2.1686 },
            'C.N. MONTJUIC': { name: 'CN Montju√Øc', address: 'Av. de l\'Estadi, 30-38, Barcelona', lat: 41.3644, lng: 2.1519 },
            'C.E. MEDITERRANI': { name: 'CE Mediterrani', address: 'Passeig Mar√≠tim Barceloneta, 33, Barcelona', lat: 41.3851, lng: 2.1734 },
            'C.N. MOLINS DE REI': { name: 'CN Molins de Rei', address: 'C/ Jacint Verdaguer, 10, Molins de Rei', lat: 41.4115, lng: 2.0169 },
            'C.N. RUB√ç': { name: 'CN Rub√≠', address: 'C/ del Pla de les Vinyes, s/n, Rub√≠', lat: 41.4930, lng: 2.0311 },
            'U.E. D\'HORTA': { name: 'UE d\'Horta', address: 'C/ Feliu i Codina, 27, Barcelona', lat: 41.4285, lng: 2.1425 },
            'C.N. SANT ANDREU': { name: 'CN Sant Andreu', address: 'C/ Santa Coloma, 33, Barcelona', lat: 41.4358, lng: 2.1897 },
            'C.N. SABADELL': { name: 'CN Sabadell', address: 'C/ de la Borriana, 45, Sabadell', lat: 41.5463, lng: 2.1086 },
            'C.N. POBLE NOU': { name: 'CN Poble Nou', address: 'C/ Escullera Llevant, 1, Barcelona', lat: 41.4033, lng: 2.2047 }
        };
        
        const rivalName = homeTeam.toUpperCase().trim();
        let rivalData = null;
        
        for (const [key, value] of Object.entries(clubLocations)) {
            const normalizedKey = key.toUpperCase();
            if (normalizedKey === rivalName || 
                rivalName.includes(normalizedKey.replace('C.N. ', '').replace('C.E. ', '').replace('U.E. ', '')) ||
                normalizedKey.includes(rivalName.replace('C.N. ', '').replace('C.E. ', '').replace('U.E. ', ''))) {
                rivalData = value;
                break;
            }
        }
        
        if (rivalData) {
            const homeLat = 41.5654, homeLng = 2.0089;
            const R = 6371;
            const dLat = (rivalData.lat - homeLat) * Math.PI / 180;
            const dLon = (rivalData.lng - homeLng) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(homeLat * Math.PI / 180) * Math.cos(rivalData.lat * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const distance = R * c;
            const drivingTime = Math.round(distance * 2);
            
            travelInfo = `
                <div style="margin-top: 12px; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 12px;">
                    <div style="font-size: 11px; color: #94a3b8; margin-bottom: 6px;">üìç ADRE√áA</div>
                    <div style="font-size: 13px; color: white; margin-bottom: 10px;">${rivalData.address}</div>
                    <div style="display: flex; gap: 12px; justify-content: center;">
                        <div style="background: rgba(255,255,255,0.1); padding: 6px 12px; border-radius: 8px;">
                            <span style="font-size: 11px; color: #94a3b8;">üìè</span>
                            <span style="font-size: 13px; font-weight: 600;">${distance.toFixed(1)} km</span>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); padding: 6px 12px; border-radius: 8px;">
                            <span style="font-size: 11px; color: #94a3b8;">üöó</span>
                            <span style="font-size: 13px; font-weight: 600;">~${drivingTime} min</span>
                        </div>
                    </div>
                </div>
            `;
        }
    }
    
    container.innerHTML = `
        <div style="font-size: 12px; margin-bottom: 12px; color: #bfdbfe;">
            ‚Ä¢ ${date} ${time ? '‚Ä¢ ' + time : ''}
        </div>
        
        <div style="display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 12px;">
            <div style="display: flex; flex-direction: column; align-items: center; gap: 8px; flex: 1;">
                ${homeLogoHtml}
                <div style="font-size: 14px; font-weight: bold; text-align: center; line-height: 1.2;">
                    ${homeTeam}
                </div>
            </div>
            
            <div style="opacity: 0.6; font-size: 16px; font-weight: bold;">VS</div>
            
            <div style="display: flex; flex-direction: column; align-items: center; gap: 8px; flex: 1;">
                ${awayLogoHtml}
                <div style="font-size: 14px; font-weight: bold; text-align: center; line-height: 1.2;">
                    ${awayTeam}
                </div>
            </div>
        </div>
        
        ${countdownHtml}
        
        <div style="margin-top: 10px;">
            <span style="background: rgba(255,255,255,0.2); padding: 3px 10px; border-radius: 12px; font-size: 11px;">
                ${isHome ? 'üè† Casa' : '‚úàÔ∏è Fora'}
            </span>
        </div>
        
        ${weather ? `
        <div style="margin-top: 12px; display: flex; align-items: center; justify-content: center; gap: 8px; background: rgba(255,255,255,0.15); padding: 8px 15px; border-radius: 15px;">
            <img src="https:${weather.icon}" style="width: 32px; height: 32px;" alt="temps">
            <span style="font-weight: 600; font-size: 15px;">${weather.temp}¬∞C</span>
            <span style="color: rgba(255,255,255,0.9); font-size: 12px;">${weather.condition}</span>
        </div>
        ` : ''}
        
        ${travelInfo}
        
        ${!isHome ? `
        <div style="margin-top: 12px;">
            <a href="https://www.google.com/maps/dir/CN+Terrassa,+Terrassa/${encodeURIComponent(homeTeam)}" 
               target="_blank" 
               rel="noopener noreferrer"
               style="display: inline-flex; align-items: center; gap: 8px; background: linear-gradient(135deg, #22d3ee, #0891b2); color: #0f172a; padding: 10px 20px; border-radius: 12px; text-decoration: none; font-size: 13px; font-weight: 700;">
                üöó Com arribar
            </a>
        </div>
        ` : ''}
    `;
}
// üìä AN√ÄLISI DEL RIVAL - VERSI√ì COMPLETA
async function loadRivalHistory() {
    const container = document.getElementById('rivals-map-pill');
    const mapDiv = document.getElementById('rivals-map');
    
    if (!container || !mapDiv) return;
    
    // Buscar el proper rival
    let nextRival = null;
    let isHome = false;
    let nextMatch = null;
    
    if (actawpData && actawpData.upcoming_matches && actawpData.upcoming_matches.length > 0) {
        nextMatch = actawpData.upcoming_matches[0];
        const homeTeam = nextMatch.team1 || '';
        const awayTeam = nextMatch.team2 || '';
        isHome = homeTeam.toUpperCase().includes('TERRASSA');
        nextRival = isHome ? awayTeam : homeTeam;
    }
    
    if (!nextRival) {
        mapDiv.innerHTML = '<div style="text-align: center; color: #94a3b8; padding: 20px;">No hi ha pr√≤xim rival</div>';
        return;
    }
    
    // Logos
    const cntLogo = isHome ? (nextMatch.team1_logo || '') : (nextMatch.team2_logo || '');
    const rivalLogo = isHome ? (nextMatch.team2_logo || '') : (nextMatch.team1_logo || '');
    
    // Normalitzar nom
    const normalizeTeamName = (name) => {
        return name.toUpperCase()
            .replace(/C\.N\./g, '').replace(/CN/g, '')
            .replace(/C\.E\./g, '').replace(/CE/g, '')
            .replace(/U\.E\./g, '').replace(/UE/g, '')
            .replace(/[''`¬¥]/g, '')
            .replace(/\s+/g, ' ')
            .trim();
    };
    
    const normalizedRival = normalizeTeamName(nextRival);
    
    // Buscar posici√≥ a la classificaci√≥
    let rivalPosition = '-';
    let rivalPoints = 0;
    let cntPosition = '-';
    let cntPoints = 0;
    if (actawpData.ranking) {
        actawpData.ranking.forEach((team, idx) => {
            const teamName = team.equip || '';
            if (normalizeTeamName(teamName).includes(normalizedRival.substring(0, 8)) ||
                normalizedRival.includes(normalizeTeamName(teamName).substring(0, 8))) {
                rivalPosition = team.posicio || (idx + 1);
                rivalPoints = team.punts || 0;
            }
            if (teamName.toUpperCase().includes('TERRASSA')) {
                cntPosition = team.posicio || (idx + 1);
                cntPoints = team.punts || 0;
            }
        });
    }
    
  // Buscar dades del rival PRIMER
    let rivalFormData = null;
    let topScorers = [];
    
    if (actawpData.rivals_form) {
        for (const [teamName, data] of Object.entries(actawpData.rivals_form)) {
            if (normalizeTeamName(teamName).includes(normalizedRival.substring(0, 8)) ||
                normalizedRival.includes(normalizeTeamName(teamName).substring(0, 8))) {
                rivalFormData = data;
                topScorers = data.top_scorers || [];
                break;
            }
        }
    }

    // Historial vs CNT - buscar a DUES fonts
    let vsWins = 0, vsDraws = 0, vsLosses = 0, vsGF = 0, vsGC = 0;
    let vsMatches = [];
    let processedMatches = new Set();
    
    const processResult = (r) => {
        const t1 = (r.team1 || '').toUpperCase();
        const t2 = (r.team2 || '').toUpperCase();
        
        const rivalInMatch = t1.includes(normalizedRival.substring(0, 8)) || t2.includes(normalizedRival.substring(0, 8)) ||
                            normalizedRival.includes(t1.substring(0, 8)) || normalizedRival.includes(t2.substring(0, 8));
        const terrassaInMatch = t1.includes('TERRASSA') || t2.includes('TERRASSA');
        
        if (rivalInMatch && terrassaInMatch) {
            const matchKey = `${t1}-${t2}-${r.score || ''}`;
            if (processedMatches.has(matchKey)) return;
            processedMatches.add(matchKey);
            
            const parts = (r.score || '0-0').replace(/\s/g, '').split('-');
            const g1 = parseInt(parts[0]) || 0;
            const g2 = parseInt(parts[1]) || 0;
            
            const cntIsTeam1 = t1.includes('TERRASSA');
            const gCNT = cntIsTeam1 ? g1 : g2;
            const gRival = cntIsTeam1 ? g2 : g1;
            
            vsGF += gCNT;
            vsGC += gRival;
            
            if (gCNT > gRival) vsWins++;
            else if (gCNT < gRival) vsLosses++;
            else vsDraws++;
            
            vsMatches.push({ gCNT, gRival, home: cntIsTeam1 });
        }
    };
    
    // 1. Buscar als nostres resultats
    if (actawpData.last_results) {
        actawpData.last_results.forEach(processResult);
    }
    
    // 2. Buscar als resultats del rival
    if (rivalFormData && rivalFormData.last_results) {
        rivalFormData.last_results.forEach(processResult);
    }
    
 
    
    const stats = rivalFormData?.stats || {};
    const formArray = rivalFormData?.form || [];
    const avgGf = stats.avg_gf || 0;
    const avgGc = stats.avg_gc || 0;
    
    // Forma icons
    const formIcons = formArray.slice(0, 5).map(r => {
        if (r === 'W') return '<span style="display: inline-block; width: 24px; height: 24px; line-height: 24px; text-align: center; background: #22c55e; color: white; border-radius: 50%; font-size: 11px; font-weight: bold;">V</span>';
        if (r === 'L') return '<span style="display: inline-block; width: 24px; height: 24px; line-height: 24px; text-align: center; background: #ef4444; color: white; border-radius: 50%; font-size: 11px; font-weight: bold;">D</span>';
        return '<span style="display: inline-block; width: 24px; height: 24px; line-height: 24px; text-align: center; background: #fbbf24; color: white; border-radius: 50%; font-size: 11px; font-weight: bold;">E</span>';
    }).join(' ');
    
    // Punts forts i febles
    let puntsForts = [];
    let puntsFebles = [];
    
    if (avgGf >= 15) puntsForts.push('Atac potent (' + avgGf + ' g/p)');
    else if (avgGf < 10) puntsFebles.push('Atac limitat (' + avgGf + ' g/p)');
    
    if (avgGc <= 8) puntsForts.push('Defensa s√≤lida (' + avgGc + ' g/p)');
    else if (avgGc >= 12) puntsFebles.push('Defensa feble (' + avgGc + ' g/p)');
    
    if (formArray.slice(0, 3).filter(f => f === 'W').length >= 2) puntsForts.push('En bon moment');
    if (formArray.slice(0, 3).filter(f => f === 'L').length >= 2) puntsFebles.push('Mal moment de forma');
    
    // Generar HTML
    mapDiv.style.height = 'auto';
    mapDiv.innerHTML = `
        <div style="padding: 15px;">
            
            <!-- Header amb logos -->
            <div style="display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 15px;">
                <div style="text-align: center;">
                    <div style="width: 50px; height: 50px; background: white; border-radius: 50%; margin: 0 auto 5px; display: flex; align-items: center; justify-content: center; overflow: hidden; padding: 3px;">
                        ${cntLogo ? '<img src="' + cntLogo + '" style="max-width: 100%; max-height: 100%; object-fit: contain;">' : 'üîµ'}
                    </div>
                    <div style="font-size: 11px; color: rgba(255,255,255,0.8);">${cntPosition}¬∫</div>
                </div>
                
                <div style="text-align: center;">
                    <div style="font-size: 16px; font-weight: 700; color: white;">VS</div>
                    <div style="font-size: 10px; color: rgba(255,255,255,0.7);">${isHome ? 'üè† Casa' : '‚úàÔ∏è Fora'}</div>
                </div>
                
                <div style="text-align: center;">
                    <div style="width: 50px; height: 50px; background: white; border-radius: 50%; margin: 0 auto 5px; display: flex; align-items: center; justify-content: center; overflow: hidden; padding: 3px;">
                        ${rivalLogo ? '<img src="' + rivalLogo + '" style="max-width: 100%; max-height: 100%; object-fit: contain;">' : '‚ö™'}
                    </div>
                    <div style="font-size: 11px; color: rgba(255,255,255,0.8);">${rivalPosition}¬∫</div>
                </div>
            </div>
            
            <div style="text-align: center; margin-bottom: 15px;">
                <div style="font-size: 15px; font-weight: 700; color: white;">${nextRival}</div>
                <div style="font-size: 11px; color: rgba(255,255,255,0.7);">Jornada ${nextMatch.jornada || '?'} ¬∑ ${nextMatch.date || ''} ¬∑ ${nextMatch.time || ''}h</div>
            </div>
            
             <!-- Historial vs CNT -->
            <div style="background: rgba(0,0,0,0.3); border-radius: 10px; padding: 12px; margin-bottom: 12px;">
                <div style="font-size: 10px; color: #94a3b8; text-transform: uppercase; margin-bottom: 8px;">üÜö Historial vs CNT</div>
                ${getHistorialVsCNT(nextRival)}
            </div>
            
            <!-- Stats i Forma -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
                <div style="background: rgba(0,0,0,0.3); border-radius: 10px; padding: 10px; text-align: center;">
                    <div style="font-size: 10px; color: #94a3b8; margin-bottom: 5px;">‚öΩ ATAC</div>
                    <div style="font-size: 18px; font-weight: 700; color: #22c55e;">${avgGf}</div>
                    <div style="font-size: 9px; color: #94a3b8;">gols/partit</div>
                </div>
                <div style="background: rgba(0,0,0,0.3); border-radius: 10px; padding: 10px; text-align: center;">
                    <div style="font-size: 10px; color: #94a3b8; margin-bottom: 5px;">üõ°Ô∏è DEFENSA</div>
                    <div style="font-size: 18px; font-weight: 700; color: #ef4444;">${avgGc}</div>
                    <div style="font-size: 9px; color: #94a3b8;">rebuts/partit</div>
                </div>
            </div>
            
            <!-- Forma -->
            <div style="background: rgba(0,0,0,0.3); border-radius: 10px; padding: 10px; margin-bottom: 12px; text-align: center;">
                <div style="font-size: 10px; color: #94a3b8; margin-bottom: 8px;">üìà FORMA ACTUAL</div>
                <div>${formIcons || '<span style="color: #64748b;">Sense dades</span>'}</div>
            </div>
            
	<!-- √öltims resultats del rival -->
            ${(function() {
                if (!rivalFormData || !rivalFormData.last_results || rivalFormData.last_results.length === 0) return '';
                
                let resultsHtml = '<div style="background: rgba(0,0,0,0.3); border-radius: 10px; padding: 10px; margin-bottom: 12px;">';
                resultsHtml += '<div style="font-size: 10px; color: #94a3b8; text-transform: uppercase; margin-bottom: 8px;">üìä √öltims resultats</div>';
                
                rivalFormData.last_results.slice(0, 5).forEach(r => {
                    const t1 = r.team1 || '';
                    const t2 = r.team2 || '';
                    const score = r.score || '0-0';
                    const parts = score.split('-');
                    const g1 = parseInt(parts[0]) || 0;
                    const g2 = parseInt(parts[1]) || 0;
                    
                    const rivalIsTeam1 = normalizeTeamName(t1).includes(normalizedRival.substring(0, 6)) || 
                                        normalizedRival.includes(normalizeTeamName(t1).substring(0, 6));
                    const gRival = rivalIsTeam1 ? g1 : g2;
                    const gOponent = rivalIsTeam1 ? g2 : g1;
                    const oponent = rivalIsTeam1 ? t2 : t1;
                    const oponentLogo = rivalIsTeam1 ? (r.team2_logo || '') : (r.team1_logo || '');
                    
                    let resultIcon, bgColor;
                    if (gRival > gOponent) {
                        resultIcon = '‚úÖ';
                        bgColor = 'rgba(34, 197, 94, 0.2)';
                    } else if (gRival < gOponent) {
                        resultIcon = '‚ùå';
                        bgColor = 'rgba(239, 68, 68, 0.2)';
                    } else {
                        resultIcon = '‚ûñ';
                        bgColor = 'rgba(251, 191, 36, 0.2)';
                    }
                    
                    const oponentShort = oponent.replace(/C\.N\.|C\.E\.|U\.E\./g, '').trim();
                    const isHome = rivalIsTeam1;
                    const logoHtml = oponentLogo ? '<img src="' + oponentLogo + '" style="width: 16px; height: 16px; border-radius: 3px; background: white;">' : '';
                    const oponentDisplay = oponentShort.length > 12 ? oponentShort.substring(0, 12) + '...' : oponentShort;
                    
                    resultsHtml += '<div style="display: flex; align-items: center; justify-content: space-between; padding: 6px 8px; background: ' + bgColor + '; border-radius: 6px; margin-bottom: 4px;">';
                    resultsHtml += '<div style="display: flex; align-items: center; gap: 6px;">';
                    resultsHtml += '<span style="font-size: 12px;">' + resultIcon + '</span>';
                    resultsHtml += '<span style="font-size: 10px; color: #64748b;">' + (isHome ? 'üè†' : '‚úàÔ∏è') + '</span>';
                    resultsHtml += logoHtml;
                    resultsHtml += '<span style="font-size: 11px; color: white;">' + oponentDisplay + '</span>';
                    resultsHtml += '</div>';
                    resultsHtml += '<span style="font-size: 12px; font-weight: bold; color: white;">' + gRival + ' - ' + gOponent + '</span>';
                    resultsHtml += '</div>';
                });
                
                resultsHtml += '</div>';
                return resultsHtml;
            })()}
			
            <!-- Jugadors a vigilar -->
${topScorers.length > 0 ? `
    <div style="background: rgba(0,0,0,0.3); border-radius: 10px; padding: 10px; margin-bottom: 12px;">
        <div style="font-size: 10px; color: #94a3b8; text-transform: uppercase; margin-bottom: 8px;">‚ö†Ô∏è Jugadors a vigilar</div>
        ${topScorers.slice(0, 5).map((p, i) => {
            const danger = (p.goals || 0) >= 10 ? 'üî¥' : (p.goals || 0) >= 5 ? 'üü°' : 'üü¢';
            const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : 'üèÖ';
            const avgGoals = p.avg_goals || (p.games > 0 ? (p.goals / p.games).toFixed(1) : '0');
            return `
                <div style="background: rgba(255,255,255,0.05); border-radius: 8px; padding: 8px; margin-bottom: 6px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px;">
                        <span style="font-size: 12px; color: white; font-weight: 600;">${medal} ${p.name || 'Desconegut'}</span>
                        <span style="font-size: 14px;">${danger}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 10px; color: #94a3b8;">
                        <span>‚öΩ <strong style="color: #fbbf24;">${p.goals || 0}</strong> gols</span>
                        <span>üéØ <strong style="color: #22c55e;">${p.penalty_goals || 0}</strong> penals</span>
                        <span>üü• <strong style="color: #ef4444;">${p.exclusions || 0}</strong> excl.</span>
                        <span>üéÆ <strong style="color: white;">${p.games || 0}</strong> PJ</span>
                    </div>
                    <div style="font-size: 9px; color: #64748b; margin-top: 3px;">
                        Mitjana: ${avgGoals} gols/partit
                    </div>
                </div>
            `;
        }).join('')}
    </div>
` : ''}
            
            <!-- Punts forts i febles -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div style="background: rgba(239, 68, 68, 0.3); border-radius: 10px; padding: 10px;">
                    <div style="font-size: 10px; color: #fca5a5; margin-bottom: 5px;">üí™ Punts forts</div>
                    ${puntsForts.length > 0 ? 
                        puntsForts.map(p => '<div style="font-size: 10px; color: white; margin-bottom: 2px;">‚Ä¢ ' + p + '</div>').join('') :
                        '<div style="font-size: 10px; color: rgba(255,255,255,0.5);">Cap destacat</div>'
                    }
                </div>
                <div style="background: rgba(34, 197, 94, 0.3); border-radius: 10px; padding: 10px;">
                    <div style="font-size: 10px; color: #86efac; margin-bottom: 5px;">üéØ Punts febles</div>
                    ${puntsFebles.length > 0 ? 
                        puntsFebles.map(p => '<div style="font-size: 10px; color: white; margin-bottom: 2px;">‚Ä¢ ' + p + '</div>').join('') :
                        '<div style="font-size: 10px; color: rgba(255,255,255,0.5);">Cap destacat</div>'
                    }
                </div>
            </div>
            
        </div>
    `;
}
function loadLastResultsMini() {
    const container = document.getElementById('last-results-mini');
    
    if (!container) {
        console.error('‚ùå Container last-results-mini no trobat');
        return;
    }
    
    console.log('üìç Carregant √∫ltims resultats...');
    
    if (!actawpData || !actawpData.last_results || actawpData.last_results.length === 0) {
        container.style.display = 'none';
        return;
    }
    
    // Agafar els √∫ltims 3 resultats
    const lastResults = actawpData.last_results.slice(0, 3);
    
    console.log('‚úÖ √öltims resultats:', lastResults);
    
    let html = '<div style="display: flex; align-items: center; justify-content: center; gap: 15px; flex-wrap: wrap; font-size: 12px;">';
    html += '<span style="font-weight: bold; color: #22d3ee;">üìä √öltims resultats:</span>';
    
    lastResults.forEach(result => {
        const team1 = result.team1 || '?';
        const team2 = result.team2 || '?';
        const score1 = result.score_team1 || 0;
        const score2 = result.score_team2 || 0;
        
        // Determinar si CN Terrassa va guanyar
        const isCNTTeam1 = team1.toUpperCase().includes('TERRASSA');
        const isCNTTeam2 = team2.toUpperCase().includes('TERRASSA');
        
        let won = false;
        let rival = '';
        let scoreCNT = 0;
        let scoreRival = 0;
        
        if (isCNTTeam1) {
            won = score1 > score2;
            rival = team2;
            scoreCNT = score1;
            scoreRival = score2;
        } else if (isCNTTeam2) {
            won = score2 > score1;
            rival = team1;
            scoreCNT = score2;
            scoreRival = score1;
        }
        
        const resultIcon = won ? '‚úÖ' : '‚ùå';
        const resultColor = won ? '#10b981' : '#ef4444';
        
        html += `
            <div style="display: flex; align-items: center; gap: 6px;">
                <span style="font-size: 14px;">${resultIcon}</span>
                <span style="font-weight: bold; color: ${resultColor};">${scoreCNT}-${scoreRival}</span>
                <span style="color: #64748b;">vs ${rival.length > 15 ? rival.substring(0, 15) + '...' : rival}</span>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}
function loadRankingPill() {
    const container = document.getElementById('ranking-pill');
    
    if (!container) {
        console.error('‚ùå Container ranking-pill no trobat');
        return;
    }
    
    console.log('üìç Carregant classificaci√≥...');
    
    if (!actawpData || !actawpData.ranking || actawpData.ranking.length === 0) {
        container.innerHTML = '<div style="color: #64748b; text-align: center; font-size: 11px;">No hi ha classificaci√≥</div>';
        return;
    }
    
    const top8 = actawpData.ranking.slice(0, 8);
    
    console.log('‚úÖ Classificaci√≥ top 8:', top8);
    
    let html = '<div style="display: flex; flex-direction: column; gap: 6px;">';
    
    top8.forEach(team => {
    const isOurTeam = team.equip.toUpperCase().includes('TERRASSA');
    const bgColor = isOurTeam ? 'rgba(59, 130, 246, 0.1)' : 'transparent';
    const borderLeft = isOurTeam ? '3px solid #3b82f6' : '3px solid transparent';
    
    // Logo de l'equip
    const logoHtml = team.logo 
        ? `<img src="${team.logo}" style="width: 20px; height: 20px; object-fit: contain; background: white; border-radius: 3px; padding: 2px;" alt="${team.equip}" onerror="this.style.display='none';">` 
        : '';
    
    html += `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 8px; background: ${bgColor}; border-radius: 4px; border-left: ${borderLeft}; font-size: 11px; gap: 8px;">
            <!-- Posici√≥ + Logo + Nom -->
            <div style="display: flex; align-items: center; gap: 6px; flex: 1; min-width: 0;">
                <span style="font-weight: bold; width: 15px; font-size: 10px; flex-shrink: 0;">${team.posicio}.</span>
                ${logoHtml}
                <span style="font-weight: ${isOurTeam ? 'bold' : 'normal'}; color: ${isOurTeam ? '#3b82f6' : 'inherit'}; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                    ${team.equip}
                </span>
            </div>
            
            <!-- Estad√≠stiques -->
            <div style="display: flex; align-items: center; gap: 8px; flex-shrink: 0;">
                <span style="color: #94a3b8; font-size: 10px;" title="Partits jugats">PJ: ${team.partits || 0}</span>
                <span style="color: #10b981; font-size: 10px;" title="Guanyats">V: ${team.guanyats || 0}</span>
                <span style="color: #ef4444; font-size: 10px;" title="Perduts">D: ${team.perduts || 0}</span>
                <span style="font-weight: bold; color: ${isOurTeam ? '#3b82f6' : 'inherit'}; font-size: 11px;">${team.punts} pts</span>
            </div>
        </div>
    `;
});
    
    html += '</div>';
    container.innerHTML = html;
}


function loadTeamSpirit() {
    const container = document.getElementById('team-spirit-content');
    
    if (!container) {
        console.error('‚ùå Container team-spirit-content no trobat');
        return;
    }
    
    console.log('üìç Carregant esperit d\'equip...');
    
    if (!allMatches || allMatches.length === 0) {
        document.getElementById('team-spirit').style.display = 'none';
        return;
    }
    
    // Calcular estad√≠stiques d'equip
    let totalGoals = 0;
    let totalGoalsAgainst = 0;
    let wins = 0;
    let draws = 0;
    let losses = 0;
    let consecutiveWins = 0;
    let currentStreak = 0;
    let homeWins = 0;
    let homeMatches = 0;
    let awayWins = 0;
    let awayMatches = 0;
    let biggestWin = { margin: 0, rival: '', score: '' };
    let cleanSheets = 0; // Partits sense encaixar gols
    let comebacks = 0; // Remuntades (si tenim dades per quarters)
    
    // Iterar pels partits (ja estan ordenats per data desc)
    allMatches.forEach((match, index) => {
        const scoreCNT = match.scoreCNT || 0;
        const scoreRival = match.scoreRival || 0;
        const isHome = match.location === 'home';
        const rival = match.rivalTeam || 'Rival';
        
        totalGoals += scoreCNT;
        totalGoalsAgainst += scoreRival;
        
        const won = scoreCNT > scoreRival;
        const draw = scoreCNT === scoreRival;
        
        if (won) {
            wins++;
            const margin = scoreCNT - scoreRival;
            if (margin > biggestWin.margin) {
                biggestWin = {
                    margin: margin,
                    rival: rival,
                    score: `${scoreCNT}-${scoreRival}`
                };
            }
        } else if (draw) {
            draws++;
        } else {
            losses++;
        }
        
        // Clean sheets
        if (scoreRival === 0) cleanSheets++;
        
        if (isHome) {
            homeMatches++;
            if (won) homeWins++;
        } else {
            awayMatches++;
            if (won) awayWins++;
        }
        
        // Calcular ratxa actual (√∫ltims partits consecutius)
        if (index === 0 && won) {
            currentStreak = 1;
            for (let i = 1; i < allMatches.length; i++) {
                const prevMatch = allMatches[i];
                if ((prevMatch.scoreCNT || 0) > (prevMatch.scoreRival || 0)) {
                    currentStreak++;
                } else {
                    break;
                }
            }
        }
    });
    
    const totalMatches = allMatches.length;
    const avgGoals = totalMatches > 0 ? (totalGoals / totalMatches).toFixed(1) : 0;
    const avgGoalsAgainst = totalMatches > 0 ? (totalGoalsAgainst / totalMatches).toFixed(1) : 0;
    const winRate = totalMatches > 0 ? Math.round((wins / totalMatches) * 100) : 0;
    const homeWinRate = homeMatches > 0 ? Math.round((homeWins / homeMatches) * 100) : 0;
    const awayWinRate = awayMatches > 0 ? Math.round((awayWins / awayMatches) * 100) : 0;
    const goalDifference = totalGoals - totalGoalsAgainst;
    
    console.log('üìä Estad√≠stiques:', {
        totalMatches,
        wins,
        currentStreak,
        avgGoals,
        winRate,
        goalDifference,
        biggestWin
    });
    
  

// Frases motivadoras segons les estad√≠stiques
const motivationalPhrases = [
    "L'equip √©s primer, la vict√≤ria √©s de tots! üíô",
    "Junts som m√©s forts! ü§ù",
    "Un per tots, tots per un! ‚ö°",
    "Treballem units, guanyem junts! üî•",
    "La for√ßa est√† en l'equip! üí™",
    "Cada gol √©s un triomf col¬∑lectiu! ‚öΩ",
    "Units cap a la vict√≤ria! üèÜ",
    "Mai ens rendim, sempre endavant! üöÄ",
    "L'esfor√ß d'avui √©s l'√®xit de dem√†! üåü",
    "Amb coratge i passi√≥, tot √©s possible! ‚ù§Ô∏è‚Äçüî•",
    "Lluitar fins al final √©s el nostre estil! üõ°Ô∏è",
    "L'equip no es construeix en un dia, per√≤ cada dia compta! üìÜ"
];

// Frases especials segons situaci√≥
let phrase = '';
const isStartOfSeason = totalMatches <= 3;
const isMidSeason = totalMatches > 3 && totalMatches <= 10;
const isEndOfSeason = totalMatches > 10;
const lastMatch = allMatches[0];
const isLastHome = lastMatch?.location === 'home';
const isLastAway = lastMatch?.location === 'away';
const strongRivals = ['CN Atl√®tic-Barceloneta', 'CN Sabadell', 'CN Matar√≥']; // Exemples

if (currentStreak >= 7) {
    phrase = `üî• ${currentStreak} vict√≤ries seguides! SOM UNA M√ÄQUINA!`;
} else if (currentStreak >= 5) {
    phrase = `üî• ${currentStreak} vict√≤ries seguides! IMPARABLES!`;
} else if (currentStreak >= 3) {
    phrase = `üí• ${currentStreak} vict√≤ries consecutives! Seguim aix√≠!`;
} else if (losses >= 3 && wins === 0) {
    phrase = "Moments dif√≠cils, per√≤ l'equip no es rendeix mai! üí™";
} else if (draws >= 2 && wins === 0) {
    phrase = "Empats seguits... ens falta molt poc per tornar a guanyar! ü§è";
} else if (winRate >= 85) {
    phrase = "Temporada de somni! Continuem amb aquesta energia! üåü";
} else if (winRate >= 70) {
    phrase = "Gran rendiment! L'equip est√† en forma! üèãÔ∏è‚Äç‚ôÇÔ∏è";
} else if (winRate >= 60) {
    phrase = "Bon ritme d'equip! A per m√©s vict√≤ries! üí™";
} else if (goalDifference >= 30) {
    phrase = "Atac letal! Estem fent hist√≤ria! ‚ö°";
} else if (goalDifference >= 15) {
    phrase = "Gran difer√®ncia de gols! Seguim marcant! ‚öΩ";
} else if (goalDifference < 0 && losses > wins) {
    phrase = "Toca aixecar el cap i tornar a lluitar! üîÅ";
} else if (avgGoalsAgainst > 12) {
    phrase = "Ens estan marcant massa... toca refor√ßar la defensa! üõ°Ô∏è";
} else if (wins === 0 && totalMatches >= 3) {
    phrase = "Encara no hem guanyat, per√≤ cada partit √©s una oportunitat nova! üîÑ";
} else if (isLastHome && winRate >= 60) {
    phrase = "üè† A casa som forts! Gr√†cies afici√≥! üíô";
} else if (isLastAway && awayWinRate >= 60) {
    phrase = "‚úàÔ∏è Guanyar fora de casa t√© molt m√®rit! Seguim! üí™";
} else if (isStartOfSeason) {
    phrase = "Comencem amb for√ßa! Aquesta temporada promet! üöÄ";
} else if (isMidSeason) {
    phrase = "Estem a la meitat del cam√≠, cada punt compta! üß≠";
} else if (isEndOfSeason && winRate >= 60) {
    phrase = "√öltims partits! Donem-ho tot fins al final! üèÅ";
} else if (strongRivals.includes(lastMatch?.rivalTeam)) {
    phrase = `Gran partit contra ${lastMatch.rivalTeam}! üí• Lluita de gegants!`;
} else {
    // Frase aleat√≤ria motivadora
    phrase = motivationalPhrases[Math.floor(Math.random() * motivationalPhrases.length)];
}


    
    // HTML amb estad√≠stiques principals
    let html = `
        <div style="font-style: italic; font-size: 13px; margin-bottom: 12px; opacity: 0.95;">
            "${phrase}"
        </div>
        
        <!-- Estad√≠stiques principals (sempre visibles) -->
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px;">
            <div style="background: rgba(255,255,255,0.15); padding: 8px; border-radius: 8px;">
                <div style="font-size: 18px; font-weight: bold;">${wins}</div>
                <div style="font-size: 10px; opacity: 0.9;">Vict√≤ries</div>
            </div>
            <div style="background: rgba(255,255,255,0.15); padding: 8px; border-radius: 8px;">
                <div style="font-size: 18px; font-weight: bold;">${avgGoals}</div>
                <div style="font-size: 10px; opacity: 0.9;">Gols/partit</div>
            </div>
            <div style="background: rgba(255,255,255,0.15); padding: 8px; border-radius: 8px;">
                <div style="font-size: 18px; font-weight: bold;">${winRate}%</div>
                <div style="font-size: 10px; opacity: 0.9;">√àxit</div>
            </div>
        </div>
        
        <!-- M√©s estad√≠stiques destacades -->
        <div style="display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; font-size: 11px; margin-top: 12px;">
    `;
    
    // Difer√®ncia de gols (si √©s positiva)
    if (goalDifference > 0) {
        html += `
            <div style="background: rgba(16, 185, 129, 0.3); padding: 5px 10px; border-radius: 12px;">
                <strong>+${goalDifference}</strong> difer√®ncia gols
            </div>
        `;
    }
    
    // Ratxa actual
    if (currentStreak >= 2) {
        html += `
            <div style="background: rgba(239, 68, 68, 0.3); padding: 5px 10px; border-radius: 12px;">
                üî• <strong>${currentStreak}</strong> seguides
            </div>
        `;
    }
    
    // Vict√≤ries a casa (si > 50%)
    if (homeWinRate > 50 && homeMatches > 0) {
        html += `
            <div style="background: rgba(59, 130, 246, 0.3); padding: 5px 10px; border-radius: 12px;">
                üè† <strong>${homeWinRate}%</strong> a casa
            </div>
        `;
    }
    
    // Vict√≤ries fora (si > 50%)
    if (awayWinRate > 50 && awayMatches > 0) {
        html += `
            <div style="background: rgba(168, 85, 247, 0.3); padding: 5px 10px; border-radius: 12px;">
                ‚úàÔ∏è <strong>${awayWinRate}%</strong> fora
            </div>
        `;
    }
    
    // Clean sheets
    if (cleanSheets > 0) {
        html += `
            <div style="background: rgba(34, 211, 238, 0.3); padding: 5px 10px; border-radius: 12px;">
                üõ°Ô∏è <strong>${cleanSheets}</strong> porteria a zero
            </div>
        `;
    }
    
    // Golejada m√©s gran
    if (biggestWin.margin >= 5) {
        html += `
            <div style="background: rgba(251, 191, 36, 0.3); padding: 5px 10px; border-radius: 12px;">
                ‚ö° Millor: <strong>${biggestWin.score}</strong> vs ${biggestWin.rival.length > 12 ? biggestWin.rival.substring(0, 12) + '...' : biggestWin.rival}
            </div>
        `;
    }
    
    // Promig gols en contra (si √©s baix)
    if (avgGoalsAgainst < 8) {
        html += `
            <div style="background: rgba(16, 185, 129, 0.3); padding: 5px 10px; border-radius: 12px;">
                üõ°Ô∏è Nom√©s <strong>${avgGoalsAgainst}</strong> gols rebuts/partit
            </div>
        `;
    }
    
    // Total gols marcats (si √©s alt)
    if (totalGoals >= 100) {
        html += `
            <div style="background: rgba(239, 68, 68, 0.3); padding: 5px 10px; border-radius: 12px;">
                üéØ <strong>${totalGoals}</strong> gols totals
            </div>
        `;
    }
    
    html += '</div>';
    
    container.innerHTML = html;
    console.log('‚úÖ Esperit d\'equip carregat amb estad√≠stiques ampliades');
}
// Variable global per guardar l'interval
var countdownInterval = null;

function startCountdownTimer() {
    // Netejar interval anterior si existeix
    if (countdownInterval) {
        clearInterval(countdownInterval);
    }
    
    // Funci√≥ per determinar l'interval segons el temps restant
    function getUpdateInterval() {
        if (!actawpData || !actawpData.upcoming_matches || actawpData.upcoming_matches.length === 0) {
            return 60000; // 1 minut per defecte
        }
        
        const match = actawpData.upcoming_matches[0];
        if (!match.date_time) return 60000;
        
        try {
            const dateStr = match.date_time.replace(/^\w+,?\s+/, '');
            const [datePart, timePart] = dateStr.split(' ');
            const [day, month, year] = datePart.split('/');
            const [hours, minutes] = timePart.split(':');
            
            const matchDate = new Date(year, month - 1, day, hours, minutes);
            const now = new Date();
            const diff = matchDate - now;
            
            // Si falta menys d'1 hora: actualitzar cada 10 segons
            if (diff > 0 && diff < 3600000) {
                return 10000;
            }
            // Si falta menys d'1 dia: actualitzar cada 30 segons
            else if (diff > 0 && diff < 86400000) {
                return 30000;
            }
            // Altrament: cada minut
            else {
                return 60000;
            }
        } catch (e) {
            return 60000;
        }
    }
    
    // Actualitzar amb l'interval adequat
    const interval = getUpdateInterval();
    countdownInterval = setInterval(() => {
        console.log('üîÑ Actualitzant compte enrere...');
        loadNextMatchPill();
        
        // Reajustar interval si cal
        const newInterval = getUpdateInterval();
        if (newInterval !== interval) {
            startCountdownTimer(); // Reiniciar amb nou interval
        }
    }, interval);
    
    console.log(`‚è±Ô∏è Compte enrere din√†mic activat (actualitzaci√≥ cada ${interval/1000}s)`);
}

function stopCountdownTimer() {
    if (countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
        console.log('‚èπÔ∏è Compte enrere din√†mic desactivat');
    }
}
async function loadFrontPagePills() {
    console.log('üé® Carregant pastilles portada...');
    
    // ‚≠ê CANVI CLAU: Sempre recarregar actawpData amb l'equip correcte
    const teamKey = localStorage.getItem('selectedTeam') || 'juvenil';
    console.log('üìã Equip seleccionat:', teamKey);
    
    // For√ßar rec√†rrega de les dades de l'equip correcte
    await loadACTAWPDataForTeam(teamKey);
    
    console.log('‚úÖ ACTAWP Data carregades per:', teamKey, actawpData);
    
    loadNextMatchPill();
    loadRankingPill();
    loadLastResultsMini();
	// Carregar mapa de rivals
loadRivalHistory()

    
    // ‚≠ê Iniciar compte enrere din√†mic
    startCountdownTimer();
}
// Detectar iOS
function isIOS() {
    return /iPhone|iPad|iPod/.test(navigator.userAgent) || 
           (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
}

// Detectar si ja est√† instal¬∑lada com PWA
function isInstalledPWA() {
    // M√®tode 1: Display mode standalone
    if (window.matchMedia('(display-mode: standalone)').matches) {
        return true;
    }
    
    // M√®tode 2: iOS standalone
    if (window.navigator.standalone === true) {
        return true;
    }
    
    // M√®tode 3: Referrer (si ve d'una PWA instal¬∑lada)
    if (document.referrer.includes('android-app://')) {
        return true;
    }
    
    return false;
}

// Elements
const installButton = document.getElementById('installButton');
const iosInstructions = document.getElementById('iosInstructions');
const alreadyInstalled = document.getElementById('alreadyInstalled');

function getActionsArray(match) {
  const arr = [match.chronologicalActions, match.actions, match.events, match.eventLog, match.accions]
    .filter(Array.isArray)
    .sort((a,b)=>b.length-a.length)[0];
  return arr || [];
}

// Detectar i normalitzar una acci√≥ de canvi d'aigua
function normalizeChangeAction(a, match) {
  const low = s => (typeof s === 'string' ? s.toLowerCase() : s);
  const type = low(a.type || a.tipus || a.event || a.kind || '');
  const action = low(a.action || a.accion || a.state || '');

  // 1) expl√≠cit per accions de canvi
  let isChange = (type === 'change' || type === 'sub' || type === 'player_change' || type === 'water_change');
  if (!isChange) {
    // 2) a vegades ve nom√©s amb action 'in'/'out'
    isChange = (action === 'in' || action === 'out');
  }
  if (!isChange) return null;

  const inOut = (action === 'in' || type === 'in') ? 'in'
               : (action === 'out' || type === 'out') ? 'out'
               : (a.enter === true) ? 'in'
               : (a.leave === true) ? 'out'
               : null;
  if (!inOut) return null;

  const playerNum = a.playerNum ?? a.jugadorNum ?? a.num ?? a.number ?? null;
  const playerName = a.playerName || a.name || '';

  return { kind: 'change', inOut, playerNum, playerName };
}
function renderChangeAction(action, inOut, quarterLabel, timeStr) {
  const isIn = inOut === 'in';
  const playerNum  = action.playerNum ?? action.jugadorNum ?? action.num ?? '?';
  const playerName = action.playerName || action.name || '';

  const badge = isIn
    ? '<span class="change-badge in">ENTRA</span>'
    : '<span class="change-badge out">SURT</span>';

  return `
    <div class="action-item change ${isIn ? 'change-in':'change-out'}">
      <div class="action-header">
        <span class="action-time">‚è±Ô∏è ${timeStr}</span>
        <span class="action-quarter">${quarterLabel}</span>
      </div>
      <div class="action-content">
        <div class="action-icon">${isIn ? 'üíß‚û°Ô∏è' : 'üíß‚¨ÖÔ∏è'}</div>
        <div class="action-details">
          <div class="action-title">${badge}</div>
          <div class="action-player">
            <span class="action-player-number">${playerNum}</span>
            ${playerName}
          </div>
        </div>
      </div>
    </div>
  `;
}
// ============================================
// üî¥ ACTUALITZAR VISTA EN DIRECTE
// ============================================
function updateLiveView() {
    if (!liveMatchData) {
        console.log('No hi ha dades de partit en directe');
        return;
    }
    
    console.log('üîÑ Actualitzant vista EN DIRECTE...');
    
    const match = liveMatchData;
    
    // ‚úÖ Detectar si el partit est√† finalitzat
    const periodStatus = getPeriodStatus(match);
    const isFinished = periodStatus.finished;
    
    // ‚úÖ Actualitzar t√≠tol segons estat del partit
    const titleElement = document.getElementById('liveTitleText');
    const pulseDot1 = document.getElementById('livePulseDot1');
    const pulseDot2 = document.getElementById('livePulseDot2');
    
    if (titleElement) {
        if (isFinished) {
            titleElement.innerHTML = `
                <div class="live-pulse-dot" style="background: #9ca3af; animation: none;"></div>
                PARTIT FINALITZAT
                <div class="live-pulse-dot" style="background: #9ca3af; animation: none;"></div>
            `;
            // Canviar tamb√© el color del fons del marcador
            const scoreboard = document.querySelector('.live-scoreboard');
            if (scoreboard) {
                scoreboard.style.background = 'linear-gradient(135deg, #374151 0%, #4b5563 100%)';
                scoreboard.style.border = '3px solid #9ca3af';
            }
        } else {
    titleElement.innerHTML = `
        <div class="live-pulse-dot"></div>
        PARTIT EN DIRECTE - ${periodStatus.label}
        <div class="live-pulse-dot"></div>
    `;
            // Restaurar colors originals
            const scoreboard = document.querySelector('.live-scoreboard');
            if (scoreboard) {
                scoreboard.style.background = 'linear-gradient(135deg, #1e3a8a 0%, #0891b2 100%)';
                scoreboard.style.border = '3px solid #22d3ee';
            }
        }
    }
    
    // Detectar quin equip est√† jugant
    const currentTeam = localStorage.getItem('selectedTeam') || 'juvenil';
    const teamEmoji = currentTeam === 'cadet' ? '‚¨õ' : 'üü¶';
    const teamName = currentTeam === 'cadet' ? 'CADET' : 'JUVENIL';
    
    // Actualitzar nom de l'equip CN Terrassa amb l'equip corresponent
    document.getElementById('liveCNTName').textContent = `${teamEmoji} CN TERRASSA ${teamName}`;
    
    // Marcador principal
    document.getElementById('liveScoreCNT').textContent = match.scoreCNT || 0;
    document.getElementById('liveScoreRival').textContent = match.scoreRival || 0;
    document.getElementById('liveRivalName').textContent = match.rivalTeam || 'RIVAL';
    
    // Marcadors per quarter
    const quarters = ['q1', 'q2', 'q3', 'q4'];
    quarters.forEach(q => {
        const qNum = q.toUpperCase();
        const cnt = match.periodScores?.[q]?.cnt || 0;
        const rival = match.periodScores?.[q]?.rival || 0;
        const el = document.getElementById(`live${qNum}`);
        if (el) {
            el.textContent = `${cnt}-${rival}`;
        }
    });
    
    // Timestamp
    if (match.lastUpdate) {
        const secondsAgo = Math.floor((Date.now() - match.lastUpdate) / 1000);
        const timeText = secondsAgo < 5 ? 'ara mateix' :
                        secondsAgo < 60 ? `fa ${secondsAgo} segons` :
                        `fa ${Math.floor(secondsAgo / 60)} minuts`;
        
        document.getElementById('liveTimestamp').textContent = 
            `√öltima actualitzaci√≥: ${timeText}`;
    }
    
    // Golejadors CN Terrassa
    const cntScorers = (match.jugadors || [])
        .filter(j => (j.estadistiques?.gols || 0) > 0)
        .sort((a, b) => (b.estadistiques?.gols || 0) - (a.estadistiques?.gols || 0))
        .slice(0, 10); // Top 10
    
    const cntScorersHTML = cntScorers.length > 0 ? cntScorers.map(j => {
        const gols = j.estadistiques?.gols || 0;
        const exclusions = j.estadistiques?.exclusions || 0;
        const golsEmoji = '‚öΩ'.repeat(Math.min(gols, 5)) + (gols > 5 ? `+${gols - 5}` : '');
        
        return `
            <div class="live-scorer-item">
                <div class="live-scorer-info">
                    <div class="live-scorer-number">${j.numero}</div>
                    <div class="live-scorer-name">${j.nom}</div>
                </div>
                <div class="live-scorer-goals">
                    ${golsEmoji} <span style="font-size: 14px; color: #fde047;">${gols}</span>
                    ${exclusions > 0 ? `<span class="live-scorer-badge">${exclusions} EXC</span>` : ''}
                </div>
            </div>
        `;
    }).join('') : '<div class="live-empty-state" style="padding: 20px;">Encara no hi ha gols</div>';
    
    document.getElementById('liveScorersCNT').innerHTML = cntScorersHTML;
    
    // Exclusions CNT
    const cntExclusions = (match.jugadors || [])
        .filter(j => (j.estadistiques?.exclusions || 0) > 0);
    
    if (cntExclusions.length > 0) {
        document.getElementById('liveExclusionsCNT').style.display = 'block';
        document.getElementById('liveExclusionsCNTList').innerHTML = cntExclusions.map(j => `
            <div class="live-exclusion-item">
                <span style="font-weight: 700;">${j.numero}. ${j.nom}</span>
                <span>${'üü•'.repeat(j.estadistiques.exclusions)}</span>
            </div>
        `).join('');
    } else {
        document.getElementById('liveExclusionsCNT').style.display = 'none';
    }
    
    // Golejadors Rival
    const rivalScorers = (match.rivalStats || [])
        .filter(r => (r.gols || 0) > 0)
        .sort((a, b) => (b.gols || 0) - (a.gols || 0))
        .slice(0, 10);
    
    const rivalScorersHTML = rivalScorers.length > 0 ? rivalScorers.map(r => {
        const gols = r.gols || 0;
        const exclusions = r.exclusions || 0;
        const golsEmoji = '‚öΩ'.repeat(Math.min(gols, 5)) + (gols > 5 ? `+${gols - 5}` : '');
        
        return `
            <div class="live-scorer-item rival">
                <div class="live-scorer-info">
                    <div class="live-scorer-number">${r.num}</div>
                    <div class="live-scorer-name">${r.name || 'Rival ' + r.num}</div>
                </div>
                <div class="live-scorer-goals">
                    ${golsEmoji} <span style="font-size: 14px; color: #fde047;">${gols}</span>
                    ${exclusions > 0 ? `<span class="live-scorer-badge">${exclusions} EXC</span>` : ''}
                </div>
            </div>
        `;
    }).join('') : '<div class="live-empty-state" style="padding: 20px;">Encara no hi ha gols</div>';
    
    document.getElementById('liveScorersRival').innerHTML = rivalScorersHTML;
    
    // Exclusions Rival
    const rivalExclusions = (match.rivalStats || [])
        .filter(r => (r.exclusions || 0) > 0);
    
    if (rivalExclusions.length > 0) {
        document.getElementById('liveExclusionsRival').style.display = 'block';
        document.getElementById('liveExclusionsRivalList').innerHTML = rivalExclusions.map(r => `
            <div class="live-exclusion-item">
                <span style="font-weight: 700;">${r.num}. ${r.name || 'Rival ' + r.num}</span>
                <span>${'üü•'.repeat(r.exclusions)}</span>
            </div>
        `).join('');
    } else {
        document.getElementById('liveExclusionsRival').style.display = 'none';
    }
    
    console.log('‚úÖ Vista EN DIRECTE actualitzada');
}
// Variable per guardar el prompt d'instal¬∑laci√≥
let deferredPrompt;
async function loadACTAWPDataForTeam(teamKey) {
    console.log('üì• Carregant dades ACTAWP per:', teamKey);
    
    const jsonUrls = {
        'juvenil': 'https://joseprico.github.io/CNT_juvenil_25_26/actawp_juvenil_data.json',
        'cadet': 'https://joseprico.github.io/cnt_cadet_25-26/actawp_cadet_data.json'
    };
    
    try {
        const response = await fetch(jsonUrls[teamKey]);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        actawpData = await response.json();
        console.log('‚úÖ Dades ACTAWP carregades correctament per', teamKey);
    } catch (error) {
        console.error('‚ùå Error carregant dades ACTAWP:', error);
        actawpData = null;
    }
}
// ========================================
// L√íGICA PRINCIPAL
// ========================================

function initPWA() {
    console.log('üîç Iniciant detecci√≥ PWA...');
    console.log('üì± iOS:', isIOS());
    console.log('‚úÖ Instal¬∑lada:', isInstalledPWA());
    
    // Si ja est√† instal¬∑lada
    if (isInstalledPWA()) {
        console.log('‚úÖ PWA ja instal¬∑lada - No mostrar res');
        
        // Mostrar missatge durant 3 segons i despr√©s amagar
        alreadyInstalled.style.display = 'block';
        setTimeout(() => {
            alreadyInstalled.style.display = 'none';
        }, 3000);
        
        return; // No fer res m√©s
    }
    
    // Si NO est√† instal¬∑lada
    if (isIOS()) {
        console.log('üçé iOS detectat - Mostrar instruccions');
        
        // Comprovar si ja ha vist les instruccions avui
        const today = new Date().toDateString();
        const lastSeen = localStorage.getItem('iosInstructionsDate');
        
        if (lastSeen !== today) {
            // Mostrar instruccions si no les ha vist avui
            setTimeout(() => {
                iosInstructions.style.display = 'block';
            }, 2000); // Esperar 2 segons despr√©s de carregar
            
            localStorage.setItem('iosInstructionsDate', today);
        }
        
    } else {
        console.log('ü§ñ Android/Desktop - Esperar event d\'instal¬∑laci√≥');
        // Android o Desktop - Esperar l'event beforeinstallprompt
    }
}

// ========================================
// ANDROID: Event d'instal¬∑laci√≥ autom√†tica
// ========================================

window.addEventListener('beforeinstallprompt', (e) => {
    console.log('üí° Event beforeinstallprompt detectat');
    e.preventDefault();
    deferredPrompt = e;
    
    // Mostrar bot√≥ nom√©s si NO est√† instal¬∑lada
    if (!isInstalledPWA()) {
        installButton.style.display = 'block';
    }
});

// Click al bot√≥ d'instal¬∑laci√≥
installButton.addEventListener('click', async () => {
    if (!deferredPrompt) {
        console.log('‚ö†Ô∏è No hi ha prompt disponible');
        alert('‚ö†Ô∏è La instal¬∑laci√≥ no est√† disponible ara mateix.');
        return;
    }
    
    console.log('üì≤ Mostrant prompt d\'instal¬∑laci√≥...');
    deferredPrompt.prompt();
    
    const { outcome } = await deferredPrompt.userChoice;
    console.log(`üë§ Usuari ${outcome === 'accepted' ? 'ha acceptat' : 'ha rebutjat'} la instal¬∑laci√≥`);
    
    if (outcome === 'accepted') {
        installButton.textContent = '‚úÖ Instal¬∑lant...';
        installButton.style.background = 'linear-gradient(135deg, #10b981, #059669)';
        
        setTimeout(() => {
            installButton.style.display = 'none';
        }, 1500);
    }
    
    deferredPrompt = null;
});

// Event quan s'instal¬∑la l'app
window.addEventListener('appinstalled', () => {
    console.log('üéâ PWA instal¬∑lada amb √®xit!');
    installButton.style.display = 'none';
    iosInstructions.style.display = 'none';
    
    // Mostrar missatge de confirmaci√≥
    alreadyInstalled.style.display = 'block';
    setTimeout(() => {
        alreadyInstalled.style.display = 'none';
    }, 3000);
});

// ========================================
// INICIAR EN CARREGAR LA P√ÄGINA
// ========================================

// Executar quan es carrega la p√†gina
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initPWA);
} else {
    initPWA();
}

console.log('üöÄ Sistema PWA carregat');
// ============================================
// üì± OPTIMITZACIONS PER M√íBIL
// ============================================

// Funci√≥ per escur√ßar noms al m√≤bil
function getShortenedName(fullName) {
    if (window.innerWidth > 768) {
        return fullName; // PC: nom complet
    }
    
    // M√≤bil: nom√©s cognom o m√†x 8 car√†cters
    const parts = fullName.trim().split(' ');
    
    if (parts.length > 1) {
        // Retornar √∫ltim cognom
        return parts[parts.length - 1];
    } else {
        // Si no t√© cognom, tallar a 8 car√†cters
        return fullName.length > 8 ? fullName.substring(0, 8) : fullName;
    }
}



// Control de scroll per amagar fletxa
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('statsTableContainer');
    
    if (container && window.innerWidth <= 768) {
        container.addEventListener('scroll', function() {
            if (this.scrollLeft > 50) {
                this.classList.add('scrolled');
            } else {
                this.classList.remove('scrolled');
            }
        });
        
        // Vibraci√≥ quan arriba al final (si est√† disponible)
        let lastScrollLeft = 0;
        container.addEventListener('scroll', function() {
            const maxScroll = this.scrollWidth - this.clientWidth;
            if (this.scrollLeft >= maxScroll - 10 && this.scrollLeft > lastScrollLeft) {
                if (navigator.vibrate) {
                    navigator.vibrate(50);
                }
            }
            lastScrollLeft = this.scrollLeft;
        });
    }
});
function goalZoneMiniRect(zone) {
  const pos = {
    'top-left':[1,1],   'top-center':[1,2],   'top-right':[1,3],
    'mid-left':[2,1],   'mid-center':[2,2],   'mid-right':[2,3],
    'bottom-left':[3,1],'bottom-center':[3,2],'bottom-right':[3,3]
  };
  const [r, c] = pos[zone] || [2,2];
  // ampliem la graella a 4 columnes per fer-la m√©s rectangular
  return `
    <div class="goal-rect" style="--r:${r}; --c:${c};" aria-label="Zona porteria: ${zone||'mid-center'}" title="${zone||'mid-center'}">
      <span class="ball" role="img" aria-label="gol">‚öΩ</span>
    </div>
  `;
}
function fieldZoneMiniRect(zone) {
  const pos = {
    '2m-left': [1,1],      '2m-center': [1,2],      '2m-right': [1,3],
    '5m-left': [2,1],      '5m-center': [2,2],      '5m-right': [2,3],
    '+6m-left': [3,1],     '+6m-center': [3,2],     '+6m-right': [3,3]
  };
  const [r, c] = pos[zone] || [2,2];
  
  return `
    <div class="field-rect" style="--r:${r}; --c:${c};" aria-label="Zona camp: ${zone||'5m-center'}" title="${zone||'5m-center'}">
      <div class="goal-indicator">ü•Ö</div>
      <div class="pool-grid">
        <span class="player-marker" role="img" aria-label="posici√≥">ü§Ω‚Äç‚ôÇÔ∏è</span>
      </div>
    </div>
  `;
}
function goalZoneMini(zone) {
  const pos = {
    'top-left':[1,1],   'top-center':[1,2],   'top-right':[1,3],
    'mid-left':[2,1],   'mid-center':[2,2],   'mid-right':[2,3],
    'bottom-left':[3,1],'bottom-center':[3,2],'bottom-right':[3,3]
  };
  const [r, c] = pos[zone] || [2,2]; // per defecte mid-center
  // fem servir CSS variables per posicionar la pilota
  return `
    <div class="goal3x3" style="--r:${r}; --c:${c};" aria-label="Zona porteria: ${zone||'mid-center'}" title="${zone||'mid-center'}">
      <span class="ball" role="img" aria-label="gol">‚öΩ</span>
    </div>
  `;
}

// Iniciar listener autom√†ticament
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
        if (window.firebaseReady) {
            let team = localStorage.getItem('selectedTeam') || 'juvenil';
            team = team.replace('_25_26', '');
            console.log('üî• Iniciant listener autom√†tic per:', team);
            listenForLiveMatch(team);
        }
    }, 1500);
});
// =====================================
// üìä ESTUDI DE RIVALS - VERSI√ì CORREGIDA
// =====================================

function loadRivalsStudy() {
    if (!actawpData || !actawpData.rivals_form) {
        console.log('‚ùå No hi ha dades de rivals');
        return;
    }
    
    console.log('üìä Carregant estudi de rivals...');
    console.log('üìä Rivals:', Object.keys(actawpData.rivals_form));
    
    loadRivalsOverview();
    loadLeagueTopScorers();
    loadTeamsComparison();
    loadRivalsDetailed();
}

// Secci√≥ 1: Visi√≥ General
function loadRivalsOverview() {
    const container = document.getElementById('rivals-overview');
    if (!container || !actawpData.rivals_form) return;
    
    const rivals = Object.entries(actawpData.rivals_form);
    
    // Ordenar per vict√≤ries (descendent)
    rivals.sort((a, b) => {
        const winsA = a[1].stats?.wins || a[1].form?.filter(f => f === 'W').length || 0;
        const winsB = b[1].stats?.wins || b[1].form?.filter(f => f === 'W').length || 0;
        return winsB - winsA;
    });
    
    const getTrendIcon = (trend) => {
        switch(trend) {
            case 'hot': return 'üî•';
            case 'up': return 'üìà';
            case 'down': return 'üìâ';
            case 'cold': return '‚ùÑÔ∏è';
            default: return '‚û°Ô∏è';
        }
    };
    
    const getTrendText = (trend) => {
        switch(trend) {
            case 'hot': return 'En ratxa';
            case 'up': return 'Pujant';
            case 'down': return 'Baixant';
            case 'cold': return 'En baixa';
            default: return 'Estable';
        }
    };
    
    // Calcular stats si no existeixen
    const calculateStats = (data) => {
        if (data.stats && data.stats.total_gf > 0) {
            return data.stats;
        }
        
        // Calcular des dels resultats
        const form = data.form || [];
        const results = data.last_results || [];
        let total_gf = 0, total_gc = 0;
        
        results.forEach(r => {
            const score = r.score || '0-0';
            const parts = score.split('-');
            if (parts.length === 2) {
                const g1 = parseInt(parts[0]) || 0;
                const g2 = parseInt(parts[1]) || 0;
                // Determinar si √©s team1 o team2
                // Per simplicitat, assumim que les dades ja estan calculades
                total_gf += g1;
                total_gc += g2;
            }
        });
        
        const matches = results.length || 1;
        return {
            wins: form.filter(f => f === 'W').length,
            draws: form.filter(f => f === 'D').length,
            losses: form.filter(f => f === 'L').length,
            total_gf: total_gf,
            total_gc: total_gc,
            avg_gf: (total_gf / matches).toFixed(1),
            avg_gc: (total_gc / matches).toFixed(1),
            trend: 'stable'
        };
    };
    
    container.innerHTML = `
        <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
            <thead>
                <tr style="background: #f1f5f9; color: #334155;">
                    <th style="padding: 10px; text-align: left;">Equip</th>
                    <th style="padding: 10px; text-align: center;">Forma</th>
                    <th style="padding: 10px; text-align: center;">V</th>
                    <th style="padding: 10px; text-align: center;">E</th>
                    <th style="padding: 10px; text-align: center;">D</th>
                    <th style="padding: 10px; text-align: center;">GF</th>
                    <th style="padding: 10px; text-align: center;">GC</th>
                    <th style="padding: 10px; text-align: center;">Mitjana</th>
                    <th style="padding: 10px; text-align: center;">Tend√®ncia</th>
                </tr>
            </thead>
            <tbody>
                ${rivals.map(([name, data], idx) => {
                    const stats = calculateStats(data);
                    const form = data.form || [];
                    const formIcons = form.slice(0, 5).map(r => {
                        if (r === 'W') return '<span style="color: #22c55e;">‚úì</span>';
                        if (r === 'L') return '<span style="color: #ef4444;">‚úó</span>';
                        return '<span style="color: #fbbf24;">-</span>';
                    }).join('');
                    
                    const isCNT = name.toUpperCase().includes('TERRASSA');
                    const rowStyle = isCNT ? 'background: #1e40af; font-weight: 600; color: white;' : 'background: #1e3a5c; color: white;';
                    
                    return `
                        <tr style="${rowStyle}">
                            <td style="padding: 10px; ${isCNT ? 'color: #1e40af;' : ''}">${isCNT ? '‚≠ê ' : ''}${name || 'Desconegut'}</td>
                            <td style="padding: 10px; text-align: center; font-family: monospace;">${formIcons || '-'}</td>
                            <td style="padding: 10px; text-align: center; color: #22c55e; font-weight: 600;">${stats.wins || 0}</td>
                            <td style="padding: 10px; text-align: center; color: #fbbf24;">${stats.draws || 0}</td>
                            <td style="padding: 10px; text-align: center; color: #ef4444;">${stats.losses || 0}</td>
                            <td style="padding: 10px; text-align: center;">${stats.total_gf || 0}</td>
                            <td style="padding: 10px; text-align: center;">${stats.total_gc || 0}</td>
                            <td style="padding: 10px; text-align: center;">${stats.avg_gf || 0}</td>
                            <td style="padding: 10px; text-align: center;">
                                ${getTrendIcon(stats.trend)} ${getTrendText(stats.trend)}
                            </td>
                        </tr>
                    `;
                }).join('')}
            </tbody>
        </table>
    `;
}

// Secci√≥ 2: Top Golejadors de la Lliga
function loadLeagueTopScorers() {
    const container = document.getElementById('league-top-scorers');
    if (!container || !actawpData.rivals_form) return;
    
    // Recollir tots els golejadors de tots els equips
    let allScorers = [];
    
    for (const [teamName, data] of Object.entries(actawpData.rivals_form)) {
        if (data.top_scorers && data.top_scorers.length > 0) {
            data.top_scorers.forEach(player => {
                if (player.name) {
                    allScorers.push({
                        name: player.name || 'Desconegut',
                        goals: player.goals || 0,
                        games: player.games || 0,
                        exclusions: player.exclusions || 0,
                        penalty_goals: player.penalty_goals || 0,
                        avg_goals: player.avg_goals || (player.games > 0 ? (player.goals / player.games).toFixed(2) : '0.00'),
                        team: teamName
                    });
                }
            });
        }
    }
    
    // Afegir jugadors de CNT si tenim dades
    if (actawpData.players && actawpData.players.length > 0) {
        actawpData.players.forEach(p => {
            const goals = p.GT || p.G || 0;
            const games = p.PJ || 0;
            if (goals > 0 && p.Nombre) {
                allScorers.push({
                    name: p.Nombre,
                    goals: goals,
                    games: games,
                    exclusions: p.EX || 0,
                    penalty_goals: p.GP || 0,
                    avg_goals: games > 0 ? (goals / games).toFixed(2) : '0.00',
                    team: 'C.N. TERRASSA',
                    isCNT: true
                });
            }
        });
    }
    
    // Ordenar per gols
    allScorers.sort((a, b) => b.goals - a.goals);
    
    // Top 15
    const top15 = allScorers.slice(0, 15);
    
    if (top15.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: #64748b; padding: 20px;">No hi ha dades de golejadors disponibles</div>';
        return;
    }
    
    container.innerHTML = `
        <div style="display: grid; gap: 8px;">
            ${top15.map((p, idx) => {
                const medal = idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : idx === 2 ? 'ü•â' : `${idx + 1}.`;
                const isCNT = p.isCNT || (p.team && p.team.toUpperCase().includes('TERRASSA'));
                const avgGoals = p.avg_goals || '0.00';
                
                return `
                    <div style="display: flex; align-items: center; padding: 10px; background: ${isCNT ? '#1e40af' : '#334155'}; color: white; border-radius: 8px; ${isCNT ? 'border: 2px solid #3b82f6;' : ''}">
                        <span style="font-size: 18px; width: 35px; text-align: center;">${medal}</span>
                        <div style="flex: 1; margin-left: 10px;">
                            <div style="font-weight: 600; color: white;">
                                ${p.name} ${isCNT ? '‚≠ê' : ''}
                            </div>
                            <div style="font-size: 12px; color: #94a3b8;">${p.team}</div>
                        </div>
                        <div style="text-align: right; margin-right: 15px;">
                            <div style="font-size: 11px; color: #64748b;">${p.games} PJ</div>
                            <div style="font-size: 11px; color: #64748b;">${avgGoals} g/p</div>
                        </div>
                        <div style="text-align: center; background: ${isCNT ? '#3b82f6' : '#fbbf24'}; color: ${isCNT ? 'white' : '#1e293b'}; padding: 8px 15px; border-radius: 8px; min-width: 60px;">
                            <div style="font-size: 20px; font-weight: 700;">${p.goals}</div>
                            <div style="font-size: 10px;">gols</div>
                        </div>
                    </div>
                `;
            }).join('')}
        </div>
    `;
}

// Secci√≥ 3: Comparativa d'Equips
function loadTeamsComparison() {
    const container = document.getElementById('teams-comparison');
    if (!container || !actawpData.rivals_form) return;
    
    const rivals = Object.entries(actawpData.rivals_form);
    
    // Trobar extrems
    let bestAttack = { name: '-', value: 0 };
    let bestDefense = { name: '-', value: 999 };
    let bestStreak = { name: '-', value: 0 };
    let mostExclusions = { name: '-', value: 0 };
    let worstMoment = { name: '-', value: 0 };
    
    rivals.forEach(([name, data]) => {
        if (!name) return;
        
        const stats = data.stats || {};
        const form = data.form || [];
        const topScorers = data.top_scorers || [];
        
        // Calcular mitjana atac si no existeix
        let avgGf = stats.avg_gf || 0;
        let avgGc = stats.avg_gc || 0;
        
        if (!avgGf && data.last_results && data.last_results.length > 0) {
            let totalGf = 0, totalGc = 0;
            data.last_results.forEach(r => {
                const parts = (r.score || '0-0').split('-');
                if (parts.length === 2) {
                    totalGf += parseInt(parts[0]) || 0;
                    totalGc += parseInt(parts[1]) || 0;
                }
            });
            avgGf = totalGf / data.last_results.length;
            avgGc = totalGc / data.last_results.length;
        }
        
        if (avgGf > bestAttack.value) {
            bestAttack = { name, value: avgGf };
        }
        
        if (avgGc < bestDefense.value && avgGc > 0) {
            bestDefense = { name, value: avgGc };
        }
        
        // Comptar ratxa de vict√≤ries
        let streak = 0;
        for (const r of form) {
            if (r === 'W') streak++;
            else break;
        }
        if (streak > bestStreak.value) {
            bestStreak = { name, value: streak };
        }
        
        // Comptar ratxa de derrotes
        let lossStreak = 0;
        for (const r of form) {
            if (r === 'L') lossStreak++;
            else break;
        }
        if (lossStreak > worstMoment.value) {
            worstMoment = { name, value: lossStreak };
        }
        
        // Exclusions dels top scorers
        const teamExclusions = topScorers.reduce((sum, p) => sum + (p.exclusions || 0), 0);
        if (teamExclusions > mostExclusions.value) {
            mostExclusions = { name, value: teamExclusions };
        }
    });
    
    // Si no hem trobat defensa v√†lida, posar 0
    if (bestDefense.value === 999) {
        bestDefense = { name: '-', value: 0 };
    }
    
    container.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            <div style="background: linear-gradient(135deg, #22c55e, #16a34a); padding: 15px; border-radius: 12px; color: white;">
                <div style="font-size: 12px; opacity: 0.9;">üèÜ Millor Atac</div>
                <div style="font-size: 16px; font-weight: 700; margin-top: 5px;">${bestAttack.name}</div>
                <div style="font-size: 14px; opacity: 0.9;">${typeof bestAttack.value === 'number' ? bestAttack.value.toFixed(1) : bestAttack.value} gols/partit</div>
            </div>
            
            <div style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); padding: 15px; border-radius: 12px; color: white;">
                <div style="font-size: 12px; opacity: 0.9;">üõ°Ô∏è Millor Defensa</div>
                <div style="font-size: 16px; font-weight: 700; margin-top: 5px;">${bestDefense.name}</div>
                <div style="font-size: 14px; opacity: 0.9;">${typeof bestDefense.value === 'number' ? bestDefense.value.toFixed(1) : bestDefense.value} gols rebuts/p</div>
            </div>
            
            <div style="background: linear-gradient(135deg, #f97316, #ea580c); padding: 15px; border-radius: 12px; color: white;">
                <div style="font-size: 12px; opacity: 0.9;">üî• Millor Ratxa</div>
                <div style="font-size: 16px; font-weight: 700; margin-top: 5px;">${bestStreak.name}</div>
                <div style="font-size: 14px; opacity: 0.9;">${bestStreak.value} vict√≤ries seguides</div>
            </div>
            
            <div style="background: linear-gradient(135deg, #ef4444, #dc2626); padding: 15px; border-radius: 12px; color: white;">
                <div style="font-size: 12px; opacity: 0.9;">üìâ Pitjor Moment</div>
                <div style="font-size: 16px; font-weight: 700; margin-top: 5px;">${worstMoment.name}</div>
                <div style="font-size: 14px; opacity: 0.9;">${worstMoment.value} derrotes seguides</div>
            </div>
            
            <div style="background: linear-gradient(135deg, #a855f7, #7c3aed); padding: 15px; border-radius: 12px; color: white;">
                <div style="font-size: 12px; opacity: 0.9;">‚ö†Ô∏è M√©s Exclusions</div>
                <div style="font-size: 16px; font-weight: 700; margin-top: 5px;">${mostExclusions.name}</div>
                <div style="font-size: 14px; opacity: 0.9;">${mostExclusions.value} exclusions (top 5)</div>
            </div>
        </div>
    `;
}
// Funci√≥ per obtenir historial vs CNT
function getHistorialVsCNT(rivalName) {
    let vsMatches = [];
    let vsWins = 0, vsDraws = 0, vsLosses = 0, vsGF = 0, vsGC = 0;
    
    if (actawpData && actawpData.last_results) {
        actawpData.last_results.forEach(r => {
            const t1 = (r.team1 || '').toUpperCase();
            const t2 = (r.team2 || '').toUpperCase();
            const rivalUpper = rivalName.toUpperCase();
            
            if (t1.includes(rivalUpper.substring(0, 10)) || t2.includes(rivalUpper.substring(0, 10)) ||
                rivalUpper.includes(t1.substring(0, 10)) || rivalUpper.includes(t2.substring(0, 10))) {
                
                const parts = (r.score || '0-0').split('-');
                const g1 = parseInt(parts[0]) || 0;
                const g2 = parseInt(parts[1]) || 0;
                
                const cntIsTeam1 = t1.includes('TERRASSA');
                const gCNT = cntIsTeam1 ? g1 : g2;
                const gRival = cntIsTeam1 ? g2 : g1;
                
                vsGF += gCNT;
                vsGC += gRival;
                
                if (gCNT > gRival) vsWins++;
                else if (gCNT < gRival) vsLosses++;
                else vsDraws++;
                
                vsMatches.push({
                    date: r.date || '',
                    scoreCNT: gCNT,
                    scoreRival: gRival,
                    home: cntIsTeam1
                });
            }
        });
    }
    
    if (vsMatches.length === 0) {
        return '<div style="text-align: center; color: rgba(255,255,255,0.7); font-size: 13px;">üÜï Encara no ens hem enfrontat aquesta temporada</div>';
    }
    
    let html = '<div style="display: flex; justify-content: space-around; text-align: center; margin-bottom: 15px;">';
    html += '<div><div style="font-size: 24px; font-weight: 700; color: #22c55e;">' + vsWins + '</div><div style="font-size: 11px; color: rgba(255,255,255,0.8);">Vict√≤ries</div></div>';
    html += '<div><div style="font-size: 24px; font-weight: 700; color: #fbbf24;">' + vsDraws + '</div><div style="font-size: 11px; color: rgba(255,255,255,0.8);">Empats</div></div>';
    html += '<div><div style="font-size: 24px; font-weight: 700; color: #ef4444;">' + vsLosses + '</div><div style="font-size: 11px; color: rgba(255,255,255,0.8);">Derrotes</div></div>';
    html += '<div><div style="font-size: 24px; font-weight: 700; color: white;">' + vsGF + '-' + vsGC + '</div><div style="font-size: 11px; color: rgba(255,255,255,0.8);">Gols</div></div>';
    html += '</div>';
    
    html += '<div style="border-top: 1px solid rgba(255,255,255,0.2); padding-top: 10px;">';
    vsMatches.forEach(m => {
        const bgColor = m.scoreCNT > m.scoreRival ? '#22c55e' : (m.scoreCNT < m.scoreRival ? '#ef4444' : '#fbbf24');
        const icon = m.home ? 'üè†' : '‚úàÔ∏è';
        html += '<div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 0; font-size: 12px; color: white;">';
        html += '<span>' + icon + ' ' + (m.date || 'Temporada') + '</span>';
        html += '<span style="font-weight: 600; padding: 4px 12px; background: ' + bgColor + '; border-radius: 20px;">CNT ' + m.scoreCNT + ' - ' + m.scoreRival + '</span>';
        html += '</div>';
    });
    html += '</div>';
    
    return html;
}
// Secci√≥ 4: An√†lisi Detallat per Rival
function loadRivalsDetailed() {
    const container = document.getElementById('rivals-detailed');
    if (!container || !actawpData.rivals_form) return;
    
    const rivals = Object.entries(actawpData.rivals_form);
    
    // Ordenar alfab√®ticament
    rivals.sort((a, b) => (a[0] || '').localeCompare(b[0] || ''));
    
    container.innerHTML = rivals.map(([name, data], idx) => {
        if (!name) return '';
        
        const stats = data.stats || {};
        const form = data.form || [];
        const topScorers = data.top_scorers || [];
        const results = data.last_results || [];
        
        // Calcular stats si no existeixen
        let totalGf = stats.total_gf || 0;
        let totalGc = stats.total_gc || 0;
        let avgGf = stats.avg_gf || 0;
        let avgGc = stats.avg_gc || 0;
        
        if (!totalGf && results.length > 0) {
            results.forEach(r => {
                const parts = (r.score || '0-0').split('-');
                if (parts.length === 2) {
                    totalGf += parseInt(parts[0]) || 0;
                    totalGc += parseInt(parts[1]) || 0;
                }
            });
            avgGf = (totalGf / results.length).toFixed(1);
            avgGc = (totalGc / results.length).toFixed(1);
        }
        
        const wins = stats.wins || form.filter(f => f === 'W').length;
        const draws = stats.draws || form.filter(f => f === 'D').length;
        const losses = stats.losses || form.filter(f => f === 'L').length;
        
        const formIcons = form.map(r => {
            if (r === 'W') return '<span style="color: #22c55e;">‚úÖ</span>';
            if (r === 'L') return '<span style="color: #ef4444;">‚ùå</span>';
            return '<span style="color: #fbbf24;">‚ûñ</span>';
        }).join(' ');
        
        const getTrendText = (trend) => {
            switch(trend) {
                case 'hot': return 'üî• En ratxa';
                case 'up': return 'üìà Pujant';
                case 'down': return 'üìâ Baixant';
                case 'cold': return '‚ùÑÔ∏è En baixa';
                default: return '‚û°Ô∏è Estable';
            }
        };
        
        return `
            <div style="margin-bottom: 15px; border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden;">
                <!-- Header clickable -->
                <div onclick="toggleRivalDetail(${idx})" style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #1e3a5c; color: white; cursor: pointer;">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div style="font-weight: 600; font-size: 15px;">${name}</div>
                        <div style="font-size: 13px;">${formIcons}</div>
                        <span style="font-size: 12px; color: #64748b;">${getTrendText(stats.trend)}</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <span style="font-size: 13px; color: #22c55e; font-weight: 600;">${wins}V</span>
                        <span style="font-size: 13px; color: #fbbf24;">${draws}E</span>
                        <span style="font-size: 13px; color: #ef4444; font-weight: 600;">${losses}D</span>
                        <span id="rival-arrow-${idx}" style="font-size: 18px; transition: transform 0.3s;">‚ñº</span>
                    </div>
                </div>
                
         <!-- Contingut expandible -->
<div id="rival-detail-${idx}" style="display: none; padding: 15px; background: #1e3a5c; color: white;">
    
    <!-- üÜö Historial vs CNT -->
    <div style="margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, #1e40af, #3b82f6); border-radius: 12px;">
        <div style="font-weight: 600; margin-bottom: 10px; color: white;">üÜö Historial vs CN Terrassa</div>
        ${getHistorialVsCNT(name)}
    </div>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
        
        <!-- Estad√≠stiques -->
        <div>
            <div style="font-weight: 600; margin-bottom: 10px; color: white;">üìä Estad√≠stiques</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 13px;">
                <div style="background: #22c55e; padding: 10px; border-radius: 8px;">
                    <div style="color: white; font-weight: 600;">‚öΩ Atac</div>
                    <div style="color: white;">${totalGf} gols (${avgGf}/p)</div>
                </div>
                <div style="background: #ef4444; padding: 10px; border-radius: 8px;">
                    <div style="color: white; font-weight: 600;">üõ°Ô∏è Defensa</div>
                    <div style="color: white;">${totalGc} rebuts (${avgGc}/p)</div>
                </div>
            </div>
        </div>
                        
                        <!-- Jugadors clau -->
                        <div>
                            <div style="font-weight: 600; margin-bottom: 10px; color: white;">‚≠ê Jugadors Clau</div>
                            ${topScorers.length > 0 ? `
                                <div style="font-size: 12px;">
                                    ${topScorers.map((p, i) => {
                                        const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : 'üèÖ';
                                        const dangerIcon = (p.goals || 0) >= 10 ? ' ‚ö†Ô∏è' : '';
                                        const playerName = p.name || 'Desconegut';
                                        return `
                                            <div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #475569;">
                                                <span>${medal} ${playerName}${dangerIcon}</span>
                                                <span style="color: #64748b;">${p.goals || 0}g | ${p.exclusions || 0}ex | ${p.games || 0}pj</span>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            ` : '<div style="color: #94a3b8; font-size: 12px;">Sense dades de jugadors</div>'}
                        </div>
                    </div>
                    
                     <!-- √öltims resultats -->
                    <div style="margin-top: 15px;">
                        <div style="font-weight: 700; margin-bottom: 10px; color: white;">üìÖ √öltims Resultats</div>
                        ${(function() {
                            if (!results || results.length === 0) return '<div style="color: #94a3b8; font-size: 12px;">Sense resultats</div>';
                            
                            const normalizeTeamName = (n) => n.toUpperCase().replace(/C\.N\.|C\.E\.|U\.E\.|CN|CE|UE/g, '').trim();
                            const normalizedName = normalizeTeamName(name);
                            
                            let html = '';
                            results.slice(0, 5).forEach(r => {
                                const t1 = r.team1 || '';
                                const t2 = r.team2 || '';
                                const score = r.score || '0-0';
                                const parts = score.split('-');
                                const g1 = parseInt(parts[0]) || 0;
                                const g2 = parseInt(parts[1]) || 0;
                                
                                const rivalIsTeam1 = normalizeTeamName(t1).includes(normalizedName.substring(0, 6)) || 
                                                    normalizedName.includes(normalizeTeamName(t1).substring(0, 6));
                                const gRival = rivalIsTeam1 ? g1 : g2;
                                const gOponent = rivalIsTeam1 ? g2 : g1;
                                const oponent = rivalIsTeam1 ? t2 : t1;
                                const oponentLogo = rivalIsTeam1 ? (r.team2_logo || '') : (r.team1_logo || '');
                                
                                let resultIcon, bgColor;
                                if (gRival > gOponent) {
                                    resultIcon = '‚úÖ';
                                    bgColor = 'rgba(34, 197, 94, 0.2)';
                                } else if (gRival < gOponent) {
                                    resultIcon = '‚ùå';
                                    bgColor = 'rgba(239, 68, 68, 0.2)';
                                } else {
                                    resultIcon = '‚ûñ';
                                    bgColor = 'rgba(251, 191, 36, 0.2)';
                                }
                                
                                const oponentShort = oponent.replace(/C\.N\.|C\.E\.|U\.E\./g, '').trim();
                                const isHome = rivalIsTeam1;
                                const logoHtml = oponentLogo ? '<img src="' + oponentLogo + '" style="width: 16px; height: 16px; border-radius: 3px; background: white;">' : '';
                                const oponentDisplay = oponentShort.length > 15 ? oponentShort.substring(0, 15) + '...' : oponentShort;
                                
                                html += '<div style="display: flex; align-items: center; justify-content: space-between; padding: 6px 8px; background: ' + bgColor + '; border-radius: 6px; margin-bottom: 4px;">';
                                html += '<div style="display: flex; align-items: center; gap: 6px;">';
                                html += '<span style="font-size: 12px;">' + resultIcon + '</span>';
                                html += '<span style="font-size: 10px; color: #64748b;">' + (isHome ? 'üè†' : '‚úàÔ∏è') + '</span>';
                                html += logoHtml;
                                html += '<span style="font-size: 11px; color: white;">' + oponentDisplay + '</span>';
                                html += '</div>';
                                html += '<span style="font-size: 12px; font-weight: bold; color: white;">' + gRival + ' - ' + gOponent + '</span>';
                                html += '</div>';
                            });
                            
                            return html;
                        })()}
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// Funci√≥ per expandir/contraure detall del rival
function toggleRivalDetail(idx) {
    const detail = document.getElementById(`rival-detail-${idx}`);
    const arrow = document.getElementById(`rival-arrow-${idx}`);
    
    if (!detail || !arrow) return;
    
    if (detail.style.display === 'none') {
        detail.style.display = 'block';
        arrow.style.transform = 'rotate(180deg)';
    } else {
        detail.style.display = 'none';
        arrow.style.transform = 'rotate(0deg)';
    }
}

// Funci√≥ principal per mostrar l'informe
function showPreMatchReport() {

    if (!actawpData || !actawpData.upcoming_matches || actawpData.upcoming_matches.length === 0) {
        alert('No hi ha pr√≤xim partit programat');
        return;
    }
    
    const nextMatch = actawpData.upcoming_matches[0];
    const homeTeam = nextMatch.team1 || '';
    const awayTeam = nextMatch.team2 || '';
    const isHome = homeTeam.toUpperCase().includes('TERRASSA');
    const rivalName = isHome ? awayTeam : homeTeam;
    const matchDate = nextMatch.date || '';
    const matchTime = nextMatch.time || '';
    const jornada = nextMatch.jornada || '';
	const team1Logo = nextMatch.team1_logo || '';
const team2Logo = nextMatch.team2_logo || '';
const cntLogo = isHome ? team1Logo : team2Logo;
const rivalLogo = isHome ? team2Logo : team1Logo;
    
    // Buscar dades del rival
    let rivalData = null;
    if (actawpData.rivals_form) {
        for (const [name, data] of Object.entries(actawpData.rivals_form)) {
            if (name.toUpperCase().includes(rivalName.toUpperCase().substring(0, 8)) ||
                rivalName.toUpperCase().includes(name.toUpperCase().substring(0, 8))) {
                rivalData = data;
                break;
            }
        }
    }
    
    // Buscar posici√≥ a la classificaci√≥
    let rivalPosition = '-';
    let rivalPoints = 0;
    let cntPosition = '-';
    let cntPoints = 0;
    if (actawpData.ranking) {
        actawpData.ranking.forEach((team, idx) => {
            if (team.equip && team.equip.toUpperCase().includes(rivalName.toUpperCase().substring(0, 8))) {
                rivalPosition = team.posicio || (idx + 1);
                rivalPoints = team.punts || 0;
            }
            if (team.equip && team.equip.toUpperCase().includes('TERRASSA')) {
                cntPosition = team.posicio || (idx + 1);
                cntPoints = team.punts || 0;
            }
        });
    }
    
    // Historial vs CNT
    let vsWins = 0, vsDraws = 0, vsLosses = 0, vsGF = 0, vsGC = 0;
    let vsMatches = [];
    if (actawpData.last_results) {
        actawpData.last_results.forEach(r => {
            const t1 = (r.team1 || '').toUpperCase();
            const t2 = (r.team2 || '').toUpperCase();
            const rivalUpper = rivalName.toUpperCase();
            
            if (t1.includes(rivalUpper.substring(0, 8)) || t2.includes(rivalUpper.substring(0, 8))) {
                const parts = (r.score || '0-0').split('-');
                const g1 = parseInt(parts[0]) || 0;
                const g2 = parseInt(parts[1]) || 0;
                
                const cntIsTeam1 = t1.includes('TERRASSA');
                const gCNT = cntIsTeam1 ? g1 : g2;
                const gRival = cntIsTeam1 ? g2 : g1;
                
                vsGF += gCNT;
                vsGC += gRival;
                
                if (gCNT > gRival) vsWins++;
                else if (gCNT < gRival) vsLosses++;
                else vsDraws++;
                
                vsMatches.push({ gCNT, gRival, home: cntIsTeam1, date: r.date });
            }
        });
    }
    
    // Stats del rival
    const stats = rivalData?.stats || {};
    const form = rivalData?.form || [];
    const topScorers = rivalData?.top_scorers || [];
    
    // Calcular tend√®ncia
    const getTrendInfo = (trend) => {
        switch(trend) {
            case 'hot': return { icon: 'üî•', text: 'En ratxa', color: '#ef4444' };
            case 'up': return { icon: 'üìà', text: 'Pujant', color: '#f97316' };
            case 'down': return { icon: 'üìâ', text: 'Baixant', color: '#22c55e' };
            case 'cold': return { icon: '‚ùÑÔ∏è', text: 'En baixa', color: '#22c55e' };
            default: return { icon: '‚û°Ô∏è', text: 'Estable', color: '#fbbf24' };
        }
    };
    
    const trend = getTrendInfo(stats.trend);
    
    // Forma icons
    const formIcons = form.slice(0, 5).map(r => {
        if (r === 'W') return '<span style="display: inline-block; width: 28px; height: 28px; line-height: 28px; text-align: center; background: #22c55e; color: white; border-radius: 50%; font-weight: bold; margin: 2px;">V</span>';
        if (r === 'L') return '<span style="display: inline-block; width: 28px; height: 28px; line-height: 28px; text-align: center; background: #ef4444; color: white; border-radius: 50%; font-weight: bold; margin: 2px;">D</span>';
        return '<span style="display: inline-block; width: 28px; height: 28px; line-height: 28px; text-align: center; background: #fbbf24; color: white; border-radius: 50%; font-weight: bold; margin: 2px;">E</span>';
    }).join('');
    
    // Punts forts i febles
    const avgGf = stats.avg_gf || 0;
    const avgGc = stats.avg_gc || 0;
    
    let puntsForts = [];
    let puntsFebles = [];
    
    if (avgGf >= 15) puntsForts.push('Atac molt potent (' + avgGf + ' gols/p)');
    else if (avgGf >= 12) puntsForts.push('Bon atac (' + avgGf + ' gols/p)');
    else if (avgGf < 10) puntsFebles.push('Atac limitat (' + avgGf + ' gols/p)');
    
    if (avgGc <= 8) puntsForts.push('Defensa s√≤lida (' + avgGc + ' gols rebuts/p)');
    else if (avgGc >= 12) puntsFebles.push('Defensa feble (' + avgGc + ' gols rebuts/p)');
    
    if (form.slice(0, 3).filter(f => f === 'W').length >= 2) puntsForts.push('En bon moment de forma');
    if (form.slice(0, 3).filter(f => f === 'L').length >= 2) puntsFebles.push('Moment de forma dolent');
    
    if (topScorers.length > 0 && topScorers[0].goals >= 15) puntsForts.push('Golejador estrella: ' + topScorers[0].name);
    
    const totalExclusions = topScorers.reduce((sum, p) => sum + (p.exclusions || 0), 0);
    if (totalExclusions >= 20) puntsFebles.push('Equip amb moltes exclusions');
    
    // Crear modal
    const modal = document.createElement('div');
    modal.id = 'pre-match-report-modal';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; overflow-y: auto; padding: 20px;';
    
    modal.innerHTML = `
        <div style="max-width: 800px; margin: 0 auto; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); border-radius: 20px; overflow: hidden; box-shadow: 0 25px 50px rgba(0,0,0,0.5);">
            
            <!-- Header -->
            <div style="background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); padding: 30px; text-align: center; position: relative;">
                <button onclick="closePreMatchReport()" style="position: absolute; top: 15px; right: 15px; background: rgba(255,255,255,0.2); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; font-size: 20px; cursor: pointer;">‚úï</button>
                
                <div style="font-size: 12px; color: rgba(255,255,255,0.8); margin-bottom: 5px;">üìã INFORME PRE-PARTIT</div>
                <div style="font-size: 14px; color: rgba(255,255,255,0.9); margin-bottom: 15px;">Jornada ${jornada} ¬∑ ${matchDate} ¬∑ ${matchTime}h</div>
                
                <div style="display: flex; justify-content: center; align-items: center; gap: 30px;">
    <div style="text-align: center;">
        <div style="width: 80px; height: 80px; background: white; border-radius: 50%; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; overflow: hidden; padding: 5px;">
            ${isHome ? 
                (cntLogo ? '<img src="' + cntLogo + '" style="max-width: 100%; max-height: 100%; object-fit: contain;">' : '<span style="font-size: 36px;">üîµ</span>') :
                (rivalLogo ? '<img src="' + rivalLogo + '" style="max-width: 100%; max-height: 100%; object-fit: contain;">' : '<span style="font-size: 36px;">‚ö™</span>')}
        </div>
        <div style="font-size: 18px; font-weight: 700; color: white;">${isHome ? 'CN TERRASSA' : rivalName}</div>
        <div style="font-size: 13px; color: rgba(255,255,255,0.7);">${isHome ? cntPosition + '¬∫ - ' + cntPoints + ' pts' : rivalPosition + '¬∫ - ' + rivalPoints + ' pts'}</div>
    </div>
    
    <div style="text-align: center;">
        <div style="font-size: 28px; font-weight: 700; color: white;">VS</div>
        <div style="font-size: 12px; color: rgba(255,255,255,0.7);">${isHome ? 'üè† Casa' : '‚úàÔ∏è Fora'}</div>
    </div>
    
    <div style="text-align: center;">
        <div style="width: 80px; height: 80px; background: white; border-radius: 50%; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; overflow: hidden; padding: 5px;">
            ${isHome ? 
                (rivalLogo ? '<img src="' + rivalLogo + '" style="max-width: 100%; max-height: 100%; object-fit: contain;">' : '<span style="font-size: 36px;">‚ö™</span>') :
                (cntLogo ? '<img src="' + cntLogo + '" style="max-width: 100%; max-height: 100%; object-fit: contain;">' : '<span style="font-size: 36px;">üîµ</span>')}
        </div>
        <div style="font-size: 18px; font-weight: 700; color: white;">${isHome ? rivalName : 'CN TERRASSA'}</div>
        <div style="font-size: 13px; color: rgba(255,255,255,0.7);">${isHome ? rivalPosition + '¬∫ - ' + rivalPoints + ' pts' : cntPosition + '¬∫ - ' + cntPoints + ' pts'}</div>
    </div>
</div>
            </div>
            
            <!-- Contingut -->
            <div style="padding: 25px;">
                
                <!-- Historial -->
                <div style="background: #334155; border-radius: 16px; padding: 20px; margin-bottom: 20px;">
                    <div style="font-size: 14px; font-weight: 600; color: #94a3b8; margin-bottom: 15px;">üÜö HISTORIAL CONTRA ${rivalName.toUpperCase()}</div>
                    
                    ${vsMatches.length === 0 ? `
                        <div style="text-align: center; color: #94a3b8; padding: 20px;">
                            <div style="font-size: 40px; margin-bottom: 10px;">üÜï</div>
                            <div>Primer enfrontament de la temporada</div>
                        </div>
                    ` : `
                        <div style="display: flex; justify-content: space-around; text-align: center; margin-bottom: 20px;">
                            <div>
                                <div style="font-size: 36px; font-weight: 700; color: #22c55e;">${vsWins}</div>
                                <div style="font-size: 12px; color: #94a3b8;">Vict√≤ries</div>
                            </div>
                            <div>
                                <div style="font-size: 36px; font-weight: 700; color: #fbbf24;">${vsDraws}</div>
                                <div style="font-size: 12px; color: #94a3b8;">Empats</div>
                            </div>
                            <div>
                                <div style="font-size: 36px; font-weight: 700; color: #ef4444;">${vsLosses}</div>
                                <div style="font-size: 12px; color: #94a3b8;">Derrotes</div>
                            </div>
                            <div>
                                <div style="font-size: 36px; font-weight: 700; color: white;">${vsGF}-${vsGC}</div>
                                <div style="font-size: 12px; color: #94a3b8;">Gols</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                            ${vsMatches.map(m => `
                                <div style="background: ${m.gCNT > m.gRival ? '#22c55e' : m.gCNT < m.gRival ? '#ef4444' : '#fbbf24'}; padding: 8px 16px; border-radius: 20px; font-weight: 600; color: white;">
                                    ${m.home ? 'üè†' : '‚úàÔ∏è'} CNT ${m.gCNT} - ${m.gRival}
                                </div>
                            `).join('')}
                        </div>
                    `}
                </div>
                
                <!-- Forma i Stats del Rival -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    
                    <!-- Forma -->
                    <div style="background: #334155; border-radius: 16px; padding: 20px;">
                        <div style="font-size: 14px; font-weight: 600; color: #94a3b8; margin-bottom: 15px;">üìà FORMA DEL RIVAL</div>
                        <div style="text-align: center; margin-bottom: 15px;">
                            ${formIcons || '<span style="color: #64748b;">Sense dades</span>'}
                        </div>
                        <div style="display: flex; justify-content: center; align-items: center; gap: 10px;">
                            <span style="font-size: 24px;">${trend.icon}</span>
                            <span style="font-size: 16px; font-weight: 600; color: ${trend.color};">${trend.text}</span>
                        </div>
                    </div>
                    
                    <!-- Stats -->
                    <div style="background: #334155; border-radius: 16px; padding: 20px;">
                        <div style="font-size: 14px; font-weight: 600; color: #94a3b8; margin-bottom: 15px;">üìä ESTAD√çSTIQUES</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div style="background: #22c55e; padding: 15px; border-radius: 12px; text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: white;">${avgGf}</div>
                                <div style="font-size: 11px; color: rgba(255,255,255,0.8);">Gols/Partit</div>
                            </div>
                            <div style="background: #ef4444; padding: 15px; border-radius: 12px; text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: white;">${avgGc}</div>
                                <div style="font-size: 11px; color: rgba(255,255,255,0.8);">Rebuts/Partit</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Jugadors Perillosos -->
                <div style="background: #334155; border-radius: 16px; padding: 20px; margin-bottom: 20px;">
                    <div style="font-size: 14px; font-weight: 600; color: #94a3b8; margin-bottom: 15px;">‚ö†Ô∏è JUGADORS A VIGILAR</div>
                    ${topScorers.length > 0 ? `
                        <div style="display: grid; gap: 10px;">
                            ${topScorers.slice(0, 3).map((p, i) => {
                                const danger = (p.goals || 0) >= 10 ? 'üî¥' : (p.goals || 0) >= 5 ? 'üü°' : 'üü¢';
                                return `
                                    <div style="display: flex; align-items: center; background: #1e293b; padding: 15px; border-radius: 12px;">
                                        <div style="font-size: 24px; margin-right: 15px;">${i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : 'ü•â'}</div>
                                        <div style="flex: 1;">
                                            <div style="font-weight: 600; color: white; font-size: 15px;">${p.name || 'Desconegut'}</div>
                                            <div style="font-size: 12px; color: #94a3b8;">${p.games || 0} partits ¬∑ ${p.exclusions || 0} exclusions</div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="font-size: 10px; color: #94a3b8;">Perillositat</div>
                                            <div style="font-size: 20px;">${danger}</div>
                                        </div>
                                        <div style="background: #f97316; padding: 10px 15px; border-radius: 10px; margin-left: 15px; text-align: center;">
                                            <div style="font-size: 20px; font-weight: 700; color: white;">${p.goals || 0}</div>
                                            <div style="font-size: 10px; color: rgba(255,255,255,0.8);">gols</div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    ` : '<div style="color: #64748b; text-align: center;">Sense dades de jugadors</div>'}
                </div>
                
                <!-- Punts Forts i Febles -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    
                    <!-- Punts Forts -->
                    <div style="background: linear-gradient(135deg, #dc2626, #ef4444); border-radius: 16px; padding: 20px;">
                        <div style="font-size: 14px; font-weight: 600; color: rgba(255,255,255,0.9); margin-bottom: 15px;">üí™ PUNTS FORTS</div>
                        ${puntsForts.length > 0 ? `
                            <ul style="margin: 0; padding-left: 20px; color: white;">
                                ${puntsForts.map(p => '<li style="margin-bottom: 8px;">' + p + '</li>').join('')}
                            </ul>
                        ` : '<div style="color: rgba(255,255,255,0.7);">Cap punt fort destacat</div>'}
                    </div>
                    
                    <!-- Punts Febles -->
                    <div style="background: linear-gradient(135deg, #16a34a, #22c55e); border-radius: 16px; padding: 20px;">
                        <div style="font-size: 14px; font-weight: 600; color: rgba(255,255,255,0.9); margin-bottom: 15px;">üéØ PUNTS FEBLES</div>
                        ${puntsFebles.length > 0 ? `
                            <ul style="margin: 0; padding-left: 20px; color: white;">
                                ${puntsFebles.map(p => '<li style="margin-bottom: 8px;">' + p + '</li>').join('')}
                            </ul>
                        ` : '<div style="color: rgba(255,255,255,0.7);">Cap punt feble destacat</div>'}
                    </div>
                </div>
                
                <!-- √öltims Resultats del Rival -->
                <div style="background: #334155; border-radius: 16px; padding: 20px;">
                    <div style="font-size: 14px; font-weight: 600; color: #94a3b8; margin-bottom: 15px;">üìÖ √öLTIMS PARTITS DEL RIVAL</div>
                    ${rivalData && rivalData.last_results && rivalData.last_results.length > 0 ? `
                        <div style="display: grid; gap: 8px;">
                            ${rivalData.last_results.slice(0, 5).map(r => {
                                const parts = (r.score || '0-0').split('-');
                                const g1 = parseInt(parts[0]) || 0;
                                const g2 = parseInt(parts[1]) || 0;
                                const rivalIsTeam1 = (r.team1 || '').toUpperCase().includes(rivalName.toUpperCase().substring(0, 6));
                                const won = rivalIsTeam1 ? g1 > g2 : g2 > g1;
                                const lost = rivalIsTeam1 ? g1 < g2 : g2 < g1;
                                const bgColor = won ? '#22c55e' : lost ? '#ef4444' : '#fbbf24';
                                
                                return `
                                    <div style="display: flex; align-items: center; background: #1e293b; padding: 12px; border-radius: 10px;">
                                        <div style="width: 8px; height: 40px; background: ${bgColor}; border-radius: 4px; margin-right: 12px;"></div>
                                        <div style="flex: 1; color: #94a3b8; font-size: 13px;">${r.team1 || '-'}</div>
                                        <div style="font-weight: 700; color: white; padding: 0 15px;">${r.score || '-'}</div>
                                        <div style="flex: 1; text-align: right; color: #94a3b8; font-size: 13px;">${r.team2 || '-'}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    ` : '<div style="color: #64748b; text-align: center;">Sense dades</div>'}
                </div>
                
            </div>
            
            <!-- Footer -->
            <div style="background: #0f172a; padding: 20px; text-align: center; border-top: 1px solid #334155;">
                <div style="color: #64748b; font-size: 12px;">CN Terrassa ¬∑ Temporada 25/26 ¬∑ Generat autom√†ticament</div>
            </div>
            
        </div>
    `;
    
    document.body.appendChild(modal);
}

// Tancar modal
function closePreMatchReport() {
    const modal = document.getElementById('pre-match-report-modal');
    if (modal) {
        modal.remove();
    }
}

// Tancar amb ESC
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closePreMatchReport();
    }
});
</script>

  
 
<script>
// üéØ PWA Service Worker Registration
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js')
            .then(registration => {
                console.log('‚úÖ Service Worker registrat:', registration.scope);
            })
            .catch(error => {
                console.log('‚ùå Error registrant Service Worker:', error);
            });
    });
}



// üì± PWA Install Prompt
let deferredPrompt;
const installButton = document.getElementById('installButton');

window.addEventListener('beforeinstallprompt', (e) => {
    console.log('üí° PWA instal¬∑lable detectada');
    e.preventDefault();
    deferredPrompt = e;
    // NO amaguem el bot√≥ - ja √©s visible amb CSS
});

installButton.addEventListener('click', async () => {
    if (!deferredPrompt) {
        alert('‚ö†Ô∏è La instal¬∑laci√≥ no est√† disponible ara mateix.\n\nPossibles raons:\n‚Ä¢ Els fitxers PWA no estan carregats\n‚Ä¢ La p√†gina no es serveix amb HTTPS\n‚Ä¢ L\'app ja est√† instal¬∑lada\n‚Ä¢ El navegador no ho suporta');
        console.log('‚ùå No hi ha prompt d\'instal¬∑laci√≥ disponible');
        return;
    }
    
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    console.log(`üë§ L'usuari ${outcome === 'accepted' ? 'ha acceptat' : 'ha rebutjat'} la instal¬∑laci√≥`);
    
    if (outcome === 'accepted') {
        installButton.textContent = '‚úÖ Instal¬∑lada!';
        installButton.style.background = 'linear-gradient(135deg, #10b981, #059669)';
        setTimeout(() => {
            installButton.style.display = 'none';
        }, 2000);
    }
    
    deferredPrompt = null;
});

window.addEventListener('appinstalled', () => {
    console.log('‚úÖ PWA instal¬∑lada amb √®xit');
    installButton.textContent = '‚úÖ Instal¬∑lada!';
    installButton.style.background = 'linear-gradient(135deg, #10b981, #059669)';
    setTimeout(() => {
        installButton.style.display = 'none';
    }, 2000);
});

// Si ja s'executa com a PWA, canviar el bot√≥
if (window.matchMedia('(display-mode: standalone)').matches) {
    console.log('‚úÖ App executant-se com a PWA');
    installButton.textContent = '‚úÖ App Instal¬∑lada';
    installButton.style.background = 'linear-gradient(135deg, #10b981, #059669)';
    installButton.style.cursor = 'default';
}

</script>
  
	<script>
(() => {
  // --- desactiva coses en local (file://) perqu√® no trenquin la p√†gina
  const isHttpish = location.protocol === 'https:' || location.protocol === 'http:';
  if (!isHttpish) {
    // OneSignal: evita que peti en local
    window.OneSignal = window.OneSignal || {};
    if (typeof window.OneSignal.init !== 'function') {
      window.OneSignal.init = async () => { console.warn('OneSignal desactivat en local'); };
    }
    // Service Worker: no a file://
    if ('serviceWorker' in navigator) {
      const _reg = navigator.serviceWorker.register;
      navigator.serviceWorker.register = () => Promise.reject(new Error('SW disabled on file://'));
    }
  }

  // --- shim per evitar "selectTeam is not defined"
  if (typeof window.selectTeam !== 'function') {
    window.selectTeam = function (team) {
      window.currentTeam = team;
      console.log('[selectTeam]', team);
      try {
        if (typeof showTab === 'function') showTab('list'); // o 'live' segons vulguis
        if (typeof displayMatchesList === 'function') displayMatchesList();
      } catch (e) { console.warn(e); }
    };
  }

  // --- util: evita col¬∑lisions de noms globals "const X" re-declarats
  // (no declaris "const statsView = ..." al nivell global; usa variables locals dins funcions)
  window.__guardNoGlobalConsts = true;
})();
</script>
<script>
    // üîí Bloqueo de clic derecho y atajos
    document.addEventListener("contextmenu", event => event.preventDefault());
    document.addEventListener("keydown", event => {
      if ((event.ctrlKey && ["s", "u"].includes(event.key.toLowerCase())) ||
          event.key === "F12") {
        event.preventDefault();
      }
    });
    </script>
</body>
</html>
